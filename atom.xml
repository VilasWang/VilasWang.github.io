<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>CodeVerse | 技术宇宙</title>
  
  <subtitle>探索技术的无限可能</subtitle>
  <link href="https://vilaswang.github.io/atom.xml" rel="self"/>
  
  <link href="https://vilaswang.github.io/"/>
  <updated>2025-12-29T12:37:47.193Z</updated>
  <id>https://vilaswang.github.io/</id>
  
  <author>
    <name>vilas</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Gemini CLI 在国内网络环境下的完整配置指南</title>
    <link href="https://vilaswang.github.io/posts/gemini-cli-proxy/"/>
    <id>https://vilaswang.github.io/posts/gemini-cli-proxy/</id>
    <published>2025-12-18T01:09:23.000Z</published>
    <updated>2025-12-29T12:37:47.193Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Gemini-CLI-在国内网络环境下的完整配置指南"><a href="#Gemini-CLI-在国内网络环境下的完整配置指南" class="headerlink" title="Gemini CLI 在国内网络环境下的完整配置指南"></a>Gemini CLI 在国内网络环境下的完整配置指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-12-18<br><strong>最后更新</strong>: 2025-12-18<br><strong>标签</strong>: <code>gemini-cli</code>, <code>proxy</code>, <code>vpn</code>, <code>network</code>, <code>ai-tools</code>, <code>跨域访问</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%B1%82">2. 系统要求</a></li><li><a href="#3-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">3. 环境准备</a></li><li><a href="#4-gemini-cli-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE">4. Gemini CLI 安装配置</a></li><li><a href="#5-%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE">5. 代理配置</a></li><li><a href="#6-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B">6. 认证流程</a></li><li><a href="#7-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">7. 常见问题与解决方案</a></li><li><a href="#8-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">8. 最佳实践</a></li><li><a href="#9-%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95">9. 验证测试</a></li><li><a href="#10-%E6%80%BB%E7%BB%93">10. 总结</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>本文档提供了一套完整的 Gemini CLI 在国内网络环境下的配置解决方案，通过代理服务和 VPN 组合，实现稳定的 Google 服务访问。</p><h2 id="2-⚙️-系统要求"><a href="#2-⚙️-系统要求" class="headerlink" title="2. ⚙️ 系统要求"></a>2. ⚙️ 系统要求</h2><h2 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h2><h3 id="基础环境"><a href="#基础环境" class="headerlink" title="基础环境"></a>基础环境</h3><table><thead><tr><th>组件</th><th>最低版本</th><th>推荐版本</th><th>验证方法</th></tr></thead><tbody><tr><td><strong>Node.js</strong></td><td>v18.x</td><td>v20.x+</td><td><code>node --version</code></td></tr><tr><td><strong>npm</strong></td><td>v9.x</td><td>v10.x+</td><td><code>npm --version</code></td></tr><tr><td><strong>操作系统</strong></td><td>Windows 10+</td><td>Windows 11&#x2F;macOS&#x2F;Linux</td><td>系统信息</td></tr></tbody></table><h3 id="网络环境"><a href="#网络环境" class="headerlink" title="网络环境"></a>网络环境</h3><h4 id="代理服务要求"><a href="#代理服务要求" class="headerlink" title="代理服务要求"></a>代理服务要求</h4><table><thead><tr><th>要求项</th><th>规格</th><th>说明</th></tr></thead><tbody><tr><td><strong>协议支持</strong></td><td>✅ HTTPS</td><td>必须支持 SSL&#x2F;TLS</td></tr><tr><td><strong>端口配置</strong></td><td>✅ 自定义端口</td><td>支持常用端口（8080, 7890, 10808等）</td></tr><tr><td><strong>连接稳定性</strong></td><td>✅ 高可用</td><td>99%+ 连接成功率</td></tr><tr><td><strong>带宽要求</strong></td><td>✅ &gt; 1Mbps</td><td>满足 API 调用需求</td></tr></tbody></table><h4 id="VPN-服务要求"><a href="#VPN-服务要求" class="headerlink" title="VPN 服务要求"></a>VPN 服务要求</h4><table><thead><tr><th>要求项</th><th>规格</th><th>说明</th></tr></thead><tbody><tr><td><strong>地理位置</strong></td><td>⚠️ <strong>美国节点推荐</strong></td><td>避免地理位置限制</td></tr><tr><td><strong>协议支持</strong></td><td>✅ OpenVPN&#x2F;WireGuard</td><td>确保兼容性</td></tr><tr><td><strong>DNS 保护</strong></td><td>✅ DNS leak防护</td><td>防止 DNS 泄露</td></tr><tr><td><strong>Kill Switch</strong></td><td>✅ 自动断网保护</td><td>意外断开时保护隐私</td></tr></tbody></table><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h3 id="Node-js-安装"><a href="#Node-js-安装" class="headerlink" title="Node.js 安装"></a>Node.js 安装</h3><h4 id="Windows-安装"><a href="#Windows-安装" class="headerlink" title="Windows 安装"></a>Windows 安装</h4><ol><li>访问 <a href="https://nodejs.org/">Node.js 官网</a></li><li>下载 Windows 安装包（.msi）</li><li>运行安装程序，勾选 “Add to PATH”</li><li>验证安装：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node --version</span><br><span class="line">npm --version</span><br></pre></td></tr></table></figure><h4 id="macOS-安装"><a href="#macOS-安装" class="headerlink" title="macOS 安装"></a>macOS 安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Homebrew</span></span><br><span class="line">brew install node</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或下载官方安装包</span></span><br></pre></td></tr></table></figure><h4 id="Linux-安装"><a href="#Linux-安装" class="headerlink" title="Linux 安装"></a>Linux 安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu/Debian</span></span><br><span class="line">curl -fsSL https://deb.nodesource.com/setup_20.x | <span class="built_in">sudo</span> -E bash -</span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y nodejs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或使用 NodeSource</span></span><br></pre></td></tr></table></figure><h3 id="网络连接测试"><a href="#网络连接测试" class="headerlink" title="网络连接测试"></a>网络连接测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试 Google 可访问性</span></span><br><span class="line">curl -I https://google.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试特定服务器连通性</span></span><br><span class="line">ping 216.239.32.223</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 HTTPS 代理</span></span><br><span class="line">curl -x http://127.0.0.1:7890 https://www.google.com</span><br></pre></td></tr></table></figure><h2 id="Gemini-CLI-安装配置"><a href="#Gemini-CLI-安装配置" class="headerlink" title="Gemini CLI 安装配置"></a>Gemini CLI 安装配置</h2><h3 id="全局安装"><a href="#全局安装" class="headerlink" title="全局安装"></a>全局安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 标准安装命令</span></span><br><span class="line">npm install -g @google/gemini-cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">gemini --version</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看帮助信息</span></span><br><span class="line">gemini --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试调试模式</span></span><br><span class="line">gemini -d --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><h3 id="安装验证"><a href="#安装验证" class="headerlink" title="安装验证"></a>安装验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 验证 npm 包安装</span></span><br><span class="line">npm list -g @google/gemini-cli</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查可执行文件</span></span><br><span class="line"><span class="built_in">where</span> gemini  <span class="comment"># Windows</span></span><br><span class="line"><span class="built_in">which</span> gemini   <span class="comment"># macOS/Linux</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试基本功能</span></span><br><span class="line">gemini --version</span><br></pre></td></tr></table></figure><h2 id="代理配置"><a href="#代理配置" class="headerlink" title="代理配置"></a>代理配置</h2><h3 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h3><h4 id="Windows-系统"><a href="#Windows-系统" class="headerlink" title="Windows 系统"></a>Windows 系统</h4><p><strong>CMD 环境</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rem 设置 HTTP 代理（换成你自己的代理地址）</span><br><span class="line">set HTTP_PROXY=http://127.0.0.1:7890</span><br><span class="line">set HTTPS_PROXY=https://127.0.0.1:7890</span><br><span class="line"></span><br><span class="line">rem 验证设置</span><br><span class="line">echo %HTTP_PROXY%</span><br><span class="line">echo %HTTPS_PROXY%</span><br></pre></td></tr></table></figure><p><strong>PowerShell 环境</strong>：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置代理环境变量</span></span><br><span class="line"><span class="variable">$env:HTTP_PROXY</span>=<span class="string">&quot;http://127.0.0.1:7890&quot;</span></span><br><span class="line"><span class="variable">$env:HTTPS_PROXY</span>=<span class="string">&quot;https://127.0.0.1:7890&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证设置</span></span><br><span class="line"><span class="variable">$env:HTTP_PROXY</span></span><br><span class="line"><span class="variable">$env:HTTPS_PROXY</span></span><br></pre></td></tr></table></figure><h4 id="macOS-Linux-系统"><a href="#macOS-Linux-系统" class="headerlink" title="macOS&#x2F;Linux 系统"></a>macOS&#x2F;Linux 系统</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Bash/Zsh 环境</span></span><br><span class="line"><span class="built_in">export</span> HTTP_PROXY=http://127.0.0.1:7890</span><br><span class="line"><span class="built_in">export</span> HTTPS_PROXY=https://127.0.0.1:7890</span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证设置</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$HTTP_PROXY</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$HTTPS_PROXY</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加到配置文件（永久生效）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export HTTP_PROXY=http://127.0.0.1:7890&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export HTTPS_PROXY=https://127.0.0.1:7890&#x27;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">source</span> ~/.bashrc</span><br></pre></td></tr></table></figure><h3 id="代理排除设置"><a href="#代理排除设置" class="headerlink" title="代理排除设置"></a>代理排除设置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows CMD</span></span><br><span class="line"><span class="built_in">set</span> NO_PROXY=localhost,127.0.0.1,.<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Windows PowerShell</span></span><br><span class="line"><span class="variable">$env</span>:NO_PROXY=<span class="string">&quot;localhost,127.0.0.1,.local&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># macOS/Linux</span></span><br><span class="line"><span class="built_in">export</span> NO_PROXY=localhost,127.0.0.1,.<span class="built_in">local</span></span><br></pre></td></tr></table></figure><h3 id="代理服务配置示例"><a href="#代理服务配置示例" class="headerlink" title="代理服务配置示例"></a>代理服务配置示例</h3><h4 id="Clash-配置"><a href="#Clash-配置" class="headerlink" title="Clash 配置"></a>Clash 配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Gemini CLI 专用规则</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="comment"># Google 相关域名走代理</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;DOMAIN-SUFFIX,googleapis.com,🔰 节点选择&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;DOMAIN-SUFFIX,google.com,🔰 节点选择&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;DOMAIN,generativelanguage.googleapis.com,🔰 节点选择&#x27;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;DOMAIN,aistudio.google.com,🔰 节点选择&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Gemini CLI 进程走代理</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#x27;PROCESS-NAME,gemini,🔰 节点选择&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">proxy-groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">🔰</span> <span class="string">节点选择</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">select</span></span><br><span class="line">    <span class="attr">proxies:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">美国节点1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">美国节点2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">美国节点3</span></span><br></pre></td></tr></table></figure><h2 id="认证流程"><a href="#认证流程" class="headerlink" title="认证流程"></a>认证流程</h2><h3 id="启动-Gemini-CLI"><a href="#启动-Gemini-CLI" class="headerlink" title="启动 Gemini CLI"></a>启动 Gemini CLI</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础启动</span></span><br><span class="line">gemini</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调试模式启动</span></span><br><span class="line">gemini -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定模型启动</span></span><br><span class="line">gemini --model=gemini-1.5-flash</span><br></pre></td></tr></table></figure><h3 id="认证步骤"><a href="#认证步骤" class="headerlink" title="认证步骤"></a>认证步骤</h3><ol><li>Gemini CLI 会自动打开浏览器进行 OAuth 认证</li><li>登录 Google 账号</li><li>授权 Gemini CLI 访问权限</li><li>浏览器会跳转回本地端口（通常为 localhost:11101）</li><li>CLI 确认认证成功</li></ol><h2 id="常见问题与解决方案"><a href="#常见问题与解决方案" class="headerlink" title="常见问题与解决方案"></a>常见问题与解决方案</h2><h3 id="连接超时问题"><a href="#连接超时问题" class="headerlink" title="连接超时问题"></a>连接超时问题</h3><p><strong>症状</strong>：</p><ul><li>终端显示 “Waiting for auth…” 后自动退出</li><li>浏览器授权成功但 CLI 连接失败</li><li>错误日志显示 <code>AggregateError [ETIMEDOUT]</code></li></ul><p><strong>解决步骤</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 启用调试模式</span></span><br><span class="line">gemini -d</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查代理设置</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$HTTPS_PROXY</span>  <span class="comment"># Linux/macOS</span></span><br><span class="line"><span class="built_in">echo</span> %HTTPS_PROXY%  <span class="comment"># Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 测试网络连通性</span></span><br><span class="line">curl -x <span class="variable">$HTTPS_PROXY</span> https://google.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 检查特定服务器</span></span><br><span class="line">curl -x <span class="variable">$HTTPS_PROXY</span> https://216.239.32.223</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 测试 DNS 解析</span></span><br><span class="line">nslookup google.com 8.8.8.8</span><br></pre></td></tr></table></figure><h3 id="认证授权问题"><a href="#认证授权问题" class="headerlink" title="认证授权问题"></a>认证授权问题</h3><p><strong>检查清单</strong>：</p><ul><li><input disabled="" type="checkbox"> 防火墙是否阻止 localhost:11101</li><li><input disabled="" type="checkbox"> 杀毒软件是否拦截 Gemini CLI</li><li><input disabled="" type="checkbox"> 代理是否支持 WebSocket 连接</li><li><input disabled="" type="checkbox"> 浏览器是否允许重定向</li></ul><h3 id="环境变量问题"><a href="#环境变量问题" class="headerlink" title="环境变量问题"></a>环境变量问题</h3><p><strong>验证方法</strong>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查当前环境变量</span></span><br><span class="line"><span class="built_in">env</span> | grep -i proxy  <span class="comment"># Linux/macOS</span></span><br><span class="line"><span class="built_in">set</span> | findstr PROXY     <span class="comment"># Windows</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试代理连接</span></span><br><span class="line">curl -v -x <span class="variable">$HTTPS_PROXY</span> https://httpbin.org/ip</span><br></pre></td></tr></table></figure><h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 临时设置（当前会话有效）</span></span><br><span class="line"><span class="built_in">export</span> HTTPS_PROXY=http://127.0.0.1:7890</span><br><span class="line"></span><br><span class="line"><span class="comment"># 永久设置（写入配置文件）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export HTTPS_PROXY=http://127.0.0.1:7890&#x27;</span> &gt;&gt; ~/.profile</span><br><span class="line"><span class="built_in">source</span> ~/.profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统级设置（需要管理员权限）</span></span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/environment &gt; /dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">HTTPS_PROXY=http://127.0.0.1:7890</span></span><br><span class="line"><span class="string">HTTP_PROXY=http://127.0.0.1:7890</span></span><br><span class="line"><span class="string">NO_PROXY=localhost,127.0.0.1,.local</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><h4 id="节点评估标准"><a href="#节点评估标准" class="headerlink" title="节点评估标准"></a>节点评估标准</h4><table><thead><tr><th>指标</th><th>优秀</th><th>良好</th><th>可接受</th></tr></thead><tbody><tr><td><strong>延迟</strong></td><td>&lt; 100ms</td><td>100-200ms</td><td>200-500ms</td></tr><tr><td><strong>稳定性</strong></td><td>99.9%+</td><td>99%+</td><td>95%+</td></tr><tr><td><strong>带宽</strong></td><td>&gt; 10Mbps</td><td>5-10Mbps</td><td>&gt; 1Mbps</td></tr><tr><td><strong>成功率</strong></td><td>100%</td><td>99%+</td><td>95%+</td></tr></tbody></table><h4 id="自动切换配置"><a href="#自动切换配置" class="headerlink" title="自动切换配置"></a>自动切换配置</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Clash 配置示例</span></span><br><span class="line"><span class="attr">proxy-groups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;Auto-Best-Proxy&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">url-test</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">&quot;http://www.gstatic.com/generate_204&quot;</span></span><br><span class="line">    <span class="attr">interval:</span> <span class="number">300</span></span><br><span class="line">    <span class="attr">tolerance:</span> <span class="number">50</span></span><br><span class="line">    <span class="attr">use:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">proxy-nodes</span></span><br></pre></td></tr></table></figure><h3 id="安全策略"><a href="#安全策略" class="headerlink" title="安全策略"></a>安全策略</h3><h4 id="网络安全"><a href="#网络安全" class="headerlink" title="网络安全"></a>网络安全</h4><ol><li><strong>选择可信服务商</strong>：避免使用免费或不稳定的代理服务</li><li><strong>加密通信</strong>：确保代理支持 HTTPS 协议</li><li><strong>日志审计</strong>：定期检查代理连接日志</li><li><strong>访问控制</strong>：限制代理服务的访问权限</li></ol><h4 id="账号安全"><a href="#账号安全" class="headerlink" title="账号安全"></a>账号安全</h4><ol><li><strong>两步验证</strong>：为 Google 账号启用 2FA</li><li><strong>应用密码</strong>：使用应用专用密码而非主密码</li><li><strong>定期审查</strong>：检查授权的应用列表</li><li><strong>安全监控</strong>：监控异常登录活动</li></ol><h2 id="验证测试"><a href="#验证测试" class="headerlink" title="验证测试"></a>验证测试</h2><h3 id="基础环境验证"><a href="#基础环境验证" class="headerlink" title="基础环境验证"></a>基础环境验证</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试基础连接</span></span><br><span class="line">curl -I https://www.google.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试代理连接</span></span><br><span class="line">curl -x <span class="variable">$HTTPS_PROXY</span> -I https://www.google.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试特定服务器</span></span><br><span class="line">curl -x <span class="variable">$HTTPS_PROXY</span> -I https://216.239.32.223</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试 API 端点</span></span><br><span class="line">curl -x <span class="variable">$HTTPS_PROXY</span> https://generativelanguage.googleapis.com</span><br></pre></td></tr></table></figure><h3 id="端到端测试脚本"><a href="#端到端测试脚本" class="headerlink" title="端到端测试脚本"></a>端到端测试脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Gemini CLI 认证测试脚本</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始 Gemini CLI 认证测试...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 检查环境变量</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$HTTPS_PROXY</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;❌ 代理环境变量未设置&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ 代理环境变量: <span class="variable">$HTTPS_PROXY</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 测试网络连接</span></span><br><span class="line"><span class="keyword">if</span> ! curl -s -x <span class="string">&quot;<span class="variable">$HTTPS_PROXY</span>&quot;</span> https://www.google.com &gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;❌ 代理连接失败&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ 代理连接正常&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启动调试模式</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;启动 Gemini CLI 调试模式...&quot;</span></span><br><span class="line"><span class="built_in">timeout</span> 30 gemini -d &amp;</span><br><span class="line">GEMINI_PID=$!</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 等待认证完成</span></span><br><span class="line"><span class="built_in">sleep</span> 5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 检查进程状态</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">kill</span> -0 <span class="variable">$GEMINI_PID</span> 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✅ Gemini CLI 进程运行中&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;请完成浏览器认证流程&quot;</span></span><br><span class="line">    <span class="built_in">wait</span> <span class="variable">$GEMINI_PID</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✅ 认证流程完成&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;❌ Gemini CLI 进程异常退出&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文档提供了一套完整的 Gemini CLI 在国内网络环境下的配置解决方案，涵盖了从环境准备到最终验证的完整流程。</p><h3 id="关键成功因素"><a href="#关键成功因素" class="headerlink" title="关键成功因素"></a>关键成功因素</h3><ul><li><strong>代理服务稳定性</strong>：选择可靠的代理服务提供商</li><li><strong>环境变量配置</strong>：正确设置 HTTPS_PROXY 和相关环境变量</li><li><strong>网络兼容性</strong>：确保代理服务支持 HTTPS 协议和 WebSocket 连接</li><li><strong>系统权限配置</strong>：正确配置防火墙和杀毒软件</li></ul><p>通过遵循本文档的指导原则和最佳实践，用户可以在国内网络环境中稳定、高效地使用 Gemini CLI，享受 Google AI 技术带来的便利和强大功能。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;Gemini-CLI-在国内网络环境下的完整配置指南&quot;&gt;&lt;a href=&quot;#Gemini-CLI-在国内网络环境下的完整配置指南&quot; class=&quot;headerlink&quot; title=&quot;Gemini CLI 在国内网络环境下的完整配置指南&quot;&gt;&lt;/a&gt;Gemini</summary>
        
      
    
    
    
    <category term="开发工具" scheme="https://vilaswang.github.io/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Gemini CLI 和 Claude Code 中配置 GitHub MCP 服务器详解</title>
    <link href="https://vilaswang.github.io/posts/mcp-github-config/"/>
    <id>https://vilaswang.github.io/posts/mcp-github-config/</id>
    <published>2025-12-18T01:09:23.000Z</published>
    <updated>2025-12-18T01:22:09.016Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Gemini-CLI-和-Claude-Code-中配置-GitHub-MCP-服务器详解"><a href="#Gemini-CLI-和-Claude-Code-中配置-GitHub-MCP-服务器详解" class="headerlink" title="Gemini CLI 和 Claude Code 中配置 GitHub MCP 服务器详解"></a>Gemini CLI 和 Claude Code 中配置 GitHub MCP 服务器详解</h1><blockquote><p><strong>文档创建时间</strong>: 2025-12-18<br><strong>最后更新</strong>: 2025-12-18<br><strong>标签</strong>: <code>github</code>, <code>mcp</code>, <code>gemini-cli</code>, <code>claude-code</code>, <code>http</code>, <code>stdio</code>, <code>ai-tools</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-mcp%E4%BC%A0%E8%BE%93%E6%96%B9%E5%BC%8F%E5%AF%B9%E6%AF%94">1. MCP传输方式对比</a></li><li><a href="#2-gemini-cli-%E7%9A%84-mcp-%E9%85%8D%E7%BD%AE">2. Gemini CLI 的 MCP 配置</a></li><li><a href="#3-claude-code-%E7%9A%84-mcp-%E9%85%8D%E7%BD%AE">3. Claude Code 的 MCP 配置</a></li><li><a href="#4-%E5%AE%9E%E7%8E%B0%E5%B7%AE%E5%BC%82%E8%AF%A6%E8%A7%A3">4. 实现差异详解</a></li><li><a href="#5-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%BB%BA%E8%AE%AE">5. 最佳实践建议</a></li><li><a href="#6-%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">6. 故障排除</a></li><li><a href="#7-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">7. 性能优化</a></li><li><a href="#8-%E6%80%BB%E7%BB%93">8. 总结</a></li></ul><hr><h2 id="1-📖-MCP传输方式对比"><a href="#1-📖-MCP传输方式对比" class="headerlink" title="1. 📖 MCP传输方式对比"></a>1. 📖 MCP传输方式对比</h2><h2 id="MCP传输方式对比"><a href="#MCP传输方式对比" class="headerlink" title="MCP传输方式对比"></a>MCP传输方式对比</h2><h3 id="HTTP-vs-stdio-传输方式"><a href="#HTTP-vs-stdio-传输方式" class="headerlink" title="HTTP vs stdio 传输方式"></a>HTTP vs stdio 传输方式</h3><table><thead><tr><th>特性</th><th>HTTP传输</th><th>stdio传输</th></tr></thead><tbody><tr><td><strong>实现复杂度</strong></td><td>相对简单</td><td>较简单</td></tr><tr><td><strong>调试便利性</strong></td><td>容易调试（可用curl等工具）</td><td>调试较困难</td></tr><tr><td><strong>跨平台性</strong></td><td>优秀</td><td>需考虑换行符问题</td></tr><tr><td><strong>安全考虑</strong></td><td>需要处理认证</td><td>通过stdin&#x2F;stdout通信</td></tr><tr><td><strong>性能</strong></td><td>有网络开销</td><td>直接进程通信</td></tr><tr><td><strong>扩展性</strong></td><td>易于集群部署</td><td>单进程限制</td></tr></tbody></table><h2 id="一、Gemini-CLI-的-MCP-配置"><a href="#一、Gemini-CLI-的-MCP-配置" class="headerlink" title="一、Gemini CLI 的 MCP 配置"></a>一、Gemini CLI 的 MCP 配置</h2><h3 id="1-1-HTTP方式配置"><a href="#1-1-HTTP方式配置" class="headerlink" title="1.1 HTTP方式配置"></a>1.1 HTTP方式配置</h3><p>HTTP方式适合已经实现了REST API的MCP服务器：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;selectedAuthType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vertex-ai&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;theme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GitHub&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;github-http&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/mcp&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Authorization&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer $&#123;GITHUB_TOKEN&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Content-Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/json&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="1-2-stdio方式配置"><a href="#1-2-stdio方式配置" class="headerlink" title="1.2 stdio方式配置"></a>1.2 stdio方式配置</h3><p>stdio方式适合直接命令行启动的MCP服务器：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;selectedAuthType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vertex-ai&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;theme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GitHub&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;github-stdio&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stdio&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;-y&quot;</span><span class="punctuation">,</span> <span class="string">&quot;@modelcontextprotocol/server-github&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;GITHUB_PERSONAL_ACCESS_TOKEN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;GITHUB_PERSONAL_ACCESS_TOKEN&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="1-3-混合配置示例"><a href="#1-3-混合配置示例" class="headerlink" title="1.3 混合配置示例"></a>1.3 混合配置示例</h3><p>同时支持两种传输方式：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;selectedAuthType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;vertex-ai&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;theme&quot;</span><span class="punctuation">:</span> <span class="string">&quot;GitHub&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;github&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stdio&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;-y&quot;</span><span class="punctuation">,</span> <span class="string">&quot;@modelcontextprotocol/server-github&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;GITHUB_PERSONAL_ACCESS_TOKEN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;GITHUB_PERSONAL_ACCESS_TOKEN&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;github-fallback&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/github-mcp&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Authorization&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer $&#123;GITHUB_TOKEN&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="二、Claude-Code-的-MCP-配置"><a href="#二、Claude-Code-的-MCP-配置" class="headerlink" title="二、Claude Code 的 MCP 配置"></a>二、Claude Code 的 MCP 配置</h2><h3 id="2-1-配置文件位置"><a href="#2-1-配置文件位置" class="headerlink" title="2.1 配置文件位置"></a>2.1 配置文件位置</h3><p>Claude Code支持多个配置文件位置：</p><ul><li>用户级配置：<code>~/.claude/claude_desktop_config.json</code></li><li>项目级配置：<code>.claude/claude_desktop_config.json</code></li><li>临时配置：<code>./mcp.json</code></li></ul><h3 id="2-2-HTTP方式配置"><a href="#2-2-HTTP方式配置" class="headerlink" title="2.2 HTTP方式配置"></a>2.2 HTTP方式配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;github-api&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://api.github.com/mcp&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Authorization&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer $&#123;GITHUB_TOKEN&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;X-GitHub-API-Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-11-28&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-3-stdio方式配置"><a href="#2-3-stdio方式配置" class="headerlink" title="2.3 stdio方式配置"></a>2.3 stdio方式配置</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;github-cli&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;-y&quot;</span><span class="punctuation">,</span> <span class="string">&quot;@modelcontextprotocol/server-github&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;GITHUB_PERSONAL_ACCESS_TOKEN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;GITHUB_PERSONAL_ACCESS_TOKEN&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-4-使用CLI命令添加MCP"><a href="#2-4-使用CLI命令添加MCP" class="headerlink" title="2.4 使用CLI命令添加MCP"></a>2.4 使用CLI命令添加MCP</h3><p>Claude Code提供了便捷的CLI命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加HTTP类型的MCP服务器</span></span><br><span class="line">claude mcp add --transport http \</span><br><span class="line">  --name github-api \</span><br><span class="line">  --url https://api.github.com/mcp \</span><br><span class="line">  --<span class="built_in">env</span> GITHUB_TOKEN=<span class="string">&quot;<span class="variable">$&#123;GITHUB_TOKEN&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加stdio类型的MCP服务器</span></span><br><span class="line">claude mcp add --transport stdio \</span><br><span class="line">  --name github-cli \</span><br><span class="line">  --<span class="built_in">command</span> npx \</span><br><span class="line">  --args <span class="string">&quot;-y&quot;</span> <span class="string">&quot;@modelcontextprotocol/server-github&quot;</span> \</span><br><span class="line">  --<span class="built_in">env</span> GITHUB_PERSONAL_ACCESS_TOKEN=<span class="string">&quot;<span class="variable">$&#123;GITHUB_PERSONAL_ACCESS_TOKEN&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure><h2 id="三、实现差异详解"><a href="#三、实现差异详解" class="headerlink" title="三、实现差异详解"></a>三、实现差异详解</h2><h3 id="3-1-服务器端实现"><a href="#3-1-服务器端实现" class="headerlink" title="3.1 服务器端实现"></a>3.1 服务器端实现</h3><h4 id="HTTP服务器示例"><a href="#HTTP服务器示例" class="headerlink" title="HTTP服务器示例"></a>HTTP服务器示例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># github_mcp_http_server.py</span></span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GitHubMCPHandler</span>(<span class="title class_ inherited__">BaseHTTPRequestHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_POST</span>(<span class="params">self</span>):</span><br><span class="line">        content_length = <span class="built_in">int</span>(<span class="variable language_">self</span>.headers[<span class="string">&#x27;Content-Length&#x27;</span>])</span><br><span class="line">        post_data = <span class="variable language_">self</span>.rfile.read(content_length)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 处理MCP请求</span></span><br><span class="line">        response = <span class="variable language_">self</span>.handle_mcp_request(json.loads(post_data))</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.send_response(<span class="number">200</span>)</span><br><span class="line">        <span class="variable language_">self</span>.send_header(<span class="string">&#x27;Content-type&#x27;</span>, <span class="string">&#x27;application/json&#x27;</span>)</span><br><span class="line">        <span class="variable language_">self</span>.end_headers()</span><br><span class="line">        <span class="variable language_">self</span>.wfile.write(json.dumps(response).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_mcp_request</span>(<span class="params">self, request</span>):</span><br><span class="line">    <span class="comment"># 实现MCP协议逻辑</span></span><br><span class="line">    <span class="keyword">if</span> request.get(<span class="string">&#x27;method&#x27;</span>) == <span class="string">&#x27;tools/list&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&#x27;tools&#x27;</span>: list_available_tools()&#125;</span><br><span class="line">    <span class="keyword">elif</span> request.get(<span class="string">&#x27;method&#x27;</span>) == <span class="string">&#x27;tools/call&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> execute_tool_call(request)</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    server = HTTPServer((<span class="string">&#x27;localhost&#x27;</span>, <span class="number">8080</span>), GitHubMCPHandler)</span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure><h4 id="stdio服务器示例"><a href="#stdio服务器示例" class="headerlink" title="stdio服务器示例"></a>stdio服务器示例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># github_mcp_stdio_server.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            line = sys.stdin.readline()</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">            request = json.loads(line.strip())</span><br><span class="line">            response = handle_mcp_request(request)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(json.dumps(response))</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            error_response = &#123;</span><br><span class="line">                <span class="string">&#x27;error&#x27;</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;code&#x27;</span>: -<span class="number">32603</span>,</span><br><span class="line">                    <span class="string">&#x27;message&#x27;</span>: <span class="built_in">str</span>(e)</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="built_in">print</span>(json.dumps(error_response))</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><h3 id="3-2-认证处理差异"><a href="#3-2-认证处理差异" class="headerlink" title="3.2 认证处理差异"></a>3.2 认证处理差异</h3><h4 id="HTTP认证"><a href="#HTTP认证" class="headerlink" title="HTTP认证"></a>HTTP认证</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Authorization&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer $&#123;GITHUB_TOKEN&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;X-API-Key&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;API_KEY&#125;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="stdio认证"><a href="#stdio认证" class="headerlink" title="stdio认证"></a>stdio认证</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;GITHUB_PERSONAL_ACCESS_TOKEN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;GITHUB_PERSONAL_ACCESS_TOKEN&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;API_KEY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;API_KEY&#125;&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="四、最佳实践建议"><a href="#四、最佳实践建议" class="headerlink" title="四、最佳实践建议"></a>四、最佳实践建议</h2><h3 id="4-1-选择传输方式的考虑因素"><a href="#4-1-选择传输方式的考虑因素" class="headerlink" title="4.1 选择传输方式的考虑因素"></a>4.1 选择传输方式的考虑因素</h3><ol><li><strong>开发阶段</strong>：使用stdio，便于调试</li><li><strong>生产环境</strong>：使用HTTP，便于监控和扩展</li><li><strong>网络环境</strong>：受限环境可能需要stdio</li><li><strong>性能要求</strong>：高频调用使用stdio</li></ol><h3 id="4-2-错误处理策略"><a href="#4-2-错误处理策略" class="headerlink" title="4.2 错误处理策略"></a>4.2 错误处理策略</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;github&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;stdio&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;-y&quot;</span><span class="punctuation">,</span> <span class="string">&quot;@modelcontextprotocol/server-github&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;GITHUB_PERSONAL_ACCESS_TOKEN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;GITHUB_PERSONAL_ACCESS_TOKEN&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;NODE_ENV&quot;</span><span class="punctuation">:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;retries&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="number">30000</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;github-backup&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://backup-server:8080/mcp&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;fallback&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="4-3-安全考虑"><a href="#4-3-安全考虑" class="headerlink" title="4.3 安全考虑"></a>4.3 安全考虑</h3><ol><li><p><strong>令牌管理</strong>：</p><ul><li>使用环境变量，避免硬编码</li><li>定期轮换访问令牌</li><li>使用最小权限原则</li></ul></li><li><p><strong>网络安全</strong>：</p><ul><li>HTTP方式使用HTTPS</li><li>验证服务器证书</li><li>限制访问来源</li></ul></li><li><p><strong>数据保护</strong>：</p><ul><li>敏感数据脱敏</li><li>日志记录控制</li><li>临时文件清理</li></ul></li></ol><h2 id="五、故障排除"><a href="#五、故障排除" class="headerlink" title="五、故障排除"></a>五、故障排除</h2><h3 id="5-1-常见问题"><a href="#5-1-常见问题" class="headerlink" title="5.1 常见问题"></a>5.1 常见问题</h3><ol><li><p><strong>连接超时</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="number">60000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;retries&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;retryDelay&quot;</span><span class="punctuation">:</span> <span class="number">1000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>认证失败</strong></p><ul><li>检查环境变量设置</li><li>验证令牌有效性</li><li>确认权限配置</li></ul></li><li><p><strong>通信错误</strong></p><ul><li>stdio：检查换行符（\n vs \r\n）</li><li>HTTP：检查Content-Type头</li></ul></li></ol><h3 id="5-2-调试技巧"><a href="#5-2-调试技巧" class="headerlink" title="5.2 调试技巧"></a>5.2 调试技巧</h3><h4 id="HTTP方式调试"><a href="#HTTP方式调试" class="headerlink" title="HTTP方式调试"></a>HTTP方式调试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试连接</span></span><br><span class="line">curl -X POST http://localhost:8080/mcp \</span><br><span class="line">  -H <span class="string">&quot;Content-Type: application/json&quot;</span> \</span><br><span class="line">  -H <span class="string">&quot;Authorization: Bearer <span class="variable">$GITHUB_TOKEN</span>&quot;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;tools/list&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="stdio方式调试"><a href="#stdio方式调试" class="headerlink" title="stdio方式调试"></a>stdio方式调试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 手动测试</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&#123;&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;tools/list&quot;&#125;&#x27;</span> | npx -y @modelcontextprotocol/server-github</span><br></pre></td></tr></table></figure><h2 id="六、性能优化"><a href="#六、性能优化" class="headerlink" title="六、性能优化"></a>六、性能优化</h2><h3 id="6-1-HTTP优化"><a href="#6-1-HTTP优化" class="headerlink" title="6.1 HTTP优化"></a>6.1 HTTP优化</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Connection&quot;</span><span class="punctuation">:</span> <span class="string">&quot;keep-alive&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Keep-Alive&quot;</span><span class="punctuation">:</span> <span class="string">&quot;timeout=60, max=100&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;timeout&quot;</span><span class="punctuation">:</span> <span class="number">30000</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="6-2-stdio优化"><a href="#6-2-stdio优化" class="headerlink" title="6.2 stdio优化"></a>6.2 stdio优化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 批量处理请求</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">batch_process_requests</span>(<span class="params">requests</span>):</span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">for</span> request <span class="keyword">in</span> requests:</span><br><span class="line">        results.append(handle_request(request))</span><br><span class="line">    <span class="keyword">return</span> results</span><br></pre></td></tr></table></figure><h2 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h2><p>HTTP和stdio两种传输方式各有优势：</p><ul><li><strong>HTTP</strong>：易于调试、扩展性好、适合分布式部署</li><li><strong>stdio</strong>：性能高、实现简单、适合本地开发</li></ul><p>根据实际需求选择合适的传输方式，并做好错误处理和安全防护。通过合理的配置和优化，可以在Gemini CLI和Claude Code中稳定地使用GitHub MCP服务器，提升开发效率。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a href="https://modelcontextprotocol.io/">Model Context Protocol官方文档</a></li><li><a href="https://ai.google.dev/gemini-api/docs/cli">Gemini CLI文档</a></li><li><a href="https://docs.anthropic.com/claude/docs/claude-for-developers">Claude Code文档</a></li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;Gemini-CLI-和-Claude-Code-中配置-GitHub-MCP-服务器详解&quot;&gt;&lt;a href=&quot;#Gemini-CLI-和-Claude-Code-中配置-GitHub-MCP-服务器详解&quot; class=&quot;headerlink&quot;</summary>
        
      
    
    
    
    <category term="开发工具" scheme="https://vilaswang.github.io/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Windows 环境下配置 GitHub MCP 服务器完整指南</title>
    <link href="https://vilaswang.github.io/posts/windows-github-mcp/"/>
    <id>https://vilaswang.github.io/posts/windows-github-mcp/</id>
    <published>2025-12-18T01:09:23.000Z</published>
    <updated>2025-12-18T01:22:18.455Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Windows-环境下配置-GitHub-MCP-服务器完整指南"><a href="#Windows-环境下配置-GitHub-MCP-服务器完整指南" class="headerlink" title="Windows 环境下配置 GitHub MCP 服务器完整指南"></a>Windows 环境下配置 GitHub MCP 服务器完整指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-12-18<br><strong>最后更新</strong>: 2025-12-18<br><strong>标签</strong>: <code>github</code>, <code>mcp</code>, <code>windows</code>, <code>powershell</code>, <code>gemini-cli</code>, <code>ai-tools</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E7%94%9F%E6%88%90-github-pat">2. 生成 GitHub PAT</a></li><li><a href="#3-%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">3. 设置环境变量</a></li><li><a href="#4-%E7%BC%96%E8%BE%91-gemini-cli-%E9%85%8D%E7%BD%AE">4. 编辑 Gemini CLI 配置</a></li><li><a href="#5-%E5%AE%89%E8%A3%85%E5%BF%85%E8%A6%81%E7%9A%84%E4%BE%9D%E8%B5%96">5. 安装必要的依赖</a></li><li><a href="#6-%E9%AA%8C%E8%AF%81%E9%85%8D%E7%BD%AE">6. 验证配置</a></li><li><a href="#7-%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">7. 故障排除</a></li><li><a href="#8-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">8. 最佳实践</a></li><li><a href="#9-%E6%80%BB%E7%BB%93">9. 总结</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>本文将详细介绍在Windows环境下如何配置GitHub MCP (Model Context Protocol) 服务器，让您可以在Gemini CLI中直接操作GitHub仓库。</p><h2 id="2-🔑-生成-GitHub-PAT"><a href="#2-🔑-生成-GitHub-PAT" class="headerlink" title="2. 🔑 生成 GitHub PAT"></a>2. 🔑 生成 GitHub PAT</h2><h2 id="步骤-1：生成-GitHub-PAT"><a href="#步骤-1：生成-GitHub-PAT" class="headerlink" title="步骤 1：生成 GitHub PAT"></a>步骤 1：生成 GitHub PAT</h2><p>按照以下步骤在GitHub创建一个<strong>Fine-grained Token</strong>（细粒度令牌）：</p><h3 id="1-1-访问GitHub设置"><a href="#1-1-访问GitHub设置" class="headerlink" title="1.1 访问GitHub设置"></a>1.1 访问GitHub设置</h3><ol><li>登录GitHub账户</li><li>点击右上角头像</li><li>选择 “Settings”（设置）</li><li>在左侧菜单中选择 “Developer settings”</li><li>点击 “Personal access tokens” → “Fine-grained tokens”</li></ol><h3 id="1-2-创建新令牌"><a href="#1-2-创建新令牌" class="headerlink" title="1.2 创建新令牌"></a>1.2 创建新令牌</h3><ol><li>点击 “Generate new token”</li><li>输入令牌名称（如：”Gemini MCP Server”）</li><li>设置过期时间（建议选择90天）</li></ol><h3 id="1-3-配置权限"><a href="#1-3-配置权限" class="headerlink" title="1.3 配置权限"></a>1.3 配置权限</h3><p><strong>Repository access</strong>：</p><ul><li>选择你要访问的仓库</li><li>建议选择 “Only select repositories” 并指定相关仓库</li></ul><p><strong>Permissions</strong>（权限配置）：</p><ul><li><strong>Contents</strong> → Read &amp; Write（读写代码内容）</li><li><strong>Issues</strong> → Read &amp; Write（管理Issues）</li><li><strong>Pull requests</strong> → Read &amp; Write（管理PR）</li><li><strong>Metadata</strong> → Read（读取仓库元数据）</li></ul><h3 id="1-4-复制令牌"><a href="#1-4-复制令牌" class="headerlink" title="1.4 复制令牌"></a>1.4 复制令牌</h3><p>生成后立即复制并保存令牌，格式如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ghp_abcd1234efgh5678ijkl90mnopqrstuvwx</span><br></pre></td></tr></table></figure><h2 id="步骤-2：设置环境变量（Windows）"><a href="#步骤-2：设置环境变量（Windows）" class="headerlink" title="步骤 2：设置环境变量（Windows）"></a>步骤 2：设置环境变量（Windows）</h2><h3 id="2-1-使用PowerShell设置"><a href="#2-1-使用PowerShell设置" class="headerlink" title="2.1 使用PowerShell设置"></a>2.1 使用PowerShell设置</h3><p>在Windows PowerShell中运行以下命令：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置用户级环境变量</span></span><br><span class="line">setx GITHUB_PERSONAL_ACCESS_TOKEN <span class="string">&quot;你的GitHub令牌&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置会话级环境变量（立即生效）</span></span><br><span class="line"><span class="variable">$env:GITHUB_PERSONAL_ACCESS_TOKEN</span> = <span class="string">&quot;你的GitHub令牌&quot;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-验证设置"><a href="#2-2-验证设置" class="headerlink" title="2.2 验证设置"></a>2.2 验证设置</h3><p>重新打开一个新的PowerShell窗口，验证环境变量：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看环境变量值</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$env:GITHUB_PERSONAL_ACCESS_TOKEN</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line"><span class="built_in">Get-ChildItem</span> Env:GITHUB_PERSONAL_ACCESS_TOKEN</span><br></pre></td></tr></table></figure><h2 id="步骤-3：编辑-Gemini-CLI-配置"><a href="#步骤-3：编辑-Gemini-CLI-配置" class="headerlink" title="步骤 3：编辑 Gemini CLI 配置"></a>步骤 3：编辑 Gemini CLI 配置</h2><h3 id="3-1-定位配置文件"><a href="#3-1-定位配置文件" class="headerlink" title="3.1 定位配置文件"></a>3.1 定位配置文件</h3><ul><li><strong>全局配置路径</strong>：<code>%USERPROFILE%\.gemini\settings.json</code></li><li><strong>项目级配置路径</strong>：<code>你的项目目录\.gemini\settings.json</code></li></ul><h3 id="3-2-创建配置文件"><a href="#3-2-创建配置文件" class="headerlink" title="3.2 创建配置文件"></a>3.2 创建配置文件</h3><p>如果配置文件不存在，先创建：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建配置目录</span></span><br><span class="line">mkdir <span class="variable">$env:USERPROFILE</span>\.gemini</span><br><span class="line"></span><br><span class="line"><span class="comment"># 编辑配置文件</span></span><br><span class="line">notepad <span class="variable">$env:USERPROFILE</span>\.gemini\settings.json</span><br></pre></td></tr></table></figure><h3 id="3-3-配置MCP服务器"><a href="#3-3-配置MCP服务器" class="headerlink" title="3.3 配置MCP服务器"></a>3.3 配置MCP服务器</h3><p>在 <code>settings.json</code> 中写入以下内容：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;github&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;-y&quot;</span><span class="punctuation">,</span> <span class="string">&quot;@modelcontextprotocol/server-github&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;GITHUB_PERSONAL_ACCESS_TOKEN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;GITHUB_PERSONAL_ACCESS_TOKEN&#125;&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="步骤-4：安装必要的依赖"><a href="#步骤-4：安装必要的依赖" class="headerlink" title="步骤 4：安装必要的依赖"></a>步骤 4：安装必要的依赖</h2><h3 id="4-1-安装Node-js（如果尚未安装）"><a href="#4-1-安装Node-js（如果尚未安装）" class="headerlink" title="4.1 安装Node.js（如果尚未安装）"></a>4.1 安装Node.js（如果尚未安装）</h3><p>访问 <a href="https://nodejs.org/">Node.js官网</a> 下载并安装LTS版本。</p><h3 id="4-2-安装GitHub-MCP服务器"><a href="#4-2-安装GitHub-MCP服务器" class="headerlink" title="4.2 安装GitHub MCP服务器"></a>4.2 安装GitHub MCP服务器</h3><p>在PowerShell中执行：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 全局安装GitHub MCP服务器</span></span><br><span class="line">npm install <span class="literal">-g</span> @modelcontextprotocol/server<span class="literal">-github</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 验证安装</span></span><br><span class="line">npx @modelcontextprotocol/server<span class="literal">-github</span> <span class="literal">--help</span></span><br></pre></td></tr></table></figure><h2 id="步骤-5：验证配置"><a href="#步骤-5：验证配置" class="headerlink" title="步骤 5：验证配置"></a>步骤 5：验证配置</h2><h3 id="5-1-启动Gemini-CLI"><a href="#5-1-启动Gemini-CLI" class="headerlink" title="5.1 启动Gemini CLI"></a>5.1 启动Gemini CLI</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Gemini CLI</span></span><br><span class="line">gemini</span><br></pre></td></tr></table></figure><h3 id="5-2-测试MCP连接"><a href="#5-2-测试MCP连接" class="headerlink" title="5.2 测试MCP连接"></a>5.2 测试MCP连接</h3><p>在Gemini CLI中输入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/mcp</span><br></pre></td></tr></table></figure><p>如果配置成功，你应该能看到 “github mcp server connected” 的提示。</p><h3 id="5-3-测试功能"><a href="#5-3-测试功能" class="headerlink" title="5.3 测试功能"></a>5.3 测试功能</h3><p>尝试以下命令测试GitHub MCP功能：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">列出我仓库中的open issues</span><br><span class="line">查看我的个人资料信息</span><br><span class="line">列出最近修改的仓库</span><br></pre></td></tr></table></figure><h2 id="故障排除"><a href="#故障排除" class="headerlink" title="故障排除"></a>故障排除</h2><h3 id="常见问题及解决方案"><a href="#常见问题及解决方案" class="headerlink" title="常见问题及解决方案"></a>常见问题及解决方案</h3><ol><li><p><strong>MCP服务器连接失败</strong></p><ul><li>检查环境变量是否正确设置</li><li>确认GitHub PAT权限配置正确</li><li>验证网络连接</li></ul></li><li><p><strong>权限错误</strong></p><ul><li>确保PAT包含必要的权限</li><li>检查PAT是否已过期</li></ul></li><li><p><strong>npx命令失败</strong></p><ul><li>确保Node.js已正确安装</li><li>检查npm全局安装路径</li></ul></li></ol><h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><ol><li><p><strong>安全性</strong>：</p><ul><li>定期更新PAT</li><li>使用最小权限原则</li><li>不要在代码中硬编码令牌</li></ul></li><li><p><strong>性能优化</strong>：</p><ul><li>使用项目级配置而非全局配置</li><li>定期清理不必要的MCP服务器配置</li></ul></li><li><p><strong>维护</strong>：</p><ul><li>定期检查令牌有效性</li><li>更新MCP服务器版本</li></ul></li></ol><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过以上步骤，您已经在Windows环境下成功配置了GitHub MCP服务器，现在可以在Gemini CLI中直接操作GitHub仓库了。这个配置让您能够更高效地管理代码仓库，提升开发效率。</p><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ul><li><a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens">GitHub Fine-grained tokens文档</a></li><li><a href="https://modelcontextprotocol.io/">Model Context Protocol官网</a></li><li><a href="https://ai.google.dev/gemini-api/docs/cli">Gemini CLI文档</a></li></ul>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;Windows-环境下配置-GitHub-MCP-服务器完整指南&quot;&gt;&lt;a href=&quot;#Windows-环境下配置-GitHub-MCP-服务器完整指南&quot; class=&quot;headerlink&quot; title=&quot;Windows 环境下配置 GitHub MCP</summary>
        
      
    
    
    
    <category term="开发工具" scheme="https://vilaswang.github.io/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Antigravity 登录认证完整解决方案（非TUN方法）</title>
    <link href="https://vilaswang.github.io/posts/56a10ecb/"/>
    <id>https://vilaswang.github.io/posts/56a10ecb/</id>
    <published>2025-12-16T22:30:00.000Z</published>
    <updated>2025-12-27T07:18:11.627Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p><strong>系统架构</strong>：Windows 10&#x2F;11 + Clash Proxy + Proxifier + Microsoft Edge</p><p><strong>协议支持</strong>：SOCKS5 代理 + OAuth 2.0 认证</p><p><strong>适用场景</strong>：国内网络环境 + 第三方服务认证</p><p><strong>文档版本</strong>：v2.0.0</p><p><strong>最后更新</strong>：2025-12-17</p></blockquote><hr><h2 id="📋-目录"><a href="#📋-目录" class="headerlink" title="📋 目录"></a>📋 目录</h2><ul><li><a href="#-%E6%A6%82%E8%BF%B0">概述</a></li><li><a href="#-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">环境准备</a></li><li><a href="#-%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4">配置步骤</a></li><li><a href="#-%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">故障排除</a></li><li><a href="#-%E6%A0%B8%E5%BF%83%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95">核心验证测试</a></li></ul><hr><h2 id="📖-概述"><a href="#📖-概述" class="headerlink" title="📖 概述"></a>📖 概述</h2><h3 id="1-1-解决方案背景"><a href="#1-1-解决方案背景" class="headerlink" title="1.1 解决方案背景"></a>1.1 解决方案背景</h3><p>Antigravity 是一款基于云原生的开发平台，采用 OAuth 2.0 标准进行用户认证。由于国内网络环境的网络限制，直接访问 Google 认证服务存在技术壁垒，需要通过专业的代理架构实现认证链路的打通。</p><h3 id="1-2-核心要求"><a href="#1-2-核心要求" class="headerlink" title="1.2 核心要求"></a>1.2 核心要求</h3><ul><li><strong>Google 账号归属地必须为美国</strong> - Antigravity 认证的硬性要求</li><li><strong>代理节点必须为美国地区</strong> - 确保与账号归属地匹配</li><li><strong>企业网络环境兼容</strong> - 适应企业防火墙和网络安全策略</li></ul><h3 id="1-3-技术架构"><a href="#1-3-技术架构" class="headerlink" title="1.3 技术架构"></a>1.3 技术架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐</span><br><span class="line">│  Antigravity.exe │───▶│  Proxifier      │───▶│  Clash Proxy    │</span><br><span class="line">│  (OAuth Client) │    │  (Process Rule) │    │ (SOCKS5:7890)   │</span><br><span class="line">└─────────────────┘    └─────────────────┘    └─────────────────┘</span><br><span class="line">                                                    │</span><br><span class="line">                                               ┌─────────────┐</span><br><span class="line">                                               │  US Proxy    │</span><br><span class="line">                                               │  (Google API)│</span><br><span class="line">                                               └─────────────┘</span><br><span class="line">                                                    │</span><br><span class="line">                                               ┌─────────────┐</span><br><span class="line">                                               │ Google OAuth  │</span><br><span class="line">                                               │  (US Region)   │</span><br><span class="line">                                               └─────────────┘</span><br></pre></td></tr></table></figure><hr><h2 id="🔧-环境准备"><a href="#🔧-环境准备" class="headerlink" title="🔧 环境准备"></a>🔧 环境准备</h2><h3 id="2-1-Google-账号要求"><a href="#2-1-Google-账号要求" class="headerlink" title="2.1 Google 账号要求"></a>2.1 Google 账号要求</h3><table><thead><tr><th>要求项</th><th>状态</th><th>说明</th></tr></thead><tbody><tr><td><strong>账号归属地</strong></td><td>⚠️ <strong>必须为美国</strong></td><td>Antigravity 认证的硬性要求</td></tr><tr><td><strong>账号状态</strong></td><td>✅ 正常</td><td>无封禁、限制或安全警告</td></tr><tr><td><strong>双重认证</strong></td><td>✅ 推荐</td><td>建议开启 2FA 提高安全性</td></tr><tr><td><strong>浏览器登录</strong></td><td>✅ 已完成</td><td>Edge 浏览器已登录目标账号</td></tr></tbody></table><p><strong>⚠️ 重要提醒</strong>：</p><ul><li><strong>非美国账号会被直接拒绝认证</strong></li><li><strong>归属地不匹配会导致认证失败</strong></li><li><strong>频繁切换地区会被标记为异常</strong></li></ul><h3 id="2-2-代理服务要求"><a href="#2-2-代理服务要求" class="headerlink" title="2.2 代理服务要求"></a>2.2 代理服务要求</h3><table><thead><tr><th>要求项</th><th>规格</th><th>说明</th></tr></thead><tbody><tr><td><strong>地理位置</strong></td><td>⚠️ <strong>必须为美国本土</strong></td><td>确保与账号归属地匹配</td></tr><tr><td><strong>IP 类型</strong></td><td>✅ 住宅级 IP</td><td>避免数据中心 IP 被识别</td></tr><tr><td><strong>服务类型</strong></td><td>✅ 专业付费服务</td><td>免费节点通常不可靠</td></tr><tr><td><strong>协议支持</strong></td><td>✅ SOCKS5</td><td>与 Clash 兼容</td></tr></tbody></table><p><strong>推荐节点选择</strong>：</p><ol><li><strong>首选节点</strong>：洛杉矶、纽约、西雅图、芝加哥</li><li><strong>备选节点</strong>：旧金山、达拉斯、迈阿密</li><li><strong>避免使用</strong>：香港、日本、新加坡等亚洲节点</li></ol><h3 id="2-3-软件环境要求"><a href="#2-3-软件环境要求" class="headerlink" title="2.3 软件环境要求"></a>2.3 软件环境要求</h3><table><thead><tr><th>软件</th><th>版本要求</th><th>用途</th></tr></thead><tbody><tr><td><strong>Clash</strong></td><td>v1.18.0+</td><td>SOCKS5 代理服务</td></tr><tr><td><strong>Proxifier</strong></td><td>v4.0+</td><td>进程级代理管理</td></tr><tr><td><strong>Edge 浏览器</strong></td><td>v118.0+</td><td>OAuth 认证浏览器</td></tr><tr><td><strong>Antigravity</strong></td><td>Latest</td><td>目标应用程序</td></tr></tbody></table><hr><h2 id="⚙️-配置步骤"><a href="#⚙️-配置步骤" class="headerlink" title="⚙️ 配置步骤"></a>⚙️ 配置步骤</h2><h3 id="3-1-Clash-代理配置"><a href="#3-1-Clash-代理配置" class="headerlink" title="3.1 Clash 代理配置"></a>3.1 Clash 代理配置</h3><h4 id="3-1-1-节点选择"><a href="#3-1-1-节点选择" class="headerlink" title="3.1.1 节点选择"></a>3.1.1 节点选择</h4><p>确保 Clash 客户端连接到美国地区节点，避免使用香港、日本等亚洲节点。</p><h4 id="3-1-2-规则配置"><a href="#3-1-2-规则配置" class="headerlink" title="3.1.2 规则配置"></a>3.1.2 规则配置</h4><p>更新 Clash 配置文件，添加 Antigravity 相关规则：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Google Auth &amp; Antigravity 必须走代理</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;DOMAIN-SUFFIX,googleapis.com,🔰 节点选择&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;DOMAIN-SUFFIX,sandbox.googleapis.com,🔰 节点选择&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;DOMAIN,oauth2.googleapis.com,🔰 节点选择&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;DOMAIN,accounts.google.com,🔰 节点选择&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;DOMAIN,daily-cloudcode-pa.sandbox.googleapis.com,🔰 节点选择&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;PROCESS-NAME,Antigravity.exe,🔰 节点选择&#x27;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;PROCESS-NAME,language_server_windows_x64.exe,🔰 节点选择&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="3-2-Proxifier-配置"><a href="#3-2-Proxifier-配置" class="headerlink" title="3.2 Proxifier 配置"></a>3.2 Proxifier 配置</h3><h4 id="3-2-1-添加代理服务器"><a href="#3-2-1-添加代理服务器" class="headerlink" title="3.2.1 添加代理服务器"></a>3.2.1 添加代理服务器</h4><ol><li>打开 Proxifier → <code>Profile → Proxy Servers… → Add</code></li><li>配置参数：<ul><li><strong>Address</strong>: 127.0.0.1</li><li><strong>Port</strong>: 7890</li><li><strong>Protocol</strong>: SOCKS5</li><li><strong>Authentication</strong>: NO</li></ul></li><li>点击 <strong>Check</strong> 验证连接，确认显示 “Socks5 server is available”</li></ol><h4 id="3-2-2-创建代理规则"><a href="#3-2-2-创建代理规则" class="headerlink" title="3.2.2 创建代理规则"></a>3.2.2 创建代理规则</h4><p><strong>规则1：Edge 浏览器直连（最高优先级）</strong></p><ul><li><strong>Rule name</strong>: Edge Direct</li><li><strong>Applications</strong>: msedge.exe</li><li><strong>Action</strong>: Direct</li><li><strong>Priority</strong>: Highest</li></ul><p><strong>规则2：Clash 进程直连（避免代理循环）</strong></p><ul><li><strong>Rule name</strong>: Clash Processes Direct</li><li><strong>Applications</strong>: clash_*.exe</li><li><strong>Action</strong>: Direct</li><li><strong>Priority</strong>: High</li></ul><p><strong>规则3：Antigravity 应用走代理</strong></p><ul><li><strong>Rule name</strong>: Antigravity via Clash</li><li><strong>Applications</strong>: Antigravity.exe, language_server_windows_x64.exe</li><li><strong>Action</strong>: 127.0.0.1:7890</li><li><strong>Priority</strong>: Normal</li></ul><h4 id="3-2-3-规则优先级确认"><a href="#3-2-3-规则优先级确认" class="headerlink" title="3.2.3 规则优先级确认"></a>3.2.3 规则优先级确认</h4><p>确保规则按以下顺序排列：</p><ol><li><strong>Edge Direct</strong> (最高优先级)</li><li><strong>Clash Processes Direct</strong> (高优先级)</li><li><strong>Antigravity via Clash</strong> (普通优先级)</li></ol><h3 id="3-3-系统环境配置"><a href="#3-3-系统环境配置" class="headerlink" title="3.3 系统环境配置"></a>3.3 系统环境配置</h3><h4 id="3-3-1-清理环境变量"><a href="#3-3-1-清理环境变量" class="headerlink" title="3.3.1 清理环境变量"></a>3.3.1 清理环境变量</h4><p>必须清空以下系统环境变量：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Windows 命令行</span></span><br><span class="line"><span class="built_in">set</span> HTTP_PROXY=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">set</span> HTTPS_PROXY=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">set</span> NO_PROXY=<span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>或者在系统属性中永久删除这些变量。</p><h4 id="3-3-2-防火墙配置"><a href="#3-3-2-防火墙配置" class="headerlink" title="3.3.2 防火墙配置"></a>3.3.2 防火墙配置</h4><p>确保防火墙允许以下连接：</p><ul><li>Clash.exe (TCP:7890 入站)</li><li>Proxifier.exe (TCP 动态端口 出站)</li><li>msedge.exe (TCP&#x2F;UDP:80&#x2F;443 出站)</li><li>Antigravity.exe (TCP&#x2F;UDP 动态端口 出站)</li></ul><hr><h2 id="🔧-故障排除"><a href="#🔧-故障排除" class="headerlink" title="🔧 故障排除"></a>🔧 故障排除</h2><h3 id="4-1-认证流程问题"><a href="#4-1-认证流程问题" class="headerlink" title="4.1 认证流程问题"></a>4.1 认证流程问题</h3><p><strong>问题：Edge 浏览器无法打开 Google 登录页面</strong></p><table><thead><tr><th>症状</th><th>可能原因</th><th>解决方案</th></tr></thead><tbody><tr><td>Edge 无响应</td><td>Proxifier 规则冲突</td><td>检查规则顺序，Edge Direct 置顶</td></tr><tr><td>页面加载失败</td><td>环境变量污染</td><td>清空 HTTP_PROXY&#x2F;HTTPS_PROXY</td></tr><tr><td>连接超时</td><td>网络防火墙限制</td><td>检查防火墙配置</td></tr></tbody></table><p><strong>问题：Google 登录成功但无法跳转回 Antigravity</strong></p><table><thead><tr><th>检查点</th><th>验证方法</th><th>解决方案</th></tr></thead><tbody><tr><td>OAuth 流程</td><td>Clash Connections 日志</td><td>检查 Clash 规则配置</td></tr><tr><td>应用代理</td><td>Proxifier 实时日志</td><td>重新配置应用规则</td></tr><tr><td>代理循环</td><td>Proxifier 连接日志</td><td>添加 Clash 直连规则</td></tr></tbody></table><h3 id="4-2-网络连接问题"><a href="#4-2-网络连接问题" class="headerlink" title="4.2 网络连接问题"></a>4.2 网络连接问题</h3><p><strong>问题：代理节点连接不稳定</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基础连接测试</span></span><br><span class="line">curl --proxy socks5://127.0.0.1:7890 https://www.google.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># IP 地理位置检测</span></span><br><span class="line">curl --proxy socks5://127.0.0.1:7890 <span class="string">&quot;https://httpbin.org/ip&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接稳定性测试</span></span><br><span class="line">ping -n 10 8.8.8.8</span><br></pre></td></tr></table></figure><p><strong>节点质量标准</strong>：</p><table><thead><tr><th>指标</th><th>优秀</th><th>可接受</th><th>需更换</th></tr></thead><tbody><tr><td><strong>延迟</strong></td><td>&lt; 100ms</td><td>100-200ms</td><td>&gt; 200ms</td></tr><tr><td><strong>稳定性</strong></td><td>99.9%+</td><td>99%+</td><td>&lt; 99%</td></tr><tr><td><strong>成功率</strong></td><td>100%</td><td>99%+</td><td>&lt; 99%</td></tr></tbody></table><h3 id="4-3-账号相关问题"><a href="#4-3-账号相关问题" class="headerlink" title="4.3 账号相关问题"></a>4.3 账号相关问题</h3><p><strong>Google 账号安全检查清单</strong>：</p><ul><li><input disabled="" type="checkbox"> 登录地点是否为美国地区</li><li><input disabled="" type="checkbox"> 登录设备是否为已知设备</li><li><input disabled="" type="checkbox"> 是否启用了两步验证</li><li><input disabled="" type="checkbox"> 应用权限是否正确授权</li></ul><p>如果账号归属地检测失败，根本原因通常是：</p><ul><li><strong>账号创建地</strong>：非美国地区创建（困难解决）</li><li><strong>常用登录地</strong>：长期非美国登录（中等解决）</li><li><strong>登录行为</strong>：频繁切换地区（简单解决）</li></ul><hr><h2 id="🧪-核心验证测试"><a href="#🧪-核心验证测试" class="headerlink" title="🧪 核心验证测试"></a>🧪 核心验证测试</h2><h3 id="5-1-基础环境验证"><a href="#5-1-基础环境验证" class="headerlink" title="5.1 基础环境验证"></a>5.1 基础环境验证</h3><table><thead><tr><th>组件</th><th>检查命令</th><th>预期结果</th></tr></thead><tbody><tr><td><strong>Clash</strong></td><td>&#96;tasklist</td><td>findstr Clash&#96;</td></tr><tr><td><strong>端口监听</strong></td><td>&#96;netstat -an</td><td>findstr :7890&#96;</td></tr><tr><td><strong>代理连接</strong></td><td><code>curl -x socks5://127.0.0.1:7890 https://www.google.com</code></td><td>HTTP 200</td></tr><tr><td><strong>Proxifier</strong></td><td>任务管理器检查</td><td>进程运行</td></tr><tr><td><strong>环境变量</strong></td><td><code>echo %HTTP_PROXY%</code></td><td>空值</td></tr></tbody></table><h3 id="5-2-OAuth-认证测试"><a href="#5-2-OAuth-认证测试" class="headerlink" title="5.2 OAuth 认证测试"></a>5.2 OAuth 认证测试</h3><p><strong>完整认证流程测试步骤</strong>：</p><ol><li><p><strong>启动 Antigravity 客户端</strong></p><ul><li>确认程序正常启动</li><li>检查 Proxifier 日志显示代理连接</li></ul></li><li><p><strong>触发 Google 登录</strong></p><ul><li>点击 OAuth 登录按钮</li><li>确认 Edge 浏览器自动打开</li></ul></li><li><p><strong>浏览器验证</strong></p><ul><li>Edge 应直连打开 Google 登录页</li><li>地址栏 URL: <code>accounts.google.com</code></li><li>页面加载正常，无代理错误</li></ul></li><li><p><strong>账号认证</strong></p><ul><li>输入美国归属地 Google 账号凭据</li><li>完成两步验证（如已启用）</li><li>授权 Antigravity 应用访问权限</li></ul></li><li><p><strong>回跳验证</strong></p><ul><li>自动跳转回 Antigravity 应用</li><li>应用显示登录成功状态</li><li>Clash 日志显示 OAuth API 代理请求</li></ul></li></ol><h3 id="5-3-关键验证点"><a href="#5-3-关键验证点" class="headerlink" title="5.3 关键验证点"></a>5.3 关键验证点</h3><table><thead><tr><th>检查节点</th><th>验证方法</th><th>成功状态</th></tr></thead><tbody><tr><td><strong>Clash 状态</strong></td><td>控制面板</td><td>绿色连接</td></tr><tr><td><strong>端口监听</strong></td><td><code>netstat -an</code></td><td><code>:7890</code> 处于 LISTEN</td></tr><tr><td><strong>代理规则</strong></td><td>Proxifier 规则列表</td><td>Edge 规则置顶</td></tr><tr><td><strong>浏览器访问</strong></td><td>直接访问 Google</td><td>正常加载</td></tr><tr><td><strong>IP 检测</strong></td><td>在线 IP 检测</td><td>美国地址</td></tr><tr><td><strong>OAuth 请求</strong></td><td>Clash Connections</td><td>显示 <code>googleapis.com</code></td></tr></tbody></table><hr><h2 id="📋-核心检查清单"><a href="#📋-核心检查清单" class="headerlink" title="📋 核心检查清单"></a>📋 核心检查清单</h2><h3 id="6-1-部署前检查"><a href="#6-1-部署前检查" class="headerlink" title="6.1 部署前检查"></a>6.1 部署前检查</h3><p><strong>Google 账号验证</strong>：</p><ul><li><input disabled="" type="checkbox"> 账号归属地为美国地区</li><li><input disabled="" type="checkbox"> 账号状态正常，无安全警告</li><li><input disabled="" type="checkbox"> 已启用两步验证</li><li><input disabled="" type="checkbox"> 浏览器已登录目标账号</li></ul><p><strong>代理服务验证</strong>：</p><ul><li><input disabled="" type="checkbox"> 代理节点位于美国地区</li><li><input disabled="" type="checkbox"> 节点支持 Google 全套服务</li><li><input disabled="" type="checkbox"> 节点连接稳定性 &gt; 99%</li><li><input disabled="" type="checkbox"> IP 地址未被 Google 标记</li></ul><p><strong>软件环境验证</strong>：</p><ul><li><input disabled="" type="checkbox"> Clash v1.18.0+ 正常运行</li><li><input disabled="" type="checkbox"> Proxifier v4.0+ 已安装</li><li><input disabled="" type="checkbox"> Microsoft Edge v118.0+ 已安装</li><li><input disabled="" type="checkbox"> 系统环境变量已清空</li></ul><h3 id="6-2-功能验证"><a href="#6-2-功能验证" class="headerlink" title="6.2 功能验证"></a>6.2 功能验证</h3><p><strong>基础功能测试</strong>：</p><ul><li><input disabled="" type="checkbox"> Clash 控制面板显示连接正常</li><li><input disabled="" type="checkbox"> 端口 7890 处于监听状态</li><li><input disabled="" type="checkbox"> Google 服务访问正常</li><li><input disabled="" type="checkbox"> IP 地址显示为美国地区</li></ul><p><strong>OAuth 流程测试</strong>：</p><ul><li><input disabled="" type="checkbox"> Antigravity 启动正常</li><li><input disabled="" type="checkbox"> 点击登录按钮触发 Edge 打开</li><li><input disabled="" type="checkbox"> Edge 直连访问 Google 登录页</li><li><input disabled="" type="checkbox"> Google 账号登录成功</li><li><input disabled="" type="checkbox"> 自动跳转回 Antigravity 应用</li><li><input disabled="" type="checkbox"> 应用显示登录成功状态</li></ul><hr><h2 id="📝-总结"><a href="#📝-总结" class="headerlink" title="📝 总结"></a>📝 总结</h2><h3 id="7-1-关键成功因素"><a href="#7-1-关键成功因素" class="headerlink" title="7.1 关键成功因素"></a>7.1 关键成功因素</h3><p><strong>成功的两大前提</strong>：</p><ul><li><strong>Google 账号归属地必须为美国</strong>：这是 Antigravity 认证的硬性要求</li><li><strong>代理节点必须为美国地区且支持 Google 全套服务</strong>：确保认证流量的地理合规性</li></ul><p><strong>技术实施要点</strong>：</p><ul><li>Proxifier 规则优先级配置是关键，Edge 浏览器必须直连</li><li>Clash 规则需要精确匹配 Google OAuth 相关域名</li><li>系统环境变量必须清空，避免代理冲突</li><li>Clash 相关进程必须直连，避免代理循环</li></ul><h3 id="7-2-快速故障排除指南"><a href="#7-2-快速故障排除指南" class="headerlink" title="7.2 快速故障排除指南"></a>7.2 快速故障排除指南</h3><p><strong>认证失败的常见原因</strong>：</p><ol><li><strong>Google 账号归属地不是美国</strong> → 更换美国账号或重新注册</li><li><strong>代理节点不在美国地区</strong> → 切换到美国节点</li><li><strong>Edge 浏览器被代理</strong> → 检查 Proxifier 规则优先级</li><li><strong>系统环境变量冲突</strong> → 清空 HTTP_PROXY&#x2F;HTTPS_PROXY</li><li><strong>代理循环</strong> → 添加 clash_*.exe 直连规则</li></ol><p><strong>验证成功的标志</strong>：</p><ul><li>✅ Edge OAuth 页面成功打开（直连）</li><li>✅ 登录后成功回跳到 Antigravity</li><li>✅ Clash Connections 能看到 oauth2.googleapis.com 走代理</li></ul><p>通过遵循本文档的核心配置步骤和验证方法，可以建立一个稳定、可靠的 Antigravity 认证环境。</p>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;系统架构&lt;/strong&gt;：Windows 10&amp;#x2F;11 + Clash Proxy + Proxifier + Microsoft Edge&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;协议支持&lt;/strong&gt;：SOCKS5 代理</summary>
        
      
    
    
    
    <category term="开发工具" scheme="https://vilaswang.github.io/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    <category term="IDE编辑器" scheme="https://vilaswang.github.io/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/IDE%E7%BC%96%E8%BE%91%E5%99%A8/"/>
    
    
    <category term="Antigravity" scheme="https://vilaswang.github.io/tags/Antigravity/"/>
    
    <category term="代理配置" scheme="https://vilaswang.github.io/tags/%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE/"/>
    
    <category term="OAuth认证" scheme="https://vilaswang.github.io/tags/OAuth%E8%AE%A4%E8%AF%81/"/>
    
    <category term="Clash" scheme="https://vilaswang.github.io/tags/Clash/"/>
    
    <category term="Proxifier" scheme="https://vilaswang.github.io/tags/Proxifier/"/>
    
    <category term="网络配置" scheme="https://vilaswang.github.io/tags/%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/"/>
    
    <category term="企业环境" scheme="https://vilaswang.github.io/tags/%E4%BC%81%E4%B8%9A%E7%8E%AF%E5%A2%83/"/>
    
  </entry>
  
  <entry>
    <title>VSCode Qt MSVC 配置指南</title>
    <link href="https://vilaswang.github.io/posts/55a960b4/"/>
    <id>https://vilaswang.github.io/posts/55a960b4/</id>
    <published>2025-12-09T06:09:56.000Z</published>
    <updated>2025-12-17T15:36:29.275Z</updated>
    
    <content type="html"><![CDATA[<h1 id="VSCode-Qt-MSVC-配置指南"><a href="#VSCode-Qt-MSVC-配置指南" class="headerlink" title="VSCode Qt MSVC 配置指南"></a>VSCode Qt MSVC 配置指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>vscode</code>, <code>qt</code>, <code>msvc</code>, <code>cmake</code>, <code>windows</code>, <code>development</code>, <code>cpp</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">2. 环境准备</a></li><li><a href="#3-vs-code-%E9%85%8D%E7%BD%AE">3. VS Code 配置</a><ul><li><a href="#31-c-c-%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AE">3.1 C&#x2F;C++ 扩展配置</a></li><li><a href="#32-%E8%B0%83%E8%AF%95%E5%99%A8%E9%85%8D%E7%BD%AE">3.2 调试器配置</a></li><li><a href="#33-%E6%9E%84%E5%BB%BA%E4%BB%BB%E5%8A%A1%E9%85%8D%E7%BD%AE">3.3 构建任务配置</a></li><li><a href="#34-qt-%E5%8F%AF%E8%A7%86%E5%8C%96%E8%B0%83%E8%AF%95">3.4 Qt 可视化调试</a></li></ul></li><li><a href="#4-cmake-%E9%85%8D%E7%BD%AE">4. CMake 配置</a></li><li><a href="#5-%E7%8E%AF%E5%A2%83%E9%AA%8C%E8%AF%81">5. 环境验证</a></li><li><a href="#6-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3">6. 常见问题解决</a></li><li><a href="#7-%E5%AE%8C%E6%95%B4%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">7. 完整工作流程</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>本指南详细介绍如何在 Windows 系统上配置 VS Code 进行 Qt C++ 开发，使用 MSVC 编译器和 CMake 构建系统。</p><h3 id="🎯-配置目标"><a href="#🎯-配置目标" class="headerlink" title="🎯 配置目标"></a>🎯 配置目标</h3><ul><li>✅ 使用 MSVC 编译器进行 Qt 开发</li><li>✅ VS Code 完整的 IntelliSense 支持</li><li>✅ 集成的调试和构建功能</li><li>✅ 跨平台 CMake 构建系统</li></ul><h3 id="🏗️-系统架构"><a href="#🏗️-系统架构" class="headerlink" title="🏗️ 系统架构"></a>🏗️ 系统架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    A[VS Code IDE] --&gt; B[C/C++ Extension]</span><br><span class="line">    A --&gt; C[CMake Tools Extension]</span><br><span class="line">    A --&gt; D[Qt Extension]</span><br><span class="line"></span><br><span class="line">    B --&gt; E[IntelliSense Engine]</span><br><span class="line">    C --&gt; F[CMake Configuration]</span><br><span class="line">    D --&gt; G[Qt Tools Integration]</span><br><span class="line"></span><br><span class="line">    E --&gt; H[MSVC Compiler]</span><br><span class="line">    F --&gt; I[Build System]</span><br><span class="line">    G --&gt; J[Qt Libraries]</span><br><span class="line"></span><br><span class="line">    H --&gt; K[cl.exe]</span><br><span class="line">    I --&gt; L[cmake.exe]</span><br><span class="line">    J --&gt; M[Qt5/Qt6]</span><br></pre></td></tr></table></figure><hr><h2 id="2-🔧-环境准备"><a href="#2-🔧-环境准备" class="headerlink" title="2. 🔧 环境准备"></a>2. 🔧 环境准备</h2><h3 id="2-1-必需组件"><a href="#2-1-必需组件" class="headerlink" title="2.1 必需组件"></a>2.1 必需组件</h3><table><thead><tr><th>组件</th><th>版本要求</th><th>下载地址</th></tr></thead><tbody><tr><td><strong>Visual Studio Build Tools</strong></td><td>2019&#x2F;2022</td><td><a href="https://visualstudio.microsoft.com/downloads/">Microsoft官网</a></td></tr><tr><td><strong>Qt</strong></td><td>5.6.3+ &#x2F; 6.x</td><td><a href="https://www.qt.io/download">Qt官网</a></td></tr><tr><td><strong>CMake</strong></td><td>3.15+</td><td><a href="https://cmake.org/download/">CMake官网</a></td></tr><tr><td><strong>VS Code</strong></td><td>最新版</td><td><a href="https://code.visualstudio.com/">VS Code官网</a></td></tr></tbody></table><h3 id="2-2-VS-Code-扩展安装"><a href="#2-2-VS-Code-扩展安装" class="headerlink" title="2.2 VS Code 扩展安装"></a>2.2 VS Code 扩展安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line">code --install-extension ms-vscode.cpptools</span><br><span class="line">code --install-extension ms-vscode.cmake-tools</span><br><span class="line">code --install-extension ms-vscode.cpptools-extension-pack</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line">code --install-extension twxs.cmake</span><br><span class="line">code --install-extension ms-vscode.hexeditor</span><br></pre></td></tr></table></figure><hr><h2 id="3-⚙️-VS-Code-配置"><a href="#3-⚙️-VS-Code-配置" class="headerlink" title="3. ⚙️ VS Code 配置"></a>3. ⚙️ VS Code 配置</h2><h3 id="3-1-🧠-C-C-扩展配置"><a href="#3-1-🧠-C-C-扩展配置" class="headerlink" title="3.1 🧠 C&#x2F;C++ 扩展配置"></a>3.1 🧠 C&#x2F;C++ 扩展配置</h3><p>创建 <code>.vscode/c_cpp_properties.json</code>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Win32-MSVC&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;includePath&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/**&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">// MSVC 标准库路径</span></span><br><span class="line">                <span class="string">&quot;$&#123;env.VCToolsInstallDir&#125;include&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">// Windows SDK 路径</span></span><br><span class="line">                <span class="string">&quot;$&#123;env.WindowsSdkDir&#125;Include/$&#123;env.WindowsSDKVersion&#125;/**&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">// Qt 包含路径（修改为你的实际路径）</span></span><br><span class="line">                <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/include/**&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/include/QtCore&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/include/QtWidgets&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/include/QtGui&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">// 添加其他需要的 Qt 模块</span></span><br><span class="line">                <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/include/QtNetwork&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;defines&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;_DEBUG&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;UNICODE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;_UNICODE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="comment">// Qt 相关定义</span></span><br><span class="line">                <span class="string">&quot;QT_CORE_LIB&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;QT_WIDGETS_LIB&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;QT_GUI_LIB&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;QT_NETWORK_LIB&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;_WIN32_WINNT=0x0601&quot;</span>  <span class="comment">// Windows 7+</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compilerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C:/Program Files (x86)/Microsoft Visual Studio/2019/BuildTools/VC/Tools/MSVC/14.29.30133/bin/Hostx64/x64/cl.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cppStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c++17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;intelliSenseMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;windows-msvc-x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;windowsSdkVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;10.0.19041.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compileCommands&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/build/compile_commands.json&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>⚙️ 关键配置说明</strong>：</p><table><thead><tr><th>配置项</th><th>说明</th><th>示例值</th></tr></thead><tbody><tr><td><strong>compilerPath</strong></td><td>MSVC 编译器路径</td><td><code>cl.exe</code> 完整路径</td></tr><tr><td><strong>intelliSenseMode</strong></td><td>IntelliSense 引擎</td><td><code>windows-msvc-x64</code></td></tr><tr><td><strong>includePath</strong></td><td>头文件搜索路径</td><td>Qt 和 MSVC 包含目录</td></tr><tr><td><strong>defines</strong></td><td>预处理器宏定义</td><td>Qt 模块和 Windows 宏</td></tr></tbody></table><h3 id="3-2-🐛-调试器配置"><a href="#3-2-🐛-调试器配置" class="headerlink" title="3.2 🐛 调试器配置"></a>3.2 🐛 调试器配置</h3><p>创建 <code>.vscode/launch.json</code>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Debug Qt App (MSVC)&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppvsdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/build/Debug/MyQtApp.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PATH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;env:Path&#125;;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/bin;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/plugins/platforms&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;QT_DEBUG_PLUGINS&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;externalTerminal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;visualizerFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/.vscode/qt.natvis&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;preLaunchTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake: build debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;postDebugTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake: clean&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Release Qt App (MSVC)&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppvsdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;/build/Release/MyQtApp.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PATH&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;env:Path&#125;;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/bin&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;console&quot;</span><span class="punctuation">:</span> <span class="string">&quot;externalTerminal&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;preLaunchTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake: build release&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>🔍 调试配置要点</strong>：</p><ul><li><strong>调试器类型</strong>: 使用 <code>cppvsdbg</code> (MSVC 原生调试器)</li><li><strong>环境变量</strong>: 确保 Qt DLL 和插件路径在 PATH 中</li><li><strong>程序路径</strong>: Debug 和 Release 版本的正确路径</li><li><strong>调试插件</strong>: <code>QT_DEBUG_PLUGINS=1</code> 用于调试 Qt 插件问题</li></ul><h3 id="3-3-🔨-构建任务配置"><a href="#3-3-🔨-构建任务配置" class="headerlink" title="3.3 🔨 构建任务配置"></a>3.3 🔨 构建任务配置</h3><p>创建 <code>.vscode/tasks.json</code>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake: configure&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;-B&quot;</span><span class="punctuation">,</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-G&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Visual Studio 16 2019&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-A&quot;</span><span class="punctuation">,</span> <span class="string">&quot;x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-DCMAKE_BUILD_TYPE=Debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-DCMAKE_PREFIX_PATH=C:/Qt/Qt5.6.3/5.6.3/msvc2015_64&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span> <span class="string">&quot;配置 CMake 项目&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake: build debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;--build&quot;</span><span class="punctuation">,</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--config&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--parallel&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;isDefault&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;$msCompile&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span> <span class="string">&quot;构建 Debug 版本&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;cmake: configure&quot;</span><span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake: build release&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;--build&quot;</span><span class="punctuation">,</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--config&quot;</span><span class="punctuation">,</span> <span class="string">&quot;Release&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--parallel&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;$msCompile&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span> <span class="string">&quot;构建 Release 版本&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake: clean&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;--build&quot;</span><span class="punctuation">,</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;--target&quot;</span><span class="punctuation">,</span> <span class="string">&quot;clean&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span> <span class="string">&quot;清理构建文件&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cmake: install qt dlls&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;powershell&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;-Command&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;Copy-Item &#x27;C:\\Qt\\Qt5.6.3\\5.6.3\\msvc2015_64\\bin\\*.dll&#x27; &#x27;build\\Debug\\&#x27; -Force; Copy-Item &#x27;C:\\Qt\\Qt5.6.3\\5.6.3\\msvc2015_64\\plugins\\platforms\\qwindows.dll&#x27; &#x27;build\\Debug\\platforms\\&#x27; -Force&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;detail&quot;</span><span class="punctuation">:</span> <span class="string">&quot;复制 Qt 运行时 DLL&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="3-4-🎨-Qt-可视化调试"><a href="#3-4-🎨-Qt-可视化调试" class="headerlink" title="3.4 🎨 Qt 可视化调试"></a>3.4 🎨 Qt 可视化调试</h3><p>创建 <code>.vscode/qt.natvis</code> 文件用于 Qt 类型可视化：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">AutoVisualizer</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/vstudio/debugger/natvis/2010&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Type</span> <span class="attr">Name</span>=<span class="string">&quot;QString&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DisplayString</span>&gt;</span>&#123;&#123; &#123;reinterpret_cast<span class="tag">&lt;<span class="name">const</span> <span class="attr">wchar_t</span>*&gt;</span>(d-&gt;data()), d-&gt;size&#125; &#125;&#125;<span class="tag">&lt;/<span class="name">DisplayString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">StringView</span>&gt;</span>d-&gt;data(),d-&gt;size,utf-16<span class="tag">&lt;/<span class="name">StringView</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Expand</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Item</span> <span class="attr">Name</span>=<span class="string">&quot;[size]&quot;</span>&gt;</span>d-&gt;size<span class="tag">&lt;/<span class="name">Item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Item</span> <span class="attr">Name</span>=<span class="string">&quot;[raw]&quot;</span>&gt;</span>d-&gt;data(),d-&gt;size<span class="tag">&lt;/<span class="name">Item</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Expand</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Type</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Type</span> <span class="attr">Name</span>=<span class="string">&quot;QByteArray&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DisplayString</span>&gt;</span>&#123;&#123; &#123;d-&gt;data(),d-&gt;size&#125; &#125;&#125;<span class="tag">&lt;/<span class="name">DisplayString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">StringView</span>&gt;</span>d-&gt;data(),d-&gt;size<span class="tag">&lt;/<span class="name">StringView</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Expand</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Item</span> <span class="attr">Name</span>=<span class="string">&quot;[size]&quot;</span>&gt;</span>d-&gt;size<span class="tag">&lt;/<span class="name">Item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ArrayItems</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Size</span>&gt;</span>d-&gt;size<span class="tag">&lt;/<span class="name">Size</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ValuePointer</span>&gt;</span>d-&gt;data()<span class="tag">&lt;/<span class="name">ValuePointer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ArrayItems</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Expand</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Type</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Type</span> <span class="attr">Name</span>=<span class="string">&quot;QList<span class="symbol">&amp;lt;</span>*<span class="symbol">&amp;gt;</span>&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">DisplayString</span>&gt;</span>&#123;&#123; size=&#123;d-&gt;size&#125; &#125;&#125;<span class="tag">&lt;/<span class="name">DisplayString</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Expand</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Item</span> <span class="attr">Name</span>=<span class="string">&quot;[size]&quot;</span>&gt;</span>d-&gt;size<span class="tag">&lt;/<span class="name">Item</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ArrayItems</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Size</span>&gt;</span>d-&gt;size<span class="tag">&lt;/<span class="name">Size</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ValuePointer</span>&gt;</span>e<span class="tag">&lt;/<span class="name">ValuePointer</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">ArrayItems</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Expand</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Type</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">AutoVisualizer</span>&gt;</span></span><br></pre></td></tr></table></figure><hr><h2 id="4-📦-CMake-配置"><a href="#4-📦-CMake-配置" class="headerlink" title="4. 📦 CMake 配置"></a>4. 📦 CMake 配置</h2><h3 id="4-1-📄-CMakeLists-txt"><a href="#4-1-📄-CMakeLists-txt" class="headerlink" title="4.1 📄 CMakeLists.txt"></a>4.1 📄 CMakeLists.txt</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.15</span>)</span><br><span class="line"><span class="keyword">project</span>(MyQtApp LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">17</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">ON</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">if</span>(MSVC)</span><br><span class="line">    <span class="comment"># 设置运行时库</span></span><br><span class="line">    <span class="keyword">set</span>(CMAKE_MSVC_RUNTIME_LIBRARY <span class="string">&quot;MultiThreaded$&lt;$&lt;CONFIG:Debug&gt;:Debug&gt;DLL&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 启用并行编译</span></span><br><span class="line">    <span class="keyword">add_compile_options</span>(/MP)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 警告设置</span></span><br><span class="line">    <span class="keyword">add_compile_options</span>(/W3)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 禁用一些 MSVC 警告</span></span><br><span class="line">    <span class="keyword">add_compile_definitions</span>(_CRT_SECURE_NO_WARNINGS)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_PREFIX_PATH <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64&quot;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_AUTOMOC <span class="keyword">ON</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_AUTOUIC <span class="keyword">ON</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_AUTORCC <span class="keyword">ON</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">find_package</span>(Qt5 COMPONENTS Core Widgets Gui Network REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE SOURCES</span><br><span class="line">    <span class="string">&quot;src/*.cpp&quot;</span></span><br><span class="line">    <span class="string">&quot;src/*.h&quot;</span></span><br><span class="line">    <span class="string">&quot;src/*.ui&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">add_executable</span>(MyQtApp <span class="variable">$&#123;SOURCES&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(MyQtApp</span><br><span class="line">    Qt5::Core</span><br><span class="line">    Qt5::Widgets</span><br><span class="line">    Qt5::Gui</span><br><span class="line">    Qt5::Network</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">set_target_properties</span>(MyQtApp PROPERTIES</span><br><span class="line">    RUNTIME_OUTPUT_DIRECTORY_DEBUG <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/Debug</span><br><span class="line">    RUNTIME_OUTPUT_DIRECTORY_RELEASE <span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/Release</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">if</span>(WIN32)</span><br><span class="line">    <span class="comment"># 设置 Windows 子系统</span></span><br><span class="line">    <span class="keyword">set_target_properties</span>(MyQtApp PROPERTIES</span><br><span class="line">        WIN32_EXECUTABLE <span class="keyword">TRUE</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 复制 Qt DLL 到输出目录</span></span><br><span class="line">    <span class="keyword">add_custom_command</span>(<span class="keyword">TARGET</span> MyQtApp POST_BUILD</span><br><span class="line">        <span class="keyword">COMMAND</span> <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E copy_directory</span><br><span class="line">        <span class="string">&quot;$&#123;CMAKE_PREFIX_PATH&#125;/bin&quot;</span></span><br><span class="line">        $&lt;TARGET_FILE_DIR:MyQtApp&gt;</span><br><span class="line">        COMMENT <span class="string">&quot;Copying Qt DLLs to output directory&quot;</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure><h3 id="4-2-🔧-CMakePresets-json-可选"><a href="#4-2-🔧-CMakePresets-json-可选" class="headerlink" title="4.2 🔧 CMakePresets.json (可选)"></a>4.2 🔧 CMakePresets.json (可选)</h3><p>创建 <code>CMakePresets.json</code> 简化配置：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cmakeMinimumRequired&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;major&quot;</span><span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minor&quot;</span><span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;patch&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;configurePresets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;windows-msvc-debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;generator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Visual Studio 16 2019&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;toolset&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host=x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;binaryDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;sourceDir&#125;/build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cacheVariables&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;CMAKE_BUILD_TYPE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CMAKE_PREFIX_PATH&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CMAKE_MSVC_RUNTIME_LIBRARY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MultiThreadedDebugDLL&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;windows-msvc-release&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;generator&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Visual Studio 16 2019&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;toolset&quot;</span><span class="punctuation">:</span> <span class="string">&quot;host=x64&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;binaryDir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;sourceDir&#125;/build&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cacheVariables&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;CMAKE_BUILD_TYPE&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Release&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CMAKE_PREFIX_PATH&quot;</span><span class="punctuation">:</span> <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;CMAKE_MSVC_RUNTIME_LIBRARY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;MultiThreadedDLL&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;buildPresets&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;configurePreset&quot;</span><span class="punctuation">:</span> <span class="string">&quot;windows-msvc-debug&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;configuration&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Debug&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;release&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;configurePreset&quot;</span><span class="punctuation">:</span> <span class="string">&quot;windows-msvc-release&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;configuration&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Release&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><hr><h2 id="5-✅-环境验证"><a href="#5-✅-环境验证" class="headerlink" title="5. ✅ 环境验证"></a>5. ✅ 环境验证</h2><h3 id="5-1-🔍-命令行验证"><a href="#5-1-🔍-命令行验证" class="headerlink" title="5.1 🔍 命令行验证"></a>5.1 🔍 命令行验证</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line">cl.exe /?</span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line">qmake <span class="literal">-query</span></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line">cmake <span class="literal">-G</span></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$env:VCToolsInstallDir</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$env:WindowsSdkDir</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$env:WindowsSDKVersion</span></span><br></pre></td></tr></table></figure><h3 id="5-2-🧪-测试项目创建"><a href="#5-2-🧪-测试项目创建" class="headerlink" title="5.2 🧪 测试项目创建"></a>5.2 🧪 测试项目创建</h3><p>创建测试源文件 <code>src/main.cpp</code>：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QMainWindow&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QLabel&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QVBoxLayout&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QPushButton&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QMessageBox&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MainWindow</span> : <span class="keyword">public</span> QMainWindow &#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MainWindow</span>(QWidget *parent = <span class="literal">nullptr</span>) : <span class="built_in">QMainWindow</span>(parent) &#123;</span><br><span class="line">        <span class="built_in">setWindowTitle</span>(<span class="string">&quot;Qt MSVC Test App&quot;</span>);</span><br><span class="line">        <span class="built_in">resize</span>(<span class="number">400</span>, <span class="number">300</span>);</span><br><span class="line"></span><br><span class="line">        QWidget *centralWidget = <span class="keyword">new</span> <span class="built_in">QWidget</span>(<span class="keyword">this</span>);</span><br><span class="line">        <span class="built_in">setCentralWidget</span>(centralWidget);</span><br><span class="line"></span><br><span class="line">        QVBoxLayout *layout = <span class="keyword">new</span> <span class="built_in">QVBoxLayout</span>(centralWidget);</span><br><span class="line"></span><br><span class="line">        QLabel *label = <span class="keyword">new</span> <span class="built_in">QLabel</span>(<span class="string">&quot;Hello Qt with MSVC!&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        label-&gt;<span class="built_in">setAlignment</span>(Qt::AlignCenter);</span><br><span class="line">        label-&gt;<span class="built_in">setStyleSheet</span>(<span class="string">&quot;font-size: 18px; font-weight: bold;&quot;</span>);</span><br><span class="line">        layout-&gt;<span class="built_in">addWidget</span>(label);</span><br><span class="line"></span><br><span class="line">        QPushButton *button = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;Test Message&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        <span class="built_in">connect</span>(button, &amp;QPushButton::clicked, <span class="keyword">this</span>, &amp;MainWindow::showTestMessage);</span><br><span class="line">        layout-&gt;<span class="built_in">addWidget</span>(button);</span><br><span class="line"></span><br><span class="line">        QPushButton *debugButton = <span class="keyword">new</span> <span class="built_in">QPushButton</span>(<span class="string">&quot;Print Debug Info&quot;</span>, <span class="keyword">this</span>);</span><br><span class="line">        <span class="built_in">connect</span>(debugButton, &amp;QPushButton::clicked, <span class="keyword">this</span>, &amp;MainWindow::printDebugInfo);</span><br><span class="line">        layout-&gt;<span class="built_in">addWidget</span>(debugButton);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">showTestMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        QMessageBox::<span class="built_in">information</span>(<span class="keyword">this</span>, <span class="string">&quot;Test&quot;</span>, <span class="string">&quot;MSVC + Qt 配置成功！&quot;</span>);</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Message box shown successfully&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">printDebugInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;=== Qt Configuration Info ===&quot;</span>;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Qt Version:&quot;</span> &lt;&lt; QT_VERSION_STR;</span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Compiler:&quot;</span> &lt;&lt;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _MSC_VER</span></span><br><span class="line">            <span class="string">&quot;MSVC &quot;</span> &lt;&lt; _MSC_VER;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="string">&quot;Unknown&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Build Type:&quot;</span> &lt;&lt;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _DEBUG</span></span><br><span class="line">            <span class="string">&quot;Debug&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">            <span class="string">&quot;Release&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;===============================&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Starting Qt application...&quot;</span>;</span><br><span class="line">    <span class="built_in">qDebug</span>() &lt;&lt; <span class="string">&quot;Qt version:&quot;</span> &lt;&lt; QT_VERSION_STR;</span><br><span class="line"></span><br><span class="line">    MainWindow window;</span><br><span class="line">    window.<span class="built_in">show</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app.<span class="built_in">exec</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;main.moc&quot;</span></span></span><br></pre></td></tr></table></figure><hr><h2 id="6-🔧-常见问题解决"><a href="#6-🔧-常见问题解决" class="headerlink" title="6. 🔧 常见问题解决"></a>6. 🔧 常见问题解决</h2><h3 id="6-1-❌-CMake-找不到-Qt"><a href="#6-1-❌-CMake-找不到-Qt" class="headerlink" title="6.1 ❌ CMake 找不到 Qt"></a>6.1 ❌ CMake 找不到 Qt</h3><p><strong>错误信息</strong>: <code>Could NOT find Qt5</code></p><p><strong>解决方案</strong>：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_PREFIX_PATH <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">set</span>(ENV&#123;QTDIR&#125; <span class="string">&quot;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="6-2-❌-缺少运行时库"><a href="#6-2-❌-缺少运行时库" class="headerlink" title="6.2 ❌ 缺少运行时库"></a>6.2 ❌ 缺少运行时库</h3><p><strong>错误信息</strong>: <code>无法启动此程序，因为计算机中缺少 VCRUNTIME140.dll</code></p><p><strong>解决方案</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[缺少 VCRUNTIME140.dll] --&gt; B&#123;解决方案&#125;</span><br><span class="line">    B --&gt; C[安装 Visual C++ Redistributable]</span><br><span class="line">    B --&gt; D[静态链接运行时库]</span><br><span class="line">    B --&gt; E[复制 DLL 到输出目录]</span><br><span class="line"></span><br><span class="line">    C --&gt; F[下载安装 vc_redist.x64.exe]</span><br><span class="line">    D --&gt; G[设置 CMAKE_MSVC_RUNTIME_LIBRARY]</span><br><span class="line">    E --&gt; H[手动复制系统 DLL]</span><br></pre></td></tr></table></figure><p><strong>CMake 配置</strong>：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># VSCode Qt MSVC 配置指南</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_MSVC_RUNTIME_LIBRARY <span class="string">&quot;MultiThreaded$&lt;$&lt;CONFIG:Debug&gt;:Debug&gt;&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="6-3-❌-Qt-插件加载失败"><a href="#6-3-❌-Qt-插件加载失败" class="headerlink" title="6.3 ❌ Qt 插件加载失败"></a>6.3 ❌ Qt 插件加载失败</h3><p><strong>错误信息</strong>: <code>This application failed to start because it could not find or load the Qt platform plugin &quot;windows&quot;</code></p><p><strong>解决方案</strong>：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在 launch.json 中添加环境变量</span></span><br><span class="line"><span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;PATH&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;env:Path&#125;;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/bin;C:/Qt/Qt5.6.3/5.6.3/msvc2015_64/plugins/platforms&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><h3 id="6-4-❌-IntelliSense-不工作"><a href="#6-4-❌-IntelliSense-不工作" class="headerlink" title="6.4 ❌ IntelliSense 不工作"></a>6.4 ❌ IntelliSense 不工作</h3><p><strong>症状</strong>: Qt 头文件显示红色下划线，代码补全不工作</p><p><strong>解决方案</strong>：</p><ol><li>检查 <code>c_cpp_properties.json</code> 中的路径是否正确</li><li>确保 Qt 版本与编译器版本匹配 (MSVC vs MinGW)</li><li>重新加载 VS Code 窗口 (<code>Ctrl+Shift+P</code> → <code>Developer: Reload Window</code>)</li></ol><h3 id="6-5-❌-调试时无法查看-Qt-对象"><a href="#6-5-❌-调试时无法查看-Qt-对象" class="headerlink" title="6.5 ❌ 调试时无法查看 Qt 对象"></a>6.5 ❌ 调试时无法查看 Qt 对象</h3><p><strong>解决方案</strong>：</p><ol><li>安装 <a href="https://marketplace.visualstudio.com/items?itemName=TheQtCompany.QtVisualStudioTools2019">Qt Visual Studio Tools</a></li><li>使用自定义的 <code>qt.natvis</code> 文件</li><li>在调试时查看 <code>this</code> 指针和成员变量</li></ol><hr><h2 id="7-🚀-完整工作流程"><a href="#7-🚀-完整工作流程" class="headerlink" title="7. 🚀 完整工作流程"></a>7. 🚀 完整工作流程</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[打开项目文件夹] --&gt; B[VS Code 自动检测 CMake]</span><br><span class="line">    B --&gt; C[选择配置预设]</span><br><span class="line">    C --&gt; D[CMake 配置项目]</span><br><span class="line">    D --&gt; E[IntelliSense 初始化完成]</span><br><span class="line">    E --&gt; F[编写代码]</span><br><span class="line">    F --&gt; G&#123;构建项目&#125;</span><br><span class="line">    G --&gt; H[Ctrl+Shift+B]</span><br><span class="line">    H --&gt; I[编译成功]</span><br><span class="line">    I --&gt; J&#123;调试运行&#125;</span><br><span class="line">    J --&gt; K[F5 启动调试]</span><br><span class="line">    K --&gt; L[应用运行]</span><br><span class="line">    L --&gt; M[调试和测试]</span><br><span class="line">    M --&gt; N&#123;修改代码?&#125;</span><br><span class="line">    N --&gt;|是| F</span><br><span class="line">    N --&gt;|否| O[完成开发]</span><br></pre></td></tr></table></figure><h3 id="7-1-📝-日常开发步骤"><a href="#7-1-📝-日常开发步骤" class="headerlink" title="7.1 📝 日常开发步骤"></a>7.1 📝 日常开发步骤</h3><ol><li><strong>打开项目</strong>：VS Code 打开项目文件夹</li><li><strong>配置 CMake</strong>：<code>Ctrl+Shift+P</code> → <code>CMake: Configure</code></li><li><strong>选择预设</strong>：底部状态栏选择 <code>windows-msvc-debug</code> 或 <code>windows-msvc-release</code></li><li><strong>智能提示</strong>：等待 IntelliSense 完成初始化</li><li><strong>编写代码</strong>：享受完整的代码补全和语法高亮</li><li><strong>构建项目</strong>：<code>Ctrl+Shift+B</code> 或点击底部状态栏的构建按钮</li><li><strong>运行调试</strong>：<code>F5</code> 启动调试会话</li></ol><h3 id="7-2-🎯-推荐快捷键"><a href="#7-2-🎯-推荐快捷键" class="headerlink" title="7.2 🎯 推荐快捷键"></a>7.2 🎯 推荐快捷键</h3><table><thead><tr><th>快捷键</th><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><code>Ctrl+Shift+B</code></td><td>构建项目</td><td>执行默认构建任务</td></tr><tr><td><code>F5</code></td><td>启动调试</td><td>运行当前配置的调试会话</td></tr><tr><td><code>Ctrl+Shift+P</code></td><td>命令面板</td><td>访问所有 VS Code 命令</td></tr><tr><td><code>Ctrl+,</code></td><td>设置</td><td>打开 VS Code 设置</td></tr><tr><td><code>Ctrl+K Ctrl+S</code></td><td>快捷键设置</td><td>自定义快捷键</td></tr></tbody></table><hr><h2 id="📊-总结"><a href="#📊-总结" class="headerlink" title="📊 总结"></a>📊 总结</h2><h3 id="✅-配置完成检查清单"><a href="#✅-配置完成检查清单" class="headerlink" title="✅ 配置完成检查清单"></a>✅ 配置完成检查清单</h3><ul><li><input checked="" disabled="" type="checkbox"> Visual Studio Build Tools 安装完成</li><li><input checked="" disabled="" type="checkbox"> Qt MSVC 版本安装完成</li><li><input checked="" disabled="" type="checkbox"> VS Code 必需扩展安装</li><li><input checked="" disabled="" type="checkbox"> C&#x2F;C++ 配置文件正确设置</li><li><input checked="" disabled="" type="checkbox"> CMake 配置文件正确设置</li><li><input checked="" disabled="" type="checkbox"> 调试器配置正确</li><li><input checked="" disabled="" type="checkbox"> 测试项目编译运行成功</li><li><input checked="" disabled="" type="checkbox"> 调试功能正常工作</li><li><input checked="" disabled="" type="checkbox"> IntelliSense 完整支持</li></ul><h3 id="🎯-下一步建议"><a href="#🎯-下一步建议" class="headerlink" title="🎯 下一步建议"></a>🎯 下一步建议</h3><ol><li><strong>学习 Qt 框架</strong>：掌握信号槽、UI 设计、多线程等</li><li><strong>CMake 进阶</strong>：学习自定义构建规则、交叉编译</li><li><strong>调试技巧</strong>：掌握断点、内存查看、性能分析</li><li><strong>版本控制</strong>：集成 Git 进行代码管理</li><li><strong>单元测试</strong>：集成 Qt Test 或 Google Test</li></ol><h3 id="📚-推荐资源"><a href="#📚-推荐资源" class="headerlink" title="📚 推荐资源"></a>📚 推荐资源</h3><ul><li><a href="https://doc.qt.io/">Qt 官方文档</a></li><li><a href="https://cmake.org/documentation/">CMake 官方文档</a></li><li><a href="https://code.visualstudio.com/docs/cpp/">VS Code C++ 扩展文档</a></li><li><a href="https://docs.microsoft.com/en-us/cpp/">Microsoft C++ 文档</a></li></ul><hr><blockquote><p><strong>💡 提示</strong>:</p><ul><li>首次配置可能需要一些时间，耐心按照步骤操作</li><li>遇到问题时，首先检查路径和环境变量是否正确</li><li>建议使用相对路径和 CMake 变量提高项目可移植性</li><li>定期更新 VS Code 扩展以获得最新功能</li></ul></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;VSCode-Qt-MSVC-配置指南&quot;&gt;&lt;a href=&quot;#VSCode-Qt-MSVC-配置指南&quot; class=&quot;headerlink&quot; title=&quot;VSCode Qt MSVC 配置指南&quot;&gt;&lt;/a&gt;VSCode Qt MSVC</summary>
        
      
    
    
    
    <category term="开发工具" scheme="https://vilaswang.github.io/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Web 认证方法指南</title>
    <link href="https://vilaswang.github.io/posts/f2ed900f/"/>
    <id>https://vilaswang.github.io/posts/f2ed900f/</id>
    <published>2025-12-09T06:09:56.000Z</published>
    <updated>2025-12-18T15:49:56.210Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Web-认证方法指南"><a href="#Web-认证方法指南" class="headerlink" title="Web 认证方法指南"></a>Web 认证方法指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>web</code>, <code>authentication</code>, <code>authorization</code>, <code>security</code>, <code>session</code>, <code>jwt</code>, <code>oauth</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">1. 核心概念</a><ul><li><a href="#11-%E8%AE%A4%E8%AF%81-vs-%E6%8E%88%E6%9D%83">1.1 认证 vs. 授权</a></li></ul></li><li><a href="#2-session-cookie-%E8%AE%A4%E8%AF%81">2. Session-Cookie 认证</a><ul><li><a href="#21-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">2.1 工作原理</a></li><li><a href="#22-%E5%AE%9E%E7%8E%B0%E7%A4%BA%E4%BE%8B">2.2 实现示例</a></li><li><a href="#23-%E4%BC%98%E7%BC%BA%E7%82%B9">2.3 优缺点</a></li></ul></li><li><a href="#3-token-%E8%AE%A4%E8%AF%81jwt">3. Token 认证（JWT）</a><ul><li><a href="#31-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">3.1 工作原理</a></li><li><a href="#32-%E5%AE%9E%E7%8E%B0%E7%A4%BA%E4%BE%8B">3.2 实现示例</a></li><li><a href="#33-%E4%BC%98%E7%BC%BA%E7%82%B9">3.3 优缺点</a></li></ul></li><li><a href="#4-oauth-%E8%AE%A4%E8%AF%81">4. OAuth 认证</a><ul><li><a href="#41-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B">4.1 认证流程</a></li><li><a href="#42-%E5%AE%9E%E7%8E%B0%E7%A4%BA%E4%BE%8B">4.2 实现示例</a></li></ul></li><li><a href="#5-%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94%E4%B8%8E%E9%80%89%E6%8B%A9">5. 方案对比与选择</a><ul><li><a href="#51-%E5%AF%B9%E6%AF%94%E8%A1%A8">5.1 对比表</a></li><li><a href="#52-%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">5.2 使用场景</a></li></ul></li></ul><hr><h2 id="1-核心概念"><a href="#1-核心概念" class="headerlink" title="1. 核心概念"></a>1. 核心概念</h2><h3 id="1-1-🔍-认证-vs-授权"><a href="#1-1-🔍-认证-vs-授权" class="headerlink" title="1.1 🔍 认证 vs. 授权"></a>1.1 🔍 认证 vs. 授权</h3><table><thead><tr><th>概念</th><th>问题</th><th>解决方案</th><th>示例</th></tr></thead><tbody><tr><td><strong>认证</strong></td><td>“你是谁？”</td><td>验证用户身份</td><td>用户名密码登录</td></tr><tr><td><strong>授权</strong></td><td>“你能做什么？”</td><td>验证用户权限</td><td>是否允许删除文章</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[用户] --&gt; B[认证 Authentication]</span><br><span class="line">    B --&gt; C[你是谁？]</span><br><span class="line">    B --&gt; D[身份验证]</span><br><span class="line">    D --&gt; E[授权 Authorization]</span><br><span class="line">    E --&gt; F[你能做什么？]</span><br><span class="line">    E --&gt; G[权限检查]</span><br></pre></td></tr></table></figure><hr><h2 id="2-Session-Cookie-认证"><a href="#2-Session-Cookie-认证" class="headerlink" title="2. Session-Cookie 认证"></a>2. Session-Cookie 认证</h2><p>这是最传统、最易于理解的认证方式。它依赖于服务器端的 Session 存储和客户端的 Cookie。</p><h3 id="2-1-⚙️-工作原理"><a href="#2-1-⚙️-工作原理" class="headerlink" title="2.1 ⚙️ 工作原理"></a>2.1 ⚙️ 工作原理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant U as User</span><br><span class="line">    participant B as Browser</span><br><span class="line">    participant S as Server</span><br><span class="line">    participant DB as Session Store</span><br><span class="line"></span><br><span class="line">    U-&gt;&gt;B: 输入用户名密码</span><br><span class="line">    B-&gt;&gt;S: POST /login</span><br><span class="line">    S-&gt;&gt;DB: 验证用户凭据</span><br><span class="line">    DB--&gt;&gt;S: 返回用户信息</span><br><span class="line">    S-&gt;&gt;DB: 创建Session</span><br><span class="line">    DB--&gt;&gt;S: 返回Session ID</span><br><span class="line">    S--&gt;&gt;B: Set-Cookie: session_id</span><br><span class="line">    B-&gt;&gt;S: GET /protected (Cookie)</span><br><span class="line">    S-&gt;&gt;DB: 验证Session ID</span><br><span class="line">    DB--&gt;&gt;S: 返回Session数据</span><br><span class="line">    S--&gt;&gt;B: 返回受保护内容</span><br></pre></td></tr></table></figure><p><strong>工作流程</strong>：</p><ol><li>用户登录，服务器验证用户名和密码</li><li>验证通过后，服务器在内存或数据库中创建唯一的 <code>Session</code> 记录</li><li>服务器通过 <code>Set-Cookie</code> 将 <code>Session ID</code> 返回给浏览器</li><li>浏览器后续请求自动通过 <code>Cookie</code> 携带 <code>Session ID</code></li><li>服务器验证 <code>Session ID</code> 确认用户身份</li></ol><h3 id="2-2-💻-实现示例"><a href="#2-2-💻-实现示例" class="headerlink" title="2.2 💻 实现示例"></a>2.2 💻 实现示例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 配置 session 中间件</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">  <span class="attr">secret</span>: <span class="string">&#x27;your_secret_key&#x27;</span>, <span class="comment">// 用于加密 session ID 的密钥，非常重要</span></span><br><span class="line">  <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">saveUninitialized</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">cookie</span>: &#123;</span><br><span class="line">    <span class="attr">secure</span>: <span class="literal">false</span>, <span class="comment">// 生产环境应设为 true (仅 HTTPS)</span></span><br><span class="line">    <span class="attr">maxAge</span>: <span class="number">60000</span>, <span class="comment">// 1分钟</span></span><br><span class="line">    <span class="attr">httpOnly</span>: <span class="literal">true</span> <span class="comment">// 防止 XSS 攻击</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录路由</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, express.<span class="title function_">json</span>(), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 验证用户名和密码 (这里应为数据库查询和密码比对)</span></span><br><span class="line">  <span class="keyword">if</span> (username === <span class="string">&#x27;admin&#x27;</span> &amp;&amp; password === <span class="string">&#x27;123456&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 2. 认证成功，将用户信息存入 session</span></span><br><span class="line">    req.<span class="property">session</span>.<span class="property">isLoggedIn</span> = <span class="literal">true</span>;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">user</span> = &#123;</span><br><span class="line">      <span class="attr">username</span>: username,</span><br><span class="line">      <span class="attr">loginTime</span>: <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">    &#125;;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;登录成功！&#x27;</span> &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;用户名或密码错误&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 受保护的路由，需要登录才能访问</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/profile&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 3. 检查 session 中是否存在用户信息</span></span><br><span class="line">  <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">isLoggedIn</span>) &#123;</span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">`欢迎回来, <span class="subst">$&#123;req.session.user.username&#125;</span>`</span>,</span><br><span class="line">      <span class="attr">loginTime</span>: req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">loginTime</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;请先登录！&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登出路由</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/logout&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 4. 销毁 session</span></span><br><span class="line">  req.<span class="property">session</span>.<span class="title function_">destroy</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;登出失败&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">clearCookie</span>(<span class="string">&#x27;connect.sid&#x27;</span>); <span class="comment">// 清除 Cookie</span></span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;已登出&#x27;</span> &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><h3 id="2-3-✅-优缺点"><a href="#2-3-✅-优缺点" class="headerlink" title="2.3 ✅ 优缺点"></a>2.3 ✅ 优缺点</h3><table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>✅ 技术成熟，易于理解</td><td>❌ 在分布式环境中需要共享 Session 存储</td></tr><tr><td>✅ 易于控制（服务端可强制失效）</td><td>❌ 依赖 Cookie，跨域场景复杂</td></tr><tr><td>✅ 安全性较高（httpOnly Cookie）</td><td>❌ 占用服务器存储资源</td></tr><tr><td>✅ 适合传统的服务器端渲染应用</td><td>❌ CSRF 攻击风险</td></tr></tbody></table><hr><h2 id="3-Token-认证（JWT）"><a href="#3-Token-认证（JWT）" class="headerlink" title="3. Token 认证（JWT）"></a>3. Token 认证（JWT）</h2><p>这是一种<strong>无状态</strong>的认证方式。服务器不再存储会话信息，而是将所有认证信息加密后形成一个令牌（Token）。</p><h3 id="3-1-⚙️-工作原理"><a href="#3-1-⚙️-工作原理" class="headerlink" title="3.1 ⚙️ 工作原理"></a>3.1 ⚙️ 工作原理</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant U as User</span><br><span class="line">    participant C as Client</span><br><span class="line">    participant S as Server</span><br><span class="line"></span><br><span class="line">    U-&gt;&gt;C: 输入用户名密码</span><br><span class="line">    C-&gt;&gt;S: POST /login</span><br><span class="line">    S-&gt;&gt;S: 验证用户凭据</span><br><span class="line">    S-&gt;&gt;S: 生成JWT Token</span><br><span class="line">    S--&gt;&gt;C: 返回JWT Token</span><br><span class="line">    C-&gt;&gt;C: 存储 Token (localStorage)</span><br><span class="line"></span><br><span class="line">    Note over C,S: 后续请求</span><br><span class="line">    C-&gt;&gt;S: GET /api/data&lt;br/&gt;Authorization: Bearer &lt;token&gt;</span><br><span class="line">    S-&gt;&gt;S: 验证 Token 签名</span><br><span class="line">    S--&gt;&gt;C: 返回数据</span><br></pre></td></tr></table></figure><p><strong>JWT 结构</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Header.Payload.Signature</span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwicm9sZSI6InVzZXIiLCJpYXQiOjE2MzU2Nzg5MDJ9.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span><br></pre></td></tr></table></figure><h3 id="3-2-💻-实现示例"><a href="#3-2-💻-实现示例" class="headerlink" title="3.2 💻 实现示例"></a>3.2 💻 实现示例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SECRET_KEY</span> = <span class="string">&#x27;your_super_secret_jwt_key&#x27;</span>; <span class="comment">// 必须非常复杂，且妥善保管</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录路由，颁发 Token</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, express.<span class="title function_">json</span>(), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; username, password &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 1. 验证用户名和密码</span></span><br><span class="line">  <span class="keyword">if</span> (username === <span class="string">&#x27;admin&#x27;</span> &amp;&amp; password === <span class="string">&#x27;123456&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// 2. 认证成功，生成 JWT</span></span><br><span class="line">    <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">username</span>: username,</span><br><span class="line">        <span class="attr">role</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">        <span class="attr">iat</span>: <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() / <span class="number">1000</span>) <span class="comment">// 签发时间</span></span><br><span class="line">      &#125;, <span class="comment">// Payload (有效载荷)，存放用户信息</span></span><br><span class="line">      <span class="variable constant_">SECRET_KEY</span>,</span><br><span class="line">      &#123; <span class="attr">expiresIn</span>: <span class="string">&#x27;1h&#x27;</span> &#125; <span class="comment">// Token 有效期 1 小时</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">message</span>: <span class="string">&#x27;登录成功！&#x27;</span>,</span><br><span class="line">      <span class="attr">token</span>: token,</span><br><span class="line">      <span class="attr">expiresIn</span>: <span class="string">&#x27;1h&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;用户名或密码错误&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间件：验证 Token</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">authenticateJWT</span> = (<span class="params">req, res, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> authHeader = req.<span class="property">headers</span>.<span class="property">authorization</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (authHeader) &#123;</span><br><span class="line">    <span class="keyword">const</span> token = authHeader.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>]; <span class="comment">// 格式：Bearer &lt;token&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 验证 Token</span></span><br><span class="line">    jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">SECRET_KEY</span>, <span class="function">(<span class="params">err, decoded</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">          <span class="attr">error</span>: <span class="string">&#x27;Token 无效或过期&#x27;</span>,</span><br><span class="line">          <span class="attr">details</span>: err.<span class="property">message</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      req.<span class="property">user</span> = decoded; <span class="comment">// 将解码出的用户信息挂载到 req 对象上</span></span><br><span class="line">      <span class="title function_">next</span>(); <span class="comment">// 验证通过，继续后续处理</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;请求头中没有 Token&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 受保护的路由，需要有效的 Token 才能访问</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/profile&#x27;</span>, authenticateJWT, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  res.<span class="title function_">json</span>(&#123;</span><br><span class="line">    <span class="attr">message</span>: <span class="string">`欢迎回来, <span class="subst">$&#123;req.user.username&#125;</span>`</span>,</span><br><span class="line">    <span class="attr">role</span>: req.<span class="property">user</span>.<span class="property">role</span>,</span><br><span class="line">    <span class="attr">tokenInfo</span>: &#123;</span><br><span class="line">      <span class="attr">issuedAt</span>: <span class="keyword">new</span> <span class="title class_">Date</span>(req.<span class="property">user</span>.<span class="property">iat</span> * <span class="number">1000</span>),</span><br><span class="line">      <span class="comment">// 注意：实际应用中应该从其他地方获取过期时间</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Token 刷新路由</span></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/refresh&#x27;</span>, express.<span class="title function_">json</span>(), <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; token &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;需要提供 Token&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> decoded = jwt.<span class="title function_">verify</span>(token, <span class="variable constant_">SECRET_KEY</span>, &#123; <span class="attr">ignoreExpiration</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查是否在刷新窗口期内（例如：过期后15分钟内）</span></span><br><span class="line">    <span class="keyword">const</span> now = <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() / <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">const</span> isWithinRefreshWindow = (now - decoded.<span class="property">exp</span>) &lt; <span class="number">900</span>; <span class="comment">// 15分钟</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isWithinRefreshWindow) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Token 过期太久，请重新登录&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 生成新的 Token</span></span><br><span class="line">    <span class="keyword">const</span> newToken = jwt.<span class="title function_">sign</span>(</span><br><span class="line">      &#123; <span class="attr">username</span>: decoded.<span class="property">username</span>, <span class="attr">role</span>: decoded.<span class="property">role</span> &#125;,</span><br><span class="line">      <span class="variable constant_">SECRET_KEY</span>,</span><br><span class="line">      &#123; <span class="attr">expiresIn</span>: <span class="string">&#x27;1h&#x27;</span> &#125;</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">token</span>: newToken &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;无效的 Token&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><h3 id="3-3-✅-优缺点"><a href="#3-3-✅-优缺点" class="headerlink" title="3.3 ✅ 优缺点"></a>3.3 ✅ 优缺点</h3><table><thead><tr><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>✅ 无状态，易于扩展</td><td>❌ Token 一旦签发，在有效期内无法强制失效</td></tr><tr><td>✅ 天然支持跨域</td><td>❌ Token 管理更复杂（如失效问题）</td></tr><tr><td>✅ 适合分布式&#x2F;API 服务</td><td>❌ 存储 Token 的安全性问题</td></tr><tr><td>✅ 减少服务器存储压力</td><td>❌ 需要处理 Token 刷新机制</td></tr></tbody></table><hr><h2 id="4-OAuth-认证"><a href="#4-OAuth-认证" class="headerlink" title="4. OAuth 认证"></a>4. OAuth 认证</h2><p>OAuth 2.0 是一个<strong>授权框架</strong>，它允许用户授权第三方应用访问他们存储在另一台服务提供商上的信息，而无需将用户名和密码提供给第三方应用。</p><h3 id="4-1-🔄-认证流程"><a href="#4-1-🔄-认证流程" class="headerlink" title="4.1 🔄 认证流程"></a>4.1 🔄 认证流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant U as User</span><br><span class="line">    participant C as Client App</span><br><span class="line">    participant A as Auth Server</span><br><span class="line">    participant R as Resource Server</span><br><span class="line"></span><br><span class="line">    U-&gt;&gt;C: 点击&quot;使用GitHub登录&quot;</span><br><span class="line">    C-&gt;&gt;A: 重定向到授权页面</span><br><span class="line">    U-&gt;&gt;A: 登录并授权</span><br><span class="line">    A-&gt;&gt;C: 重定向回调 + 授权码</span><br><span class="line">    C-&gt;&gt;A: 用授权码交换访问令牌</span><br><span class="line">    A-&gt;&gt;C: 返回访问令牌</span><br><span class="line">    C-&gt;&gt;R: 用访问令牌请求用户资源</span><br><span class="line">    R-&gt;&gt;A: 验证访问令牌</span><br><span class="line">    A--&gt;&gt;R: 令牌有效</span><br><span class="line">    R--&gt;&gt;C: 返回用户资源</span><br></pre></td></tr></table></figure><h3 id="4-2-💻-实现示例"><a href="#4-2-💻-实现示例" class="headerlink" title="4.2 💻 实现示例"></a>4.2 💻 实现示例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">&#x27;axios&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> querystring = <span class="built_in">require</span>(<span class="string">&#x27;querystring&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// GitHub OAuth 配置</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">GITHUB_CLIENT_ID</span> = <span class="string">&#x27;your_github_client_id&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">GITHUB_CLIENT_SECRET</span> = <span class="string">&#x27;your_github_client_secret&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">REDIRECT_URI</span> = <span class="string">&#x27;http://localhost:3000/auth/github/callback&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 重定向用户到 GitHub</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/auth/github&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> params = querystring.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">    <span class="attr">client_id</span>: <span class="variable constant_">GITHUB_CLIENT_ID</span>,</span><br><span class="line">    <span class="attr">redirect_uri</span>: <span class="variable constant_">REDIRECT_URI</span>,</span><br><span class="line">    <span class="attr">scope</span>: <span class="string">&#x27;user:email&#x27;</span>, <span class="comment">// 请求的权限范围</span></span><br><span class="line">    <span class="attr">state</span>: <span class="title class_">Math</span>.<span class="title function_">random</span>().<span class="title function_">toString</span>(<span class="number">36</span>).<span class="title function_">substring</span>(<span class="number">7</span>) <span class="comment">// CSRF 保护</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> githubAuthUrl = <span class="string">`https://github.com/login/oauth/authorize?<span class="subst">$&#123;params&#125;</span>`</span>;</span><br><span class="line">  res.<span class="title function_">redirect</span>(githubAuthUrl);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. GitHub 回调地址</span></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/auth/github/callback&#x27;</span>, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; code, state &#125; = req.<span class="property">query</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 3. 用 code 换取 access_token</span></span><br><span class="line">    <span class="keyword">const</span> tokenResponse = <span class="keyword">await</span> axios.<span class="title function_">post</span>(<span class="string">&#x27;https://github.com/login/oauth/access_token&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">client_id</span>: <span class="variable constant_">GITHUB_CLIENT_ID</span>,</span><br><span class="line">      <span class="attr">client_secret</span>: <span class="variable constant_">GITHUB_CLIENT_SECRET</span>,</span><br><span class="line">      <span class="attr">code</span>: code,</span><br><span class="line">      <span class="attr">state</span>: state <span class="comment">// 验证 state 防止 CSRF</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">headers</span>: &#123; <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span> &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> tokenData = tokenResponse.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">const</span> accessToken = tokenData.<span class="property">access_token</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 使用 access_token 获取用户信息</span></span><br><span class="line">    <span class="keyword">const</span> userResponse = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="string">&#x27;https://api.github.com/user&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">headers</span>: &#123; <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`token <span class="subst">$&#123;accessToken&#125;</span>`</span> &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 获取用户邮箱（如果设置了邮箱为私有）</span></span><br><span class="line">    <span class="keyword">const</span> emailResponse = <span class="keyword">await</span> axios.<span class="title function_">get</span>(<span class="string">&#x27;https://api.github.com/user/emails&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">headers</span>: &#123; <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`token <span class="subst">$&#123;accessToken&#125;</span>`</span> &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> userData = userResponse.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">const</span> emails = emailResponse.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">const</span> primaryEmail = emails.<span class="title function_">find</span>(<span class="function"><span class="params">email</span> =&gt;</span> email.<span class="property">primary</span>)?.<span class="property">email</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 根据 userData 处理本地用户登录和 session/jwt 创建</span></span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="title function_">findOrCreateUser</span>(&#123;</span><br><span class="line">      <span class="attr">githubId</span>: userData.<span class="property">id</span>,</span><br><span class="line">      <span class="attr">username</span>: userData.<span class="property">login</span>,</span><br><span class="line">      <span class="attr">email</span>: primaryEmail,</span><br><span class="line">      <span class="attr">avatar</span>: userData.<span class="property">avatar_url</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里可以创建 session 或 JWT</span></span><br><span class="line">    <span class="keyword">const</span> sessionToken = <span class="title function_">createSessionForUser</span>(user);</span><br><span class="line"></span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">`/dashboard?token=<span class="subst">$&#123;sessionToken&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;GitHub OAuth error:&#x27;</span>, error);</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;OAuth 授权失败&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助函数：查找或创建用户</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">findOrCreateUser</span>(<span class="params">githubData</span>) &#123;</span><br><span class="line">  <span class="comment">// 这里应该连接数据库查找或创建用户</span></span><br><span class="line">  <span class="comment">// 返回用户对象</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">id</span>: githubData.<span class="property">githubId</span>,</span><br><span class="line">    <span class="attr">username</span>: githubData.<span class="property">username</span>,</span><br><span class="line">    <span class="attr">email</span>: githubData.<span class="property">email</span>,</span><br><span class="line">    <span class="attr">avatar</span>: githubData.<span class="property">avatar</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助函数：为用户创建会话</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createSessionForUser</span>(<span class="params">user</span>) &#123;</span><br><span class="line">  <span class="comment">// 这里可以创建 JWT 或 session</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;generated_session_token&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><hr><h2 id="5-方案对比与选择"><a href="#5-方案对比与选择" class="headerlink" title="5. 方案对比与选择"></a>5. 方案对比与选择</h2><h3 id="5-1-📊-对比表"><a href="#5-1-📊-对比表" class="headerlink" title="5.1 📊 对比表"></a>5.1 📊 对比表</h3><table><thead><tr><th>认证方式</th><th>适用场景</th><th>状态管理</th><th>跨域支持</th><th>扩展性</th><th>安全性</th><th>实现复杂度</th></tr></thead><tbody><tr><td><strong>Session-Cookie</strong></td><td>传统的服务器端渲染 Web 应用</td><td>有状态</td><td>⚠️ 需要配置</td><td>⚠️ 需要共享存储</td><td>✅ 高</td><td>🟢 简单</td></tr><tr><td><strong>Token (JWT)</strong></td><td>前后端分离 SPA、移动端 APP、API 接口</td><td>无状态</td><td>✅ 原生支持</td><td>✅ 极好</td><td>✅ 中高</td><td>🟡 中等</td></tr><tr><td><strong>OAuth</strong></td><td>需要第三方登录功能的任何应用</td><td>混合</td><td>✅ 原生支持</td><td>✅ 极好</td><td>✅ 高</td><td>🔴 复杂</td></tr></tbody></table><h3 id="5-2-🎯-使用场景"><a href="#5-2-🎯-使用场景" class="headerlink" title="5.2 🎯 使用场景"></a>5.2 🎯 使用场景</h3><h4 id="🌐-Web-应用"><a href="#🌐-Web-应用" class="headerlink" title="🌐 Web 应用"></a>🌐 Web 应用</h4><ul><li><strong>传统 Web 应用</strong>：Session-Cookie</li><li><strong>现代 SPA</strong>：JWT Token</li><li><strong>混合模式</strong>：JWT + 可选 Session</li></ul><h4 id="📱-移动端应用"><a href="#📱-移动端应用" class="headerlink" title="📱 移动端应用"></a>📱 移动端应用</h4><ul><li><strong>Native App</strong>：JWT Token</li><li><strong>Hybrid App</strong>：JWT Token</li><li><strong>小程序</strong>：Session-Cookie 或 JWT</li></ul><h4 id="🔗-API-服务"><a href="#🔗-API-服务" class="headerlink" title="🔗 API 服务"></a>🔗 API 服务</h4><ul><li><strong>RESTful API</strong>：JWT Token</li><li><strong>GraphQL API</strong>：JWT Token</li><li><strong>微服务架构</strong>：JWT Token</li></ul><h4 id="🤝-单点登录-SSO"><a href="#🤝-单点登录-SSO" class="headerlink" title="🤝 单点登录 (SSO)"></a>🤝 单点登录 (SSO)</h4><ul><li><strong>企业内应用</strong>：OAuth 2.0 &#x2F; SAML</li><li><strong>跨平台应用</strong>：OAuth 2.0</li><li><strong>第三方登录</strong>：OAuth 2.0</li></ul><h3 id="5-3-🔄-常见组合"><a href="#5-3-🔄-常见组合" class="headerlink" title="5.3 🔄 常见组合"></a>5.3 🔄 常见组合</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[Web应用] --&gt; B[主认证方式]</span><br><span class="line">    A --&gt; C[辅助认证方式]</span><br><span class="line"></span><br><span class="line">    B --&gt; D[Session-Cookie&lt;br/&gt;传统Web应用]</span><br><span class="line">    B --&gt; E[JWT Token&lt;br/&gt;SPA/移动端]</span><br><span class="line">    B --&gt; F[OAuth&lt;br/&gt;第三方登录]</span><br><span class="line"></span><br><span class="line">    C --&gt; G[CSRF保护]</span><br><span class="line">    C --&gt; H[HTTPS强制]</span><br><span class="line">    C --&gt; I[Rate Limiting]</span><br><span class="line">    C --&gt; J[输入验证]</span><br></pre></td></tr></table></figure><p><strong>现代常见组合</strong>：</p><ul><li><strong>Web App</strong>：<strong>Session</strong> 或 <strong>JWT</strong> + HTTPS + CSRF Protection</li><li><strong>Mobile&#x2F;Native App</strong>：<strong>JWT</strong> + HTTPS + Device Fingerprinting</li><li><strong>单点登录</strong>：<strong>OAuth</strong> 或 <strong>JWT</strong> + Centralized Auth Server</li><li><strong>第三方登录</strong>：<strong>OAuth</strong> + Local Account Binding</li></ul><hr><h2 id="⚠️-安全最佳实践"><a href="#⚠️-安全最佳实践" class="headerlink" title="⚠️ 安全最佳实践"></a>⚠️ 安全最佳实践</h2><p>无论选择哪种认证方式，都务必遵循以下安全原则：</p><ol><li><strong>🔒 使用 HTTPS</strong> - 保证传输过程的安全</li><li><strong>🕐 设置合理的过期时间</strong> - Token 和 Session 都不应长期有效</li><li><strong>🛡️ 防范常见攻击</strong>：<ul><li>XSS (Cross-Site Scripting)</li><li>CSRF (Cross-Site Request Forgery)</li><li>点击劫持 (Clickjacking)</li></ul></li><li><strong>📝 记录安全日志</strong> - 监控异常登录行为</li><li><strong>🔄 定期轮换密钥</strong> - 定期更换 JWT 密钥和会话密钥</li><li><strong>✅ 实施最小权限原则</strong> - 只授予必要的权限</li></ol><hr><h2 id="📚-参考资源"><a href="#📚-参考资源" class="headerlink" title="📚 参考资源"></a>📚 参考资源</h2><ul><li><a href="https://tools.ietf.org/html/rfc6749">RFC 6749 - OAuth 2.0</a></li><li><a href="https://jwt.io/">JWT.io - JWT 在线工具</a></li><li><a href="https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html">OWASP Authentication Cheat Sheet</a></li><li><a href="https://expressjs.com/">Express.js 官方文档</a></li></ul><hr><blockquote><p><strong>💡 提示</strong>: 在选择认证方案时，请综合考虑：</p><ul><li>应用架构和部署环境</li><li>用户体验需求</li><li>安全性要求</li><li>开发和维护成本</li><li>团队技术栈熟悉度</li></ul></blockquote>]]></content>
    
    
    <summary type="html">深入浅出地介绍 Web 认证的核心概念，对比 Session-Cookie、JWT Token 和 OAuth 认证方案的优缺点及适用场景。</summary>
    
    
    
    <category term="Web架构安全" scheme="https://vilaswang.github.io/categories/Web%E6%9E%B6%E6%9E%84%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>认证系统架构</title>
    <link href="https://vilaswang.github.io/posts/ab2eaca1/"/>
    <id>https://vilaswang.github.io/posts/ab2eaca1/</id>
    <published>2025-12-09T06:09:56.000Z</published>
    <updated>2025-12-18T15:50:18.058Z</updated>
    
    <content type="html"><![CDATA[<h1 id="认证系统架构"><a href="#认证系统架构" class="headerlink" title="认证系统架构"></a>认证系统架构</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>authentication</code>, <code>authorization</code>, <code>jwt</code>, <code>oauth</code>, <code>security</code>, <code>api</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F%E6%A6%82%E8%BF%B0">1. 认证方式概述</a></li><li><a href="#2-%E6%9C%AC%E5%9C%B0%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B">2. 本地认证流程</a><ul><li><a href="#21-%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B">2.1 注册流程</a></li><li><a href="#22-%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B">2.2 登录流程</a></li><li><a href="#23-token-%E9%AA%8C%E8%AF%81%E6%B5%81%E7%A8%8B">2.3 Token 验证流程</a></li></ul></li><li><a href="#3-google-oauth-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B">3. Google OAuth 认证流程</a><ul><li><a href="#31-%E9%85%8D%E7%BD%AE">3.1 配置</a></li><li><a href="#32-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B">3.2 认证流程</a></li><li><a href="#33-%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86">3.3 会话管理</a></li></ul></li><li><a href="#4-%E5%AE%89%E5%85%A8%E7%89%B9%E6%80%A7">4. 安全特性</a><ul><li><a href="#41-%E9%80%9F%E7%8E%87%E9%99%90%E5%88%B6">4.1 速率限制</a></li><li><a href="#42-cors-%E9%85%8D%E7%BD%AE">4.2 CORS 配置</a></li><li><a href="#43-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">4.3 错误处理</a></li></ul></li><li><a href="#5-%E4%B8%AD%E9%97%B4%E4%BB%B6%E9%93%BE">5. 中间件链</a></li><li><a href="#6-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">6. 环境配置</a></li></ul><hr><h2 id="1-认证方式概述"><a href="#1-认证方式概述" class="headerlink" title="1. 认证方式概述"></a>1. 认证方式概述</h2><p>系统支持两种主要的认证方式：</p><ol><li><strong>🔑 本地用户名密码认证</strong>（JWT Token）</li><li><strong>🌐 Google OAuth 2.0 认证</strong></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[用户] --&gt; B[认证选择]</span><br><span class="line">    B --&gt; C[本地认证]</span><br><span class="line">    B --&gt; D[OAuth认证]</span><br><span class="line">    C --&gt; E[JWT Token]</span><br><span class="line">    D --&gt; F[Google授权]</span><br><span class="line">    E --&gt; G[访问API]</span><br><span class="line">    F --&gt; G</span><br></pre></td></tr></table></figure><hr><h2 id="2-本地认证流程"><a href="#2-本地认证流程" class="headerlink" title="2. 本地认证流程"></a>2. 本地认证流程</h2><h3 id="2-1-🔧-注册流程"><a href="#2-1-🔧-注册流程" class="headerlink" title="2.1 🔧 注册流程"></a>2.1 🔧 注册流程</h3><ol><li>客户端发送 <code>POST</code> 请求到 <code>/api/v1/auth/register</code></li><li>请求经过速率限制中间件（Rate Limiter）检查</li><li>通过注册验证器（registerValidator）验证请求数据</li><li>控制器处理注册逻辑，创建新用户</li><li>返回注册结果</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant C as Client</span><br><span class="line">    participant R as Rate Limiter</span><br><span class="line">    participant V as Validator</span><br><span class="line">    participant Ctrl as Controller</span><br><span class="line">    participant DB as Database</span><br><span class="line"></span><br><span class="line">    C-&gt;&gt;R: POST /api/v1/auth/register</span><br><span class="line">    R-&gt;&gt;V: 验证请求数据</span><br><span class="line">    V-&gt;&gt;Ctrl: 处理注册逻辑</span><br><span class="line">    Ctrl-&gt;&gt;DB: 创建新用户</span><br><span class="line">    DB--&gt;&gt;Ctrl: 返回用户信息</span><br><span class="line">    Ctrl--&gt;&gt;C: 返回注册结果</span><br></pre></td></tr></table></figure><h3 id="2-2-🔐-登录流程"><a href="#2-2-🔐-登录流程" class="headerlink" title="2.2 🔐 登录流程"></a>2.2 🔐 登录流程</h3><ol><li>客户端发送 <code>POST</code> 请求到 <code>/api/v1/auth/login</code></li><li>请求经过速率限制中间件检查</li><li>通过登录验证器（loginValidator）验证请求数据</li><li>控制器验证用户名和密码</li><li>生成 JWT Token（有效期24小时）</li><li>返回 Token 给客户端</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant C as Client</span><br><span class="line">    participant R as Rate Limiter</span><br><span class="line">    participant V as Validator</span><br><span class="line">    participant Ctrl as Controller</span><br><span class="line">    participant JWT as JWT Service</span><br><span class="line"></span><br><span class="line">    C-&gt;&gt;R: POST /api/v1/auth/login</span><br><span class="line">    R-&gt;&gt;V: 验证登录数据</span><br><span class="line">    V-&gt;&gt;Ctrl: 验证用户凭据</span><br><span class="line">    Ctrl-&gt;&gt;JWT: 生成Token</span><br><span class="line">    JWT--&gt;&gt;Ctrl: 返回JWT Token</span><br><span class="line">    Ctrl--&gt;&gt;C: 返回Token信息</span><br></pre></td></tr></table></figure><h3 id="2-3-🛡️-Token-验证流程"><a href="#2-3-🛡️-Token-验证流程" class="headerlink" title="2.3 🛡️ Token 验证流程"></a>2.3 🛡️ Token 验证流程</h3><ol><li>客户端在请求头中携带 Token：<code>Authorization: Bearer &lt;token&gt;</code></li><li><code>authenticateToken</code> 中间件验证 Token：<ul><li>检查 Token 是否存在</li><li>验证 Token 有效性</li><li>从 Token 中解析用户信息</li><li>将用户信息附加到请求对象</li></ul></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Token 验证中间件示例</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">authenticateToken</span> = (<span class="params">req, res, next</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> authHeader = req.<span class="property">headers</span>[<span class="string">&#x27;authorization&#x27;</span>];</span><br><span class="line">  <span class="keyword">const</span> token = authHeader &amp;&amp; authHeader.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Access token required&#x27;</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  jwt.<span class="title function_">verify</span>(token, process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>, <span class="function">(<span class="params">err, user</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123; <span class="attr">error</span>: <span class="string">&#x27;Invalid or expired token&#x27;</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    req.<span class="property">user</span> = user;</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="3-Google-OAuth-认证流程"><a href="#3-Google-OAuth-认证流程" class="headerlink" title="3. Google OAuth 认证流程"></a>3. Google OAuth 认证流程</h2><h3 id="3-1-⚙️-配置"><a href="#3-1-⚙️-配置" class="headerlink" title="3.1 ⚙️ 配置"></a>3.1 ⚙️ 配置</h3><ul><li>使用 Passport.js 的 Google 策略</li><li>配置了 Google Client ID 和 Secret</li><li>设置了回调 URL</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Google OAuth 配置示例</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">GoogleStrategy</span> = <span class="built_in">require</span>(<span class="string">&#x27;passport-google-oauth20&#x27;</span>).<span class="property">Strategy</span>;</span><br><span class="line"></span><br><span class="line">passport.<span class="title function_">use</span>(<span class="keyword">new</span> <span class="title class_">GoogleStrategy</span>(&#123;</span><br><span class="line">  <span class="attr">clientID</span>: process.<span class="property">env</span>.<span class="property">GOOGLE_CLIENT_ID</span>,</span><br><span class="line">  <span class="attr">clientSecret</span>: process.<span class="property">env</span>.<span class="property">GOOGLE_CLIENT_SECRET</span>,</span><br><span class="line">  <span class="attr">callbackURL</span>: <span class="string">&quot;/api/v1/auth/google/callback&quot;</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">accessToken, refreshToken, profile, done</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 用户验证逻辑</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><h3 id="3-2-🔄-认证流程"><a href="#3-2-🔄-认证流程" class="headerlink" title="3.2 🔄 认证流程"></a>3.2 🔄 认证流程</h3><ol><li>用户访问 <code>/api/v1/auth/oauth/google</code></li><li>重定向到 Google 登录页面</li><li>用户授权后，Google 重定向回回调 URL</li><li>Passport 处理回调：<ul><li>验证用户信息</li><li>如果用户不存在，创建新用户</li><li>生成会话</li></ul></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant U as User</span><br><span class="line">    participant A as App</span><br><span class="line">    participant G as Google</span><br><span class="line">    participant DB as Database</span><br><span class="line"></span><br><span class="line">    U-&gt;&gt;A: 访问OAuth端点</span><br><span class="line">    A-&gt;&gt;G: 重定向到Google</span><br><span class="line">    U-&gt;&gt;G: 登录并授权</span><br><span class="line">    G-&gt;&gt;A: 回调授权码</span><br><span class="line">    A-&gt;&gt;G: 交换访问令牌</span><br><span class="line">    G-&gt;&gt;A: 返回用户信息</span><br><span class="line">    A-&gt;&gt;DB: 查找/创建用户</span><br><span class="line">    A-&gt;&gt;U: 建立会话</span><br></pre></td></tr></table></figure><h3 id="3-3-📋-会话管理"><a href="#3-3-📋-会话管理" class="headerlink" title="3.3 📋 会话管理"></a>3.3 📋 会话管理</h3><ul><li>使用 <code>express-session</code> 管理会话</li><li>配置了会话密钥和选项</li><li>实现了用户序列化和反序列化</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 会话配置示例</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">  <span class="attr">secret</span>: process.<span class="property">env</span>.<span class="property">SESSION_SECRET</span>,</span><br><span class="line">  <span class="attr">resave</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">saveUninitialized</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">cookie</span>: &#123;</span><br><span class="line">    <span class="attr">secure</span>: process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;production&#x27;</span>,</span><br><span class="line">    <span class="attr">maxAge</span>: <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span> <span class="comment">// 24小时</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><hr><h2 id="4-安全特性"><a href="#4-安全特性" class="headerlink" title="4. 安全特性"></a>4. 安全特性</h2><h3 id="4-1-🚦-速率限制"><a href="#4-1-🚦-速率限制" class="headerlink" title="4.1 🚦 速率限制"></a>4.1 🚦 速率限制</h3><ul><li>使用 <code>express-rate-limit</code> 实现</li><li>默认限制：15分钟内每个 IP 最多 100 个请求</li><li>应用于登录和注册接口</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 速率限制配置示例</span></span><br><span class="line"><span class="keyword">const</span> rateLimiter = <span class="title function_">rateLimit</span>(&#123;</span><br><span class="line">  <span class="attr">windowMs</span>: <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000</span>, <span class="comment">// 15分钟</span></span><br><span class="line">  <span class="attr">max</span>: <span class="number">100</span>, <span class="comment">// 最大请求数</span></span><br><span class="line">  <span class="attr">message</span>: <span class="string">&#x27;Too many requests from this IP&#x27;</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="4-2-🌐-CORS-配置"><a href="#4-2-🌐-CORS-配置" class="headerlink" title="4.2 🌐 CORS 配置"></a>4.2 🌐 CORS 配置</h3><ul><li>可配置允许的源（默认允许所有）</li><li>限制允许的 HTTP 方法</li><li>配置允许的请求头</li><li>支持凭证（credentials）</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CORS 配置示例</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>(&#123;</span><br><span class="line">  <span class="attr">origin</span>: process.<span class="property">env</span>.<span class="property">ALLOWED_ORIGINS</span>?.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>) || <span class="string">&#x27;*&#x27;</span>,</span><br><span class="line">  <span class="attr">methods</span>: [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>],</span><br><span class="line">  <span class="attr">allowedHeaders</span>: [<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;Authorization&#x27;</span>],</span><br><span class="line">  <span class="attr">credentials</span>: <span class="literal">true</span></span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><h3 id="4-3-⚠️-错误处理"><a href="#4-3-⚠️-错误处理" class="headerlink" title="4.3 ⚠️ 错误处理"></a>4.3 ⚠️ 错误处理</h3><ul><li>统一的错误处理中间件</li><li>区分开发环境和生产环境的错误响应</li><li>详细的错误日志记录</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误处理中间件示例</span></span><br><span class="line">app.<span class="title function_">use</span>(<span class="function">(<span class="params">err, req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(err.<span class="property">stack</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.<span class="property">env</span>.<span class="property">NODE_ENV</span> === <span class="string">&#x27;development&#x27;</span>) &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">error</span>: err.<span class="property">message</span>,</span><br><span class="line">      <span class="attr">stack</span>: err.<span class="property">stack</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">      <span class="attr">error</span>: <span class="string">&#x27;Internal Server Error&#x27;</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><hr><h2 id="5-🔗-中间件链"><a href="#5-🔗-中间件链" class="headerlink" title="5. 🔗 中间件链"></a>5. 🔗 中间件链</h2><p>请求处理流程：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[客户端请求] --&gt; B[日志中间件]</span><br><span class="line">    B --&gt; C[基础中间件]</span><br><span class="line">    C --&gt; D[CORS中间件]</span><br><span class="line">    D --&gt; E[会话中间件]</span><br><span class="line">    E --&gt; F[Passport初始化]</span><br><span class="line">    F --&gt; G[路由处理]</span><br><span class="line">    G --&gt; H[控制器逻辑]</span><br><span class="line">    H --&gt; I[响应返回]</span><br><span class="line">    I --&gt; J[错误处理中间件]</span><br></pre></td></tr></table></figure><ol><li><strong>日志中间件</strong>（请求记录）</li><li><strong>基础中间件</strong>（JSON解析、CORS等）</li><li><strong>会话中间件</strong></li><li><strong>Passport 初始化</strong></li><li><strong>路由处理</strong></li><li><strong>错误处理中间件</strong></li></ol><hr><h2 id="6-🛠️-环境配置"><a href="#6-🛠️-环境配置" class="headerlink" title="6. 🛠️ 环境配置"></a>6. 🛠️ 环境配置</h2><p>关键配置项：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 认证系统架构</span><br><span class="line">JWT_SECRET=your-super-secret-jwt-key</span><br><span class="line">JWT_EXPIRES_IN=24h</span><br><span class="line"></span><br><span class="line"># 认证系统架构</span><br><span class="line">SESSION_SECRET=your-session-secret</span><br><span class="line"></span><br><span class="line"># 认证系统架构</span><br><span class="line">GOOGLE_CLIENT_ID=your-google-client-id</span><br><span class="line">GOOGLE_CLIENT_SECRET=your-google-client-secret</span><br><span class="line"></span><br><span class="line"># 认证系统架构</span><br><span class="line">DB_HOST=localhost</span><br><span class="line">DB_PORT=3306</span><br><span class="line">DB_NAME=your-database-name</span><br><span class="line">DB_USER=your-username</span><br><span class="line">DB_PASSWORD=your-password</span><br><span class="line"></span><br><span class="line"># 认证系统架构</span><br><span class="line">UPLOAD_DIR=./uploads</span><br><span class="line">MAX_FILE_SIZE=10485760</span><br><span class="line"></span><br><span class="line"># 认证系统架构</span><br><span class="line">ALLOWED_ORIGINS=http://localhost:3000,https://yourdomain.com</span><br><span class="line"></span><br><span class="line"># 认证系统架构</span><br><span class="line">RATE_LIMIT_WINDOW_MS=900000</span><br><span class="line">RATE_LIMIT_MAX_REQUESTS=100</span><br></pre></td></tr></table></figure><hr><h2 id="📊-总结"><a href="#📊-总结" class="headerlink" title="📊 总结"></a>📊 总结</h2><p>这个认证系统采用了多重安全机制，包括：</p><ul><li>✅ <strong>JWT Token</strong> 认证</li><li>✅ <strong>OAuth 2.0</strong> 第三方登录</li><li>✅ <strong>速率限制</strong> 防止暴力攻击</li><li>✅ <strong>CORS</strong> 跨域保护</li><li>✅ <strong>统一错误处理</strong> 提升用户体验</li></ul><p>通过中间件链的方式，实现了灵活的认证流程控制，能够有效保护 API 接口的安全。</p><hr><blockquote><p><strong>💡 提示</strong>: 在生产环境中，请确保：</p><ul><li>使用强密码作为密钥</li><li>启用 HTTPS</li><li>定期轮换密钥</li><li>监控异常访问行为</li></ul></blockquote>]]></content>
    
    
    <summary type="html">本文档展示了 Web 认证系统的整体设计架构，包含负载均衡、认证流转及安全组件的交互流程。</summary>
    
    
    
    <category term="Web架构安全" scheme="https://vilaswang.github.io/categories/Web%E6%9E%B6%E6%9E%84%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>MariaDB C++ Windows 安装指南</title>
    <link href="https://vilaswang.github.io/posts/15251b3b/"/>
    <id>https://vilaswang.github.io/posts/15251b3b/</id>
    <published>2025-12-09T06:09:56.000Z</published>
    <updated>2025-12-17T15:36:29.277Z</updated>
    
    <content type="html"><![CDATA[<h1 id="MariaDB-C-Windows-安装指南"><a href="#MariaDB-C-Windows-安装指南" class="headerlink" title="MariaDB C++ Windows 安装指南"></a>MariaDB C++ Windows 安装指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>mariadb</code>, <code>cpp</code>, <code>windows</code>, <code>development</code>, <code>database</code>, <code>connector</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E5%AE%89%E8%A3%85-mariadb-%E6%9C%8D%E5%8A%A1%E5%99%A8">2. 安装 MariaDB 服务器</a><ul><li><a href="#21-%E8%8E%B7%E5%8F%96%E5%AE%89%E8%A3%85%E7%A8%8B%E5%BA%8F">2.1 获取安装程序</a></li><li><a href="#22-%E8%BF%90%E8%A1%8C%E5%AE%89%E8%A3%85%E5%90%91%E5%AF%BC">2.2 运行安装向导</a></li><li><a href="#23-%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85">2.3 验证安装</a></li></ul></li><li><a href="#3-%E5%AE%89%E8%A3%85-mariadb-%E8%BF%9E%E6%8E%A5%E5%99%A8">3. 安装 MariaDB 连接器</a><ul><li><a href="#31-connectorc">3.1 Connector&#x2F;C++</a></li><li><a href="#32-connectorc">3.2 Connector&#x2F;C</a></li><li><a href="#33-%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F">3.3 配置环境变量</a></li></ul></li><li><a href="#4-%E9%85%8D%E7%BD%AE-visual-studio-%E9%A1%B9%E7%9B%AE">4. 配置 Visual Studio 项目</a><ul><li><a href="#41-%E5%8C%85%E5%90%AB%E5%A4%B4%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95">4.1 包含头文件目录</a></li><li><a href="#42-%E9%85%8D%E7%BD%AE%E5%BA%93%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95">4.2 配置库文件目录</a></li><li><a href="#43-%E6%8C%87%E5%AE%9A%E4%BE%9D%E8%B5%96%E7%9A%84%E5%BA%93%E6%96%87%E4%BB%B6">4.3 指定依赖的库文件</a></li><li><a href="#44-%E6%8B%B7%E8%B4%9D-dll-%E6%96%87%E4%BB%B6">4.4 拷贝 DLL 文件</a></li></ul></li><li><a href="#5-%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E4%BB%A3%E7%A0%81">5. 编写测试代码</a></li><li><a href="#6-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">6. 常见问题和解决方案</a></li><li><a href="#7-%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE">7. 高级配置</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>在Windows下进行C++开发并使用MariaDB，主要涉及MariaDB服务器端的安装、开发库的配置，以及在你的C++项目中正确连接和使用这些库。</p><h3 id="🎯-目标"><a href="#🎯-目标" class="headerlink" title="🎯 目标"></a>🎯 目标</h3><ul><li>✅ 安装 MariaDB 服务器</li><li>✅ 配置 C++ 开发环境</li><li>✅ 创建可运行的 C++ 数据库程序</li><li>✅ 掌握基本的数据库操作</li></ul><h3 id="🏗️-系统架构图"><a href="#🏗️-系统架构图" class="headerlink" title="🏗️ 系统架构图"></a>🏗️ 系统架构图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[C++ Application] --&gt; B[MariaDB Connector/C++]</span><br><span class="line">    B --&gt; C[MariaDB Connector/C]</span><br><span class="line">    C --&gt; D[MariaDB Server]</span><br><span class="line">    D --&gt; E[Database Files]</span><br><span class="line"></span><br><span class="line">    F[Visual Studio IDE] --&gt; G[Project Configuration]</span><br><span class="line">    G --&gt; H[Include Directories]</span><br><span class="line">    G --&gt; I[Library Directories]</span><br><span class="line">    G --&gt; J[Dependencies]</span><br></pre></td></tr></table></figure><hr><h2 id="2-💾-安装-MariaDB-服务器"><a href="#2-💾-安装-MariaDB-服务器" class="headerlink" title="2. 💾 安装 MariaDB 服务器"></a>2. 💾 安装 MariaDB 服务器</h2><h3 id="2-1-🔍-获取安装程序"><a href="#2-1-🔍-获取安装程序" class="headerlink" title="2.1 🔍 获取安装程序"></a>2.1 🔍 获取安装程序</h3><p>访问 <a href="https://mariadb.org/download/">MariaDB官方网站的下载页面</a>，选择适用于Windows的安装程序。</p><p><strong>推荐版本选择</strong>：</p><ul><li><strong>稳定版本</strong>: MariaDB 11.8 LTS (长期支持版本)</li><li><strong>文件格式</strong>: <code>.msi</code> 安装程序</li><li><strong>架构</strong>: 根据你的系统选择 x64 或 x86</li></ul><h3 id="2-2-⚙️-运行安装向导"><a href="#2-2-⚙️-运行安装向导" class="headerlink" title="2.2 ⚙️ 运行安装向导"></a>2.2 ⚙️ 运行安装向导</h3><p>运行下载的 <code>.msi</code> 安装程序，按照向导步骤操作：</p><h4 id="📋-重要配置项"><a href="#📋-重要配置项" class="headerlink" title="📋 重要配置项"></a>📋 重要配置项</h4><table><thead><tr><th>配置项</th><th>推荐设置</th><th>说明</th></tr></thead><tbody><tr><td><strong>根密码</strong></td><td>强密码</td><td>管理数据库的最高权限账户</td></tr><tr><td><strong>服务名</strong></td><td><code>MariaDB</code> 或 <code>MySQL</code></td><td>保持默认即可</td></tr><tr><td><strong>端口</strong></td><td><code>3306</code></td><td>默认数据库端口</td></tr><tr><td><strong>字符集</strong></td><td><strong>UTF-8</strong></td><td>支持多语言</td></tr><tr><td><strong>启用网络访问</strong></td><td>是</td><td>允许远程连接</td></tr></tbody></table><h4 id="⚠️-权限错误处理"><a href="#⚠️-权限错误处理" class="headerlink" title="⚠️ 权限错误处理"></a>⚠️ 权限错误处理</h4><p>如果在安装过程中遇到服务权限相关的错误：</p><ol><li><strong>不要退出安装程序</strong></li><li>打开 Windows 的”服务”管理界面 (<code>services.msc</code>)</li><li>找到 MariaDB 服务</li><li>右键 → “属性” → “登录”选项卡</li><li>将登录身份修改为”<strong>本地系统账户</strong>“</li><li>返回安装程序点击”<strong>重试</strong>“</li></ol><h3 id="2-3-✅-验证安装"><a href="#2-3-✅-验证安装" class="headerlink" title="2.3 ✅ 验证安装"></a>2.3 ✅ 验证安装</h3><p>安装完成后，通过以下方式验证：</p><h4 id="方法一：命令行验证"><a href="#方法一：命令行验证" class="headerlink" title="方法一：命令行验证"></a>方法一：命令行验证</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MariaDB C++ Windows 安装指南</span></span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># MariaDB C++ Windows 安装指南</span></span><br></pre></td></tr></table></figure><h4 id="方法二：图形化工具"><a href="#方法二：图形化工具" class="headerlink" title="方法二：图形化工具"></a>方法二：图形化工具</h4><ul><li><strong>HeidiSQL</strong> (可能随安装包提供)</li><li><strong>DBeaver</strong></li><li><strong>Navicat</strong></li><li><strong>phpMyAdmin</strong></li></ul><hr><h2 id="3-🔌-安装-MariaDB-连接器"><a href="#3-🔌-安装-MariaDB-连接器" class="headerlink" title="3. 🔌 安装 MariaDB 连接器"></a>3. 🔌 安装 MariaDB 连接器</h2><h3 id="3-1-📦-Connector-C"><a href="#3-1-📦-Connector-C" class="headerlink" title="3.1 📦 Connector&#x2F;C++"></a>3.1 📦 Connector&#x2F;C++</h3><p>MariaDB Connector&#x2F;C++ 是官方的 C++ 数据库连接器。</p><p><strong>下载地址</strong>：<br><a href="https://mariadb.com/downloads/connectors/connectors-data-access/cpp-connector">MariaDB Connector&#x2F;C++ 官方下载页面</a></p><p><strong>版本选择指南</strong>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[Visual Studio版本] --&gt; B[Connector版本]</span><br><span class="line">    B --&gt; C[VS 2019/2022]</span><br><span class="line">    B --&gt; D[VS 2017]</span><br><span class="line">    B --&gt; E[VS 2015]</span><br><span class="line">    C --&gt; F[最新版本]</span><br><span class="line">    D --&gt; G[较新版本]</span><br><span class="line">    E --&gt; H[兼容版本]</span><br></pre></td></tr></table></figure><h3 id="3-2-🔧-Connector-C-依赖项"><a href="#3-2-🔧-Connector-C-依赖项" class="headerlink" title="3.2 🔧 Connector&#x2F;C (依赖项)"></a>3.2 🔧 Connector&#x2F;C (依赖项)</h3><p><strong>重要</strong>：<code>MariaDB Connector/C++</code> 依赖于 <code>MariaDB Connector/C</code></p><p><strong>下载地址</strong>：<br><a href="https://mariadb.com/downloads/connectors/connectors-data-access/c-connector">MariaDB Connector&#x2F;C 官方下载页面</a></p><h3 id="3-3-🌐-配置环境变量"><a href="#3-3-🌐-配置环境变量" class="headerlink" title="3.3 🌐 配置环境变量"></a>3.3 🌐 配置环境变量</h3><p>为了确保运行时能找到必要的 DLL 文件：</p><h4 id="自动配置（推荐）"><a href="#自动配置（推荐）" class="headerlink" title="自动配置（推荐）"></a>自动配置（推荐）</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># MariaDB C++ Windows 安装指南</span><br><span class="line">setx <span class="built_in">PATH</span> &quot;<span class="variable">%PATH%</span>;C:\mariadb-connector-c\lib&quot;</span><br></pre></td></tr></table></figure><h4 id="手动配置"><a href="#手动配置" class="headerlink" title="手动配置"></a>手动配置</h4><ol><li>右键”此电脑” → “属性” → “高级系统设置”</li><li>点击”环境变量”</li><li>在”系统变量”中找到 <code>Path</code></li><li>点击”编辑” → “新建”</li><li>添加路径：<code>C:\mariadb-connector-c\lib</code></li></ol><hr><h2 id="4-🛠️-配置-Visual-Studio-项目"><a href="#4-🛠️-配置-Visual-Studio-项目" class="headerlink" title="4. 🛠️ 配置 Visual Studio 项目"></a>4. 🛠️ 配置 Visual Studio 项目</h2><h3 id="4-1-📁-包含头文件目录"><a href="#4-1-📁-包含头文件目录" class="headerlink" title="4.1 📁 包含头文件目录"></a>4.1 📁 包含头文件目录</h3><ol><li>在 Visual Studio 中打开项目</li><li>右键点击项目名称，选择 <strong>“属性”</strong></li><li>导航到 <strong>“配置属性” → “C&#x2F;C++” → “常规” → “附加包含目录”</strong></li><li>添加以下路径：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\mariadb-connector-cpp\include</span><br><span class="line">C:\mariadb-connector-c\include</span><br></pre></td></tr></table></figure></li></ol><h3 id="4-2-🔗-配置库文件目录"><a href="#4-2-🔗-配置库文件目录" class="headerlink" title="4.2 🔗 配置库文件目录"></a>4.2 🔗 配置库文件目录</h3><p>在同一个属性页中：</p><ol><li>导航到 <strong>“配置属性” → “链接器” → “常规” → “附加库目录”</strong></li><li>添加以下路径：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C:\mariadb-connector-cpp\lib</span><br><span class="line">C:\mariadb-connector-c\lib</span><br></pre></td></tr></table></figure></li></ol><h3 id="4-3-📚-指定依赖的库文件"><a href="#4-3-📚-指定依赖的库文件" class="headerlink" title="4.3 📚 指定依赖的库文件"></a>4.3 📚 指定依赖的库文件</h3><ol><li>导航到 <strong>“配置属性” → “链接器” → “输入” → “附加依赖项”</strong></li><li>添加以下库文件（根据实际文件名可能略有不同）：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mariadbclient.lib</span><br><span class="line">libmariadb.lib</span><br><span class="line">mariadbcpp.lib</span><br></pre></td></tr></table></figure></li></ol><h3 id="4-4-📋-拷贝-DLL-文件"><a href="#4-4-📋-拷贝-DLL-文件" class="headerlink" title="4.4 📋 拷贝 DLL 文件"></a>4.4 📋 拷贝 DLL 文件</h3><p>确保程序运行时能找到必要的动态链接库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[Connector/lib] --&gt; B[项目输出目录]</span><br><span class="line">    A --&gt; C[libmariadb.dll]</span><br><span class="line">    A --&gt; D[mariadbcpp.dll]</span><br><span class="line">    B --&gt; E[Debug/Release文件夹]</span><br></pre></td></tr></table></figure><p><strong>需要复制的 DLL 文件</strong>：</p><ul><li><code>libmariadb.dll</code> (来自 Connector&#x2F;C)</li><li><code>mariadbcpp.dll</code> (来自 Connector&#x2F;C++)</li><li>其他依赖的 DLL 文件</li></ul><hr><h2 id="5-💻-编写测试代码"><a href="#5-💻-编写测试代码" class="headerlink" title="5. 💻 编写测试代码"></a>5. 💻 编写测试代码</h2><h3 id="5-1-📄-完整测试程序"><a href="#5-1-📄-完整测试程序" class="headerlink" title="5.1 📄 完整测试程序"></a>5.1 📄 完整测试程序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mariadb/conncpp.hpp&gt;</span> <span class="comment">// Connector/C++ 的主要头文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据库配置结构</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DatabaseConfig</span> &#123;</span><br><span class="line">    std::string host = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="type">int</span> port = <span class="number">3306</span>;</span><br><span class="line">    std::string database = <span class="string">&quot;test_db&quot;</span>;</span><br><span class="line">    std::string username = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    std::string password = <span class="string">&quot;your_root_password_here&quot;</span>; <span class="comment">// 替换为实际密码</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DatabaseConfig config;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;🔌 正在连接到 MariaDB 服务器...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 获取驱动实例</span></span><br><span class="line">        sql::mariadb::IMariaDBDriver* driver = sql::mariadb::<span class="built_in">get_driver_instance</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 配置数据库连接属性</span></span><br><span class="line">        sql::SQLString url = <span class="string">&quot;jdbc:mariadb://&quot;</span> + config.host + <span class="string">&quot;:&quot;</span> +</span><br><span class="line">                           std::<span class="built_in">to_string</span>(config.port) + <span class="string">&quot;/&quot;</span> + config.database;</span><br><span class="line"></span><br><span class="line">        sql::Properties properties;</span><br><span class="line">        properties[<span class="string">&quot;user&quot;</span>] = config.username;</span><br><span class="line">        properties[<span class="string">&quot;password&quot;</span>] = config.password;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 建立连接</span></span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::Connection&gt; <span class="title">conn</span><span class="params">(driver-&gt;connect(url, properties))</span></span>;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✅ 成功连接到 MariaDB 服务器！&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;📊 数据库: &quot;</span> &lt;&lt; config.database &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;🌐 主机: &quot;</span> &lt;&lt; config.host &lt;&lt; <span class="string">&quot;:&quot;</span> &lt;&lt; config.port &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 执行简单查询测试</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n🔍 执行测试查询...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::Statement&gt; <span class="title">stmt</span><span class="params">(conn-&gt;createStatement())</span></span>;</span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::ResultSet&gt; <span class="title">res</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            stmt-&gt;executeQuery(<span class="string">&quot;SELECT VERSION() as version, NOW() as current_time&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (res-&gt;<span class="built_in">next</span>()) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;📦 MariaDB 版本: &quot;</span> &lt;&lt; res-&gt;<span class="built_in">getString</span>(<span class="string">&quot;version&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;⏰ 当前时间: &quot;</span> &lt;&lt; res-&gt;<span class="built_in">getString</span>(<span class="string">&quot;current_time&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 创建测试表</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n🏗️  创建测试表...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        stmt-&gt;<span class="built_in">execute</span>(<span class="string">&quot;DROP TABLE IF EXISTS test_users&quot;</span>);</span><br><span class="line">        stmt-&gt;<span class="built_in">execute</span>(<span class="string">R&quot;(</span></span><br><span class="line"><span class="string">            CREATE TABLE test_users (</span></span><br><span class="line"><span class="string">                id INT AUTO_INCREMENT PRIMARY KEY,</span></span><br><span class="line"><span class="string">                username VARCHAR(50) NOT NULL,</span></span><br><span class="line"><span class="string">                email VARCHAR(100),</span></span><br><span class="line"><span class="string">                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP</span></span><br><span class="line"><span class="string">            )</span></span><br><span class="line"><span class="string">        )&quot;</span>);</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✅ 测试表创建成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 插入测试数据</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n📝 插入测试数据...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::PreparedStatement&gt; <span class="title">pstmt</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            conn-&gt;prepareStatement(<span class="string">&quot;INSERT INTO test_users (username, email) VALUES (?, ?)&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line"></span><br><span class="line">        pstmt-&gt;<span class="built_in">setString</span>(<span class="number">1</span>, <span class="string">&quot;test_user1&quot;</span>);</span><br><span class="line">        pstmt-&gt;<span class="built_in">setString</span>(<span class="number">2</span>, <span class="string">&quot;user1@example.com&quot;</span>);</span><br><span class="line">        pstmt-&gt;<span class="built_in">executeUpdate</span>();</span><br><span class="line"></span><br><span class="line">        pstmt-&gt;<span class="built_in">setString</span>(<span class="number">1</span>, <span class="string">&quot;test_user2&quot;</span>);</span><br><span class="line">        pstmt-&gt;<span class="built_in">setString</span>(<span class="number">2</span>, <span class="string">&quot;user2@example.com&quot;</span>);</span><br><span class="line">        pstmt-&gt;<span class="built_in">executeUpdate</span>();</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✅ 测试数据插入成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 查询测试数据</span></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n📋 查询测试数据...&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::ResultSet&gt; <span class="title">selectRes</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            stmt-&gt;executeQuery(<span class="string">&quot;SELECT * FROM test_users ORDER BY id&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;+----+------------+---------------------+---------------------+&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;| ID | Username   | Email               | Created At          |&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;+----+------------+---------------------+---------------------+&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (selectRes-&gt;<span class="built_in">next</span>()) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;| &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">2</span>) &lt;&lt; selectRes-&gt;<span class="built_in">getInt</span>(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; | &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">10</span>) &lt;&lt; selectRes-&gt;<span class="built_in">getString</span>(<span class="string">&quot;username&quot;</span>)</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; | &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">19</span>) &lt;&lt; selectRes-&gt;<span class="built_in">getString</span>(<span class="string">&quot;email&quot;</span>)</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; | &quot;</span> &lt;&lt; std::<span class="built_in">setw</span>(<span class="number">19</span>) &lt;&lt; selectRes-&gt;<span class="built_in">getString</span>(<span class="string">&quot;created_at&quot;</span>)</span><br><span class="line">                      &lt;&lt; <span class="string">&quot; |&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;+----+------------+---------------------+---------------------+&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. 统计记录数</span></span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::ResultSet&gt; <span class="title">countRes</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            stmt-&gt;executeQuery(<span class="string">&quot;SELECT COUNT(*) as total FROM test_users&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (countRes-&gt;<span class="built_in">next</span>()) &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;\n📊 总记录数: &quot;</span> &lt;&lt; countRes-&gt;<span class="built_in">getInt</span>(<span class="string">&quot;total&quot;</span>) &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;\n🎉 所有测试通过！MariaDB C++ 连接配置成功！&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="built_in">catch</span> (sql::SQLException&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;❌ 数据库连接或查询错误:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;   错误信息: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;   错误代码: &quot;</span> &lt;&lt; e.<span class="built_in">getErrorCode</span>() &lt;&lt; std::endl;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;   SQL状态: &quot;</span> &lt;&lt; e.<span class="built_in">getSQLState</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="built_in">catch</span> (std::exception&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;❌ 程序错误: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-🏃‍♂️-运行测试"><a href="#5-2-🏃‍♂️-运行测试" class="headerlink" title="5.2 🏃‍♂️ 运行测试"></a>5.2 🏃‍♂️ 运行测试</h3><ol><li><p><strong>编译项目</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Build → Build Solution (Ctrl+Shift+B)</span><br></pre></td></tr></table></figure></li><li><p><strong>运行程序</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Debug → Start Without Debugging (Ctrl+F5)</span><br></pre></td></tr></table></figure></li><li><p><strong>预期输出</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">🔌 正在连接到 MariaDB 服务器...</span><br><span class="line">✅ 成功连接到 MariaDB 服务器！</span><br><span class="line">📊 数据库: test_db</span><br><span class="line">🌐 主机: localhost:3306</span><br><span class="line"></span><br><span class="line">🔍 执行测试查询...</span><br><span class="line">📦 MariaDB 版本: 11.8.0</span><br><span class="line">⏰ 当前时间: 2025-11-14 16:30:00</span><br><span class="line"></span><br><span class="line">🏗️  创建测试表...</span><br><span class="line">✅ 测试表创建成功</span><br><span class="line"></span><br><span class="line">📝 插入测试数据...</span><br><span class="line">✅ 测试数据插入成功</span><br><span class="line"></span><br><span class="line">📋 查询测试数据...</span><br><span class="line">+----+------------+---------------------+---------------------+</span><br><span class="line">| ID | Username   | Email               | Created At          |</span><br><span class="line">+----+------------+---------------------+---------------------+</span><br><span class="line">|  1 | test_user1 | user1@example.com   | 2025-11-14 16:30:01 |</span><br><span class="line">|  2 | test_user2 | user2@example.com   | 2025-11-14 16:30:01 |</span><br><span class="line">+----+------------+---------------------+---------------------+</span><br><span class="line"></span><br><span class="line">📊 总记录数: 2</span><br><span class="line"></span><br><span class="line">🎉 所有测试通过！MariaDB C++ 连接配置成功！</span><br></pre></td></tr></table></figure></li></ol><hr><h2 id="6-🔧-常见问题和解决方案"><a href="#6-🔧-常见问题和解决方案" class="headerlink" title="6. 🔧 常见问题和解决方案"></a>6. 🔧 常见问题和解决方案</h2><h3 id="6-1-❌-连接失败"><a href="#6-1-❌-连接失败" class="headerlink" title="6.1 ❌ 连接失败"></a>6.1 ❌ 连接失败</h3><p><strong>错误信息</strong>: <code>Can&#39;t connect to MySQL server</code></p><p><strong>解决方案</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[连接失败] --&gt; B&#123;检查项目&#125;</span><br><span class="line">    B --&gt; C[MariaDB服务是否启动]</span><br><span class="line">    B --&gt; D[端口3306是否被占用]</span><br><span class="line">    B --&gt; E[防火墙设置]</span><br><span class="line">    B --&gt; F[用户名密码是否正确]</span><br><span class="line"></span><br><span class="line">    C --&gt; G[启动服务: net start mysql]</span><br><span class="line">    D --&gt; H[更换端口或释放端口]</span><br><span class="line">    E --&gt; I[添加防火墙例外]</span><br><span class="line">    F --&gt; J[重置root密码]</span><br></pre></td></tr></table></figure><h3 id="6-2-❌-DLL-找不到"><a href="#6-2-❌-DLL-找不到" class="headerlink" title="6.2 ❌ DLL 找不到"></a>6.2 ❌ DLL 找不到</h3><p><strong>错误信息</strong>: <code>无法启动此程序，因为计算机中丢失 libmariadb.dll</code></p><p><strong>解决方案</strong>:</p><ol><li>确认 DLL 文件在正确位置</li><li>检查 PATH 环境变量</li><li>将 DLL 复制到项目输出目录</li></ol><h3 id="6-3-❌-编译错误"><a href="#6-3-❌-编译错误" class="headerlink" title="6.3 ❌ 编译错误"></a>6.3 ❌ 编译错误</h3><p><strong>常见编译错误及解决方案</strong>:</p><table><thead><tr><th>错误信息</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><code>无法找到头文件</code></td><td>Include 目录未正确配置</td><td>检查附加包含目录设置</td></tr><tr><td><code>无法解析的外部符号</code></td><td>库文件未正确链接</td><td>检查附加依赖项和库目录</td></tr><tr><td><code>字符集不匹配</code></td><td>Unicode&#x2F;ANSI 编码问题</td><td>在项目设置中统一字符集</td></tr></tbody></table><hr><h2 id="7-🚀-高级配置"><a href="#7-🚀-高级配置" class="headerlink" title="7. 🚀 高级配置"></a>7. 🚀 高级配置</h2><h3 id="7-1-🔐-连接池配置"><a href="#7-1-🔐-连接池配置" class="headerlink" title="7.1 🔐 连接池配置"></a>7.1 🔐 连接池配置</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mariadb/conncpp.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MariaDBConnectionPool</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::unique_ptr&lt;sql::mariadb::IMariaDBDriver&gt; driver;</span><br><span class="line">    sql::SQLString url;</span><br><span class="line">    sql::Properties properties;</span><br><span class="line">    std::vector&lt;std::unique_ptr&lt;sql::Connection&gt;&gt; connections;</span><br><span class="line">    std::mutex mutex;</span><br><span class="line">    <span class="type">int</span> maxConnections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MariaDBConnectionPool</span>(<span class="type">const</span> std::string&amp; host, <span class="type">int</span> port,</span><br><span class="line">                         <span class="type">const</span> std::string&amp; database,</span><br><span class="line">                         <span class="type">const</span> std::string&amp; username,</span><br><span class="line">                         <span class="type">const</span> std::string&amp; password,</span><br><span class="line">                         <span class="type">int</span> maxConn = <span class="number">10</span>)</span><br><span class="line">        : <span class="built_in">maxConnections</span>(maxConn) &#123;</span><br><span class="line"></span><br><span class="line">        driver = std::<span class="built_in">unique_ptr</span>&lt;sql::mariadb::IMariaDBDriver&gt;(</span><br><span class="line">            sql::mariadb::<span class="built_in">get_driver_instance</span>()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        url = <span class="string">&quot;jdbc:mariadb://&quot;</span> + host + <span class="string">&quot;:&quot;</span> + std::<span class="built_in">to_string</span>(port) + <span class="string">&quot;/&quot;</span> + database;</span><br><span class="line"></span><br><span class="line">        properties[<span class="string">&quot;user&quot;</span>] = username;</span><br><span class="line">        properties[<span class="string">&quot;password&quot;</span>] = password;</span><br><span class="line">        properties[<span class="string">&quot;autoReconnect&quot;</span>] = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">        properties[<span class="string">&quot;useSSL&quot;</span>] = <span class="string">&quot;false&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::unique_ptr&lt;sql::Connection&gt; <span class="title">getConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; conn : connections) &#123;</span><br><span class="line">            <span class="keyword">if</span> (conn &amp;&amp; !conn-&gt;<span class="built_in">isClosed</span>()) &#123;</span><br><span class="line">                <span class="keyword">return</span> std::<span class="built_in">move</span>(conn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建新连接</span></span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;sql::Connection&gt;(</span><br><span class="line">            driver-&gt;<span class="built_in">connect</span>(url, properties)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">returnConnection</span><span class="params">(std::unique_ptr&lt;sql::Connection&gt; conn)</span> </span>&#123;</span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (conn &amp;&amp; connections.<span class="built_in">size</span>() &lt; maxConnections) &#123;</span><br><span class="line">            connections.<span class="built_in">push_back</span>(std::<span class="built_in">move</span>(conn));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="7-2-📝-事务处理"><a href="#7-2-📝-事务处理" class="headerlink" title="7.2 📝 事务处理"></a>7.2 📝 事务处理</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">transactionExample</span><span class="params">(std::unique_ptr&lt;sql::Connection&gt;&amp; conn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 开始事务</span></span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::Statement&gt; <span class="title">stmt</span><span class="params">(conn-&gt;createStatement())</span></span>;</span><br><span class="line">        stmt-&gt;<span class="built_in">execute</span>(<span class="string">&quot;START TRANSACTION&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行多个SQL操作</span></span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::PreparedStatement&gt; <span class="title">pstmt</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            conn-&gt;prepareStatement(<span class="string">&quot;UPDATE accounts SET balance = balance - ? WHERE id = ?&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 扣款</span></span><br><span class="line">        pstmt-&gt;<span class="built_in">setDouble</span>(<span class="number">1</span>, <span class="number">100.0</span>);</span><br><span class="line">        pstmt-&gt;<span class="built_in">setInt</span>(<span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">        pstmt-&gt;<span class="built_in">executeUpdate</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加款</span></span><br><span class="line">        pstmt-&gt;<span class="built_in">setDouble</span>(<span class="number">1</span>, <span class="number">100.0</span>);</span><br><span class="line">        pstmt-&gt;<span class="built_in">setInt</span>(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">        pstmt-&gt;<span class="built_in">executeUpdate</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 提交事务</span></span><br><span class="line">        conn-&gt;<span class="built_in">commit</span>();</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✅ 事务执行成功&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="built_in">catch</span> (sql::SQLException&amp; e) &#123;</span><br><span class="line">        <span class="comment">// 回滚事务</span></span><br><span class="line">        conn-&gt;<span class="built_in">rollback</span>();</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;❌ 事务执行失败，已回滚: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-3-🌍-国际化支持"><a href="#7-3-🌍-国际化支持" class="headerlink" title="7.3 🌍 国际化支持"></a>7.3 🌍 国际化支持</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">setupUTF8Connection</span><span class="params">(std::unique_ptr&lt;sql::Connection&gt;&amp; conn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 设置连接字符集</span></span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::Statement&gt; <span class="title">stmt</span><span class="params">(conn-&gt;createStatement())</span></span>;</span><br><span class="line">        stmt-&gt;<span class="built_in">execute</span>(<span class="string">&quot;SET NAMES &#x27;utf8mb4&#x27;&quot;</span>);</span><br><span class="line">        stmt-&gt;<span class="built_in">execute</span>(<span class="string">&quot;SET CHARACTER SET utf8mb4&quot;</span>);</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;✅ UTF-8 字符集配置完成&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 测试中文支持</span></span><br><span class="line">        <span class="function">std::unique_ptr&lt;sql::PreparedStatement&gt; <span class="title">pstmt</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            conn-&gt;prepareStatement(<span class="string">&quot;INSERT INTO test_table (name) VALUES (?)&quot;</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span></span>;</span><br><span class="line">        pstmt-&gt;<span class="built_in">setString</span>(<span class="number">1</span>, <span class="string">&quot;测试中文字符&quot;</span>);</span><br><span class="line">        pstmt-&gt;<span class="built_in">executeUpdate</span>();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="built_in">catch</span> (sql::SQLException&amp; e) &#123;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">&quot;❌ UTF-8 配置失败: &quot;</span> &lt;&lt; e.<span class="built_in">what</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="📊-总结"><a href="#📊-总结" class="headerlink" title="📊 总结"></a>📊 总结</h2><h3 id="✅-成功标志"><a href="#✅-成功标志" class="headerlink" title="✅ 成功标志"></a>✅ 成功标志</h3><ul><li><input checked="" disabled="" type="checkbox"> MariaDB 服务器安装完成</li><li><input checked="" disabled="" type="checkbox"> Connector&#x2F;C 和 Connector&#x2F;C++ 安装完成</li><li><input checked="" disabled="" type="checkbox"> Visual Studio 项目配置正确</li><li><input checked="" disabled="" type="checkbox"> 测试程序运行成功</li><li><input checked="" disabled="" type="checkbox"> 基本数据库操作正常</li></ul><h3 id="🎯-下一步建议"><a href="#🎯-下一步建议" class="headerlink" title="🎯 下一步建议"></a>🎯 下一步建议</h3><ol><li><strong>学习高级 SQL 操作</strong>：存储过程、触发器、视图</li><li><strong>掌握连接池技术</strong>：提高应用程序性能</li><li><strong>了解事务处理</strong>：确保数据一致性</li><li><strong>实现错误处理</strong>：增强程序健壮性</li><li><strong>安全配置</strong>：防止 SQL 注入攻击</li></ol><h3 id="📚-推荐资源"><a href="#📚-推荐资源" class="headerlink" title="📚 推荐资源"></a>📚 推荐资源</h3><ul><li><a href="https://mariadb.com/docs/clients/connector-cpp/">MariaDB Connector&#x2F;C++ 官方文档</a></li><li><a href="https://www.w3schools.com/sql/">SQL 基础教程</a></li><li><a href="https://isocpp.org/">C++ 数据库编程最佳实践</a></li></ul><hr><blockquote><p><strong>💡 提示</strong>: 在生产环境中，请务必：</p><ul><li>使用强密码和连接加密</li><li>实施适当的错误处理和日志记录</li><li>定期备份数据库</li><li>监控数据库性能和安全</li></ul></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;MariaDB-C-Windows-安装指南&quot;&gt;&lt;a href=&quot;#MariaDB-C-Windows-安装指南&quot; class=&quot;headerlink&quot; title=&quot;MariaDB C++ Windows 安装指南&quot;&gt;&lt;/a&gt;MariaDB C++</summary>
        
      
    
    
    
    <category term="数据库系统" scheme="https://vilaswang.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="关系型数据库" scheme="https://vilaswang.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL C++ Windows 安装指南</title>
    <link href="https://vilaswang.github.io/posts/b71a62b0/"/>
    <id>https://vilaswang.github.io/posts/b71a62b0/</id>
    <published>2025-12-09T06:09:56.000Z</published>
    <updated>2025-12-17T15:36:29.279Z</updated>
    
    <content type="html"><![CDATA[<h1 id="PostgreSQL-C-Windows-安装指南"><a href="#PostgreSQL-C-Windows-安装指南" class="headerlink" title="PostgreSQL C++ Windows 安装指南"></a>PostgreSQL C++ Windows 安装指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>postgresql</code>, <code>c</code>, <code>windows</code>, <code>development</code>, <code>database</code>, <code>libpq</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E7%B3%BB%E7%BB%9F%E7%BB%84%E4%BB%B6">2. 系统组件</a></li><li><a href="#3-postgresql-%E5%AE%89%E8%A3%85">3. PostgreSQL 安装</a><ul><li><a href="#31-%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E5%8C%85">3.1 下载安装包</a></li><li><a href="#32-%E8%BF%90%E8%A1%8C%E5%AE%89%E8%A3%85%E7%A8%8B%E5%BA%8F">3.2 运行安装程序</a></li></ul></li><li><a href="#4-c-%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">4. C 开发环境配置</a><ul><li><a href="#41-%E5%8C%85%E5%90%AB%E5%A4%B4%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE">4.1 包含头文件配置</a></li><li><a href="#42-%E9%93%BE%E6%8E%A5%E5%BA%93%E9%85%8D%E7%BD%AE">4.2 链接库配置</a></li><li><a href="#43-%E8%BF%90%E8%A1%8C%E6%97%B6%E4%BE%9D%E8%B5%96%E9%85%8D%E7%BD%AE">4.3 运行时依赖配置</a></li></ul></li><li><a href="#5-%E9%AA%8C%E8%AF%81%E4%B8%8E%E6%B5%8B%E8%AF%95">5. 验证与测试</a></li><li><a href="#6-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3">6. 常见问题解决</a></li><li><a href="#7-%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE">7. 高级配置</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>本指南详细说明如何在 Windows 系统上配置 PostgreSQL 的 C 语言开发环境，包括服务器安装、客户端库配置和开发环境设置。</p><h3 id="🎯-配置目标"><a href="#🎯-配置目标" class="headerlink" title="🎯 配置目标"></a>🎯 配置目标</h3><ul><li>✅ 安装 PostgreSQL 数据库服务器</li><li>✅ 配置 C 语言客户端库 (libpq)</li><li>✅ 设置开发环境和编译选项</li><li>✅ 创建可运行的 C 数据库应用程序</li></ul><h3 id="🏗️-系统架构"><a href="#🏗️-系统架构" class="headerlink" title="🏗️ 系统架构"></a>🏗️ 系统架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[C Application] --&gt; B[libpq Client Library]</span><br><span class="line">    B --&gt; C[PostgreSQL Server]</span><br><span class="line">    C --&gt; D[Database Files]</span><br><span class="line"></span><br><span class="line">    E[Visual Studio] --&gt; F[Project Configuration]</span><br><span class="line">    F --&gt; G[Include Directories]</span><br><span class="line">    F --&gt; H[Library Directories]</span><br><span class="line">    F --&gt; I[Dependencies]</span><br><span class="line"></span><br><span class="line">    G --&gt; J[postgresql/include]</span><br><span class="line">    H --&gt; K[postgresql/lib]</span><br><span class="line">    I --&gt; L[libpq.lib]</span><br></pre></td></tr></table></figure><hr><h2 id="2-🔧-系统组件"><a href="#2-🔧-系统组件" class="headerlink" title="2. 🔧 系统组件"></a>2. 🔧 系统组件</h2><table><thead><tr><th>组件</th><th>主要作用</th><th>获取与说明</th></tr></thead><tbody><tr><td><strong>PostgreSQL 服务器</strong></td><td>提供数据库服务核心，包含运行实例所需的所有程序</td><td>从官网下载安装包，通常自动安装</td></tr><tr><td><strong>C客户端库 (libpq)</strong></td><td>C程序连接和操作PostgreSQL数据库的主要库，包含头文件和链接库</td><td><strong>安装时必须勾选 “PostgreSQL C Libraries (libpq)”</strong></td></tr><tr><td><strong>Command Line Tools</strong></td><td>提供 <code>psql</code> 等命令行工具，用于数据库管理和调试</td><td>推荐安装，便于开发和测试</td></tr><tr><td><strong>pgAdmin</strong></td><td>图形化管理工具，可视化管理数据库</td><td>可选安装，便于日常管理</td></tr></tbody></table><hr><h2 id="3-💾-PostgreSQL-安装"><a href="#3-💾-PostgreSQL-安装" class="headerlink" title="3. 💾 PostgreSQL 安装"></a>3. 💾 PostgreSQL 安装</h2><h3 id="3-1-🌐-下载安装包"><a href="#3-1-🌐-下载安装包" class="headerlink" title="3.1 🌐 下载安装包"></a>3.1 🌐 下载安装包</h3><p>访问 <a href="https://www.postgresql.org/download/windows/">PostgreSQL官网下载页面</a>：</p><p><strong>推荐版本选择</strong>：</p><ul><li><strong>最新稳定版</strong>: PostgreSQL 16.x</li><li><strong>架构</strong>: x64 (64位)</li><li><strong>安装包格式</strong>: Windows exe 安装程序</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[访问官网] --&gt; B[选择Windows版本]</span><br><span class="line">    B --&gt; C[下载安装包]</span><br><span class="line">    C --&gt; D[运行安装程序]</span><br><span class="line">    D --&gt; E[配置组件选择]</span><br><span class="line">    E --&gt; F[完成安装]</span><br></pre></td></tr></table></figure><h3 id="3-2-⚙️-运行安装程序"><a href="#3-2-⚙️-运行安装程序" class="headerlink" title="3.2 ⚙️ 运行安装程序"></a>3.2 ⚙️ 运行安装程序</h3><ol><li><p><strong>启动安装程序</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以管理员权限运行</span></span><br><span class="line">postgresql-16.1-1-windows-x64.exe</span><br></pre></td></tr></table></figure></li><li><p><strong>组件选择界面</strong></p><p><strong>关键步骤</strong>：在 <strong>“Select Components”</strong> 界面，请确保勾选以下选项：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">✅ PostgreSQL Server                    (必须)</span><br><span class="line">✅ Command Line Tools                  (推荐)</span><br><span class="line">✅ PostgreSQL C Libraries (libpq)     (必须)</span><br><span class="line">✅ pgAdmin 4                          (可选)</span><br></pre></td></tr></table></figure></li><li><p><strong>重要配置项</strong></p><table><thead><tr><th>配置项</th><th>推荐设置</th><th>说明</th></tr></thead><tbody><tr><td><strong>安装目录</strong></td><td><code>C:\Program Files\PostgreSQL\16</code></td><td>默认路径，避免包含空格或中文</td></tr><tr><td><strong>数据目录</strong></td><td><code>C:\Program Files\PostgreSQL\16\data</code></td><td>数据库存储位置</td></tr><tr><td><strong>超级用户密码</strong></td><td>强密码</td><td>记住postgres用户密码</td></tr><tr><td><strong>端口</strong></td><td><code>5432</code></td><td>默认端口，确保未被占用</td></tr><tr><td><strong>区域设置</strong></td><td><code>Chinese (Simplified), China</code></td><td>或根据需要选择</td></tr></tbody></table></li><li><p><strong>安装完成验证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查服务状态</span></span><br><span class="line">services.msc  <span class="comment"># 查看postgresql服务是否运行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试连接</span></span><br><span class="line">psql -U postgres -h localhost</span><br></pre></td></tr></table></figure></li></ol><hr><h2 id="4-🛠️-C-开发环境配置"><a href="#4-🛠️-C-开发环境配置" class="headerlink" title="4. 🛠️ C 开发环境配置"></a>4. 🛠️ C 开发环境配置</h2><p>安装完成后，PostgreSQL 通常位于 <code>C:\Program Files\PostgreSQL\16</code> 目录。</p><h3 id="4-1-📁-包含头文件配置"><a href="#4-1-📁-包含头文件配置" class="headerlink" title="4.1 📁 包含头文件配置"></a>4.1 📁 包含头文件配置</h3><p><strong>头文件路径</strong>: <code>C:\Program Files\PostgreSQL\16\include</code></p><p><strong>关键头文件</strong>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libpq-fe.h&gt;</span>          <span class="comment">// 主要的客户端接口</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libpq/libpq-fs.h&gt;</span>    <span class="comment">// 大对象支持</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;postgres_ext.h&gt;</span>      <span class="comment">// PostgreSQL 扩展定义</span></span></span><br></pre></td></tr></table></figure><p><strong>Visual Studio 配置</strong>:</p><ol><li>右键项目 → 属性</li><li><strong>配置属性</strong> → <strong>C&#x2F;C++</strong> → <strong>常规</strong></li><li><strong>附加包含目录</strong> 添加：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\PostgreSQL\16\include</span><br></pre></td></tr></table></figure></li></ol><h3 id="4-2-🔗-链接库配置"><a href="#4-2-🔗-链接库配置" class="headerlink" title="4.2 🔗 链接库配置"></a>4.2 🔗 链接库配置</h3><p><strong>库文件路径</strong>: <code>C:\Program Files\PostgreSQL\16\lib</code></p><p><strong>主要库文件</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libpq.lib        // 主要的客户端库</span><br><span class="line">ws2_32.lib       // Windows Socket 库</span><br><span class="line">advapi32.lib     // Windows API 库</span><br></pre></td></tr></table></figure><p><strong>Visual Studio 配置</strong>:</p><ol><li><p><strong>配置属性</strong> → <strong>链接器</strong> → <strong>常规</strong></p></li><li><p><strong>附加库目录</strong> 添加：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\PostgreSQL\16\lib</span><br></pre></td></tr></table></figure></li><li><p><strong>配置属性</strong> → <strong>链接器</strong> → <strong>输入</strong></p></li><li><p><strong>附加依赖项</strong> 添加：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libpq.lib;ws2_32.lib;advapi32.lib;</span><br></pre></td></tr></table></figure></li></ol><h3 id="4-3-🔄-运行时依赖配置"><a href="#4-3-🔄-运行时依赖配置" class="headerlink" title="4.3 🔄 运行时依赖配置"></a>4.3 🔄 运行时依赖配置</h3><p><strong>DLL 文件</strong>: <code>C:\Program Files\PostgreSQL\16\bin\libpq.dll</code></p><p><strong>配置方法 (三选一)</strong>:</p><h4 id="方法一：环境变量配置-推荐"><a href="#方法一：环境变量配置-推荐" class="headerlink" title="方法一：环境变量配置 (推荐)"></a>方法一：环境变量配置 (推荐)</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># PostgreSQL C++ Windows 安装指南</span><br><span class="line">setx <span class="built_in">PATH</span> &quot;<span class="variable">%PATH%</span>;C:\Program Files\PostgreSQL\<span class="number">16</span>\bin&quot;</span><br><span class="line"></span><br><span class="line"># PostgreSQL C++ Windows 安装指南</span><br><span class="line"># PostgreSQL C++ Windows 安装指南</span><br></pre></td></tr></table></figure><h4 id="方法二：项目配置"><a href="#方法二：项目配置" class="headerlink" title="方法二：项目配置"></a>方法二：项目配置</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># PostgreSQL C++ Windows 安装指南</span><br><span class="line"><span class="built_in">set</span> <span class="built_in">PATH</span>=C:\Program Files\PostgreSQL\<span class="number">16</span>\bin;<span class="variable">%PATH%</span></span><br><span class="line">your_app.exe</span><br></pre></td></tr></table></figure><h4 id="方法三：复制-DLL"><a href="#方法三：复制-DLL" class="headerlink" title="方法三：复制 DLL"></a>方法三：复制 DLL</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># PostgreSQL C++ Windows 安装指南</span><br><span class="line"><span class="built_in">copy</span> &quot;C:\Program Files\PostgreSQL\<span class="number">16</span>\bin\libpq.dll&quot; &quot;your_project_dir\Debug\&quot;</span><br><span class="line"><span class="built_in">copy</span> &quot;C:\Program Files\PostgreSQL\<span class="number">16</span>\bin\libpq.dll&quot; &quot;your_project_dir\Release\&quot;</span><br></pre></td></tr></table></figure><hr><h2 id="5-🧪-验证与测试"><a href="#5-🧪-验证与测试" class="headerlink" title="5. 🧪 验证与测试"></a>5. 🧪 验证与测试</h2><h3 id="5-1-📄-测试程序"><a href="#5-1-📄-测试程序" class="headerlink" title="5.1 📄 测试程序"></a>5.1 📄 测试程序</h3><p>创建测试文件 <code>test_pgsql.c</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;libpq-fe.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;🐘 PostgreSQL C Development Environment Test\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;=============================================\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 检查 libpq 版本</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;📋 libpq Library Information:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   Version: %s\n&quot;</span>, PQlibVersion());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 连接字符串</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *conninfo = <span class="string">&quot;host=localhost port=5432 dbname=postgres user=postgres password=your_password&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n🔌 Attempting to connect to PostgreSQL...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 建立连接</span></span><br><span class="line">    PGconn *conn = PQconnectdb(conninfo);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PQstatus(conn) != CONNECTION_OK) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;❌ Connection failed: %s\n&quot;</span>, PQerrorMessage(conn));</span><br><span class="line">        PQfinish(conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;✅ Connection established successfully!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 获取服务器信息</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n📊 Server Information:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   Host: %s\n&quot;</span>, PQhost(conn));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   Port: %s\n&quot;</span>, PQport(conn));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   Database: %s\n&quot;</span>, PQdb(conn));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   User: %s\n&quot;</span>, PQuser(conn));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 执行简单查询</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n🔍 Executing test query...\n&quot;</span>);</span><br><span class="line">    PGresult *res = PQexec(conn, <span class="string">&quot;SELECT version() as version, current_database() as database&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PQresultStatus(res) != PGRES_TUPLES_OK) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;❌ Query failed: %s\n&quot;</span>, PQerrorMessage(conn));</span><br><span class="line">        PQclear(res);</span><br><span class="line">        PQfinish(conn);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 显示查询结果</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;✅ Query executed successfully!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;📋 Query Results:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> rows = PQntuples(res);</span><br><span class="line">    <span class="type">int</span> cols = PQnfields(res);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; rows; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; cols; j++) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;   %s: %s\n&quot;</span>, PQfname(res, j), PQgetvalue(res, i, j));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. 清理资源</span></span><br><span class="line">    PQclear(res);</span><br><span class="line">    PQfinish(conn);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n🎉 All tests completed successfully!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;🚀 Your PostgreSQL C development environment is ready!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-2-🔨-编译命令"><a href="#5-2-🔨-编译命令" class="headerlink" title="5.2 🔨 编译命令"></a>5.2 🔨 编译命令</h3><h4 id="Visual-Studio-编译"><a href="#Visual-Studio-编译" class="headerlink" title="Visual Studio 编译"></a>Visual Studio 编译</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line">msbuild YourProject.vcxproj /p:Configuration=Debug</span><br></pre></td></tr></table></figure><h4 id="命令行编译-cl-exe"><a href="#命令行编译-cl-exe" class="headerlink" title="命令行编译 (cl.exe)"></a>命令行编译 (cl.exe)</h4><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># PostgreSQL C++ Windows 安装指南</span><br><span class="line">&quot;C:\Program Files (x86)\Microsoft Visual Studio\<span class="number">2019</span>\Enterprise\VC\Auxiliary\Build\vcvars64.bat&quot;</span><br><span class="line"></span><br><span class="line"># PostgreSQL C++ Windows 安装指南</span><br><span class="line">cl /EHsc /I&quot;C:\Program Files\PostgreSQL\<span class="number">16</span>\include&quot; ^</span><br><span class="line">   test_pgsql.c /link ^</span><br><span class="line">   /LIBPATH:&quot;C:\Program Files\PostgreSQL\<span class="number">16</span>\lib&quot; ^</span><br><span class="line">   libpq.lib ws2_32.lib advapi32.lib</span><br></pre></td></tr></table></figure><h4 id="GCC-MinGW-编译"><a href="#GCC-MinGW-编译" class="headerlink" title="GCC (MinGW) 编译"></a>GCC (MinGW) 编译</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gcc -o test_pgsql test_pgsql.c ^</span><br><span class="line">   -I<span class="string">&quot;C:\Program Files\PostgreSQL\16\include&quot;</span> ^</span><br><span class="line">   -L<span class="string">&quot;C:\Program Files\PostgreSQL\16\lib&quot;</span> ^</span><br><span class="line">   -lpq -lws2_32 -ladvapi32</span><br></pre></td></tr></table></figure><h3 id="5-3-✅-预期输出"><a href="#5-3-✅-预期输出" class="headerlink" title="5.3 ✅ 预期输出"></a>5.3 ✅ 预期输出</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">🐘 PostgreSQL C Development Environment Test</span><br><span class="line">=============================================</span><br><span class="line"></span><br><span class="line">📋 libpq Library Information:</span><br><span class="line">   Version: 160001</span><br><span class="line"></span><br><span class="line">🔌 Attempting to connect to PostgreSQL...</span><br><span class="line">✅ Connection established successfully!</span><br><span class="line"></span><br><span class="line">📊 Server Information:</span><br><span class="line">   Host: localhost</span><br><span class="line">   Port: 5432</span><br><span class="line">   Database: postgres</span><br><span class="line">   User: postgres</span><br><span class="line"></span><br><span class="line">🔍 Executing test query...</span><br><span class="line">✅ Query executed successfully!</span><br><span class="line">📋 Query Results:</span><br><span class="line">   version: PostgreSQL 16.1, compiled by Visual C++ build 1938, 64-bit</span><br><span class="line">   database: postgres</span><br><span class="line"></span><br><span class="line">🎉 All tests completed successfully!</span><br><span class="line">🚀 Your PostgreSQL C development environment is ready!</span><br></pre></td></tr></table></figure><hr><h2 id="6-🔧-常见问题解决"><a href="#6-🔧-常见问题解决" class="headerlink" title="6. 🔧 常见问题解决"></a>6. 🔧 常见问题解决</h2><h3 id="6-1-❌-编译错误"><a href="#6-1-❌-编译错误" class="headerlink" title="6.1 ❌ 编译错误"></a>6.1 ❌ 编译错误</h3><h4 id="错误-无法打开源文件-libpq-fe-h"><a href="#错误-无法打开源文件-libpq-fe-h" class="headerlink" title="错误: 无法打开源文件: &#39;libpq-fe.h&#39;"></a>错误: <code>无法打开源文件: &#39;libpq-fe.h&#39;</code></h4><p><strong>解决方案</strong>:</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="string">&quot;C:/Program Files/PostgreSQL/16/include&quot;</span>)</span><br></pre></td></tr></table></figure><h4 id="错误-无法解析的外部符号-PQconnectdb"><a href="#错误-无法解析的外部符号-PQconnectdb" class="headerlink" title="错误: 无法解析的外部符号 _PQconnectdb"></a>错误: <code>无法解析的外部符号 _PQconnectdb</code></h4><p><strong>解决方案</strong>:</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="keyword">link_directories</span>(<span class="string">&quot;C:/Program Files/PostgreSQL/16/lib&quot;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(your_target libpq ws2_32 advapi32)</span><br></pre></td></tr></table></figure><h3 id="6-2-❌-运行时错误"><a href="#6-2-❌-运行时错误" class="headerlink" title="6.2 ❌ 运行时错误"></a>6.2 ❌ 运行时错误</h3><h4 id="错误-无法启动此程序，因为计算机中缺少-libpq-dll"><a href="#错误-无法启动此程序，因为计算机中缺少-libpq-dll" class="headerlink" title="错误: 无法启动此程序，因为计算机中缺少 libpq.dll"></a>错误: <code>无法启动此程序，因为计算机中缺少 libpq.dll</code></h4><p><strong>解决方案</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[缺少 libpq.dll] --&gt; B&#123;解决方案&#125;</span><br><span class="line">    B --&gt; C[添加 PATH 环境变量]</span><br><span class="line">    B --&gt; D[复制 DLL 到程序目录]</span><br><span class="line">    B --&gt; E[使用 Visual Studio 调试环境]</span><br><span class="line"></span><br><span class="line">    C --&gt; F[系统属性 → 环境变量 → PATH]</span><br><span class="line">    D --&gt; G[复制到 Debug/Release 文件夹]</span><br><span class="line">    E --&gt; H[项目属性 → 调试 → 环境]</span><br></pre></td></tr></table></figure><h4 id="错误-connection-to-server-at-localhost-1-port-5432-failed"><a href="#错误-connection-to-server-at-localhost-1-port-5432-failed" class="headerlink" title="错误: connection to server at &quot;localhost&quot; (::1), port 5432 failed"></a>错误: <code>connection to server at &quot;localhost&quot; (::1), port 5432 failed</code></h4><p><strong>解决方案</strong>:</p><ol><li>检查 PostgreSQL 服务是否启动</li><li>验证端口和主机配置</li><li>检查防火墙设置</li></ol><h3 id="6-3-❌-权限问题"><a href="#6-3-❌-权限问题" class="headerlink" title="6.3 ❌ 权限问题"></a>6.3 ❌ 权限问题</h3><h4 id="错误-FATAL-password-authentication-failed-for-user-postgres"><a href="#错误-FATAL-password-authentication-failed-for-user-postgres" class="headerlink" title="错误: FATAL: password authentication failed for user &quot;postgres&quot;"></a>错误: <code>FATAL: password authentication failed for user &quot;postgres&quot;</code></h4><p><strong>解决方案</strong>:</p><ol><li>确认密码正确</li><li>检查 <code>pg_hba.conf</code> 认证配置</li><li>重置 postgres 用户密码</li></ol><hr><h2 id="7-🚀-高级配置"><a href="#7-🚀-高级配置" class="headerlink" title="7. 🚀 高级配置"></a>7. 🚀 高级配置</h2><h3 id="7-1-📝-CMake-配置示例"><a href="#7-1-📝-CMake-配置示例" class="headerlink" title="7.1 📝 CMake 配置示例"></a>7.1 📝 CMake 配置示例</h3><p>创建 <code>CMakeLists.txt</code>:</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.10</span>)</span><br><span class="line"><span class="keyword">project</span>(PostgreSQLCTest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_C_STANDARD <span class="number">99</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="keyword">find_package</span>(PostgreSQL REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;PostgreSQL_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="keyword">add_executable</span>(test_pgsql test_pgsql.c)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(test_pgsql <span class="variable">$&#123;PostgreSQL_LIBRARIES&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="keyword">if</span>(WIN32)</span><br><span class="line">    <span class="keyword">target_link_libraries</span>(test_pgsql ws2_32 advapi32)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL C++ Windows 安装指南</span></span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;PostgreSQL version: $&#123;PostgreSQL_VERSION&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;PostgreSQL include dir: $&#123;PostgreSQL_INCLUDE_DIRS&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;PostgreSQL libraries: $&#123;PostgreSQL_LIBRARIES&#125;&quot;</span>)</span><br></pre></td></tr></table></figure><h3 id="7-2-🔒-安全连接配置"><a href="#7-2-🔒-安全连接配置" class="headerlink" title="7.2 🔒 安全连接配置"></a>7.2 🔒 安全连接配置</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SSL 连接示例</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *conninfo = <span class="string">&quot;host=localhost &quot;</span></span><br><span class="line">                      <span class="string">&quot;port=5432 &quot;</span></span><br><span class="line">                      <span class="string">&quot;dbname=postgres &quot;</span></span><br><span class="line">                      <span class="string">&quot;user=postgres &quot;</span></span><br><span class="line">                      <span class="string">&quot;password=your_password &quot;</span></span><br><span class="line">                      <span class="string">&quot;sslmode=require &quot;</span></span><br><span class="line">                      <span class="string">&quot;sslcert=client.crt &quot;</span></span><br><span class="line">                      <span class="string">&quot;sslkey=client.key&quot;</span>;</span><br><span class="line"></span><br><span class="line">PGconn *conn = PQconnectdb(conninfo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查 SSL 状态</span></span><br><span class="line"><span class="keyword">if</span> (PQsslInUse(conn)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;✅ SSL connection established\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;   SSL Protocol: %s\n&quot;</span>, PQsslAttribute(conn, <span class="string">&quot;protocol&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-3-📊-性能优化配置"><a href="#7-3-📊-性能优化配置" class="headerlink" title="7.3 📊 性能优化配置"></a>7.3 📊 性能优化配置</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 连接池配置示例</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_CONNECTIONS 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    PGconn *connections[MAX_CONNECTIONS];</span><br><span class="line">    <span class="type">int</span> available[MAX_CONNECTIONS];</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">&#125; ConnectionPool;</span><br><span class="line"></span><br><span class="line">ConnectionPool* <span class="title function_">create_pool</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* conninfo)</span> &#123;</span><br><span class="line">    ConnectionPool *pool = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(ConnectionPool));</span><br><span class="line">    pool-&gt;count = MAX_CONNECTIONS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MAX_CONNECTIONS; i++) &#123;</span><br><span class="line">        pool-&gt;connections[i] = PQconnectdb(conninfo);</span><br><span class="line">        pool-&gt;available[i] = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pool;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PGconn* <span class="title function_">get_connection</span><span class="params">(ConnectionPool *pool)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; pool-&gt;count; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pool-&gt;available[i]) &#123;</span><br><span class="line">            pool-&gt;available[i] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> pool-&gt;connections[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>; <span class="comment">// 所有连接都在使用中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="📊-总结"><a href="#📊-总结" class="headerlink" title="📊 总结"></a>📊 总结</h2><h3 id="✅-配置完成检查清单"><a href="#✅-配置完成检查清单" class="headerlink" title="✅ 配置完成检查清单"></a>✅ 配置完成检查清单</h3><ul><li><input checked="" disabled="" type="checkbox"> PostgreSQL 服务器安装完成</li><li><input checked="" disabled="" type="checkbox"> C 客户端库 (libpq) 安装完成</li><li><input checked="" disabled="" type="checkbox"> 开发环境配置正确</li><li><input checked="" disabled="" type="checkbox"> 测试程序编译运行成功</li><li><input checked="" disabled="" type="checkbox"> 基本数据库操作正常工作</li><li><input checked="" disabled="" type="checkbox"> 错误处理机制完善</li></ul><h3 id="🎯-下一步建议"><a href="#🎯-下一步建议" class="headerlink" title="🎯 下一步建议"></a>🎯 下一步建议</h3><ol><li><strong>学习 libpq API</strong>：掌握连接管理、查询执行、结果处理</li><li><strong>实现连接池</strong>：提高应用程序性能</li><li><strong>异步编程</strong>：使用非阻塞操作提升响应性</li><li><strong>错误处理</strong>：完善异常情况和资源清理</li><li><strong>事务管理</strong>：确保数据一致性</li></ol><h3 id="📚-推荐资源"><a href="#📚-推荐资源" class="headerlink" title="📚 推荐资源"></a>📚 推荐资源</h3><ul><li><a href="https://www.postgresql.org/docs/current/libpq.html">PostgreSQL 官方文档</a></li><li><a href="https://www.postgresql.org/docs/current/libpq-C.html">libpq C API 参考</a></li><li><a href="https://www.postgresqltutorial.com/">PostgreSQL 教程</a></li><li><a href="https://isocpp.org/">C 数据库编程最佳实践</a></li></ul><hr><blockquote><p><strong>💡 提示</strong>:</p><ul><li>首次配置可能需要一些时间，请耐心按照步骤操作</li><li>生产环境中请使用 SSL 连接和强密码</li><li>定期备份数据库和配置文件</li><li>监控数据库性能和连接状态</li></ul></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;PostgreSQL-C-Windows-安装指南&quot;&gt;&lt;a href=&quot;#PostgreSQL-C-Windows-安装指南&quot; class=&quot;headerlink&quot; title=&quot;PostgreSQL C++ Windows</summary>
        
      
    
    
    
    <category term="数据库系统" scheme="https://vilaswang.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F/"/>
    
    <category term="关系型数据库" scheme="https://vilaswang.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F/%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>IO 事件分类概念</title>
    <link href="https://vilaswang.github.io/posts/ecdf807f/"/>
    <id>https://vilaswang.github.io/posts/ecdf807f/</id>
    <published>2025-12-09T06:09:55.000Z</published>
    <updated>2025-12-17T15:36:29.263Z</updated>
    
    <content type="html"><![CDATA[<h1 id="IO-事件分类概念"><a href="#IO-事件分类概念" class="headerlink" title="IO 事件分类概念"></a>IO 事件分类概念</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>io</code>, <code>events</code>, <code>networking</code>, <code>system-programming</code>, <code>poll</code>, <code>epoll</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-io-%E4%BA%8B%E4%BB%B6%E7%B1%BB%E5%9E%8B">2. I&#x2F;O 事件类型</a><ul><li><a href="#21-%E7%BD%91%E7%BB%9Cio%E4%BA%8B%E4%BB%B6">2.1 网络I&#x2F;O事件</a></li><li><a href="#22-%E6%96%87%E4%BB%B6io%E4%BA%8B%E4%BB%B6">2.2 文件I&#x2F;O事件</a></li><li><a href="#23-%E8%AE%BE%E5%A4%87io%E4%BA%8B%E4%BB%B6">2.3 设备I&#x2F;O事件</a></li><li><a href="#24-%E5%AE%9A%E6%97%B6%E5%99%A8%E4%BA%8B%E4%BB%B6">2.4 定时器事件</a></li><li><a href="#25-%E4%BF%A1%E5%8F%B7%E4%BA%8B%E4%BB%B6">2.5 信号事件</a></li></ul></li><li><a href="#3-%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%B8%AD%E7%9A%84io%E4%BA%8B%E4%BB%B6">3. 网络编程中的I&#x2F;O事件</a></li><li><a href="#4-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">4. 事件处理最佳实践</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>在计算机系统中，I&#x2F;O（输入&#x2F;输出）事件是系统通知程序某个 I&#x2F;O 操作状态变化的机制。正确理解和分类这些事件对于高效的网络编程至关重要。</p><hr><h2 id="2-🔧-I-O-事件类型"><a href="#2-🔧-I-O-事件类型" class="headerlink" title="2. 🔧 I&#x2F;O 事件类型"></a>2. 🔧 I&#x2F;O 事件类型</h2><h3 id="2-1-🌐-网络I-O事件"><a href="#2-1-🌐-网络I-O事件" class="headerlink" title="2.1 🌐 网络I&#x2F;O事件"></a>2.1 🌐 网络I&#x2F;O事件</h3><p>网络编程中最常见的 I&#x2F;O 事件类型：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[网络I/O事件] --&gt; B[可读事件]</span><br><span class="line">    A --&gt; C[可写事件]</span><br><span class="line">    A --&gt; D[错误事件]</span><br><span class="line">    A --&gt; E[挂起事件]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[数据到达]</span><br><span class="line">    B --&gt; B2[新连接请求]</span><br><span class="line">    B --&gt; B3[对端关闭]</span><br><span class="line"></span><br><span class="line">    C --&gt; C1[缓冲区有空间]</span><br><span class="line">    C --&gt; C2[连接建立完成]</span><br><span class="line"></span><br><span class="line">    D --&gt; D1[连接异常]</span><br><span class="line">    D --&gt; D2[协议错误]</span><br><span class="line"></span><br><span class="line">    E --&gt; E1[对端主动关闭]</span><br><span class="line">    E --&gt; E2[连接断开]</span><br></pre></td></tr></table></figure><h4 id="可读事件（Read-Event）"><a href="#可读事件（Read-Event）" class="headerlink" title="可读事件（Read Event）"></a>可读事件（Read Event）</h4><ul><li><strong>定义</strong>: 数据到达，可以读取</li><li><strong>场景</strong>:<ul><li>接收到网络数据</li><li>新的连接请求（监听套接字）</li><li>对端关闭连接（读取返回0）</li></ul></li></ul><h4 id="可写事件（Write-Event）"><a href="#可写事件（Write-Event）" class="headerlink" title="可写事件（Write Event）"></a>可写事件（Write Event）</h4><ul><li><strong>定义</strong>: 缓冲区有空间，可以写入数据</li><li><strong>场景</strong>:<ul><li>发送缓冲区有空间</li><li>非阻塞连接建立完成</li></ul></li></ul><h4 id="错误事件（Error-Event）"><a href="#错误事件（Error-Event）" class="headerlink" title="错误事件（Error Event）"></a>错误事件（Error Event）</h4><ul><li><strong>定义</strong>: 连接出现错误</li><li><strong>场景</strong>:<ul><li>网络连接异常</li><li>协议错误</li><li>资源不足</li></ul></li></ul><h4 id="挂起事件（Hangup-Event）"><a href="#挂起事件（Hangup-Event）" class="headerlink" title="挂起事件（Hangup Event）"></a>挂起事件（Hangup Event）</h4><ul><li><strong>定义</strong>: 连接被对端关闭</li><li><strong>场景</strong>:<ul><li>对端主动关闭连接</li><li>连接断开</li></ul></li></ul><h3 id="2-2-📁-文件I-O事件"><a href="#2-2-📁-文件I-O事件" class="headerlink" title="2.2 📁 文件I&#x2F;O事件"></a>2.2 📁 文件I&#x2F;O事件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[文件I/O事件] --&gt; B[读写事件]</span><br><span class="line">    A --&gt; C[状态变化]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[文件可读]</span><br><span class="line">    B --&gt; B2[文件可写]</span><br><span class="line"></span><br><span class="line">    C --&gt; C1[文件修改]</span><br><span class="line">    C --&gt; C2[文件删除]</span><br><span class="line">    C --&gt; C3[权限变化]</span><br></pre></td></tr></table></figure><h4 id="读写事件"><a href="#读写事件" class="headerlink" title="读写事件"></a>读写事件</h4><ul><li><strong>文件可读</strong>: 文件描述符可以进行读操作</li><li><strong>文件可写</strong>: 文件描述符可以进行写操作</li></ul><h4 id="状态变化事件"><a href="#状态变化事件" class="headerlink" title="状态变化事件"></a>状态变化事件</h4><ul><li><strong>文件修改</strong>: 文件内容被修改</li><li><strong>文件删除</strong>: 文件被删除</li><li><strong>权限变化</strong>: 文件权限或所有者改变</li></ul><h3 id="2-3-🔌-设备I-O事件"><a href="#2-3-🔌-设备I-O事件" class="headerlink" title="2.3 🔌 设备I&#x2F;O事件"></a>2.3 🔌 设备I&#x2F;O事件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[设备I/O事件] --&gt; B[终端事件]</span><br><span class="line">    A --&gt; C[串口事件]</span><br><span class="line">    A --&gt; D[硬件设备事件]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[键盘输入]</span><br><span class="line">    B --&gt; B2[鼠标事件]</span><br><span class="line"></span><br><span class="line">    C --&gt; C1[串口数据到达]</span><br><span class="line">    C --&gt; C2[串口可发送]</span><br><span class="line"></span><br><span class="line">    D --&gt; D1[USB设备插拔]</span><br><span class="line">    D --&gt; D2[硬件状态变化]</span><br></pre></td></tr></table></figure><h3 id="2-4-⏰-定时器事件"><a href="#2-4-⏰-定时器事件" class="headerlink" title="2.4 ⏰ 定时器事件"></a>2.4 ⏰ 定时器事件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[定时器事件] --&gt; B[超时事件]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[单次定时器]</span><br><span class="line">    B --&gt; B2[周期性定时器]</span><br><span class="line">    B --&gt; B3[相对定时器]</span><br><span class="line">    B --&gt; B4[绝对定时器]</span><br></pre></td></tr></table></figure><h3 id="2-5-📢-信号事件"><a href="#2-5-📢-信号事件" class="headerlink" title="2.5 📢 信号事件"></a>2.5 📢 信号事件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[信号事件] --&gt; B[系统信号]</span><br><span class="line">    A --&gt; C[用户自定义信号]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[SIGTERM]</span><br><span class="line">    B --&gt; B2[SIGINT]</span><br><span class="line">    B --&gt; B3[SIGKILL]</span><br><span class="line">    B --&gt; B4[SIGUSR1]</span><br><span class="line">    B --&gt; B5[SIGUSR2]</span><br></pre></td></tr></table></figure><hr><h2 id="3-🌐-网络编程中的I-O事件"><a href="#3-🌐-网络编程中的I-O事件" class="headerlink" title="3. 🌐 网络编程中的I&#x2F;O事件"></a>3. 🌐 网络编程中的I&#x2F;O事件</h2><h3 id="3-1-📋-事件类型详解"><a href="#3-1-📋-事件类型详解" class="headerlink" title="3.1 📋 事件类型详解"></a>3.1 📋 事件类型详解</h3><h4 id="1-可读事件（POLLIN-POLLPRI）"><a href="#1-可读事件（POLLIN-POLLPRI）" class="headerlink" title="1. 可读事件（POLLIN&#x2F;POLLPRI）"></a>1. 可读事件（POLLIN&#x2F;POLLPRI）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 poll 监听可读事件</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span>[1];</span></span><br><span class="line">fds[<span class="number">0</span>].fd = sockfd;</span><br><span class="line">fds[<span class="number">0</span>].events = POLLIN;  <span class="comment">// 监听可读事件</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> ret = poll(fds, <span class="number">1</span>, timeout);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fds[<span class="number">0</span>].revents &amp; POLLIN) &#123;</span><br><span class="line">    <span class="comment">// 处理可读事件</span></span><br><span class="line">    handle_read_event(sockfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>表示的情况</strong>:</p><ul><li>✅ 有新数据到达，可以读取</li><li>✅ 新的连接请求到达（对于监听套接字）</li><li>✅ 对端关闭连接（读取时会返回0）</li></ul><h4 id="2-可写事件（POLLOUT）"><a href="#2-可写事件（POLLOUT）" class="headerlink" title="2. 可写事件（POLLOUT）"></a>2. 可写事件（POLLOUT）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听可写事件</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span>[1];</span></span><br><span class="line">fds[<span class="number">0</span>].fd = sockfd;</span><br><span class="line">fds[<span class="number">0</span>].events = POLLOUT;  <span class="comment">// 监听可写事件</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> ret = poll(fds, <span class="number">1</span>, timeout);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fds[<span class="number">0</span>].revents &amp; POLLOUT) &#123;</span><br><span class="line">    <span class="comment">// 处理可写事件</span></span><br><span class="line">    handle_write_event(sockfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>表示的情况</strong>:</p><ul><li>✅ 发送缓冲区有空间</li><li>✅ 连接建立完成（对于非阻塞连接）</li></ul><h4 id="3-错误事件（POLLERR）"><a href="#3-错误事件（POLLERR）" class="headerlink" title="3. 错误事件（POLLERR）"></a>3. 错误事件（POLLERR）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查错误事件</span></span><br><span class="line"><span class="keyword">if</span> (fds[<span class="number">0</span>].revents &amp; POLLERR) &#123;</span><br><span class="line">    <span class="comment">// 处理错误事件</span></span><br><span class="line">    handle_error_event(sockfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>表示的情况</strong>:</p><ul><li>❌ 连接异常</li><li>❌ 协议错误</li><li>❌ 网络不可达</li></ul><h4 id="4-挂起事件（POLLHUP）"><a href="#4-挂起事件（POLLHUP）" class="headerlink" title="4. 挂起事件（POLLHUP）"></a>4. 挂起事件（POLLHUP）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查挂起事件</span></span><br><span class="line"><span class="keyword">if</span> (fds[<span class="number">0</span>].revents &amp; POLLHUP) &#123;</span><br><span class="line">    <span class="comment">// 处理连接关闭</span></span><br><span class="line">    handle_hangup_event(sockfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>表示的情况</strong>:</p><ul><li>⚠️ 对端主动关闭连接</li><li>⚠️ 连接断开</li></ul><h4 id="5-无效事件（POLLNVAL）"><a href="#5-无效事件（POLLNVAL）" class="headerlink" title="5. 无效事件（POLLNVAL）"></a>5. 无效事件（POLLNVAL）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 检查无效事件</span></span><br><span class="line"><span class="keyword">if</span> (fds[<span class="number">0</span>].revents &amp; POLLNVAL) &#123;</span><br><span class="line">    <span class="comment">// 处理无效文件描述符</span></span><br><span class="line">    handle_invalid_event(sockfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>表示的情况</strong>:</p><ul><li>❌ 文件描述符未打开或已关闭</li></ul><h3 id="3-2-🔄-事件处理流程"><a href="#3-2-🔄-事件处理流程" class="headerlink" title="3.2 🔄 事件处理流程"></a>3.2 🔄 事件处理流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant App as 应用程序</span><br><span class="line">    participant Kernel as 内核</span><br><span class="line">    participant Network as 网络</span><br><span class="line"></span><br><span class="line">    App-&gt;&gt;Kernel: poll/epoll_wait</span><br><span class="line">    Kernel-&gt;&gt;Network: 监听事件</span><br><span class="line">    Network-&gt;&gt;Kernel: 事件发生</span><br><span class="line">    Kernel-&gt;&gt;App: 返回就绪事件</span><br><span class="line">    App-&gt;&gt;App: 处理事件</span><br><span class="line">    App-&gt;&gt;Kernel: 继续监听</span><br></pre></td></tr></table></figure><hr><h2 id="4-💡-事件处理最佳实践"><a href="#4-💡-事件处理最佳实践" class="headerlink" title="4. 💡 事件处理最佳实践"></a>4. 💡 事件处理最佳实践</h2><h3 id="4-1-🎯-事件处理策略"><a href="#4-1-🎯-事件处理策略" class="headerlink" title="4.1 🎯 事件处理策略"></a>4.1 🎯 事件处理策略</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事件处理的最佳实践示例</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handle_events</span><span class="params">(<span class="keyword">struct</span> pollfd *fds, <span class="type">int</span> nfds)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nfds; i++) &#123;</span><br><span class="line">        <span class="type">int</span> fd = fds[i].fd;</span><br><span class="line">        <span class="type">short</span> revents = fds[i].revents;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (revents == <span class="number">0</span>) <span class="keyword">continue</span>;  <span class="comment">// 无事件</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 优先处理错误和挂起事件</span></span><br><span class="line">        <span class="keyword">if</span> (revents &amp; POLLNVAL) &#123;</span><br><span class="line">            close(fd);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (revents &amp; POLLERR) &#123;</span><br><span class="line">            handle_socket_error(fd);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (revents &amp; POLLHUP) &#123;</span><br><span class="line">            handle_socket_hangup(fd);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理可读事件</span></span><br><span class="line">        <span class="keyword">if</span> (revents &amp; POLLIN) &#123;</span><br><span class="line">            handle_read_event(fd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理可写事件</span></span><br><span class="line">        <span class="keyword">if</span> (revents &amp; POLLOUT) &#123;</span><br><span class="line">            handle_write_event(fd);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理紧急数据</span></span><br><span class="line">        <span class="keyword">if</span> (revents &amp; POLLPRI) &#123;</span><br><span class="line">            handle_urgent_data(fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2-⚠️-注意事项"><a href="#4-2-⚠️-注意事项" class="headerlink" title="4.2 ⚠️ 注意事项"></a>4.2 ⚠️ 注意事项</h3><ol><li><strong>事件优先级</strong>: 错误事件 &gt; 挂起事件 &gt; 读写事件</li><li><strong>边缘触发</strong>: 使用 ET 模式时要确保处理完所有数据</li><li><strong>资源管理</strong>: 及时关闭无效的文件描述符</li><li><strong>性能优化</strong>: 避免不必要的事件监听</li></ol><h3 id="4-3-🔧-常见问题解决"><a href="#4-3-🔧-常见问题解决" class="headerlink" title="4.3 🔧 常见问题解决"></a>4.3 🔧 常见问题解决</h3><table><thead><tr><th>问题</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>CPU占用过高</strong></td><td>忙等待或事件处理不当</td><td>使用阻塞I&#x2F;O或优化事件循环</td></tr><tr><td><strong>事件丢失</strong></td><td>边缘触发模式处理不完整</td><td>使用水平触发或确保数据读完</td></tr><tr><td><strong>连接泄漏</strong></td><td>错误事件处理不当</td><td>及时清理和关闭连接</td></tr></tbody></table><hr><h2 id="📊-总结"><a href="#📊-总结" class="headerlink" title="📊 总结"></a>📊 总结</h2><h3 id="✅-核心要点"><a href="#✅-核心要点" class="headerlink" title="✅ 核心要点"></a>✅ 核心要点</h3><ul><li><strong>I&#x2F;O事件分类</strong>: 网络、文件、设备、定时器、信号</li><li><strong>网络事件处理</strong>: 可读、可写、错误、挂起、无效</li><li><strong>最佳实践</strong>: 事件优先级、资源管理、性能优化</li></ul><h3 id="🎯-实际应用"><a href="#🎯-实际应用" class="headerlink" title="🎯 实际应用"></a>🎯 实际应用</h3><ul><li><strong>Web服务器</strong>: 处理HTTP请求和响应</li><li><strong>代理服务器</strong>: 转发客户端和服务器数据</li><li><strong>聊天应用</strong>: 实时消息传输</li><li><strong>文件监控</strong>: 监控文件系统变化</li></ul><h3 id="📚-扩展学习"><a href="#📚-扩展学习" class="headerlink" title="📚 扩展学习"></a>📚 扩展学习</h3><ul><li><a href="https://man7.org/linux/man-pages/man2/poll.2.html">Linux I&#x2F;O 多路复用</a></li><li><a href="https://man7.org/linux/man-pages/man7/epoll.7.html">epoll 编程指南</a></li><li><a href="https://github.com/ideawu/immerse">高性能网络编程</a></li></ul><hr><blockquote><p><strong>💡 提示</strong>: 在实际开发中，建议使用成熟的网络库（如 libevent、libuv）来处理复杂的事件管理，这些库已经处理了大部分边界情况和优化。</p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;IO-事件分类概念&quot;&gt;&lt;a href=&quot;#IO-事件分类概念&quot; class=&quot;headerlink&quot; title=&quot;IO 事件分类概念&quot;&gt;&lt;/a&gt;IO 事件分类概念&lt;/h1&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;文档创建时间&lt;/strong&gt;:</summary>
        
      
    
    
    
    <category term="系统级编程" scheme="https://vilaswang.github.io/categories/%E7%B3%BB%E7%BB%9F%E7%BA%A7%E7%BC%96%E7%A8%8B/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Graphviz 流程图指南</title>
    <link href="https://vilaswang.github.io/posts/445c44cb/"/>
    <id>https://vilaswang.github.io/posts/445c44cb/</id>
    <published>2025-12-09T06:09:55.000Z</published>
    <updated>2025-12-18T15:50:20.012Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Graphviz-流程图指南"><a href="#Graphviz-流程图指南" class="headerlink" title="Graphviz 流程图指南"></a>Graphviz 流程图指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>graphviz</code>, <code>flowchart</code>, <code>diagram</code>, <code>visualization</code>, <code>documentation</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">2. 环境准备</a></li><li><a href="#3-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">3. 基本使用</a></li><li><a href="#4-%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F">4. 输出格式</a></li><li><a href="#5-%E5%B8%B8%E8%A7%81%E7%94%A8%E4%BE%8B">5. 常见用例</a></li><li><a href="#6-%E9%AB%98%E7%BA%A7%E9%85%8D%E7%BD%AE">6. 高级配置</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>Graphviz 是一个开源的图形可视化软件，特别适合生成各种流程图、架构图和关系图。</p><h3 id="🎯-主要用途"><a href="#🎯-主要用途" class="headerlink" title="🎯 主要用途"></a>🎯 主要用途</h3><ul><li>✅ 流程图生成</li><li>✅ 系统架构图</li><li>✅ 类关系图</li><li>✅ 依赖关系图</li><li>✅ 状态机图</li></ul><hr><h2 id="2-🔧-环境准备"><a href="#2-🔧-环境准备" class="headerlink" title="2. 🔧 环境准备"></a>2. 🔧 环境准备</h2><h3 id="2-1-安装依赖"><a href="#2-1-安装依赖" class="headerlink" title="2.1 安装依赖"></a>2.1 安装依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">pip install graphviz</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">conda install python-graphviz</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get install graphviz</span><br></pre></td></tr></table></figure><h3 id="2-2-验证安装"><a href="#2-2-验证安装" class="headerlink" title="2.2 验证安装"></a>2.2 验证安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> graphviz</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">dot = graphviz.Digraph(comment=<span class="string">&#x27;Test Graph&#x27;</span>)</span><br><span class="line">dot.node(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;Test Node&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(dot.source)  <span class="comment"># 输出 DOT 源码</span></span><br></pre></td></tr></table></figure><hr><h2 id="3-🚀-基本使用"><a href="#3-🚀-基本使用" class="headerlink" title="3. 🚀 基本使用"></a>3. 🚀 基本使用</h2><h3 id="3-1-生成流程图"><a href="#3-1-生成流程图" class="headerlink" title="3.1 生成流程图"></a>3.1 生成流程图</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">python drogon_flow_diagram.py</span><br></pre></td></tr></table></figure><h3 id="3-2-基本示例"><a href="#3-2-基本示例" class="headerlink" title="3.2 基本示例"></a>3.2 基本示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> graphviz <span class="keyword">import</span> Digraph</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">dot = Digraph(comment=<span class="string">&#x27;Simple Flowchart&#x27;</span>)</span><br><span class="line">dot.attr(rankdir=<span class="string">&#x27;LR&#x27;</span>)  <span class="comment"># 从左到右布局</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">dot.node(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;开始&#x27;</span>)</span><br><span class="line">dot.node(<span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;处理&#x27;</span>)</span><br><span class="line">dot.node(<span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;结束&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">dot.edges([<span class="string">&#x27;AB&#x27;</span>, <span class="string">&#x27;BC&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">dot.render(<span class="string">&#x27;flowchart&#x27;</span>, <span class="built_in">format</span>=<span class="string">&#x27;png&#x27;</span>, cleanup=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><hr><h2 id="4-📁-输出格式"><a href="#4-📁-输出格式" class="headerlink" title="4. 📁 输出格式"></a>4. 📁 输出格式</h2><p>生成的文件包括：</p><table><thead><tr><th>文件名</th><th>格式</th><th>说明</th></tr></thead><tbody><tr><td><code>drogon_http_flow.png</code></td><td>PNG</td><td>位图格式，适合网页显示</td></tr><tr><td><code>drogon_http_flow.svg</code></td><td>SVG</td><td>矢量图，可缩放</td></tr><tr><td><code>drogon_http_flow.pdf</code></td><td>PDF</td><td>适合打印和文档</td></tr><tr><td><code>drogon_http_flow.dot</code></td><td>DOT</td><td>Graphviz 源码</td></tr></tbody></table><hr><h2 id="5-💡-常见用例"><a href="#5-💡-常见用例" class="headerlink" title="5. 💡 常见用例"></a>5. 💡 常见用例</h2><h3 id="5-1-系统架构图"><a href="#5-1-系统架构图" class="headerlink" title="5.1 系统架构图"></a>5.1 系统架构图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">dot = Digraph(comment=<span class="string">&#x27;System Architecture&#x27;</span>)</span><br><span class="line">dot.attr(rankdir=<span class="string">&#x27;TB&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line"><span class="keyword">with</span> dot.subgraph(name=<span class="string">&#x27;cluster_frontend&#x27;</span>) <span class="keyword">as</span> c:</span><br><span class="line">    c.attr(label=<span class="string">&#x27;Frontend&#x27;</span>)</span><br><span class="line">    c.node(<span class="string">&#x27;web&#x27;</span>, <span class="string">&#x27;Web App&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> dot.subgraph(name=<span class="string">&#x27;cluster_backend&#x27;</span>) <span class="keyword">as</span> c:</span><br><span class="line">    c.attr(label=<span class="string">&#x27;Backend&#x27;</span>)</span><br><span class="line">    c.node(<span class="string">&#x27;api&#x27;</span>, <span class="string">&#x27;API Server&#x27;</span>)</span><br><span class="line">    c.node(<span class="string">&#x27;db&#x27;</span>, <span class="string">&#x27;Database&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">dot.edge(<span class="string">&#x27;web&#x27;</span>, <span class="string">&#x27;api&#x27;</span>)</span><br><span class="line">dot.edge(<span class="string">&#x27;api&#x27;</span>, <span class="string">&#x27;db&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="5-2-类关系图"><a href="#5-2-类关系图" class="headerlink" title="5.2 类关系图"></a>5.2 类关系图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dot = Digraph(comment=<span class="string">&#x27;Class Diagram&#x27;</span>)</span><br><span class="line">dot.attr(rankdir=<span class="string">&#x27;TB&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">dot.node(<span class="string">&#x27;Base&#x27;</span>, <span class="string">&#x27;Base Class&#x27;</span>, shape=<span class="string">&#x27;record&#x27;</span>)</span><br><span class="line">dot.node(<span class="string">&#x27;Derived&#x27;</span>, <span class="string">&#x27;Derived Class&#x27;</span>, shape=<span class="string">&#x27;record&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Graphviz 流程图指南</span></span><br><span class="line">dot.edge(<span class="string">&#x27;Base&#x27;</span>, <span class="string">&#x27;Derived&#x27;</span>, arrowhead=<span class="string">&#x27;empty&#x27;</span>)</span><br></pre></td></tr></table></figure><hr><h2 id="6-⚙️-高级配置"><a href="#6-⚙️-高级配置" class="headerlink" title="6. ⚙️ 高级配置"></a>6. ⚙️ 高级配置</h2><h3 id="6-1-样式定制"><a href="#6-1-样式定制" class="headerlink" title="6.1 样式定制"></a>6.1 样式定制</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dot.attr(<span class="string">&#x27;node&#x27;</span>, shape=<span class="string">&#x27;box&#x27;</span>, style=<span class="string">&#x27;rounded,filled&#x27;</span>, fillcolor=<span class="string">&#x27;lightblue&#x27;</span>)</span><br><span class="line">dot.attr(<span class="string">&#x27;edge&#x27;</span>, color=<span class="string">&#x27;darkblue&#x27;</span>, fontcolor=<span class="string">&#x27;darkblue&#x27;</span>)</span><br></pre></td></tr></table></figure><h3 id="6-2-子图组织"><a href="#6-2-子图组织" class="headerlink" title="6.2 子图组织"></a>6.2 子图组织</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> dot.subgraph(name=<span class="string">&#x27;cluster_module1&#x27;</span>) <span class="keyword">as</span> c:</span><br><span class="line">    c.attr(label=<span class="string">&#x27;Module 1&#x27;</span>, style=<span class="string">&#x27;filled&#x27;</span>, color=<span class="string">&#x27;lightgrey&#x27;</span>)</span><br><span class="line">    c.node(<span class="string">&#x27;m1_a&#x27;</span>, <span class="string">&#x27;Component A&#x27;</span>)</span><br><span class="line">    c.node(<span class="string">&#x27;m1_b&#x27;</span>, <span class="string">&#x27;Component B&#x27;</span>)</span><br></pre></td></tr></table></figure><hr><h2 id="📚-相关资源"><a href="#📚-相关资源" class="headerlink" title="📚 相关资源"></a>📚 相关资源</h2><ul><li><a href="https://graphviz.org/documentation/">Graphviz 官方文档</a></li><li><a href="https://graphviz.readthedocs.io/">Python graphviz 库</a></li><li><a href="https://graphviz.org/doc/info/lang.html">DOT 语言指南</a></li></ul><hr><blockquote><p><strong>💡 提示</strong>: Graphviz 特别适合生成技术文档中的架构图和流程图，建议与其他文档生成工具配合使用。</p></blockquote>]]></content>
    
    
    <summary type="html">详细介绍了 Graphviz 和 DOT 语言的使用方法，包含基础语法、属性配置及复杂流程图的绘制技巧。</summary>
    
    
    
    <category term="开发工具" scheme="https://vilaswang.github.io/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Drogon Windows 构建指南</title>
    <link href="https://vilaswang.github.io/posts/58c0a1f/"/>
    <id>https://vilaswang.github.io/posts/58c0a1f/</id>
    <published>2025-12-09T06:09:55.000Z</published>
    <updated>2025-12-17T15:36:29.310Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Drogon-Windows-构建指南"><a href="#Drogon-Windows-构建指南" class="headerlink" title="Drogon Windows 构建指南"></a>Drogon Windows 构建指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>drogon</code>, <code>cpp</code>, <code>windows</code>, <code>source-build</code>, <code>cmake</code>, <code>conan</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87">2. 环境准备</a></li><li><a href="#3-%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD">3. 源码下载</a></li><li><a href="#4-%E4%BE%9D%E8%B5%96%E5%AE%89%E8%A3%85">4. 依赖安装</a></li><li><a href="#5-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85">5. 编译安装</a></li><li><a href="#6-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE">6. 环境配置</a></li><li><a href="#7-%E5%88%9B%E5%BB%BA%E6%96%B0%E9%A1%B9%E7%9B%AE">7. 创建新项目</a></li><li><a href="#8-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">8. 常见问题</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>Drogon 是一个现代化的 C++ Web 框架。本指南介绍如何在 Windows 系统上从源码编译安装 Drogon。</p><h3 id="🎯-安装目标"><a href="#🎯-安装目标" class="headerlink" title="🎯 安装目标"></a>🎯 安装目标</h3><ul><li>✅ 从源码编译 Drogon 框架</li><li>✅ 配置开发环境</li><li>✅ 创建第一个 Drogon 项目</li><li>✅ 验证安装成功</li></ul><hr><h2 id="2-🔧-环境准备"><a href="#2-🔧-环境准备" class="headerlink" title="2. 🔧 环境准备"></a>2. 🔧 环境准备</h2><h3 id="2-1-必需工具"><a href="#2-1-必需工具" class="headerlink" title="2.1 必需工具"></a>2.1 必需工具</h3><ul><li><strong>Visual Studio 2019+</strong> - C++ 编译器</li><li><strong>Git</strong> - 源码管理</li><li><strong>CMake 3.15+</strong> - 构建系统</li><li><strong>Conan</strong> - C++ 包管理器</li></ul><h3 id="2-2-安装-Conan"><a href="#2-2-安装-Conan" class="headerlink" title="2.2 安装 Conan"></a>2.2 安装 Conan</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">pip install conan</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">choco install conan</span><br></pre></td></tr></table></figure><hr><h2 id="3-📥-源码下载"><a href="#3-📥-源码下载" class="headerlink" title="3. 📥 源码下载"></a>3. 📥 源码下载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line"><span class="built_in">cd</span> %WORK_PATH%</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/drogonframework/drogon</span><br><span class="line"><span class="built_in">cd</span> drogon</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">git submodule update --init</span><br></pre></td></tr></table></figure><hr><h2 id="4-📦-依赖安装"><a href="#4-📦-依赖安装" class="headerlink" title="4. 📦 依赖安装"></a>4. 📦 依赖安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">conan profile detect --force</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">conan install .. \</span><br><span class="line">    -s compiler=<span class="string">&quot;msvc&quot;</span> \</span><br><span class="line">    -s compiler.version=194 \</span><br><span class="line">    -s compiler.cppstd=17 \</span><br><span class="line">    -s build_type=Debug \</span><br><span class="line">    --output-folder . \</span><br><span class="line">    --build=missing</span><br></pre></td></tr></table></figure><h3 id="4-1-自定义依赖"><a href="#4-1-自定义依赖" class="headerlink" title="4.1 自定义依赖"></a>4.1 自定义依赖</h3><p>编辑 <code>conanfile.txt</code> 可以添加或修改依赖：</p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[requires]</span><br><span class="line"># Drogon Windows 构建指南</span><br><span class="line">[generators]</span><br><span class="line">CMakeDeps</span><br><span class="line">CMakeToolchain</span><br><span class="line"></span><br><span class="line">[options]</span><br><span class="line">shared=False</span><br></pre></td></tr></table></figure><hr><h2 id="5-🔨-编译安装"><a href="#5-🔨-编译安装" class="headerlink" title="5. 🔨 编译安装"></a>5. 🔨 编译安装</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">cmake .. \</span><br><span class="line">    -DCMAKE_BUILD_TYPE=Debug \</span><br><span class="line">    -DCMAKE_TOOLCHAIN_FILE=<span class="string">&quot;conan_toolchain.cmake&quot;</span> \</span><br><span class="line">    -DCMAKE_POLICY_DEFAULT_CMP0091=NEW \</span><br><span class="line">    -DCMAKE_INSTALL_PREFIX=<span class="string">&quot;D:\ThirdParty\drogon&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">cmake --build . --parallel --target install</span><br></pre></td></tr></table></figure><h3 id="5-1-⚠️-重要说明"><a href="#5-1-⚠️-重要说明" class="headerlink" title="5.1 ⚠️ 重要说明"></a>5.1 ⚠️ 重要说明</h3><ul><li>Conan 和 CMake 的 build type 必须保持一致</li><li>Release 构建时将 <code>Debug</code> 改为 <code>Release</code></li><li>可根据需要修改安装路径</li></ul><hr><h2 id="6-🔗-环境配置"><a href="#6-🔗-环境配置" class="headerlink" title="6. 🔗 环境配置"></a>6. 🔗 环境配置</h2><h3 id="6-1-安装结果"><a href="#6-1-安装结果" class="headerlink" title="6.1 安装结果"></a>6.1 安装结果</h3><p>编译完成后，以下文件将被安装到指定目录：</p><table><thead><tr><th>文件类型</th><th>安装路径</th><th>说明</th></tr></thead><tbody><tr><td><strong>头文件</strong></td><td><code>D:\ThirdParty\drogon\include\drogon</code></td><td>Drogon 主要头文件</td></tr><tr><td><strong>库文件</strong></td><td><code>D:\ThirdParty\drogon\bin</code></td><td>drogon.dll</td></tr><tr><td><strong>命令工具</strong></td><td><code>D:\ThirdParty\drogon\bin</code></td><td>drogon_ctl.exe</td></tr><tr><td><strong>Trantor头文件</strong></td><td><code>D:\ThirdParty\drogon\include\trantor</code></td><td>依赖库头文件</td></tr><tr><td><strong>Trantor库文件</strong></td><td><code>D:\ThirdParty\drogon\bin</code></td><td>trantor.dll</td></tr></tbody></table><h3 id="6-2-环境变量"><a href="#6-2-环境变量" class="headerlink" title="6.2 环境变量"></a>6.2 环境变量</h3><p>添加以下路径到系统 <code>PATH</code> 环境变量：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D:\<span class="title">ThirdParty</span>\<span class="title">drogon</span>\<span class="title">bin</span></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\<span class="title">ThirdParty</span>\<span class="title">drogon</span>\<span class="title">lib</span>\<span class="title">cmake</span>\<span class="title">Drogon</span></span></span><br><span class="line"><span class="function"><span class="title">D</span>:\<span class="title">ThirdParty</span>\<span class="title">drogon</span>\<span class="title">lib</span>\<span class="title">cmake</span>\<span class="title">Trantor</span></span></span><br></pre></td></tr></table></figure><hr><h2 id="7-🚀-创建新项目"><a href="#7-🚀-创建新项目" class="headerlink" title="7. 🚀 创建新项目"></a>7. 🚀 创建新项目</h2><h3 id="7-1-使用命令行工具"><a href="#7-1-使用命令行工具" class="headerlink" title="7.1 使用命令行工具"></a>7.1 使用命令行工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">drogon_ctl create project your_project_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line">copy drogon\conanfile.txt your_project_name\</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line"><span class="built_in">cd</span> your_project_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># Drogon Windows 构建指南</span></span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">conan profile detect --force</span><br><span class="line">conan install .. \</span><br><span class="line">    -s compiler=<span class="string">&quot;msvc&quot;</span> \</span><br><span class="line">    -s compiler.version=194 \</span><br><span class="line">    -s compiler.cppstd=17 \</span><br><span class="line">    -s build_type=Debug \</span><br><span class="line">    --output-folder . \</span><br><span class="line">    --build=missing</span><br><span class="line"></span><br><span class="line">cmake .. \</span><br><span class="line">    -DCMAKE_BUILD_TYPE=Debug \</span><br><span class="line">    -DCMAKE_TOOLCHAIN_FILE=<span class="string">&quot;conan_toolchain.cmake&quot;</span> \</span><br><span class="line">    -DCMAKE_POLICY_DEFAULT_CMP0091=NEW</span><br><span class="line"></span><br><span class="line">cmake --build . --parallel</span><br></pre></td></tr></table></figure><h3 id="7-2-项目结构"><a href="#7-2-项目结构" class="headerlink" title="7.2 项目结构"></a>7.2 项目结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">your_project_name/</span><br><span class="line">├── build/</span><br><span class="line">├── config.json</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── conanfile.txt</span><br><span class="line">├── main.cc</span><br><span class="line">├── plugins/</span><br><span class="line">├── run.bat</span><br><span class="line">└── tests/</span><br></pre></td></tr></table></figure><hr><h2 id="8-🔧-常见问题"><a href="#8-🔧-常见问题" class="headerlink" title="8. 🔧 常见问题"></a>8. 🔧 常见问题</h2><h3 id="8-1-编译错误"><a href="#8-1-编译错误" class="headerlink" title="8.1 编译错误"></a>8.1 编译错误</h3><ul><li><strong>VS 版本不匹配</strong>: 确认 compiler.version 与安装的 Visual Studio 版本一致</li><li><strong>C++ 标准问题</strong>: 确保 compiler.cppstd 设置正确</li><li><strong>依赖缺失</strong>: 使用 <code>--build=missing</code> 强制构建缺失的依赖</li></ul><h3 id="8-2-链接错误"><a href="#8-2-链接错误" class="headerlink" title="8.2 链接错误"></a>8.2 链接错误</h3><ul><li><strong>DLL 找不到</strong>: 检查 PATH 环境变量设置</li><li><strong>库文件路径</strong>: 确认 CMAKE_PREFIX_PATH 设置正确</li></ul><h3 id="8-3-运行时错误"><a href="#8-3-运行时错误" class="headerlink" title="8.3 运行时错误"></a>8.3 运行时错误</h3><ul><li><strong>配置文件</strong>: 检查 <code>config.json</code> 配置是否正确</li><li><strong>端口占用</strong>: 确认配置的端口未被占用</li></ul><hr><h2 id="📚-相关资源"><a href="#📚-相关资源" class="headerlink" title="📚 相关资源"></a>📚 相关资源</h2><ul><li><a href="https://drogon.docs.sguanheng.com/">Drogon 官方文档</a></li><li><a href="https://conan.io/">Conan 包管理器</a></li><li><a href="https://cmake.org/documentation/">CMake 官方文档</a></li></ul><hr><blockquote><p><strong>💡 提示</strong>:</p><ul><li>首次编译可能需要较长时间</li><li>建议使用 Release 模式进行生产构建</li><li>定期更新 Drogon 源码以获得最新功能</li></ul></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;Drogon-Windows-构建指南&quot;&gt;&lt;a href=&quot;#Drogon-Windows-构建指南&quot; class=&quot;headerlink&quot; title=&quot;Drogon Windows 构建指南&quot;&gt;&lt;/a&gt;Drogon Windows</summary>
        
      
    
    
    
    <category term="框架库" scheme="https://vilaswang.github.io/categories/%E6%A1%86%E6%9E%B6%E5%BA%93/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>服务器认证 API 规范</title>
    <link href="https://vilaswang.github.io/posts/ec4e5506/"/>
    <id>https://vilaswang.github.io/posts/ec4e5506/</id>
    <published>2025-12-09T06:09:55.000Z</published>
    <updated>2025-12-18T15:49:58.220Z</updated>
    
    <content type="html"><![CDATA[<h1 id="服务器认证-API-规范"><a href="#服务器认证-API-规范" class="headerlink" title="服务器认证 API 规范"></a>服务器认证 API 规范</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>authentication</code>, <code>api</code>, <code>security</code>, <code>jwt</code>, <code>express</code>, <code>nodejs</code>, <code>middleware</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E8%AE%A4%E8%AF%81%E4%B8%AD%E9%97%B4%E4%BB%B6">2. 认证中间件</a></li><li><a href="#3-%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B">3. 认证流程</a><ul><li><a href="#31-%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B">3.1 注册流程</a></li><li><a href="#32-%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B">3.2 登录流程</a></li><li><a href="#33-token-%E9%AA%8C%E8%AF%81%E6%B5%81%E7%A8%8B">3.3 Token 验证流程</a></li></ul></li><li><a href="#4-%E5%AE%89%E5%85%A8%E6%8E%AA%E6%96%BD">4. 安全措施</a><ul><li><a href="#41-%E8%BE%93%E5%85%A5%E9%AA%8C%E8%AF%81">4.1 输入验证</a></li><li><a href="#42-%E8%AF%B7%E6%B1%82%E9%A2%91%E7%8E%87%E9%99%90%E5%88%B6">4.2 请求频率限制</a></li><li><a href="#43-cors-%E9%85%8D%E7%BD%AE">4.3 CORS 配置</a></li></ul></li><li><a href="#5-%E7%94%A8%E6%88%B7%E6%A8%A1%E5%9E%8B">5. 用户模型</a></li><li><a href="#6-%E5%8F%97%E4%BF%9D%E6%8A%A4%E7%9A%84%E8%B7%AF%E7%94%B1">6. 受保护的路由</a></li><li><a href="#7-%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8">7. 客户端使用</a></li><li><a href="#8-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7">8. 高级特性</a></li><li><a href="#9-%E6%B5%8B%E8%AF%95%E4%B8%8E%E8%B0%83%E8%AF%95">9. 测试与调试</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>本指南详细说明如何实现服务器端的用户认证系统，包括注册、登录、Token 验证以及相关安全措施。</p><h3 id="🎯-认证系统特性"><a href="#🎯-认证系统特性" class="headerlink" title="🎯 认证系统特性"></a>🎯 认证系统特性</h3><ul><li>✅ <strong>JWT Token 认证</strong></li><li>✅ <strong>密码加密存储</strong></li><li>✅ <strong>请求频率限制</strong></li><li>✅ <strong>输入验证和清理</strong></li><li>✅ <strong>CORS 跨域保护</strong></li><li>✅ <strong>错误处理和安全日志</strong></li></ul><h3 id="🏗️-系统架构"><a href="#🏗️-系统架构" class="headerlink" title="🏗️ 系统架构"></a>🏗️ 系统架构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[Client Request] --&gt; B[Rate Limiting]</span><br><span class="line">    B --&gt; C[Input Validation]</span><br><span class="line">    C --&gt; D[Auth Middleware]</span><br><span class="line">    D --&gt; E&#123;Public Route?&#125;</span><br><span class="line">    E --&gt;|Yes| F[Business Logic]</span><br><span class="line">    E --&gt;|No| G[JWT Verification]</span><br><span class="line">    G --&gt; H[User Extraction]</span><br><span class="line">    H --&gt; F</span><br><span class="line">    F --&gt; I[Response]</span><br></pre></td></tr></table></figure><hr><h2 id="2-🔐-认证中间件"><a href="#2-🔐-认证中间件" class="headerlink" title="2. 🔐 认证中间件"></a>2. 🔐 认证中间件</h2><h3 id="2-1-📄-中间件实现-src-middleware-auth-js"><a href="#2-1-📄-中间件实现-src-middleware-auth-js" class="headerlink" title="2.1 📄 中间件实现 (src/middleware/auth.js)"></a>2.1 📄 中间件实现 (<code>src/middleware/auth.js</code>)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> rateLimit = <span class="built_in">require</span>(<span class="string">&#x27;express-rate-limit&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">&#x27;helmet&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JWT Token 认证中间件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; <span class="variable">req</span> - Express 请求对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; <span class="variable">res</span> - Express 响应对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">Function</span>&#125; <span class="variable">next</span> - Express 下一个中间件函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">authenticateToken</span> = (<span class="params">req, res, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 从请求头获取 Bearer Token</span></span><br><span class="line">        <span class="keyword">const</span> authHeader = req.<span class="property">headers</span>[<span class="string">&#x27;authorization&#x27;</span>];</span><br><span class="line">        <span class="keyword">const</span> token = authHeader &amp;&amp; authHeader.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证 Token 格式</span></span><br><span class="line">        <span class="keyword">if</span> (!token) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;Access token is required&#x27;</span>,</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;TOKEN_MISSING&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!authHeader.<span class="title function_">startsWith</span>(<span class="string">&#x27;Bearer &#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;Invalid token format. Expected: Bearer &lt;token&gt;&#x27;</span>,</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;TOKEN_FORMAT_INVALID&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证 JWT Token</span></span><br><span class="line">        jwt.<span class="title function_">verify</span>(token, process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>, &#123;</span><br><span class="line">            <span class="attr">algorithms</span>: [<span class="string">&#x27;HS256&#x27;</span>],</span><br><span class="line">            <span class="attr">clockTolerance</span>: <span class="number">30</span> <span class="comment">// 允许30秒时钟偏差</span></span><br><span class="line">        &#125;, <span class="function">(<span class="params">err, decoded</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`JWT Verification failed: <span class="subst">$&#123;err.message&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                    <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;Invalid or expired token&#x27;</span>,</span><br><span class="line">                    <span class="attr">code</span>: <span class="string">&#x27;TOKEN_INVALID&#x27;</span>,</span><br><span class="line">                    <span class="attr">details</span>: err.<span class="property">name</span> <span class="comment">// 可选：生产环境可能要隐藏</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将用户信息附加到请求对象</span></span><br><span class="line">            req.<span class="property">user</span> = &#123;</span><br><span class="line">                <span class="attr">id</span>: decoded.<span class="property">userId</span>,</span><br><span class="line">                <span class="attr">iat</span>: decoded.<span class="property">iat</span>,</span><br><span class="line">                <span class="attr">exp</span>: decoded.<span class="property">exp</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="title function_">next</span>();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Authentication middleware error:&#x27;</span>, error);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;Internal server error during authentication&#x27;</span>,</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;AUTH_ERROR&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 可选的认证中间件 - Token 可选的路由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">optionalAuth</span> = (<span class="params">req, res, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> authHeader = req.<span class="property">headers</span>[<span class="string">&#x27;authorization&#x27;</span>];</span><br><span class="line">    <span class="keyword">const</span> token = authHeader &amp;&amp; authHeader.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>)[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (token) &#123;</span><br><span class="line">        <span class="title function_">authenticateToken</span>(req, res, next);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">next</span>(); <span class="comment">// 没有 Token 时继续执行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    authenticateToken,</span><br><span class="line">    optionalAuth</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="2-2-🚦-请求频率限制"><a href="#2-2-🚦-请求频率限制" class="headerlink" title="2.2 🚦 请求频率限制"></a>2.2 🚦 请求频率限制</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 认证相关的频率限制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> authLimiter = <span class="title function_">rateLimit</span>(&#123;</span><br><span class="line">    <span class="attr">windowMs</span>: <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000</span>,  <span class="comment">// 15分钟窗口期</span></span><br><span class="line">    <span class="attr">max</span>: <span class="number">5</span>,                    <span class="comment">// 最多5次尝试</span></span><br><span class="line">    <span class="attr">message</span>: &#123;</span><br><span class="line">        <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;Too many authentication attempts, please try again later&#x27;</span>,</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;RATE_LIMIT_EXCEEDED&#x27;</span>,</span><br><span class="line">        <span class="attr">retryAfter</span>: <span class="string">&#x27;15 minutes&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">standardHeaders</span>: <span class="literal">true</span>,      <span class="comment">// 返回速率限制信息在 headers</span></span><br><span class="line">    <span class="attr">legacyHeaders</span>: <span class="literal">false</span>,      <span class="comment">// 禁用 `X-RateLimit-*` headers</span></span><br><span class="line">    <span class="attr">handler</span>: <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">429</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;Too many authentication attempts, please try again later&#x27;</span>,</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;RATE_LIMIT_EXCEEDED&#x27;</span>,</span><br><span class="line">            <span class="attr">retryAfter</span>: <span class="string">&#x27;15 minutes&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一般 API 的频率限制</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> apiLimiter = <span class="title function_">rateLimit</span>(&#123;</span><br><span class="line">    <span class="attr">windowMs</span>: <span class="number">15</span> * <span class="number">60</span> * <span class="number">1000</span>,  <span class="comment">// 15分钟</span></span><br><span class="line">    <span class="attr">max</span>: <span class="number">100</span>,                  <span class="comment">// 最多100次请求</span></span><br><span class="line">    <span class="attr">message</span>: &#123;</span><br><span class="line">        <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">message</span>: <span class="string">&#x27;API rate limit exceeded&#x27;</span>,</span><br><span class="line">        <span class="attr">code</span>: <span class="string">&#x27;API_RATE_LIMIT_EXCEEDED&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">    authLimiter,</span><br><span class="line">    apiLimiter</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="3-🔑-认证流程"><a href="#3-🔑-认证流程" class="headerlink" title="3. 🔑 认证流程"></a>3. 🔑 认证流程</h2><h3 id="3-1-📝-注册流程-auth-register"><a href="#3-1-📝-注册流程-auth-register" class="headerlink" title="3.1 📝 注册流程 (/auth/register)"></a>3.1 📝 注册流程 (<code>/auth/register</code>)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; body, validationResult &#125; = <span class="built_in">require</span>(<span class="string">&#x27;express-validator&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcrypt&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册验证规则</span></span><br><span class="line"><span class="keyword">const</span> registerValidation = [</span><br><span class="line">    <span class="title function_">body</span>(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        .<span class="title function_">trim</span>()</span><br><span class="line">        .<span class="title function_">isLength</span>(&#123; <span class="attr">min</span>: <span class="number">3</span>, <span class="attr">max</span>: <span class="number">20</span> &#125;)</span><br><span class="line">        .<span class="title function_">withMessage</span>(<span class="string">&#x27;Username must be 3-20 characters long&#x27;</span>)</span><br><span class="line">        .<span class="title function_">matches</span>(<span class="regexp">/^[a-zA-Z0-9_]+$/</span>)</span><br><span class="line">        .<span class="title function_">withMessage</span>(<span class="string">&#x27;Username can only contain letters, numbers and underscores&#x27;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="title function_">body</span>(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">        .<span class="title function_">isEmail</span>()</span><br><span class="line">        .<span class="title function_">normalizeEmail</span>()</span><br><span class="line">        .<span class="title function_">withMessage</span>(<span class="string">&#x27;Valid email address is required&#x27;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="title function_">body</span>(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        .<span class="title function_">isLength</span>(&#123; <span class="attr">min</span>: <span class="number">6</span> &#125;)</span><br><span class="line">        .<span class="title function_">withMessage</span>(<span class="string">&#x27;Password must be at least 6 characters long&#x27;</span>)</span><br><span class="line">        .<span class="title function_">matches</span>(<span class="regexp">/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).*$/</span>)</span><br><span class="line">        .<span class="title function_">withMessage</span>(<span class="string">&#x27;Password must contain at least one uppercase letter, one lowercase letter, and one number&#x27;</span>)</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户注册路由</span></span><br><span class="line"><span class="comment"> * POST /auth/register</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/register&#x27;</span>,</span><br><span class="line">    registerValidation,  <span class="comment">// 输入验证</span></span><br><span class="line">    validate,            <span class="comment">// 验证结果处理</span></span><br><span class="line">    authLimiter,        <span class="comment">// 请求频率限制</span></span><br><span class="line">    <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> transaction = <span class="keyword">await</span> pool.<span class="title function_">beginTransaction</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; username, password, email &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">`Registration attempt: username=<span class="subst">$&#123;username&#125;</span>, email=<span class="subst">$&#123;email&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 检查用户名是否已存在</span></span><br><span class="line">            <span class="keyword">const</span> [existingUser] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">                <span class="string">&#x27;SELECT id FROM users WHERE username = ? OR email = ?&#x27;</span>,</span><br><span class="line">                [username, email]</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (existingUser.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">await</span> transaction.<span class="title function_">rollback</span>();</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                    <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">message</span>: existingUser[<span class="number">0</span>].<span class="property">username</span> === username</span><br><span class="line">                        ? <span class="string">&#x27;Username is already taken&#x27;</span></span><br><span class="line">                        : <span class="string">&#x27;Email is already registered&#x27;</span>,</span><br><span class="line">                    <span class="attr">code</span>: <span class="string">&#x27;USER_EXISTS&#x27;</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 密码加密</span></span><br><span class="line">            <span class="keyword">const</span> saltRounds = <span class="number">12</span>;</span><br><span class="line">            <span class="keyword">const</span> hashedPassword = <span class="keyword">await</span> bcrypt.<span class="title function_">hash</span>(password, saltRounds);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 创建新用户</span></span><br><span class="line">            <span class="keyword">const</span> [result] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">                <span class="string">&#x27;INSERT INTO users (username, password, email, created_at, updated_at) VALUES (?, ?, ?, NOW(), NOW())&#x27;</span>,</span><br><span class="line">                [username, hashedPassword, email]</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> userId = result.<span class="property">insertId</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 生成 JWT Token</span></span><br><span class="line">            <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(</span><br><span class="line">                &#123;</span><br><span class="line">                    userId,</span><br><span class="line">                    username,</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;access&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">expiresIn</span>: <span class="string">&#x27;24h&#x27;</span>,</span><br><span class="line">                    <span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span>,</span><br><span class="line">                    <span class="attr">issuer</span>: <span class="string">&#x27;your-app-name&#x27;</span>,</span><br><span class="line">                    <span class="attr">audience</span>: <span class="string">&#x27;your-app-users&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 生成 Refresh Token (可选)</span></span><br><span class="line">            <span class="keyword">const</span> refreshToken = jwt.<span class="title function_">sign</span>(</span><br><span class="line">                &#123;</span><br><span class="line">                    userId,</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;refresh&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                process.<span class="property">env</span>.<span class="property">JWT_REFRESH_SECRET</span>,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">expiresIn</span>: <span class="string">&#x27;7d&#x27;</span>,</span><br><span class="line">                    <span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6. 保存 Refresh Token 到数据库 (可选)</span></span><br><span class="line">            <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">                <span class="string">&#x27;UPDATE users SET refresh_token = ? WHERE id = ?&#x27;</span>,</span><br><span class="line">                [refreshToken, userId]</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">await</span> transaction.<span class="title function_">commit</span>();</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">`User registered successfully: userId=<span class="subst">$&#123;userId&#125;</span>, username=<span class="subst">$&#123;username&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 7. 返回成功响应 (不包含敏感信息)</span></span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">201</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;Registration successful&#x27;</span>,</span><br><span class="line">                <span class="attr">data</span>: &#123;</span><br><span class="line">                    <span class="attr">user</span>: &#123;</span><br><span class="line">                        <span class="attr">id</span>: userId,</span><br><span class="line">                        <span class="attr">username</span>: username,</span><br><span class="line">                        <span class="attr">email</span>: email,</span><br><span class="line">                        <span class="attr">created_at</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">tokens</span>: &#123;</span><br><span class="line">                        <span class="attr">access_token</span>: token,</span><br><span class="line">                        <span class="attr">refresh_token</span>: refreshToken,</span><br><span class="line">                        <span class="attr">token_type</span>: <span class="string">&#x27;Bearer&#x27;</span>,</span><br><span class="line">                        <span class="attr">expires_in</span>: <span class="number">86400</span> <span class="comment">// 24小时</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="keyword">await</span> transaction.<span class="title function_">rollback</span>();</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Registration error:&#x27;</span>, error);</span><br><span class="line"></span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;Registration failed due to server error&#x27;</span>,</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;REGISTRATION_ERROR&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="3-2-🔐-登录流程-auth-login"><a href="#3-2-🔐-登录流程-auth-login" class="headerlink" title="3.2 🔐 登录流程 (/auth/login)"></a>3.2 🔐 登录流程 (<code>/auth/login</code>)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用户登录路由</span></span><br><span class="line"><span class="comment"> * POST /auth/login</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>,</span><br><span class="line">    authLimiter,      <span class="comment">// 请求频率限制</span></span><br><span class="line">    [</span><br><span class="line">        <span class="title function_">body</span>(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            .<span class="title function_">trim</span>()</span><br><span class="line">            .<span class="title function_">notEmpty</span>()</span><br><span class="line">            .<span class="title function_">withMessage</span>(<span class="string">&#x27;Username or email is required&#x27;</span>),</span><br><span class="line"></span><br><span class="line">        <span class="title function_">body</span>(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">            .<span class="title function_">notEmpty</span>()</span><br><span class="line">            .<span class="title function_">withMessage</span>(<span class="string">&#x27;Password is required&#x27;</span>)</span><br><span class="line">    ],</span><br><span class="line">    validate,         <span class="comment">// 验证结果处理</span></span><br><span class="line">    <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; username, password &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">`Login attempt: username=<span class="subst">$&#123;username&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1. 查找用户 (支持用户名或邮箱登录)</span></span><br><span class="line">            <span class="keyword">const</span> [users] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">                <span class="string">&#x27;SELECT id, username, email, password, refresh_token, failed_login_attempts, locked_until FROM users WHERE username = ? OR email = ?&#x27;</span>,</span><br><span class="line">                [username, username]</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (users.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                    <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;Invalid username or password&#x27;</span>,</span><br><span class="line">                    <span class="attr">code</span>: <span class="string">&#x27;INVALID_CREDENTIALS&#x27;</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> user = users[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 检查账户是否被锁定</span></span><br><span class="line">            <span class="keyword">if</span> (user.<span class="property">locked_until</span> &amp;&amp; <span class="keyword">new</span> <span class="title class_">Date</span>() &lt; <span class="keyword">new</span> <span class="title class_">Date</span>(user.<span class="property">locked_until</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">423</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                    <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;Account is temporarily locked due to too many failed login attempts&#x27;</span>,</span><br><span class="line">                    <span class="attr">code</span>: <span class="string">&#x27;ACCOUNT_LOCKED&#x27;</span>,</span><br><span class="line">                    <span class="attr">locked_until</span>: user.<span class="property">locked_until</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 验证密码</span></span><br><span class="line">            <span class="keyword">const</span> isValidPassword = <span class="keyword">await</span> bcrypt.<span class="title function_">compare</span>(password, user.<span class="property">password</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!isValidPassword) &#123;</span><br><span class="line">                <span class="comment">// 增加失败次数</span></span><br><span class="line">                <span class="keyword">const</span> newFailedAttempts = user.<span class="property">failed_login_attempts</span> + <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">const</span> lockAccount = newFailedAttempts &gt;= <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">                    <span class="string">`UPDATE users SET</span></span><br><span class="line"><span class="string">                     failed_login_attempts = ?,</span></span><br><span class="line"><span class="string">                     locked_until = ?</span></span><br><span class="line"><span class="string">                     WHERE id = ?`</span>,</span><br><span class="line">                    [</span><br><span class="line">                        lockAccount ? <span class="number">0</span> : newFailedAttempts,</span><br><span class="line">                        lockAccount ? <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="title class_">Date</span>.<span class="title function_">now</span>() + <span class="number">30</span> * <span class="number">60</span> * <span class="number">1000</span>) : <span class="literal">null</span>, <span class="comment">// 30分钟锁定</span></span><br><span class="line">                        user.<span class="property">id</span></span><br><span class="line">                    ]</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">warn</span>(<span class="string">`Failed login attempt: username=<span class="subst">$&#123;username&#125;</span>, attempts=<span class="subst">$&#123;newFailedAttempts&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                    <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;Invalid username or password&#x27;</span>,</span><br><span class="line">                    <span class="attr">code</span>: <span class="string">&#x27;INVALID_CREDENTIALS&#x27;</span>,</span><br><span class="line">                    <span class="attr">remaining_attempts</span>: <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="number">5</span> - newFailedAttempts)</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 登录成功 - 重置失败次数</span></span><br><span class="line">            <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">                <span class="string">&#x27;UPDATE users SET failed_login_attempts = 0, locked_until = NULL, last_login = NOW() WHERE id = ?&#x27;</span>,</span><br><span class="line">                [user.<span class="property">id</span>]</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 生成 JWT Token</span></span><br><span class="line">            <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">userId</span>: user.<span class="property">id</span>,</span><br><span class="line">                    <span class="attr">username</span>: user.<span class="property">username</span>,</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;access&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">expiresIn</span>: <span class="string">&#x27;24h&#x27;</span>,</span><br><span class="line">                    <span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span>,</span><br><span class="line">                    <span class="attr">issuer</span>: <span class="string">&#x27;your-app-name&#x27;</span>,</span><br><span class="line">                    <span class="attr">audience</span>: <span class="string">&#x27;your-app-users&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6. 生成新的 Refresh Token</span></span><br><span class="line">            <span class="keyword">const</span> refreshToken = jwt.<span class="title function_">sign</span>(</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">userId</span>: user.<span class="property">id</span>,</span><br><span class="line">                    <span class="attr">type</span>: <span class="string">&#x27;refresh&#x27;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                process.<span class="property">env</span>.<span class="property">JWT_REFRESH_SECRET</span>,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">expiresIn</span>: <span class="string">&#x27;7d&#x27;</span>,</span><br><span class="line">                    <span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 7. 更新 Refresh Token</span></span><br><span class="line">            <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">                <span class="string">&#x27;UPDATE users SET refresh_token = ? WHERE id = ?&#x27;</span>,</span><br><span class="line">                [refreshToken, user.<span class="property">id</span>]</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="string">`User logged in successfully: userId=<span class="subst">$&#123;user.id&#125;</span>, username=<span class="subst">$&#123;user.username&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">            res.<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;Login successful&#x27;</span>,</span><br><span class="line">                <span class="attr">data</span>: &#123;</span><br><span class="line">                    <span class="attr">user</span>: &#123;</span><br><span class="line">                        <span class="attr">id</span>: user.<span class="property">id</span>,</span><br><span class="line">                        <span class="attr">username</span>: user.<span class="property">username</span>,</span><br><span class="line">                        <span class="attr">email</span>: user.<span class="property">email</span>,</span><br><span class="line">                        <span class="attr">last_login</span>: <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">toISOString</span>()</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">tokens</span>: &#123;</span><br><span class="line">                        <span class="attr">access_token</span>: token,</span><br><span class="line">                        <span class="attr">refresh_token</span>: refreshToken,</span><br><span class="line">                        <span class="attr">token_type</span>: <span class="string">&#x27;Bearer&#x27;</span>,</span><br><span class="line">                        <span class="attr">expires_in</span>: <span class="number">86400</span> <span class="comment">// 24小时</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Login error:&#x27;</span>, error);</span><br><span class="line"></span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;Login failed due to server error&#x27;</span>,</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;LOGIN_ERROR&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="3-3-🔄-Token-刷新流程"><a href="#3-3-🔄-Token-刷新流程" class="headerlink" title="3.3 🔄 Token 刷新流程"></a>3.3 🔄 Token 刷新流程</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 刷新访问令牌</span></span><br><span class="line"><span class="comment"> * POST /auth/refresh</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/refresh&#x27;</span>,</span><br><span class="line">    <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> &#123; refresh_token &#125; = req.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!refresh_token) &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">401</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                    <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;Refresh token is required&#x27;</span>,</span><br><span class="line">                    <span class="attr">code</span>: <span class="string">&#x27;REFRESH_TOKEN_MISSING&#x27;</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 验证 Refresh Token</span></span><br><span class="line">            jwt.<span class="title function_">verify</span>(refresh_token, process.<span class="property">env</span>.<span class="property">JWT_REFRESH_SECRET</span>, <span class="title function_">async</span> (err, decoded) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                        <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">message</span>: <span class="string">&#x27;Invalid refresh token&#x27;</span>,</span><br><span class="line">                        <span class="attr">code</span>: <span class="string">&#x27;REFRESH_TOKEN_INVALID&#x27;</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 检查数据库中的 Refresh Token</span></span><br><span class="line">                <span class="keyword">const</span> [users] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">                    <span class="string">&#x27;SELECT id, username, refresh_token FROM users WHERE id = ?&#x27;</span>,</span><br><span class="line">                    [decoded.<span class="property">userId</span>]</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (users.<span class="property">length</span> === <span class="number">0</span> || users[<span class="number">0</span>].<span class="property">refresh_token</span> !== refresh_token) &#123;</span><br><span class="line">                    <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">403</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                        <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                        <span class="attr">message</span>: <span class="string">&#x27;Invalid refresh token&#x27;</span>,</span><br><span class="line">                        <span class="attr">code</span>: <span class="string">&#x27;REFRESH_TOKEN_MISMATCH&#x27;</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 生成新的 Access Token</span></span><br><span class="line">                <span class="keyword">const</span> newAccessToken = jwt.<span class="title function_">sign</span>(</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">userId</span>: decoded.<span class="property">userId</span>,</span><br><span class="line">                        <span class="attr">username</span>: users[<span class="number">0</span>].<span class="property">username</span>,</span><br><span class="line">                        <span class="attr">type</span>: <span class="string">&#x27;access&#x27;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">expiresIn</span>: <span class="string">&#x27;24h&#x27;</span>,</span><br><span class="line">                        <span class="attr">algorithm</span>: <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                );</span><br><span class="line"></span><br><span class="line">                res.<span class="title function_">json</span>(&#123;</span><br><span class="line">                    <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;Token refreshed successfully&#x27;</span>,</span><br><span class="line">                    <span class="attr">data</span>: &#123;</span><br><span class="line">                        <span class="attr">access_token</span>: newAccessToken,</span><br><span class="line">                        <span class="attr">token_type</span>: <span class="string">&#x27;Bearer&#x27;</span>,</span><br><span class="line">                        <span class="attr">expires_in</span>: <span class="number">86400</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Token refresh error:&#x27;</span>, error);</span><br><span class="line"></span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;Token refresh failed&#x27;</span>,</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;REFRESH_ERROR&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><hr><h2 id="4-🛡️-安全措施"><a href="#4-🛡️-安全措施" class="headerlink" title="4. 🛡️ 安全措施"></a>4. 🛡️ 安全措施</h2><h3 id="4-1-✅-输入验证"><a href="#4-1-✅-输入验证" class="headerlink" title="4.1 ✅ 输入验证"></a>4.1 ✅ 输入验证</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; body, validationResult &#125; = <span class="built_in">require</span>(<span class="string">&#x27;express-validator&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 验证结果处理中间件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">validate</span> = (<span class="params">req, res, next</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> errors = <span class="title function_">validationResult</span>(req);</span><br><span class="line">    <span class="keyword">if</span> (!errors.<span class="title function_">isEmpty</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;Validation failed&#x27;</span>,</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;VALIDATION_ERROR&#x27;</span>,</span><br><span class="line">            <span class="attr">errors</span>: errors.<span class="title function_">array</span>()</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通用验证规则</span></span><br><span class="line"><span class="keyword">const</span> commonValidation = &#123;</span><br><span class="line">    <span class="attr">username</span>: [</span><br><span class="line">        <span class="title function_">body</span>(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">            .<span class="title function_">trim</span>()</span><br><span class="line">            .<span class="title function_">isLength</span>(&#123; <span class="attr">min</span>: <span class="number">3</span>, <span class="attr">max</span>: <span class="number">20</span> &#125;)</span><br><span class="line">            .<span class="title function_">matches</span>(<span class="regexp">/^[a-zA-Z0-9_]+$/</span>)</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="attr">email</span>: [</span><br><span class="line">        <span class="title function_">body</span>(<span class="string">&#x27;email&#x27;</span>)</span><br><span class="line">            .<span class="title function_">isEmail</span>()</span><br><span class="line">            .<span class="title function_">normalizeEmail</span>()</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="attr">password</span>: [</span><br><span class="line">        <span class="title function_">body</span>(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">            .<span class="title function_">isLength</span>(&#123; <span class="attr">min</span>: <span class="number">8</span> &#125;)</span><br><span class="line">            .<span class="title function_">matches</span>(<span class="regexp">/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[@$!%*?&amp;]).*$/</span>)</span><br><span class="line">            .<span class="title function_">withMessage</span>(<span class="string">&#x27;Password must be at least 8 characters long and contain uppercase, lowercase, number, and special character&#x27;</span>)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="4-2-🚦-CORS-配置"><a href="#4-2-🚦-CORS-配置" class="headerlink" title="4.2 🚦 CORS 配置"></a>4.2 🚦 CORS 配置</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cors = <span class="built_in">require</span>(<span class="string">&#x27;cors&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> corsOptions = &#123;</span><br><span class="line">    <span class="attr">origin</span>: <span class="keyword">function</span> (<span class="params">origin, callback</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> allowedOrigins = process.<span class="property">env</span>.<span class="property">ALLOWED_ORIGINS</span>?.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>) || [<span class="string">&#x27;http://localhost:3000&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 允许没有 origin 的请求 (如移动应用)</span></span><br><span class="line">        <span class="keyword">if</span> (!origin) <span class="keyword">return</span> <span class="title function_">callback</span>(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (allowedOrigins.<span class="title function_">includes</span>(origin)) &#123;</span><br><span class="line">            <span class="title function_">callback</span>(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">callback</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Not allowed by CORS&#x27;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">methods</span>: [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;PUT&#x27;</span>, <span class="string">&#x27;DELETE&#x27;</span>, <span class="string">&#x27;OPTIONS&#x27;</span>],</span><br><span class="line">    <span class="attr">allowedHeaders</span>: [<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;Authorization&#x27;</span>, <span class="string">&#x27;X-Requested-With&#x27;</span>],</span><br><span class="line">    <span class="attr">credentials</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">optionsSuccessStatus</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">maxAge</span>: <span class="number">86400</span> <span class="comment">// 24小时</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">cors</span>(corsOptions));</span><br></pre></td></tr></table></figure><h3 id="4-3-🔒-安全头部"><a href="#4-3-🔒-安全头部" class="headerlink" title="4.3 🔒 安全头部"></a>4.3 🔒 安全头部</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">&#x27;helmet&#x27;</span>);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">helmet</span>(&#123;</span><br><span class="line">    <span class="attr">contentSecurityPolicy</span>: &#123;</span><br><span class="line">        <span class="attr">directives</span>: &#123;</span><br><span class="line">            <span class="attr">defaultSrc</span>: [<span class="string">&quot;&#x27;self&#x27;&quot;</span>],</span><br><span class="line">            <span class="attr">styleSrc</span>: [<span class="string">&quot;&#x27;self&#x27;&quot;</span>, <span class="string">&quot;&#x27;unsafe-inline&#x27;&quot;</span>],</span><br><span class="line">            <span class="attr">scriptSrc</span>: [<span class="string">&quot;&#x27;self&#x27;&quot;</span>],</span><br><span class="line">            <span class="attr">imgSrc</span>: [<span class="string">&quot;&#x27;self&#x27;&quot;</span>, <span class="string">&quot;data:&quot;</span>, <span class="string">&quot;https:&quot;</span>],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">hsts</span>: &#123;</span><br><span class="line">        <span class="attr">maxAge</span>: <span class="number">31536000</span>,</span><br><span class="line">        <span class="attr">includeSubDomains</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">preload</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><hr><h2 id="5-👤-用户模型"><a href="#5-👤-用户模型" class="headerlink" title="5. 👤 用户模型"></a>5. 👤 用户模型</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcrypt&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> pool = <span class="built_in">require</span>(<span class="string">&#x27;../database/connection&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">username</span> - 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">password</span> - 明文密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">email</span> - 邮箱</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;number&gt;</span>&#125; 用户ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">createUser</span>(<span class="params">username, password, email</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> hashedPassword = <span class="keyword">await</span> bcrypt.<span class="title function_">hash</span>(password, <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> [result] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">&#x27;INSERT INTO users (username, password, email, created_at, updated_at) VALUES (?, ?, ?, NOW(), NOW())&#x27;</span>,</span><br><span class="line">            [username, hashedPassword, email]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result.<span class="property">insertId</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据用户名查找用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">username</span> - 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;Object|null&gt;</span>&#125; 用户对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">findUserByUsername</span>(<span class="params">username</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> [users] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">&#x27;SELECT id, username, email, password, created_at, updated_at FROM users WHERE username = ?&#x27;</span>,</span><br><span class="line">            [username]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> users[<span class="number">0</span>] || <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据邮箱查找用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">email</span> - 邮箱</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;Object|null&gt;</span>&#125; 用户对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">findUserByEmail</span>(<span class="params">email</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> [users] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">&#x27;SELECT id, username, email, password, created_at, updated_at FROM users WHERE email = ?&#x27;</span>,</span><br><span class="line">            [email]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> users[<span class="number">0</span>] || <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">password</span> - 明文密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">hashedPassword</span> - 哈希密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;boolean&gt;</span>&#125; 验证结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">verifyPassword</span>(<span class="params">password, hashedPassword</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> bcrypt.<span class="title function_">compare</span>(password, hashedPassword);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新用户最后登录时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">number</span>&#125; <span class="variable">userId</span> - 用户ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;void&gt;</span>&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">updateLastLogin</span>(<span class="params">userId</span>) &#123;</span><br><span class="line">        <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">&#x27;UPDATE users SET last_login = NOW() WHERE id = ?&#x27;</span>,</span><br><span class="line">            [userId]</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检查用户是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">username</span> - 用户名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">email</span> - 邮箱</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;boolean&gt;</span>&#125; 是否存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">async</span> <span class="title function_">userExists</span>(<span class="params">username, email</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> [users] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">&#x27;SELECT id FROM users WHERE username = ? OR email = ?&#x27;</span>,</span><br><span class="line">            [username, email]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> users.<span class="property">length</span> &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">User</span>;</span><br></pre></td></tr></table></figure><hr><h2 id="6-🛡️-受保护的路由"><a href="#6-🛡️-受保护的路由" class="headerlink" title="6. 🛡️ 受保护的路由"></a>6. 🛡️ 受保护的路由</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; authenticateToken &#125; = <span class="built_in">require</span>(<span class="string">&#x27;../middleware/auth&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取用户信息</span></span><br><span class="line"><span class="comment"> * GET /api/user/profile</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/profile&#x27;</span>, authenticateToken, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> userId = req.<span class="property">user</span>.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> [users] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">&#x27;SELECT id, username, email, created_at, last_login FROM users WHERE id = ?&#x27;</span>,</span><br><span class="line">            [userId]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (users.<span class="property">length</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">404</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;User not found&#x27;</span>,</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;USER_NOT_FOUND&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">user</span>: users[<span class="number">0</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Profile fetch error:&#x27;</span>, error);</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;Failed to fetch profile&#x27;</span>,</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;PROFILE_ERROR&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 文件上传路由</span></span><br><span class="line"><span class="comment"> * POST /api/files/upload</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/upload&#x27;</span>,</span><br><span class="line">    authenticateToken,</span><br><span class="line">    upload.<span class="title function_">single</span>(<span class="string">&#x27;file&#x27;</span>),</span><br><span class="line">    <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!req.<span class="property">file</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                    <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                    <span class="attr">message</span>: <span class="string">&#x27;No file uploaded&#x27;</span>,</span><br><span class="line">                    <span class="attr">code</span>: <span class="string">&#x27;NO_FILE_UPLOADED&#x27;</span></span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 文件处理逻辑...</span></span><br><span class="line">            res.<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;File uploaded successfully&#x27;</span>,</span><br><span class="line">                <span class="attr">data</span>: &#123;</span><br><span class="line">                    <span class="attr">filename</span>: req.<span class="property">file</span>.<span class="property">filename</span>,</span><br><span class="line">                    <span class="attr">size</span>: req.<span class="property">file</span>.<span class="property">size</span>,</span><br><span class="line">                    <span class="attr">mimetype</span>: req.<span class="property">file</span>.<span class="property">mimetype</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;File upload error:&#x27;</span>, error);</span><br><span class="line">            res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;File upload failed&#x27;</span>,</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;UPLOAD_ERROR&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><hr><h2 id="7-💻-客户端使用"><a href="#7-💻-客户端使用" class="headerlink" title="7. 💻 客户端使用"></a>7. 💻 客户端使用</h2><h3 id="7-1-🔐-登录示例"><a href="#7-1-🔐-登录示例" class="headerlink" title="7.1 🔐 登录示例"></a>7.1 🔐 登录示例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AuthClient</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">baseURL</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">baseURL</span> = baseURL;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">token</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户登录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">username</span> - 用户名或邮箱</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">password</span> - 密码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;Object&gt;</span>&#125; 登录结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.baseURL&#125;</span>/auth/login`</span>, &#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123; username, password &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">token</span> = data.<span class="property">data</span>.<span class="property">tokens</span>.<span class="property">access_token</span>;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">refreshToken</span> = data.<span class="property">data</span>.<span class="property">tokens</span>.<span class="property">refresh_token</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 存储到 localStorage</span></span><br><span class="line">                <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;access_token&#x27;</span>, <span class="variable language_">this</span>.<span class="property">token</span>);</span><br><span class="line">                <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;refresh_token&#x27;</span>, <span class="variable language_">this</span>.<span class="property">refreshToken</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Login error:&#x27;</span>, error);</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 带认证的请求</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">string</span>&#125; <span class="variable">url</span> - 请求URL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &#123;<span class="type">Object</span>&#125; <span class="variable">options</span> - 请求选项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@returns</span> &#123;<span class="type">Promise&lt;Response&gt;</span>&#125; 响应对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">authenticatedRequest</span>(<span class="params">url, options = &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">token</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;No authentication token available&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> defaultOptions = &#123;</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.token&#125;</span>`</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            ...options</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, defaultOptions);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Token 过期时自动刷新</span></span><br><span class="line">        <span class="keyword">if</span> (response.<span class="property">status</span> === <span class="number">403</span>) &#123;</span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">refreshAccessToken</span>();</span><br><span class="line">            defaultOptions.<span class="property">headers</span>.<span class="property">Authorization</span> = <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.token&#125;</span>`</span>;</span><br><span class="line">            response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url, defaultOptions);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 刷新访问令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">refreshAccessToken</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.baseURL&#125;</span>/auth/refresh`</span>, &#123;</span><br><span class="line">                <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">                <span class="attr">headers</span>: &#123;</span><br><span class="line">                    <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">body</span>: <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                    <span class="attr">refresh_token</span>: <span class="variable language_">this</span>.<span class="property">refreshToken</span></span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (data.<span class="property">success</span>) &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="property">token</span> = data.<span class="property">data</span>.<span class="property">access_token</span>;</span><br><span class="line">                <span class="variable language_">localStorage</span>.<span class="title function_">setItem</span>(<span class="string">&#x27;access_token&#x27;</span>, <span class="variable language_">this</span>.<span class="property">token</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Token refresh failed&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Token refresh error:&#x27;</span>, error);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">logout</span>();</span><br><span class="line">            <span class="keyword">throw</span> error;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用户登出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="title function_">logout</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">token</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refreshToken</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;access_token&#x27;</span>);</span><br><span class="line">        <span class="variable language_">localStorage</span>.<span class="title function_">removeItem</span>(<span class="string">&#x27;refresh_token&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> authClient = <span class="keyword">new</span> <span class="title class_">AuthClient</span>(<span class="string">&#x27;http://localhost:3000/api&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录</span></span><br><span class="line"><span class="keyword">const</span> loginResult = <span class="keyword">await</span> authClient.<span class="title function_">login</span>(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送认证请求</span></span><br><span class="line"><span class="keyword">const</span> profileResponse = <span class="keyword">await</span> authClient.<span class="title function_">authenticatedRequest</span>(<span class="string">&#x27;/user/profile&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> profileData = <span class="keyword">await</span> profileResponse.<span class="title function_">json</span>();</span><br></pre></td></tr></table></figure><hr><h2 id="8-🚀-高级特性"><a href="#8-🚀-高级特性" class="headerlink" title="8. 🚀 高级特性"></a>8. 🚀 高级特性</h2><h3 id="8-1-🔄-双因素认证-2FA"><a href="#8-1-🔄-双因素认证-2FA" class="headerlink" title="8.1 🔄 双因素认证 (2FA)"></a>8.1 🔄 双因素认证 (2FA)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> speakeasy = <span class="built_in">require</span>(<span class="string">&#x27;speakeasy&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> qrcode = <span class="built_in">require</span>(<span class="string">&#x27;qrcode&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启用双因素认证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/2fa/enable&#x27;</span>, authenticateToken, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> userId = req.<span class="property">user</span>.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成密钥</span></span><br><span class="line">        <span class="keyword">const</span> secret = speakeasy.<span class="title function_">generateSecret</span>(&#123;</span><br><span class="line">            <span class="attr">name</span>: <span class="string">`YourApp (<span class="subst">$&#123;req.user.username&#125;</span>)`</span>,</span><br><span class="line">            <span class="attr">issuer</span>: <span class="string">&#x27;YourApp&#x27;</span>,</span><br><span class="line">            <span class="attr">length</span>: <span class="number">32</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 保存密钥到数据库 (未验证状态)</span></span><br><span class="line">        <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">&#x27;UPDATE users SET two_factor_secret = ?, two_factor_enabled = FALSE WHERE id = ?&#x27;</span>,</span><br><span class="line">            [secret.<span class="property">base32</span>, userId]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成二维码</span></span><br><span class="line">        <span class="keyword">const</span> qrCodeUrl = <span class="keyword">await</span> qrcode.<span class="title function_">toDataURL</span>(secret.<span class="property">otpauth_url</span>);</span><br><span class="line"></span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;2FA setup initiated&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>: &#123;</span><br><span class="line">                <span class="attr">secret</span>: secret.<span class="property">base32</span>,</span><br><span class="line">                <span class="attr">qr_code</span>: qrCodeUrl,</span><br><span class="line">                <span class="attr">backup_codes</span>: <span class="title function_">generateBackupCodes</span>()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;2FA enable error:&#x27;</span>, error);</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;Failed to enable 2FA&#x27;</span>,</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;TWO_FA_ENABLE_ERROR&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证双因素认证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/2fa/verify&#x27;</span>, authenticateToken, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; token &#125; = req.<span class="property">body</span>;</span><br><span class="line">        <span class="keyword">const</span> userId = req.<span class="property">user</span>.<span class="property">id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取用户的密钥</span></span><br><span class="line">        <span class="keyword">const</span> [users] = <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">&#x27;SELECT two_factor_secret FROM users WHERE id = ?&#x27;</span>,</span><br><span class="line">            [userId]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (users.<span class="property">length</span> === <span class="number">0</span> || !users[<span class="number">0</span>].<span class="property">two_factor_secret</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;2FA not set up for this user&#x27;</span>,</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;TWO_FA_NOT_SETUP&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证令牌</span></span><br><span class="line">        <span class="keyword">const</span> verified = speakeasy.<span class="property">totp</span>.<span class="title function_">verify</span>(&#123;</span><br><span class="line">            <span class="attr">secret</span>: users[<span class="number">0</span>].<span class="property">two_factor_secret</span>,</span><br><span class="line">            <span class="attr">encoding</span>: <span class="string">&#x27;base32&#x27;</span>,</span><br><span class="line">            <span class="attr">token</span>: token,</span><br><span class="line">            <span class="attr">window</span>: <span class="number">2</span> <span class="comment">// 允许2个时间窗口的偏差</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!verified) &#123;</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">status</span>(<span class="number">400</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">                <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">                <span class="attr">message</span>: <span class="string">&#x27;Invalid 2FA token&#x27;</span>,</span><br><span class="line">                <span class="attr">code</span>: <span class="string">&#x27;TWO_FA_INVALID_TOKEN&#x27;</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启用双因素认证</span></span><br><span class="line">        <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">&#x27;UPDATE users SET two_factor_enabled = TRUE WHERE id = ?&#x27;</span>,</span><br><span class="line">            [userId]</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        res.<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;2FA enabled successfully&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;2FA verification error:&#x27;</span>, error);</span><br><span class="line">        res.<span class="title function_">status</span>(<span class="number">500</span>).<span class="title function_">json</span>(&#123;</span><br><span class="line">            <span class="attr">success</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">message</span>: <span class="string">&#x27;Failed to verify 2FA&#x27;</span>,</span><br><span class="line">            <span class="attr">code</span>: <span class="string">&#x27;TWO_FA_VERIFY_ERROR&#x27;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="8-2-📝-审计日志"><a href="#8-2-📝-审计日志" class="headerlink" title="8.2 📝 审计日志"></a>8.2 📝 审计日志</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 记录安全事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">logSecurityEvent</span>(<span class="params">userId, eventType, details, ipAddress, userAgent</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> pool.<span class="title function_">execute</span>(</span><br><span class="line">            <span class="string">`INSERT INTO security_logs</span></span><br><span class="line"><span class="string">             (user_id, event_type, details, ip_address, user_agent, created_at)</span></span><br><span class="line"><span class="string">             VALUES (?, ?, ?, ?, ?, NOW())`</span>,</span><br><span class="line">            [userId, eventType, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(details), ipAddress, userAgent]</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Failed to log security event:&#x27;</span>, error);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在认证路由中使用</span></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, authLimiter, <span class="title function_">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> ipAddress = req.<span class="property">ip</span>;</span><br><span class="line">    <span class="keyword">const</span> userAgent = req.<span class="title function_">get</span>(<span class="string">&#x27;User-Agent&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... 登录逻辑 ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (loginSuccessful) &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">logSecurityEvent</span>(</span><br><span class="line">            user.<span class="property">id</span>,</span><br><span class="line">            <span class="string">&#x27;LOGIN_SUCCESS&#x27;</span>,</span><br><span class="line">            &#123; username &#125;,</span><br><span class="line">            ipAddress,</span><br><span class="line">            userAgent</span><br><span class="line">        );</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> <span class="title function_">logSecurityEvent</span>(</span><br><span class="line">            <span class="literal">null</span>, <span class="comment">// 未知用户</span></span><br><span class="line">            <span class="string">&#x27;LOGIN_FAILED&#x27;</span>,</span><br><span class="line">            &#123; username, <span class="attr">reason</span>: <span class="string">&#x27;invalid_credentials&#x27;</span> &#125;,</span><br><span class="line">            ipAddress,</span><br><span class="line">            userAgent</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><hr><h2 id="9-🧪-测试与调试"><a href="#9-🧪-测试与调试" class="headerlink" title="9. 🧪 测试与调试"></a>9. 🧪 测试与调试</h2><h3 id="9-1-🧪-单元测试"><a href="#9-1-🧪-单元测试" class="headerlink" title="9.1 🧪 单元测试"></a>9.1 🧪 单元测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">&#x27;supertest&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">&#x27;../app&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> pool = <span class="built_in">require</span>(<span class="string">&#x27;../database/connection&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">describe</span>(<span class="string">&#x27;Authentication API&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">beforeEach</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="comment">// 清理测试数据</span></span><br><span class="line">        <span class="keyword">await</span> pool.<span class="title function_">execute</span>(<span class="string">&#x27;DELETE FROM users WHERE username LIKE &quot;test_%&quot;&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">afterAll</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">        <span class="comment">// 关闭数据库连接</span></span><br><span class="line">        <span class="keyword">await</span> pool.<span class="title function_">end</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">describe</span>(<span class="string">&#x27;POST /auth/register&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">it</span>(<span class="string">&#x27;should register a new user successfully&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> userData = &#123;</span><br><span class="line">                <span class="attr">username</span>: <span class="string">&#x27;test_user&#x27;</span>,</span><br><span class="line">                <span class="attr">email</span>: <span class="string">&#x27;test@example.com&#x27;</span>,</span><br><span class="line">                <span class="attr">password</span>: <span class="string">&#x27;TestPass123!&#x27;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">request</span>(app)</span><br><span class="line">                .<span class="title function_">post</span>(<span class="string">&#x27;/auth/register&#x27;</span>)</span><br><span class="line">                .<span class="title function_">send</span>(userData)</span><br><span class="line">                .<span class="title function_">expect</span>(<span class="number">201</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">success</span>).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">            <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">data</span>.<span class="property">user</span>.<span class="property">username</span>).<span class="title function_">toBe</span>(userData.<span class="property">username</span>);</span><br><span class="line">            <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">data</span>.<span class="property">tokens</span>.<span class="property">access_token</span>).<span class="title function_">toBeDefined</span>();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">it</span>(<span class="string">&#x27;should reject duplicate username&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> userData = &#123;</span><br><span class="line">                <span class="attr">username</span>: <span class="string">&#x27;test_user&#x27;</span>,</span><br><span class="line">                <span class="attr">email</span>: <span class="string">&#x27;test@example.com&#x27;</span>,</span><br><span class="line">                <span class="attr">password</span>: <span class="string">&#x27;TestPass123!&#x27;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第一次注册成功</span></span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">request</span>(app)</span><br><span class="line">                .<span class="title function_">post</span>(<span class="string">&#x27;/auth/register&#x27;</span>)</span><br><span class="line">                .<span class="title function_">send</span>(userData)</span><br><span class="line">                .<span class="title function_">expect</span>(<span class="number">201</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 第二次注册失败</span></span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">request</span>(app)</span><br><span class="line">                .<span class="title function_">post</span>(<span class="string">&#x27;/auth/register&#x27;</span>)</span><br><span class="line">                .<span class="title function_">send</span>(userData)</span><br><span class="line">                .<span class="title function_">expect</span>(<span class="number">400</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">success</span>).<span class="title function_">toBe</span>(<span class="literal">false</span>);</span><br><span class="line">            <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">code</span>).<span class="title function_">toBe</span>(<span class="string">&#x27;USER_EXISTS&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">describe</span>(<span class="string">&#x27;POST /auth/login&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">beforeEach</span>(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">            <span class="comment">// 创建测试用户</span></span><br><span class="line">            <span class="keyword">await</span> <span class="title function_">request</span>(app)</span><br><span class="line">                .<span class="title function_">post</span>(<span class="string">&#x27;/auth/register&#x27;</span>)</span><br><span class="line">                .<span class="title function_">send</span>(&#123;</span><br><span class="line">                    <span class="attr">username</span>: <span class="string">&#x27;test_user&#x27;</span>,</span><br><span class="line">                    <span class="attr">email</span>: <span class="string">&#x27;test@example.com&#x27;</span>,</span><br><span class="line">                    <span class="attr">password</span>: <span class="string">&#x27;TestPass123!&#x27;</span></span><br><span class="line">                &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">it</span>(<span class="string">&#x27;should login with valid credentials&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">request</span>(app)</span><br><span class="line">                .<span class="title function_">post</span>(<span class="string">&#x27;/auth/login&#x27;</span>)</span><br><span class="line">                .<span class="title function_">send</span>(&#123;</span><br><span class="line">                    <span class="attr">username</span>: <span class="string">&#x27;test_user&#x27;</span>,</span><br><span class="line">                    <span class="attr">password</span>: <span class="string">&#x27;TestPass123!&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="title function_">expect</span>(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">success</span>).<span class="title function_">toBe</span>(<span class="literal">true</span>);</span><br><span class="line">            <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">data</span>.<span class="property">tokens</span>.<span class="property">access_token</span>).<span class="title function_">toBeDefined</span>();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">it</span>(<span class="string">&#x27;should reject invalid credentials&#x27;</span>, <span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">request</span>(app)</span><br><span class="line">                .<span class="title function_">post</span>(<span class="string">&#x27;/auth/login&#x27;</span>)</span><br><span class="line">                .<span class="title function_">send</span>(&#123;</span><br><span class="line">                    <span class="attr">username</span>: <span class="string">&#x27;test_user&#x27;</span>,</span><br><span class="line">                    <span class="attr">password</span>: <span class="string">&#x27;wrongpassword&#x27;</span></span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="title function_">expect</span>(<span class="number">401</span>);</span><br><span class="line"></span><br><span class="line">            <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">success</span>).<span class="title function_">toBe</span>(<span class="literal">false</span>);</span><br><span class="line">            <span class="title function_">expect</span>(response.<span class="property">body</span>.<span class="property">code</span>).<span class="title function_">toBe</span>(<span class="string">&#x27;INVALID_CREDENTIALS&#x27;</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="9-2-🔍-调试工具"><a href="#9-2-🔍-调试工具" class="headerlink" title="9.2 🔍 调试工具"></a>9.2 🔍 调试工具</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Token 调试工具</span></span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">debugToken</span>(<span class="params">token</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> decoded = jwt.<span class="title function_">decode</span>(token, &#123; <span class="attr">complete</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Token Debug Info:&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Header:&#x27;</span>, decoded.<span class="property">header</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Payload:&#x27;</span>, decoded.<span class="property">payload</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Signature:&#x27;</span>, decoded.<span class="property">signature</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证 token</span></span><br><span class="line">        <span class="keyword">const</span> verified = jwt.<span class="title function_">verify</span>(token, process.<span class="property">env</span>.<span class="property">JWT_SECRET</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Verification:&#x27;</span>, <span class="string">&#x27;✅ Valid&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Expiration:&#x27;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>(verified.<span class="property">exp</span> * <span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Verification:&#x27;</span>, <span class="string">&#x27;❌ Invalid&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error:&#x27;</span>, error.<span class="property">message</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用方式</span></span><br><span class="line"><span class="title function_">debugToken</span>(<span class="string">&#x27;your.jwt.token.here&#x27;</span>);</span><br></pre></td></tr></table></figure><hr><h2 id="📊-总结"><a href="#📊-总结" class="headerlink" title="📊 总结"></a>📊 总结</h2><h3 id="✅-认证系统特性"><a href="#✅-认证系统特性" class="headerlink" title="✅ 认证系统特性"></a>✅ 认证系统特性</h3><ul><li>✅ <strong>安全的密码存储</strong> (bcrypt)</li><li>✅ <strong>JWT Token 认证</strong></li><li>✅ <strong>请求频率限制</strong></li><li>✅ <strong>输入验证和清理</strong></li><li>✅ <strong>CORS 跨域保护</strong></li><li>✅ <strong>错误处理和安全日志</strong></li><li>✅ <strong>双因素认证支持</strong></li><li>✅ <strong>审计日志记录</strong></li></ul><h3 id="🎯-安全最佳实践"><a href="#🎯-安全最佳实践" class="headerlink" title="🎯 安全最佳实践"></a>🎯 安全最佳实践</h3><ol><li><strong>使用 HTTPS</strong> - 所有认证请求必须通过 HTTPS</li><li><strong>密码策略</strong> - 强制使用复杂密码</li><li><strong>Token 管理</strong> - 合理设置过期时间</li><li><strong>监控日志</strong> - 记录所有安全相关事件</li><li><strong>定期更新</strong> - 保持依赖库最新版本</li></ol><h3 id="📚-扩展建议"><a href="#📚-扩展建议" class="headerlink" title="📚 扩展建议"></a>📚 扩展建议</h3><ul><li>实现密码重置功能</li><li>添加账户邮箱验证</li><li>实现社交登录集成</li><li>添加设备管理功能</li><li>实现细粒度权限控制</li></ul><hr><blockquote><p><strong>💡 提示</strong>: 在生产环境中，请确保：</p><ul><li>使用强密钥和定期轮换</li><li>启用详细的日志记录</li><li>实施监控和告警机制</li><li>定期进行安全审计</li></ul></blockquote>]]></content>
    
    
    <summary type="html">专业的技术文档，详细说明如何实现基于 JWT 的服务器端用户认证系统，涵盖注册、登录、Token 刷新及安全防护。</summary>
    
    
    
    <category term="Web架构安全" scheme="https://vilaswang.github.io/categories/Web%E6%9E%B6%E6%9E%84%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>C++ Web 代理设计架构</title>
    <link href="https://vilaswang.github.io/posts/95bf2167/"/>
    <id>https://vilaswang.github.io/posts/95bf2167/</id>
    <published>2025-12-09T06:09:55.000Z</published>
    <updated>2025-12-17T15:36:29.259Z</updated>
    
    <content type="html"><![CDATA[<h1 id="C-Web-代理设计架构"><a href="#C-Web-代理设计架构" class="headerlink" title="C++ Web 代理设计架构"></a>C++ Web 代理设计架构</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>agents</code>, <code>cpp</code>, <code>web-development</code>, <code>specialization</code>, <code>ai-assistants</code>, <code>claude-code</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99">2. 设计原则</a></li><li><a href="#3-agent-%E6%9E%B6%E6%9E%84">3. Agent 架构</a></li><li><a href="#4-%E6%A0%B8%E5%BF%83%E5%9B%A2%E9%98%9F-agents">4. 核心团队 Agents</a><ul><li><a href="#41-project-architect-agent">4.1 Project Architect Agent</a></li><li><a href="#42-api-designer-agent">4.2 API Designer Agent</a></li><li><a href="#43-core-logic-developer-agent">4.3 Core Logic Developer Agent</a></li><li><a href="#44-web-service-integrator-agent">4.4 Web Service Integrator Agent</a></li><li><a href="#45-build--dependency-expert-agent">4.5 Build &amp; Dependency Expert Agent</a></li><li><a href="#46-qa-specialist-agent">4.6 QA Specialist Agent</a></li><li><a href="#47-deployment-operator-agent">4.7 Deployment Operator Agent</a></li></ul></li><li><a href="#5-%E5%8D%8F%E4%BD%9C%E6%B5%81%E7%A8%8B">5. 协作流程</a></li><li><a href="#6-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97">6. 使用指南</a></li><li><a href="#7-%E6%89%A9%E5%B1%95%E5%92%8C%E7%BB%B4%E6%8A%A4">7. 扩展和维护</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>本指南详细说明如何为 C++ Web 项目创建专门化的 AI Agent 团队，每个 Agent 都具有特定的职责和专业能力，通过协同工作完成从设计到部署的完整开发流程。</p><h3 id="🎯-设计目标"><a href="#🎯-设计目标" class="headerlink" title="🎯 设计目标"></a>🎯 设计目标</h3><ul><li>✅ <strong>专业化分工</strong> - 每个 Agent 专注于特定领域</li><li>✅ <strong>流程标准化</strong> - 建立清晰的开发工作流程</li><li>✅ <strong>质量保证</strong> - 确保代码质量和最佳实践</li><li>✅ <strong>可扩展性</strong> - 支持项目规模和复杂度增长</li><li>✅ <strong>一致性</strong> - 维护项目规范和标准统一</li></ul><h3 id="🏗️-系统架构图"><a href="#🏗️-系统架构图" class="headerlink" title="🏗️ 系统架构图"></a>🏗️ 系统架构图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">    A[Project Requirements] --&gt; B[Team Lead / Coordinator]</span><br><span class="line"></span><br><span class="line">    B --&gt; C[Project Architect]</span><br><span class="line">    B --&gt; D[API Designer]</span><br><span class="line">    B --&gt; E[Core Logic Developer]</span><br><span class="line">    B --&gt; F[Web Service Integrator]</span><br><span class="line">    B --&gt; G[Build Expert]</span><br><span class="line">    B --&gt; H[QA Specialist]</span><br><span class="line">    B --&gt; I[Deployment Operator]</span><br><span class="line"></span><br><span class="line">    C --&gt; J[System Architecture]</span><br><span class="line">    C --&gt; K[Technology Stack]</span><br><span class="line"></span><br><span class="line">    D --&gt; L[API Specifications]</span><br><span class="line">    D --&gt; M[Documentation]</span><br><span class="line"></span><br><span class="line">    E --&gt; N[Business Logic]</span><br><span class="line">    E --&gt; O[Core Algorithms]</span><br><span class="line"></span><br><span class="line">    F --&gt; P[Web Framework Integration]</span><br><span class="line">    F --&gt; Q[Request Handling]</span><br><span class="line"></span><br><span class="line">    G --&gt; R[Build Configuration]</span><br><span class="line">    G --&gt; S[Dependency Management]</span><br><span class="line"></span><br><span class="line">    H --&gt; T[Testing Strategy]</span><br><span class="line">    H --&gt; U[Quality Metrics]</span><br><span class="line"></span><br><span class="line">    I --&gt; V[Containerization]</span><br><span class="line">    I --&gt; W[Deployment Scripts]</span><br><span class="line"></span><br><span class="line">    J --&gt; X[C++ Web Application]</span><br><span class="line">    L --&gt; X</span><br><span class="line">    N --&gt; X</span><br><span class="line">    P --&gt; X</span><br><span class="line">    R --&gt; X</span><br><span class="line">    T --&gt; X</span><br><span class="line">    V --&gt; X</span><br></pre></td></tr></table></figure><hr><h2 id="2-🎯-设计原则"><a href="#2-🎯-设计原则" class="headerlink" title="2. 🎯 设计原则"></a>2. 🎯 设计原则</h2><h3 id="2-1-🔄-职责分离原则"><a href="#2-1-🔄-职责分离原则" class="headerlink" title="2.1 🔄 职责分离原则"></a>2.1 🔄 职责分离原则</h3><p>每个 Agent 都应该有明确的职责边界，避免功能重叠：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[架构设计] --&gt; B[业务逻辑] --&gt; C[Web集成] --&gt; D[构建部署]</span><br><span class="line"></span><br><span class="line">    style A fill:#e1f5fe</span><br><span class="line">    style B fill:#f3e5f5</span><br><span class="line">    style C fill:#e8f5e8</span><br><span class="line">    style D fill:#fff3e0</span><br></pre></td></tr></table></figure><h3 id="2-2-📋-可追溯性原则"><a href="#2-2-📋-可追溯性原则" class="headerlink" title="2.2 📋 可追溯性原则"></a>2.2 📋 可追溯性原则</h3><p>每个产出物都应该能够追溯到创建它的 Agent：</p><table><thead><tr><th>Agent</th><th>产出物</th><th>可追溯标识</th></tr></thead><tbody><tr><td>Architect</td><td><code>CMakeLists.txt</code></td><td><code>// Generated by: cpp_architect</code></td></tr><tr><td>API Designer</td><td>OpenAPI spec</td><td><code>// Designed by: api_designer</code></td></tr><tr><td>Core Logic</td><td><code>.cpp/.hpp</code> files</td><td><code>// Implemented by: core_logic_developer</code></td></tr></tbody></table><h3 id="2-3-🔄-迭代改进原则"><a href="#2-3-🔄-迭代改进原则" class="headerlink" title="2.3 🔄 迭代改进原则"></a>2.3 🔄 迭代改进原则</h3><p>Agent 应该能够基于反馈进行迭代改进，而不需要完全重写。</p><hr><h2 id="3-🏢-Agent-架构"><a href="#3-🏢-Agent-架构" class="headerlink" title="3. 🏢 Agent 架构"></a>3. 🏢 Agent 架构</h2><h3 id="3-1-🔧-标准化-Agent-结构"><a href="#3-1-🔧-标准化-Agent-结构" class="headerlink" title="3.1 🔧 标准化 Agent 结构"></a>3.1 🔧 标准化 Agent 结构</h3><p>每个 Agent 都遵循统一的模板结构：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># C++ Web 代理设计架构</span></span><br><span class="line"><span class="section">## Description</span></span><br><span class="line">&#123;详细的角色描述和职责&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">## Capabilities</span></span><br><span class="line"><span class="bullet">-</span> &#123;核心能力列表&#125;</span><br><span class="line"><span class="bullet">-</span> &#123;专业技能&#125;</span><br><span class="line"><span class="bullet">-</span> &#123;工具和框架&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">## Workflow</span></span><br><span class="line"><span class="bullet">1.</span> &#123;步骤1&#125;</span><br><span class="line"><span class="bullet">2.</span> &#123;步骤2&#125;</span><br><span class="line"><span class="bullet">3.</span> &#123;步骤3&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">## Input Dependencies</span></span><br><span class="line"><span class="bullet">-</span> &#123;需要的前置输入&#125;</span><br><span class="line"><span class="bullet">-</span> &#123;依赖的文件或配置&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">## Output Artifacts</span></span><br><span class="line"><span class="bullet">-</span> &#123;生成的文件&#125;</span><br><span class="line"><span class="bullet">-</span> &#123;文档产出&#125;</span><br><span class="line"><span class="bullet">-</span> &#123;配置文件&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">## Collaboration</span></span><br><span class="line"><span class="bullet">-</span> &#123;与其他 Agent 的协作方式&#125;</span><br><span class="line"><span class="bullet">-</span> &#123;交互接口&#125;</span><br><span class="line"><span class="bullet">-</span> &#123;数据交换格式&#125;</span><br></pre></td></tr></table></figure><h3 id="3-2-🔗-Agent-通信协议"><a href="#3-2-🔗-Agent-通信协议" class="headerlink" title="3.2 🔗 Agent 通信协议"></a>3.2 🔗 Agent 通信协议</h3><p>定义标准化的 Agent 间通信格式：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;agent_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;core_logic_developer&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;task_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;task_uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;inputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;api_spec&quot;</span><span class="punctuation">:</span> <span class="string">&quot;path/to/openapi.yaml&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;architecture&quot;</span><span class="punctuation">:</span> <span class="string">&quot;path/to/architecture.md&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;source_files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;src/*.cpp&quot;</span><span class="punctuation">,</span> <span class="string">&quot;include/*.hpp&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;unit_tests&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;tests/*.cpp&quot;</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-11-14T10:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><hr><h2 id="4-🎭-核心团队-Agents"><a href="#4-🎭-核心团队-Agents" class="headerlink" title="4. 🎭 核心团队 Agents"></a>4. 🎭 核心团队 Agents</h2><h3 id="4-1-🏗️-Project-Architect-Agent"><a href="#4-1-🏗️-Project-Architect-Agent" class="headerlink" title="4.1 🏗️ Project Architect Agent"></a>4.1 🏗️ Project Architect Agent</h3><h4 id="Agent-cpp-architect"><a href="#Agent-cpp-architect" class="headerlink" title="Agent: cpp_architect"></a>Agent: <code>cpp_architect</code></h4><p><strong>Description:</strong><br>你是一位经验丰富的 C++ 系统架构师。你的核心职责是为新的 C++ Web 服务项目进行高层次设计和技术选型。你专注于系统的可扩展性、性能和可维护性。</p><p><strong>Capabilities:</strong></p><ul><li>系统架构设计和模式选择</li><li>C++ Web 框架技术选型</li><li>性能分析和优化策略</li><li>代码规范和最佳实践制定</li><li>项目结构设计</li><li>依赖关系管理</li></ul><p><strong>Workflow:</strong></p><ol><li><strong>需求分析</strong> - 分析项目需求，确定核心模块和组件</li><li><strong>技术选型</strong> - 选择合适的 C++ Web 框架并说明理由</li><li><strong>架构设计</strong> - 设计系统架构图，包括组件关系和数据流</li><li><strong>接口定义</strong> - 定义关键的数据结构、接口和命名空间</li><li><strong>规范制定</strong> - 制定代码规范和项目结构准则</li></ol><p><strong>Input Dependencies:</strong></p><ul><li>项目需求文档</li><li>性能要求</li><li>部署环境信息</li><li>团队技能水平</li></ul><p><strong>Output Artifacts:</strong></p><ul><li><code>docs/architecture.md</code> - 架构设计文档</li><li><code>CMakeLists.txt</code> - 初始构建配置</li><li><code>project_structure.txt</code> - 项目目录结构规划</li><li><code>include/core/</code> - 核心模块头文件草图</li></ul><p><strong>Collaboration:</strong></p><ul><li><strong>向 API Designer 提供架构约束</strong></li><li><strong>接收 Build Expert 的技术反馈</strong></li><li><strong>指导 Core Logic Developer 的模块设计</strong></li></ul><hr><h3 id="4-2-📝-API-Designer-Agent"><a href="#4-2-📝-API-Designer-Agent" class="headerlink" title="4.2 📝 API Designer Agent"></a>4.2 📝 API Designer Agent</h3><h4 id="Agent-api-designer"><a href="#Agent-api-designer" class="headerlink" title="Agent: api_designer"></a>Agent: <code>api_designer</code></h4><p><strong>Description:</strong><br>你是一名专注于 API 设计的专家。你的任务是将业务需求转化为一组清晰、符合 RESTful 规范或 RPC 规范的 Web API 接口。</p><p><strong>Capabilities:</strong></p><ul><li>RESTful API 设计原则</li><li>OpenAPI&#x2F;Swagger 规范编写</li><li>API 文档生成和维护</li><li>数据模型设计</li><li>错误处理和状态码设计</li><li>API 版本管理策略</li></ul><p><strong>Workflow:</strong></p><ol><li><strong>需求沟通</strong> - 与 <code>cpp_architect</code> 和需求方沟通，理解功能点</li><li><strong>接口设计</strong> - 设计每个 API 端点的 URL 路径、HTTP 方法</li><li><strong>数据格式定义</strong> - 定义请求和响应的数据格式（JSON Schema）</li><li><strong>文档编写</strong> - 编写详细的 API 文档，包括参数说明、状态码和示例</li><li><strong>验证测试</strong> - 创建 API 验证测试用例</li></ol><p><strong>Input Dependencies:</strong></p><ul><li>业务需求文档</li><li>系统架构设计</li><li>用户故事和用例</li></ul><p><strong>Output Artifacts:</strong></p><ul><li><code>api/openapi.yaml</code> - OpenAPI 规范文件</li><li><code>docs/api.md</code> - 人类可读的 API 文档</li><li><code>include/api/dtos.hpp</code> - C++ 数据传输对象定义</li><li><code>tests/api_validation.cpp</code> - API 验证测试</li></ul><p><strong>Collaboration:</strong></p><ul><li><strong>从 Architect 获取架构约束</strong></li><li><strong>为 Core Logic Developer 提供数据结构</strong></li><li><strong>与 QA Specialist 协作设计测试用例</strong></li></ul><hr><h3 id="4-3-⚙️-Core-Logic-Developer-Agent"><a href="#4-3-⚙️-Core-Logic-Developer-Agent" class="headerlink" title="4.3 ⚙️ Core Logic Developer Agent"></a>4.3 ⚙️ Core Logic Developer Agent</h3><h4 id="Agent-core-logic-developer"><a href="#Agent-core-logic-developer" class="headerlink" title="Agent: core_logic_developer"></a>Agent: <code>core_logic_developer</code></h4><p><strong>Description:</strong><br>你是一名纯粹的 C++ 核心逻辑程序员。你只关心业务逻辑和算法的实现，不涉及任何 Web 或网络细节。你编写的代码应该是框架无关的、可测试的。</p><p><strong>Capabilities:</strong></p><ul><li>现代 C++ 编程（C++17&#x2F;20）</li><li>算法和数据结构实现</li><li>设计模式应用</li><li>内存管理和性能优化</li><li>异常处理和错误管理</li><li>单元测试编写</li></ul><p><strong>Workflow:</strong></p><ol><li><strong>需求理解</strong> - 接收来自 <code>api_designer</code> 的数据结构定义和业务规则</li><li><strong>设计实现</strong> - 实现具体的业务逻辑类、函数和算法</li><li><strong>编码质量</strong> - 确保代码高效、安全（异常处理、内存管理）</li><li><strong>测试编写</strong> - 为每个函数和类编写单元测试</li><li><strong>规范遵循</strong> - 遵循 <code>cpp_architect</code> 制定的代码规范</li></ol><p><strong>Input Dependencies:</strong></p><ul><li>API 数据结构定义</li><li>业务逻辑规则</li><li>性能要求</li><li>代码规范</li></ul><p><strong>Output Artifacts:</strong></p><ul><li><code>src/core/*.cpp</code> - 纯净的 C++ 业务逻辑实现</li><li><code>include/core/*.hpp</code> - 核心逻辑头文件</li><li><code>tests/unit/*.cpp</code> - 单元测试文件</li><li><code>docs/core_design.md</code> - 核心逻辑设计文档</li></ul><p><strong>Collaboration:</strong></p><ul><li><strong>从 API Designer 获取数据模型</strong></li><li><strong>向 Web Service Integrator 提供接口</strong></li><li><strong>与 QA Specialist 协作测试策略</strong></li></ul><hr><h3 id="4-4-🌐-Web-Service-Integrator-Agent"><a href="#4-4-🌐-Web-Service-Integrator-Agent" class="headerlink" title="4.4 🌐 Web Service Integrator Agent"></a>4.4 🌐 Web Service Integrator Agent</h3><h4 id="Agent-web-service-integrator"><a href="#Agent-web-service-integrator" class="headerlink" title="Agent: web_service_integrator"></a>Agent: <code>web_service_integrator</code></h4><p><strong>Description:</strong><br>你是一名集成专家，负责将 <code>core_logic_developer</code> 编写的业务逻辑与 <code>cpp_architect</code> 选定的 Web 框架”粘合”在一起。</p><p><strong>Capabilities:</strong></p><ul><li>Web 框架集成（Drogon, Pistache, Crow 等）</li><li>HTTP 请求&#x2F;响应处理</li><li>序列化&#x2F;反序列化（JSON, XML 等）</li><li>路由配置和管理</li><li>中间件开发</li><li>错误处理和日志记录</li></ul><p><strong>Workflow:</strong></p><ol><li><strong>框架准备</strong> - 引入 <code>core_logic_developer</code> 创建的库或代码</li><li><strong>控制器开发</strong> - 使用选定的 Web 框架创建控制器</li><li><strong>请求处理</strong> - 在控制器中处理 HTTP 请求，调用业务逻辑</li><li><strong>响应格式化</strong> - 将业务逻辑结果序列化为 HTTP 响应</li><li><strong>路由配置</strong> - 配置路由，将 URL 映射到对应的控制器</li></ol><p><strong>Input Dependencies:</strong></p><ul><li>选定的 Web 框架</li><li>核心业务逻辑代码</li><li>API 接口定义</li><li>系统架构设计</li></ul><p><strong>Output Artifacts:</strong></p><ul><li><code>src/web/*.cpp</code> - Web 框架特定的源代码</li><li><code>src/main.cpp</code> - 程序入口文件</li><li><code>config/routes.json</code> - 路由配置文件</li><li><code>docs/integration_guide.md</code> - 集成指南</li></ul><p><strong>Collaboration:</strong></p><ul><li><strong>集成 Core Logic Developer 的代码</strong></li><li><strong>实现 API Designer 定义的接口</strong></li><li><strong>使用 Architect 选择的框架</strong></li></ul><hr><h3 id="4-5-🔨-Build-Dependency-Expert-Agent"><a href="#4-5-🔨-Build-Dependency-Expert-Agent" class="headerlink" title="4.5 🔨 Build &amp; Dependency Expert Agent"></a>4.5 🔨 Build &amp; Dependency Expert Agent</h3><h4 id="Agent-build-dependency-expert"><a href="#Agent-build-dependency-expert" class="headerlink" title="Agent: build_dependency_expert"></a>Agent: <code>build_dependency_expert</code></h4><p><strong>Description:</strong><br>你是一名构建系统大师，精通 CMake 和 C++ 依赖管理（如 Conan, vcpkg）。你确保项目可以在不同平台上一键构建。</p><p><strong>Capabilities:</strong></p><ul><li>CMake 高级配置和优化</li><li>包管理器集成（Conan, vcpkg, Hunter）</li><li>跨平台构建配置</li><li>CI&#x2F;CD 管道设置</li><li>静态分析和代码检查集成</li><li>构建性能优化</li></ul><p><strong>Workflow:</strong></p><ol><li><strong>构建配置</strong> - 维护和优化 <code>CMakeLists.txt</code> 文件</li><li><strong>依赖管理</strong> - 管理项目的所有第三方依赖</li><li><strong>编译配置</strong> - 配置编译选项、警告级别、优化设置</li><li><strong>工具集成</strong> - 设置静态分析或代码格式化工具</li><li><strong>CI&#x2F;CD 配置</strong> - 创建持续集成和部署管道</li></ol><p><strong>Input Dependencies:</strong></p><ul><li>项目架构和依赖需求</li><li>目标平台信息</li><li>团队开发工具链</li></ul><p><strong>Output Artifacts:</strong></p><ul><li><code>CMakeLists.txt</code> - 完整的构建配置</li><li><code>conanfile.txt</code> - Conan 依赖配置</li><li><code>.github/workflows/</code> - CI&#x2F;CD 配置文件</li><li><code>scripts/build.sh</code> - 构建脚本</li><li><code>docs/build_guide.md</code> - 构建指南</li></ul><p><strong>Collaboration:</strong></p><ul><li><strong>支持所有其他 Agent 的构建需求</strong></li><li><strong>优化整个项目的构建流程</strong></li><li><strong>确保跨平台兼容性</strong></li></ul><hr><h3 id="4-6-🔍-QA-Specialist-Agent"><a href="#4-6-🔍-QA-Specialist-Agent" class="headerlink" title="4.6 🔍 QA Specialist Agent"></a>4.6 🔍 QA Specialist Agent</h3><h4 id="Agent-qa-specialist"><a href="#Agent-qa-specialist" class="headerlink" title="Agent: qa_specialist"></a>Agent: <code>qa_specialist</code></h4><p><strong>Description:</strong><br>你是一名一丝不苟的质量保证工程师。你为项目的所有关键部分编写全面的测试用例，并确保代码质量标准得到执行。</p><p><strong>Capabilities:</strong></p><ul><li>单元测试和集成测试设计</li><li>性能测试和基准测试</li><li>代码覆盖率分析</li><li>静态代码分析</li><li>测试自动化</li><li>质量指标监控</li></ul><p><strong>Workflow:</strong></p><ol><li><strong>测试策略</strong> - 制定全面的测试策略和计划</li><li><strong>单元测试</strong> - 为 <code>core_logic_developer</code> 编写的每个函数和类编写单元测试</li><li><strong>集成测试</strong> - 为 <code>web_service_integrator</code> 创建的 API 端点编写集成测试</li><li><strong>质量检查</strong> - 进行代码覆盖率分析和静态代码分析</li><li><strong>CI 集成</strong> - 确保测试融入 CI&#x2F;CD 流程</li></ol><p><strong>Input Dependencies:</strong></p><ul><li>业务逻辑代码</li><li>API 接口定义</li><li>质量标准和要求</li></ul><p><strong>Output Artifacts:</strong></p><ul><li><code>tests/unit/*.cpp</code> - 单元测试</li><li><code>tests/integration/*.cpp</code> - 集成测试</li><li><code>tests/performance/*.cpp</code> - 性能测试</li><li><code>.codecov.yml</code> - 代码覆盖率配置</li><li><code>docs/testing_guide.md</code> - 测试指南</li></ul><p><strong>Collaboration:</strong></p><ul><li><strong>验证 Core Logic Developer 的代码</strong></li><li><strong>测试 Web Service Integrator 的接口</strong></li><li><strong>确保 Deployment Operator 的部署质量</strong></li></ul><hr><h3 id="4-7-🚀-Deployment-Operator-Agent"><a href="#4-7-🚀-Deployment-Operator-Agent" class="headerlink" title="4.7 🚀 Deployment Operator Agent"></a>4.7 🚀 Deployment Operator Agent</h3><h4 id="Agent-deployment-operator"><a href="#Agent-deployment-operator" class="headerlink" title="Agent: deployment_operator"></a>Agent: <code>deployment_operator</code></h4><p><strong>Description:</strong><br>你是一名 DevOps 工程师，负责将开发完成的服务打包并部署到目标环境，确保生产环境的稳定性和可靠性。</p><p><strong>Capabilities:</strong></p><ul><li>容器化（Docker, Podman）</li><li>容器编排（Docker Compose, Kubernetes）</li><li>配置管理</li><li>监控和日志</li><li>自动化部署脚本</li><li>基础设施即代码</li></ul><p><strong>Workflow:</strong></p><ol><li><strong>容器化</strong> - 编写 <code>Dockerfile</code>，创建服务的容器镜像</li><li><strong>编排配置</strong> - 编写 <code>docker-compose.yml</code> 文件，用于一键部署</li><li><strong>脚本编写</strong> - 编写部署脚本或 CI&#x2F;CD 流水线配置</li><li><strong>配置模板</strong> - 生成生产环境配置文件模板</li><li><strong>监控设置</strong> - 配置监控和日志收集</li></ol><p><strong>Input Dependencies:</strong></p><ul><li>构建好的应用程序</li><li>部署环境信息</li><li>运行时配置需求</li></ul><p><strong>Output Artifacts:</strong></p><ul><li><code>Dockerfile</code> - 容器镜像定义</li><li><code>docker-compose.yml</code> - 服务编排配置</li><li><code>scripts/deploy.sh</code> - 部署脚本</li><li><code>config/production.env</code> - 生产环境配置</li><li><code>docs/deployment_guide.md</code> - 部署指南</li></ul><p><strong>Collaboration:</strong></p><ul><li><strong>打包 Build Expert 的构建产物</strong></li><li><strong>部署 Web Service Integrator 的服务</strong></li><li><strong>配置 QA Specialist 批准的版本</strong></li></ul><hr><h2 id="5-🔄-协作流程"><a href="#5-🔄-协作流程" class="headerlink" title="5. 🔄 协作流程"></a>5. 🔄 协作流程</h2><h3 id="5-1-📋-标准开发流程"><a href="#5-1-📋-标准开发流程" class="headerlink" title="5.1 📋 标准开发流程"></a>5.1 📋 标准开发流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant PM as Project Manager</span><br><span class="line">    participant A as Architect</span><br><span class="line">    participant API as API Designer</span><br><span class="line">    participant CL as Core Logic</span><br><span class="line">    participant WSI as Web Integrator</span><br><span class="line">    participant BE as Build Expert</span><br><span class="line">    participant QA as QA Specialist</span><br><span class="line">    participant DO as Deployment Operator</span><br><span class="line"></span><br><span class="line">    PM-&gt;&gt;A: 项目需求</span><br><span class="line">    A-&gt;&gt;API: 架构约束</span><br><span class="line">    A-&gt;&gt;BE: 技术栈选择</span><br><span class="line">    API-&gt;&gt;CL: API 规范</span><br><span class="line">    CL-&gt;&gt;WSI: 核心逻辑</span><br><span class="line">    WSI-&gt;&gt;BE: 依赖需求</span><br><span class="line">    BE-&gt;&gt;QA: 构建配置</span><br><span class="line">    QA-&gt;&gt;DO: 测试报告</span><br><span class="line">    DO-&gt;&gt;PM: 部署就绪</span><br></pre></td></tr></table></figure><h3 id="5-2-🔄-迭代开发流程"><a href="#5-2-🔄-迭代开发流程" class="headerlink" title="5.2 🔄 迭代开发流程"></a>5.2 🔄 迭代开发流程</h3><ol><li><strong>Sprint Planning</strong> - Architect 和团队确定下一个迭代目标</li><li><strong>API Design</strong> - API Designer 先行设计接口规范</li><li><strong>Parallel Development</strong> - Core Logic 和 Web Integrator 并行开发</li><li><strong>Integration Testing</strong> - QA Specialist 执行集成测试</li><li><strong>Build &amp; Deploy</strong> - Build Expert 和 Deployment Operator 完成构建部署</li></ol><h3 id="5-3-🚨-错误处理流程"><a href="#5-3-🚨-错误处理流程" class="headerlink" title="5.3 🚨 错误处理流程"></a>5.3 🚨 错误处理流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[发现错误] --&gt; B&#123;错误类型&#125;</span><br><span class="line">    B --&gt;|构建错误| C[Build Expert]</span><br><span class="line">    B --&gt;|逻辑错误| D[Core Logic Developer]</span><br><span class="line">    B --&gt;|集成错误| E[Web Service Integrator]</span><br><span class="line">    B --&gt;|测试失败| F[QA Specialist]</span><br><span class="line"></span><br><span class="line">    C --&gt; G[修复配置]</span><br><span class="line">    D --&gt; H[修复逻辑]</span><br><span class="line">    E --&gt; I[修复集成]</span><br><span class="line">    F --&gt; J[修复测试]</span><br><span class="line"></span><br><span class="line">    G --&gt; K[重新验证]</span><br><span class="line">    H --&gt; K</span><br><span class="line">    I --&gt; K</span><br><span class="line">    J --&gt; K</span><br><span class="line"></span><br><span class="line">    K --&gt; L[错误解决]</span><br></pre></td></tr></table></figure><hr><h2 id="6-📖-使用指南"><a href="#6-📖-使用指南" class="headerlink" title="6. 📖 使用指南"></a>6. 📖 使用指南</h2><h3 id="6-1-🚀-快速开始"><a href="#6-1-🚀-快速开始" class="headerlink" title="6.1 🚀 快速开始"></a>6.1 🚀 快速开始</h3><h4 id="步骤-1-初始化项目"><a href="#步骤-1-初始化项目" class="headerlink" title="步骤 1: 初始化项目"></a>步骤 1: 初始化项目</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/agents create cpp_architect</span><br><span class="line">&quot;创建一个新的 C++ Web 项目，需要实现用户管理系统，要求高性能和可扩展性&quot;</span><br></pre></td></tr></table></figure><h4 id="步骤-2-生成架构"><a href="#步骤-2-生成架构" class="headerlink" title="步骤 2: 生成架构"></a>步骤 2: 生成架构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/agents create api_designer</span><br><span class="line">&quot;基于架构设计用户管理系统的 API，包括用户注册、登录、信息管理等接口&quot;</span><br></pre></td></tr></table></figure><h4 id="步骤-3-实现核心逻辑"><a href="#步骤-3-实现核心逻辑" class="headerlink" title="步骤 3: 实现核心逻辑"></a>步骤 3: 实现核心逻辑</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/agents create core_logic_developer</span><br><span class="line">&quot;实现用户管理的核心业务逻辑，包括用户验证、密码加密、数据校验等&quot;</span><br></pre></td></tr></table></figure><h3 id="6-2-🔧-Agent-管理命令"><a href="#6-2-🔧-Agent-管理命令" class="headerlink" title="6.2 🔧 Agent 管理命令"></a>6.2 🔧 Agent 管理命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># C++ Web 代理设计架构</span></span><br><span class="line">/agents create &lt;agent_name&gt; <span class="string">&quot;&lt;task_description&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># C++ Web 代理设计架构</span></span><br><span class="line">/agents switch &lt;agent_name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># C++ Web 代理设计架构</span></span><br><span class="line">/agents list</span><br><span class="line"></span><br><span class="line"><span class="comment"># C++ Web 代理设计架构</span></span><br><span class="line">/agents remove &lt;agent_name&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># C++ Web 代理设计架构</span></span><br><span class="line">/agents status &lt;agent_name&gt;</span><br></pre></td></tr></table></figure><h3 id="6-3-📝-协作最佳实践"><a href="#6-3-📝-协作最佳实践" class="headerlink" title="6.3 📝 协作最佳实践"></a>6.3 📝 协作最佳实践</h3><ol><li><strong>明确依赖关系</strong> - 在每个任务开始前明确依赖的产出物</li><li><strong>版本控制</strong> - 每个 Agent 的产出都应该进行版本管理</li><li><strong>文档同步</strong> - 确保 Agent 间的文档保持同步</li><li><strong>定期同步</strong> - 建立定期的 Agent 同步会议或检查点</li><li><strong>质量门禁</strong> - 每个 Agent 的产出都应该通过质量检查</li></ol><hr><h2 id="7-🔄-扩展和维护"><a href="#7-🔄-扩展和维护" class="headerlink" title="7. 🔄 扩展和维护"></a>7. 🔄 扩展和维护</h2><h3 id="7-1-➕-添加新-Agent"><a href="#7-1-➕-添加新-Agent" class="headerlink" title="7.1 ➕ 添加新 Agent"></a>7.1 ➕ 添加新 Agent</h3><p>当项目需要新的专业能力时，可以添加专门的 Agent：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># C++ Web 代理设计架构</span></span><br><span class="line"><span class="strong">**Description:**</span></span><br><span class="line">你是一名安全专家，专注于确保 C++ Web 应用的安全性。</span><br><span class="line"></span><br><span class="line"><span class="strong">**Capabilities:**</span></span><br><span class="line"><span class="bullet">-</span> 安全漏洞评估</span><br><span class="line"><span class="bullet">-</span> 加密算法实现</span><br><span class="line"><span class="bullet">-</span> 认证和授权机制</span><br><span class="line"><span class="bullet">-</span> 安全编码规范</span><br><span class="line"><span class="bullet">-</span> 渗透测试</span><br></pre></td></tr></table></figure><h3 id="7-2-🔧-Agent-优化"><a href="#7-2-🔧-Agent-优化" class="headerlink" title="7.2 🔧 Agent 优化"></a>7.2 🔧 Agent 优化</h3><p>定期评估和优化现有 Agent：</p><ol><li><strong>性能评估</strong> - 监控 Agent 的工作效率</li><li><strong>质量评估</strong> - 检查 Agent 产出的质量</li><li><strong>能力更新</strong> - 根据新技术更新 Agent 能力</li><li><strong>协作优化</strong> - 改进 Agent 间的协作流程</li></ol><h3 id="7-3-📊-Agent-性能指标"><a href="#7-3-📊-Agent-性能指标" class="headerlink" title="7.3 📊 Agent 性能指标"></a>7.3 📊 Agent 性能指标</h3><table><thead><tr><th>Agent</th><th>关键指标</th><th>目标值</th></tr></thead><tbody><tr><td>Architect</td><td>架构设计时间</td><td>&lt; 2小时</td></tr><tr><td>API Designer</td><td>API 规范完成率</td><td>100%</td></tr><tr><td>Core Logic</td><td>代码覆盖率</td><td>&gt; 80%</td></tr><tr><td>Web Integrator</td><td>集成成功率</td><td>&gt; 95%</td></tr><tr><td>Build Expert</td><td>构建成功率</td><td>100%</td></tr><tr><td>QA Specialist</td><td>缺陷发现率</td><td>&gt; 90%</td></tr><tr><td>Deployment Operator</td><td>部署成功率</td><td>&gt; 99%</td></tr></tbody></table><hr><h2 id="📊-总结"><a href="#📊-总结" class="headerlink" title="📊 总结"></a>📊 总结</h2><h3 id="✅-Agent-团队优势"><a href="#✅-Agent-团队优势" class="headerlink" title="✅ Agent 团队优势"></a>✅ Agent 团队优势</h3><ul><li>✅ <strong>专业化分工</strong> - 每个 Agent 专注于特定领域</li><li>✅ <strong>标准化流程</strong> - 建立可重复的开发流程</li><li>✅ <strong>质量保证</strong> - 多层次的质量控制机制</li><li>✅ <strong>可扩展性</strong> - 支持项目规模增长</li><li>✅ <strong>知识传承</strong> - Agent 间共享最佳实践</li></ul><h3 id="🎯-实施建议"><a href="#🎯-实施建议" class="headerlink" title="🎯 实施建议"></a>🎯 实施建议</h3><ol><li><strong>从简单开始</strong> - 先创建核心 Agent，逐步完善</li><li><strong>持续迭代</strong> - 根据项目反馈优化 Agent 设计</li><li><strong>文档驱动</strong> - 保持良好的文档习惯</li><li><strong>工具集成</strong> - 集成现有的开发工具和平台</li><li><strong>团队培训</strong> - 确保团队理解 Agent 协作模式</li></ol><h3 id="📚-扩展资源"><a href="#📚-扩展资源" class="headerlink" title="📚 扩展资源"></a>📚 扩展资源</h3><ul><li><a href="https://docs.anthropic.com/claude-code/agents">Claude Code Agent 文档</a></li><li><a href="https://github.com/fffaraz/awesome-cpp#web-frameworks">C++ Web 框架比较</a></li><li><a href="https://github.com/isocpp/CppCoreGuidelines">现代 C++ 最佳实践</a></li><li><a href="https://restfulapi.net/">API 设计指南</a></li></ul><hr><blockquote><p><strong>💡 提示</strong>:</p><ul><li>Agent 间的协作需要明确的接口和规范</li><li>定期回顾和优化 Agent 工作流程</li><li>保持 Agent 知识库的更新和维护</li><li>建立有效的质量监控和反馈机制</li></ul></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;C-Web-代理设计架构&quot;&gt;&lt;a href=&quot;#C-Web-代理设计架构&quot; class=&quot;headerlink&quot; title=&quot;C++ Web 代理设计架构&quot;&gt;&lt;/a&gt;C++ Web</summary>
        
      
    
    
    
    <category term="软件架构" scheme="https://vilaswang.github.io/categories/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Claude MCP 配置指南</title>
    <link href="https://vilaswang.github.io/posts/361d35d7/"/>
    <id>https://vilaswang.github.io/posts/361d35d7/</id>
    <published>2025-12-09T06:09:54.000Z</published>
    <updated>2025-12-17T15:36:29.274Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Claude-MCP-配置指南"><a href="#Claude-MCP-配置指南" class="headerlink" title="Claude MCP 配置指南"></a>Claude MCP 配置指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>claude-code</code>, <code>mcp</code>, <code>model-context-protocol</code>, <code>productivity</code>, <code>automation</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-mcp-%E6%A6%82%E8%BF%B0">1. MCP 概述</a></li><li><a href="#2-%E5%BF%85%E8%A3%85-mcp-%E6%9C%8D%E5%8A%A1%E5%99%A8">2. 必装 MCP 服务器</a></li><li><a href="#3-%E6%8E%A8%E8%8D%90%E7%BB%84%E5%90%88">3. 推荐组合</a></li><li><a href="#4-%E9%85%8D%E7%BD%AE%E6%AD%A5%E9%AA%A4">4. 配置步骤</a></li><li><a href="#5-top-15-mcp-%E6%9C%8D%E5%8A%A1%E5%99%A8">5. Top 15 MCP 服务器</a></li><li><a href="#6-%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">6. 故障排除</a></li></ul><hr><h2 id="1-📖-MCP-概述"><a href="#1-📖-MCP-概述" class="headerlink" title="1. 📖 MCP 概述"></a>1. 📖 MCP 概述</h2><p>MCP (Model Context Protocol) 是 Claude Code 的扩展协议，允许 AI 助手直接控制各种工具和服务。</p><h3 id="🎯-MCP-优势"><a href="#🎯-MCP-优势" class="headerlink" title="🎯 MCP 优势"></a>🎯 MCP 优势</h3><ul><li>✅ <strong>扩展能力</strong> - 大幅扩展 Claude 的功能范围</li><li>✅ <strong>自动化</strong> - 实现复杂的自动化工作流</li><li>✅ <strong>集成性</strong> - 连接各种第三方服务和工具</li><li>✅ <strong>实时性</strong> - 获取最新的 API 文档和代码示例</li></ul><hr><h2 id="2-⭐-必装-MCP-服务器"><a href="#2-⭐-必装-MCP-服务器" class="headerlink" title="2. ⭐ 必装 MCP 服务器"></a>2. ⭐ 必装 MCP 服务器</h2><h3 id="2-1-🌐-Playwright-MCP-浏览器自动化"><a href="#2-1-🌐-Playwright-MCP-浏览器自动化" class="headerlink" title="2.1 🌐 Playwright MCP - 浏览器自动化"></a>2.1 🌐 Playwright MCP - 浏览器自动化</h3><p><strong>功能</strong>: 让 Claude 直接控制浏览器进行测试、截图、数据爬取</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">claude mcp add playwright -s user -- npx @playwright/mcp@latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">claude mcp list</span><br></pre></td></tr></table></figure><p><strong>适用场景</strong>:</p><ul><li>🔄 自动化测试</li><li>📸 网页截图</li><li>🕷️ 网页数据爬取</li><li>🎯 UI 交互测试</li></ul><h3 id="2-2-📚-Context7-MCP-文档实时查询"><a href="#2-2-📚-Context7-MCP-文档实时查询" class="headerlink" title="2.2 📚 Context7 MCP - 文档实时查询"></a>2.2 📚 Context7 MCP - 文档实时查询</h3><p><strong>功能</strong>: 获取各种编程库的最新文档和代码示例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">claude mcp add context7 -- npx -y @upstash/context7-mcp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">claude mcp add context7 -s user -- npx -y @upstash/context7-mcp</span><br></pre></td></tr></table></figure><p><strong>适用场景</strong>:</p><ul><li>🔍 API 集成开发</li><li>📖 编程学习</li><li>💡 代码示例查找</li><li>🆕 新技术探索</li></ul><h3 id="2-3-🖥️-Filesystem-MCP-文件系统操作"><a href="#2-3-🖥️-Filesystem-MCP-文件系统操作" class="headerlink" title="2.3 🖥️ Filesystem MCP - 文件系统操作"></a>2.3 🖥️ Filesystem MCP - 文件系统操作</h3><p><strong>功能</strong>: 读写和管理本地文件、文件夹，批量操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">npm install -g @modelcontextprotocol/server-filesystem</span><br></pre></td></tr></table></figure><p><strong>适用场景</strong>:</p><ul><li>📁 代码分析</li><li>📄 文档生成</li><li>💾 自动备份</li><li>🔄 批量文件处理</li></ul><h3 id="2-4-🔧-Git-MCP-版本控制"><a href="#2-4-🔧-Git-MCP-版本控制" class="headerlink" title="2.4 🔧 Git MCP - 版本控制"></a>2.4 🔧 Git MCP - 版本控制</h3><p><strong>功能</strong>: 执行 Git 命令，管理版本控制</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">npm install -g @modelcontextprotocol/server-github</span><br></pre></td></tr></table></figure><p><strong>适用场景</strong>:</p><ul><li>📊 版本管理</li><li>🚀 自动化部署</li><li>👥 团队协作</li><li>🔍 代码审查</li></ul><h3 id="2-5-🗃️-Database-MCP-数据库连接"><a href="#2-5-🗃️-Database-MCP-数据库连接" class="headerlink" title="2.5 🗃️ Database MCP - 数据库连接"></a>2.5 🗃️ Database MCP - 数据库连接</h3><p><strong>功能</strong>: 连接和管理多种数据库</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">npm install -g @modelcontextprotocol/server-postgres</span><br></pre></td></tr></table></figure><p><strong>适用场景</strong>:</p><ul><li>🗄️ 数据库管理</li><li>📊 数据分析</li><li>🔍 SQL 查询</li><li>💿 数据迁移</li></ul><hr><h2 id="3-🎯-推荐组合"><a href="#3-🎯-推荐组合" class="headerlink" title="3. 🎯 推荐组合"></a>3. 🎯 推荐组合</h2><h3 id="3-1-📱-按角色分类"><a href="#3-1-📱-按角色分类" class="headerlink" title="3.1 📱 按角色分类"></a>3.1 📱 按角色分类</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[开发者角色] --&gt; B[前端开发者]</span><br><span class="line">    A --&gt; C[后端开发者]</span><br><span class="line">    A --&gt; D[数据分析师]</span><br><span class="line">    A --&gt; E[全栈开发者]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[Filesystem + Git + Figma]</span><br><span class="line">    C --&gt; C1[Git + Prisma + FastAPI]</span><br><span class="line">    D --&gt; D1[Context7 + Python + Database]</span><br><span class="line">    E --&gt; E1[Filesystem + Git + Pipedream]</span><br></pre></td></tr></table></figure><h3 id="3-2-📦-5个必装组合"><a href="#3-2-📦-5个必装组合" class="headerlink" title="3.2 📦 5个必装组合"></a>3.2 📦 5个必装组合</h3><p>基于2025年使用统计，以下 MCP 服务器覆盖90%的日常需求：</p><ol><li><strong>@modelcontextprotocol&#x2F;server-filesystem</strong> - 文件系统访问</li><li><strong>@modelcontextprotocol&#x2F;server-github</strong> - GitHub 集成</li><li><strong>@modelcontextprotocol&#x2F;server-postgres</strong> - 数据库连接</li><li><strong>@modelcontextprotocol&#x2F;server-slack</strong> - 团队协作</li><li><strong>@modelcontextprotocol&#x2F;server-kubernetes</strong> - 容器管理</li></ol><hr><h2 id="4-⚙️-配置步骤"><a href="#4-⚙️-配置步骤" class="headerlink" title="4. ⚙️ 配置步骤"></a>4. ⚙️ 配置步骤</h2><h3 id="4-1-🔍-步骤1-安装-MCP-服务器"><a href="#4-1-🔍-步骤1-安装-MCP-服务器" class="headerlink" title="4.1 🔍 步骤1: 安装 MCP 服务器"></a>4.1 🔍 步骤1: 安装 MCP 服务器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">npm install -g @modelcontextprotocol/server-browserkit \</span><br><span class="line">  @modelcontextprotocol/server-ollama \</span><br><span class="line">  @modelcontextprotocol/server-filesystem \</span><br><span class="line">  @modelcontextprotocol/server-github \</span><br><span class="line">  @modelcontextprotocol/server-postgres</span><br></pre></td></tr></table></figure><h3 id="4-2-📝-步骤2-配置-Claude-Code-CLI"><a href="#4-2-📝-步骤2-配置-Claude-Code-CLI" class="headerlink" title="4.2 📝 步骤2: 配置 Claude Code CLI"></a>4.2 📝 步骤2: 配置 Claude Code CLI</h3><p>Claude Code CLI 的配置文件位于：</p><ul><li><strong>macOS &#x2F; Linux</strong>: <code>~/.config/claude/claude_desktop_config.json</code></li><li><strong>Windows</strong>: <code>%USERPROFILE%\.claude.json</code></li></ul><h3 id="4-3-📄-步骤3-配置示例"><a href="#4-3-📄-步骤3-配置示例" class="headerlink" title="4.3 📄 步骤3: 配置示例"></a>4.3 📄 步骤3: 配置示例</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;browserkit&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;-y&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;@modelcontextprotocol/server-browserkit&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ollama&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;-y&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;@modelcontextprotocol/server-ollama&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;filesystem&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;-y&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;@modelcontextprotocol/server-filesystem&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;/path/to/allowed/directory&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;github&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;-y&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;@modelcontextprotocol/server-github&quot;</span></span><br><span class="line">      <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="4-4-🔧-步骤4-特殊配置"><a href="#4-4-🔧-步骤4-特殊配置" class="headerlink" title="4.4 🔧 步骤4: 特殊配置"></a>4.4 🔧 步骤4: 特殊配置</h3><h4 id="Xmind-生成器-MCP"><a href="#Xmind-生成器-MCP" class="headerlink" title="Xmind 生成器 MCP"></a>Xmind 生成器 MCP</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;xmind&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;npx&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;xmind-generator-mcp&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;outputPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;E:/xmind_generator_mcp_path&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoOpenFile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="Office-Word-MCP"><a href="#Office-Word-MCP" class="headerlink" title="Office Word MCP"></a>Office Word MCP</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">claude mcp add office-word -s user -- uvx --from office-word-mcp-server word_mcp_server</span><br></pre></td></tr></table></figure><hr><h2 id="5-📊-Top-15-MCP-服务器"><a href="#5-📊-Top-15-MCP-服务器" class="headerlink" title="5. 📊 Top 15 MCP 服务器"></a>5. 📊 Top 15 MCP 服务器</h2><table><thead><tr><th>排名</th><th>名称</th><th>Star数</th><th>核心功能</th><th>最佳场景</th></tr></thead><tbody><tr><td>1</td><td>Filesystem MCP</td><td>64,053 ⭐</td><td>读写&#x2F;管理本地文件、文件夹</td><td>代码分析、文档生成、自动备份</td></tr><tr><td>2</td><td>Git MCP</td><td>64,053 ⭐</td><td>执行git命令，查看历史和差异</td><td>版本管理、自动化部署、团队协作</td></tr><tr><td>3</td><td>Prisma MCP</td><td>43,499 ⭐</td><td>管理Prisma数据库模式</td><td>Web开发、数据库设计</td></tr><tr><td>4</td><td>Context7 MCP</td><td>25,610 ⭐</td><td>获取最新库文档和代码示例</td><td>API集成、编程学习</td></tr><tr><td>5</td><td>GitHub MCP</td><td>20,923 ⭐</td><td>管理仓库、PR和Issues</td><td>开源项目管理、CI&#x2F;CD</td></tr><tr><td>6</td><td>Task Master</td><td>20,520 ⭐</td><td>智能任务分解和优先级管理</td><td>项目管理、敏捷开发</td></tr><tr><td>7</td><td>Repomix</td><td>18,511 ⭐</td><td>压缩代码库为AI友好格式</td><td>大型代码审查、架构分析</td></tr><tr><td>8</td><td>BlenderMCP</td><td>12,829 ⭐</td><td>控制Blender进行3D建模</td><td>游戏开发、3D设计</td></tr><tr><td>9</td><td>mcp-run-python</td><td>11,603 ⭐</td><td>安全运行Python代码</td><td>算法验证、数据分析</td></tr><tr><td>10</td><td>Pipedream</td><td>10,139 ⭐</td><td>连接2500+应用和API</td><td>业务流程自动化、数据同步</td></tr><tr><td>11</td><td>Figma MCP</td><td>9,891 ⭐</td><td>读取Figma设计，生成前端代码</td><td>UI&#x2F;UX开发、设计转代码</td></tr><tr><td>12</td><td>数据库MCP工具箱</td><td>9,229 ⭐</td><td>支持多数据库查询和优化</td><td>数据库管理、数据分析</td></tr><tr><td>13</td><td>Serena</td><td>8,743 ⭐</td><td>大型代码库符号化分析</td><td>代码重构、bug修复</td></tr><tr><td>14</td><td>FastAPI-MCP</td><td>7,857 ⭐</td><td>零配置集成FastAPI</td><td>API开发、微服务</td></tr><tr><td>15</td><td>Fonoster MCP</td><td>6,740 ⭐</td><td>管理电话系统</td><td>客服系统、电话营销</td></tr></tbody></table><hr><h2 id="6-🔧-故障排除"><a href="#6-🔧-故障排除" class="headerlink" title="6. 🔧 故障排除"></a>6. 🔧 故障排除</h2><h3 id="6-1-❌-常见问题"><a href="#6-1-❌-常见问题" class="headerlink" title="6.1 ❌ 常见问题"></a>6.1 ❌ 常见问题</h3><h4 id="问题1-MCP-服务器无法启动"><a href="#问题1-MCP-服务器无法启动" class="headerlink" title="问题1: MCP 服务器无法启动"></a>问题1: MCP 服务器无法启动</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">claude mcp list</span><br><span class="line"></span><br><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line">claude mcp remove &lt;server-name&gt;</span><br><span class="line">claude mcp add &lt;server-name&gt; &lt;<span class="built_in">command</span>&gt;</span><br></pre></td></tr></table></figure><h4 id="问题2-配置文件格式错误"><a href="#问题2-配置文件格式错误" class="headerlink" title="问题2: 配置文件格式错误"></a>问题2: 配置文件格式错误</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 验证 JSON 格式</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;mcpServers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;server-name&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;command-string&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;arg1&quot;</span><span class="punctuation">,</span> <span class="string">&quot;arg2&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="问题3-权限问题"><a href="#问题3-权限问题" class="headerlink" title="问题3: 权限问题"></a>问题3: 权限问题</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line"><span class="built_in">ls</span> -la ~/.claude.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># Claude MCP 配置指南</span></span><br><span class="line"><span class="built_in">chmod</span> 600 ~/.claude.json</span><br></pre></td></tr></table></figure><h3 id="6-2-🛠️-调试技巧"><a href="#6-2-🛠️-调试技巧" class="headerlink" title="6.2 🛠️ 调试技巧"></a>6.2 🛠️ 调试技巧</h3><ol><li><strong>查看日志</strong>: 检查 Claude Code 的日志输出</li><li><strong>测试连接</strong>: 使用简单的命令测试 MCP 服务器</li><li><strong>逐步配置</strong>: 一次只添加一个 MCP 服务器</li><li><strong>版本检查</strong>: 确保所有依赖版本兼容</li></ol><h3 id="6-3-📞-获取帮助"><a href="#6-3-📞-获取帮助" class="headerlink" title="6.3 📞 获取帮助"></a>6.3 📞 获取帮助</h3><ul><li><strong>官方文档</strong>: <a href="https://docs.anthropic.com/claude/docs/mcp">Claude Code MCP Documentation</a></li><li><strong>社区支持</strong>: GitHub Issues 和 Discussions</li><li><strong>示例配置</strong>: 官方示例仓库</li></ul><hr><h2 id="📚-扩展资源"><a href="#📚-扩展资源" class="headerlink" title="📚 扩展资源"></a>📚 扩展资源</h2><h3 id="🔗-相关链接"><a href="#🔗-相关链接" class="headerlink" title="🔗 相关链接"></a>🔗 相关链接</h3><ul><li><a href="https://modelcontextprotocol.io/">MCP 官方文档</a></li><li><a href="https://docs.anthropic.com/claude/docs">Claude Code 指南</a></li><li><a href="https://github.com/modelcontextprotocol/servers">MCP 服务器列表</a></li></ul><h3 id="🎯-学习路径"><a href="#🎯-学习路径" class="headerlink" title="🎯 学习路径"></a>🎯 学习路径</h3><ol><li><strong>基础配置</strong> - 从简单的 Filesystem MCP 开始</li><li><strong>功能扩展</strong> - 逐步添加专业领域 MCP</li><li><strong>自定义开发</strong> - 学习开发自定义 MCP 服务器</li><li><strong>最佳实践</strong> - 掌握高级配置和优化技巧</li></ol><hr><h2 id="📈-使用建议"><a href="#📈-使用建议" class="headerlink" title="📈 使用建议"></a>📈 使用建议</h2><h3 id="💡-效率提升技巧"><a href="#💡-效率提升技巧" class="headerlink" title="💡 效率提升技巧"></a>💡 效率提升技巧</h3><ol><li><strong>按需安装</strong> - 只安装当前项目需要的 MCP</li><li><strong>定期更新</strong> - 保持 MCP 服务器为最新版本</li><li><strong>性能优化</strong> - 监控 MCP 服务器资源使用情况</li><li><strong>安全考虑</strong> - 限制文件系统访问范围</li></ol><h3 id="🔄-工作流优化"><a href="#🔄-工作流优化" class="headerlink" title="🔄 工作流优化"></a>🔄 工作流优化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[项目分析] --&gt; B[选择合适MCP]</span><br><span class="line">    B --&gt; C[配置测试]</span><br><span class="line">    C --&gt; D[集成工作流]</span><br><span class="line">    D --&gt; E[持续优化]</span><br><span class="line"></span><br><span class="line">    style A fill:#e1f5fe</span><br><span class="line">    style B fill:#f3e5f5</span><br><span class="line">    style C fill:#e8f5e8</span><br><span class="line">    style D fill:#fff3e0</span><br><span class="line">    style E fill:#fce4ec</span><br></pre></td></tr></table></figure><hr><blockquote><p><strong>💡 提示</strong>: MCP 配置是一个迭代过程，建议从基础功能开始，逐步扩展到复杂的自动化工作流。定期检查更新以获得最新功能和安全修复。</p></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;Claude-MCP-配置指南&quot;&gt;&lt;a href=&quot;#Claude-MCP-配置指南&quot; class=&quot;headerlink&quot; title=&quot;Claude MCP 配置指南&quot;&gt;&lt;/a&gt;Claude MCP</summary>
        
      
    
    
    
    <category term="开发工具" scheme="https://vilaswang.github.io/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>mTLS 证书生成指南</title>
    <link href="https://vilaswang.github.io/posts/cb45c274/"/>
    <id>https://vilaswang.github.io/posts/cb45c274/</id>
    <published>2025-12-09T06:09:54.000Z</published>
    <updated>2025-12-18T15:49:44.728Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mTLS-证书生成指南"><a href="#mTLS-证书生成指南" class="headerlink" title="mTLS 证书生成指南"></a>mTLS 证书生成指南</h1><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#%E7%94%9F%E6%88%90-ca-%E8%AF%81%E4%B9%A6">生成 CA 证书</a></li><li><a href="#%E7%94%9F%E6%88%90%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AF%81%E4%B9%A6">生成 服务器证书</a></li><li><a href="#%E7%94%9F%E6%88%90%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%AF%81%E4%B9%A6">生成客户端证书</a></li><li><a href="#%E8%AF%81%E4%B9%A6%E9%AA%8C%E8%AF%81%E6%B5%8B%E8%AF%95">证书验证测试</a></li><li><a href="#%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E">文件说明</a></li><li><a href="#%E5%AE%89%E5%85%A8%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9">安全注意事项</a></li><li><a href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">使用场景</a></li></ul><hr><h2 id="生成-CA-证书"><a href="#生成-CA-证书" class="headerlink" title="生成 CA 证书"></a>生成 CA 证书</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mTLS 证书生成指南</span></span><br><span class="line">openssl genrsa -aes256 -out ca-key.pem 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># mTLS 证书生成指南</span></span><br><span class="line">openssl genrsa -out ca-key.pem 4096</span><br><span class="line"></span><br><span class="line"><span class="comment"># mTLS 证书生成指南</span></span><br><span class="line">openssl req -new -x509 -days 3650 -key ca-key.pem -out ca-crt.pem -sha256</span><br></pre></td></tr></table></figure><p><strong>CA 证书生成注意事项：</strong></p><ul><li>Common Name: 输入 CA 名称，如 “My-CA”</li><li>Organization: 输入组织名称</li><li>Country: 输入国家代码，如 “CN”</li><li>有效期建议设置为 10 年 (3650 天)</li></ul><h2 id="生成服务器证书"><a href="#生成服务器证书" class="headerlink" title="生成服务器证书"></a>生成服务器证书</h2><h3 id="1-生成服务器私钥"><a href="#1-生成服务器私钥" class="headerlink" title="1. 生成服务器私钥"></a>1. 生成服务器私钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out server-key.pem 2048</span><br></pre></td></tr></table></figure><h3 id="2-生成服务器证书签名请求"><a href="#2-生成服务器证书签名请求" class="headerlink" title="2. 生成服务器证书签名请求"></a>2. 生成服务器证书签名请求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -sha256 -key server-key.pem -out server-csr.pem</span><br></pre></td></tr></table></figure><p><strong>在提示输入信息时：</strong></p><ul><li><strong>Country Name</strong>: 与 CA 证书相同</li><li><strong>State or Province Name</strong>: 省份名称</li><li><strong>Locality Name</strong>: 城市名称</li><li><strong>Organization Name</strong>: 服务器所属组织</li><li><strong>Organizational Unit Name</strong>: 部门名称（可选）</li><li><strong>Common Name</strong>: <strong>重要！</strong> 必须填写服务器的域名或 IP 地址</li><li><strong>Email Address</strong>: 邮箱地址（可选）</li></ul><h3 id="3-创建服务器证书扩展配置文件"><a href="#3-创建服务器证书扩展配置文件" class="headerlink" title="3. 创建服务器证书扩展配置文件"></a>3. 创建服务器证书扩展配置文件</h3><p>创建 <code>server_cert_ext.cnf</code> 文件：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[server_cert]</span></span><br><span class="line"><span class="attr">basicConstraints</span> = critical, CA:<span class="literal">FALSE</span></span><br><span class="line"><span class="attr">keyUsage</span> = critical, digitalSignature, keyEncipherment</span><br><span class="line"><span class="attr">extendedKeyUsage</span> = serverAuth</span><br><span class="line"><span class="attr">subjectKeyIdentifier</span> = hash</span><br><span class="line"><span class="attr">authorityKeyIdentifier</span> = keyid,issuer</span><br><span class="line"><span class="attr">subjectAltName</span> = @alt_names</span><br><span class="line"></span><br><span class="line"><span class="section">[alt_names]</span></span><br><span class="line"><span class="attr">DNS.1</span> = localhost</span><br><span class="line"><span class="attr">DNS.2</span> = your-domain.com</span><br><span class="line"><span class="attr">IP.1</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">IP.2</span> = your-server-ip</span><br></pre></td></tr></table></figure><h3 id="4-生成服务器证书"><a href="#4-生成服务器证书" class="headerlink" title="4. 生成服务器证书"></a>4. 生成服务器证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> server-csr.pem -CA ca-crt.pem -CAkey ca-key.pem -CAcreateserial -out server-crt.pem -days 365 -sha256 -extfile server_cert_ext.cnf -extensions server_cert</span><br><span class="line"></span><br><span class="line"><span class="comment"># mTLS 证书生成指南</span></span><br><span class="line">openssl verify -CAfile ca-crt.pem server-crt.pem</span><br></pre></td></tr></table></figure><h3 id="5-查看证书详情"><a href="#5-查看证书详情" class="headerlink" title="5. 查看证书详情"></a>5. 查看证书详情</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> server-crt.pem -text -noout -purpose</span><br></pre></td></tr></table></figure><h2 id="生成客户端证书"><a href="#生成客户端证书" class="headerlink" title="生成客户端证书"></a>生成客户端证书</h2><h3 id="1-生成客户端私钥"><a href="#1-生成客户端私钥" class="headerlink" title="1. 生成客户端私钥"></a>1. 生成客户端私钥</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out client-key.pem 2048</span><br></pre></td></tr></table></figure><h3 id="2-生成客户端证书签名请求"><a href="#2-生成客户端证书签名请求" class="headerlink" title="2. 生成客户端证书签名请求"></a>2. 生成客户端证书签名请求</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -new -sha256 -key client-key.pem -out client-csr.pem</span><br></pre></td></tr></table></figure><p><strong>在提示输入信息时：</strong></p><ul><li><strong>Country Name</strong>: 与 CA 证书相同</li><li><strong>State or Province Name</strong>: 省份名称</li><li><strong>Locality Name</strong>: 城市名称</li><li><strong>Organization Name</strong>: 客户端所属组织</li><li><strong>Organizational Unit Name</strong>: 部门名称（可选）</li><li><strong>Common Name</strong>: 客户端标识名称（用于区分不同客户端）</li><li><strong>Email Address</strong>: 邮箱地址（可选）</li></ul><h3 id="3-创建客户端证书扩展配置文件"><a href="#3-创建客户端证书扩展配置文件" class="headerlink" title="3. 创建客户端证书扩展配置文件"></a>3. 创建客户端证书扩展配置文件</h3><p>创建 <code>client_cert_ext.cnf</code> 文件：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[client_cert]</span></span><br><span class="line"><span class="attr">basicConstraints</span> = critical, CA:<span class="literal">FALSE</span></span><br><span class="line"><span class="attr">keyUsage</span> = critical, digitalSignature, keyEncipherment</span><br><span class="line"><span class="attr">extendedKeyUsage</span> = clientAuth</span><br><span class="line"><span class="attr">subjectKeyIdentifier</span> = hash</span><br><span class="line"><span class="attr">authorityKeyIdentifier</span> = keyid,issuer</span><br><span class="line"><span class="attr">subjectAltName</span> = @alt_names</span><br><span class="line"></span><br><span class="line"><span class="section">[alt_names]</span></span><br><span class="line"><span class="attr">DNS.1</span> = client</span><br><span class="line"><span class="attr">DNS.2</span> = localhost</span><br></pre></td></tr></table></figure><h3 id="4-生成客户端证书"><a href="#4-生成客户端证书" class="headerlink" title="4. 生成客户端证书"></a>4. 生成客户端证书</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -req -<span class="keyword">in</span> client-csr.pem -CA ca-crt.pem -CAkey ca-key.pem -CAcreateserial -out client-crt.pem -days 365 -sha256 -extfile client_cert_ext.cnf -extensions client_cert</span><br><span class="line"></span><br><span class="line"><span class="comment"># mTLS 证书生成指南</span></span><br><span class="line">openssl verify -CAfile ca-crt.pem client-crt.pem</span><br></pre></td></tr></table></figure><h3 id="5-查看证书详情-1"><a href="#5-查看证书详情-1" class="headerlink" title="5. 查看证书详情"></a>5. 查看证书详情</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> client-crt.pem -text -noout -purpose</span><br></pre></td></tr></table></figure><h2 id="证书验证测试"><a href="#证书验证测试" class="headerlink" title="证书验证测试"></a>证书验证测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mTLS 证书生成指南</span></span><br><span class="line">openssl s_server -cert server-crt.pem -key server-key.pem -CAfile ca-crt.pem -Verify 1 -port 8443</span><br><span class="line"></span><br><span class="line"><span class="comment"># mTLS 证书生成指南</span></span><br><span class="line">openssl s_client -connect localhost:8443 -cert client-crt.pem -key client-key.pem -CAfile ca-crt.pem</span><br></pre></td></tr></table></figure><h2 id="文件说明"><a href="#文件说明" class="headerlink" title="文件说明"></a>文件说明</h2><ul><li><code>ca-key.pem</code>: CA 私钥（妥善保管）</li><li><code>ca-crt.pem</code>: CA 根证书（客户端需要信任此证书）</li><li><code>ca.srl</code>: CA 序列号文件</li><li><code>server-key.pem</code>: 服务器私钥</li><li><code>server-csr.pem</code>: 服务器证书签名请求（可删除）</li><li><code>server-crt.pem</code>: 服务器证书</li><li><code>client-key.pem</code>: 客户端私钥</li><li><code>client-csr.pem</code>: 客户端证书签名请求（可删除）</li><li><code>client-crt.pem</code>: 客户端证书</li></ul><h2 id="安全注意事项"><a href="#安全注意事项" class="headerlink" title="安全注意事项"></a>安全注意事项</h2><ol><li><strong>私钥保护</strong>: 所有 <code>.pem</code> 私钥文件必须严格保护，不要泄露</li><li><strong>证书有效期</strong>: 定期检查和更新即将过期的证书</li><li><strong>Common Name</strong>: 服务器证书的 Common Name 必须与实际访问的域名匹配</li><li><strong>SAN 扩展</strong>: 现代浏览器要求使用 SAN (Subject Alternative Name) 而不是 CN</li><li><strong>密码保护</strong>: 生产环境中建议为私钥设置密码保护</li></ol><h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><ul><li><strong>服务器端</strong>: 配置 web 服务器（Nginx、Apache 等）使用 <code>server-crt.pem</code> 和 <code>server-key.pem</code></li><li><strong>客户端</strong>: 配置应用程序使用 <code>client-crt.pem</code> 和 <code>client-key.pem</code> 进行双向认证</li><li><strong>信任链</strong>: 客户端需要将 <code>ca-crt.pem</code> 添加到信任证书存储中</li></ul>]]></content>
    
    
    <summary type="html">详细的技术指南，介绍如何使用 OpenSSL 生成 CA 证书、服务器证书和客户端证书，以及如何进行 mTLS 双向认证。</summary>
    
    
    
    <category term="Web架构安全" scheme="https://vilaswang.github.io/categories/Web%E6%9E%B6%E6%9E%84%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>文件管理 API 规范</title>
    <link href="https://vilaswang.github.io/posts/eed6fb04/"/>
    <id>https://vilaswang.github.io/posts/eed6fb04/</id>
    <published>2025-12-09T06:09:54.000Z</published>
    <updated>2025-12-17T15:36:29.297Z</updated>
    
    <content type="html"><![CDATA[<h1 id="文件管理-API-规范"><a href="#文件管理-API-规范" class="headerlink" title="文件管理 API 规范"></a>文件管理 API 规范</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>版本</strong>: v1.0<br><strong>标签</strong>: <code>api</code>, <code>rest</code>, <code>file-management</code>, <code>authentication</code>, <code>swagger</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF">1. 基础信息</a></li><li><a href="#2-%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83">2. 认证与授权</a></li><li><a href="#3-%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86">3. 文件管理</a></li><li><a href="#4-%E6%96%87%E4%BB%B6%E6%94%AF%E6%8C%81">4. 文件支持</a></li><li><a href="#5-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">5. 错误处理</a></li><li><a href="#6-%E5%AE%89%E5%85%A8%E6%9C%BA%E5%88%B6">6. 安全机制</a></li><li><a href="#7-%E9%80%9F%E7%8E%87%E9%99%90%E5%88%B6">7. 速率限制</a></li><li><a href="#8-openapi-%E8%A7%84%E8%8C%83">8. OpenAPI 规范</a></li></ul><hr><h2 id="1-📋-基础信息"><a href="#1-📋-基础信息" class="headerlink" title="1. 📋 基础信息"></a>1. 📋 基础信息</h2><table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td><strong>Base URL</strong></td><td><code>/api/v1</code></td></tr><tr><td><strong>协议</strong></td><td>HTTPS</td></tr><tr><td><strong>数据格式</strong></td><td>JSON</td></tr><tr><td><strong>认证方式</strong></td><td>JWT Bearer Token</td></tr><tr><td><strong>API 版本</strong></td><td>v1.0</td></tr></tbody></table><h3 id="🔐-认证请求格式"><a href="#🔐-认证请求格式" class="headerlink" title="🔐 认证请求格式"></a>🔐 认证请求格式</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/api/v1/files/list</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>your-domain.com</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Bearer &lt;jwt_token&gt;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br></pre></td></tr></table></figure><hr><h2 id="2-🔐-认证与授权"><a href="#2-🔐-认证与授权" class="headerlink" title="2. 🔐 认证与授权"></a>2. 🔐 认证与授权</h2><h3 id="2-1-👤-用户注册"><a href="#2-1-👤-用户注册" class="headerlink" title="2.1 👤 用户注册"></a>2.1 👤 用户注册</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant C as Client</span><br><span class="line">    participant A as API Server</span><br><span class="line">    participant D as Database</span><br><span class="line"></span><br><span class="line">    C-&gt;&gt;A: POST /auth/register</span><br><span class="line">    A-&gt;&gt;A: 验证输入数据</span><br><span class="line">    A-&gt;&gt;D: 检查用户是否存在</span><br><span class="line">    D--&gt;&gt;A: 返回检查结果</span><br><span class="line">    A-&gt;&gt;A: 加密密码</span><br><span class="line">    A-&gt;&gt;D: 创建新用户</span><br><span class="line">    D--&gt;&gt;A: 返回用户信息</span><br><span class="line">    A-&gt;&gt;A: 生成JWT Token</span><br><span class="line">    A--&gt;&gt;C: 返回用户信息和Token</span><br></pre></td></tr></table></figure><h4 id="接口详情"><a href="#接口详情" class="headerlink" title="接口详情"></a>接口详情</h4><p><strong>请求</strong>:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/auth/register</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br></pre></td></tr></table></figure><p><strong>请求体</strong>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;confirmPassword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>验证规则</strong>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;minLength&quot;</span>: <span class="number">3</span>,</span><br><span class="line">        <span class="string">&quot;maxLength&quot;</span>: <span class="number">20</span>,</span><br><span class="line">        <span class="string">&quot;pattern&quot;</span>: <span class="string">&quot;^[a-zA-Z0-9_]+$&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;format&quot;</span>: <span class="string">&quot;email&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;minLength&quot;</span>: <span class="number">8</span>,</span><br><span class="line">        <span class="string">&quot;pattern&quot;</span>: <span class="string">&quot;^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@$!%*?&amp;])[A-Za-z\\d@$!%*?&amp;]&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>成功响应 (201)</strong>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;注册成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;createdAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-11-14T10:00:00Z&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-2-🔑-用户登录"><a href="#2-2-🔑-用户登录" class="headerlink" title="2.2 🔑 用户登录"></a>2.2 🔑 用户登录</h3><p><strong>请求</strong>:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/auth/login</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br></pre></td></tr></table></figure><p><strong>请求体</strong>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>成功响应 (200)</strong>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;登录成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;lastLoginAt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-11-14T10:00:00Z&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;expiresIn&quot;</span><span class="punctuation">:</span> <span class="number">86400</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="2-3-🌐-OAuth-集成"><a href="#2-3-🌐-OAuth-集成" class="headerlink" title="2.3 🌐 OAuth 集成"></a>2.3 🌐 OAuth 集成</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[用户点击Google登录] --&gt; B[重定向到Google OAuth]</span><br><span class="line">    B --&gt; C[用户授权]</span><br><span class="line">    C --&gt; D[Google回调处理]</span><br><span class="line">    D --&gt; E[创建或查找用户]</span><br><span class="line">    E --&gt; F[生成JWT Token]</span><br><span class="line">    F --&gt; G[重定向到应用]</span><br><span class="line"></span><br><span class="line">    style A fill:#e1f5fe</span><br><span class="line">    style G fill:#e8f5e8</span><br></pre></td></tr></table></figure><hr><h2 id="3-📁-文件管理"><a href="#3-📁-文件管理" class="headerlink" title="3. 📁 文件管理"></a>3. 📁 文件管理</h2><h3 id="3-1-📤-单文件上传"><a href="#3-1-📤-单文件上传" class="headerlink" title="3.1 📤 单文件上传"></a>3.1 📤 单文件上传</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant C as Client</span><br><span class="line">    participant S as API Server</span><br><span class="line">    participant F as File Storage</span><br><span class="line">    participant D as Database</span><br><span class="line"></span><br><span class="line">    C-&gt;&gt;S: POST /files/upload (multipart/form-data)</span><br><span class="line">    S-&gt;&gt;S: 验证认证Token</span><br><span class="line">    S-&gt;&gt;S: 文件类型和大小验证</span><br><span class="line">    S-&gt;&gt;S: 生成唯一文件名</span><br><span class="line">    S-&gt;&gt;F: 保存文件</span><br><span class="line">    F--&gt;&gt;S: 返回文件信息</span><br><span class="line">    S-&gt;&gt;D: 保存文件元数据</span><br><span class="line">    D--&gt;&gt;S: 返回保存结果</span><br><span class="line">    S--&gt;&gt;C: 返回上传结果</span><br></pre></td></tr></table></figure><h4 id="接口详情-1"><a href="#接口详情-1" class="headerlink" title="接口详情"></a>接口详情</h4><p><strong>请求</strong>:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/files/upload</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Bearer &lt;token&gt;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data</span><br></pre></td></tr></table></figure><p><strong>请求体</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file: &lt;binary_data&gt;</span><br></pre></td></tr></table></figure><p><strong>成功响应 (200)</strong>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;文件上传成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;file&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;document.pdf&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;originalName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;我的文档.pdf&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1048576</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;mimeType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/pdf&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/uploads/2025/11/14/uuid-document.pdf&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uploadTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-11-14T10:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;checksum&quot;</span><span class="punctuation">:</span> <span class="string">&quot;sha256:abc123...&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="3-2-📦-多文件上传"><a href="#3-2-📦-多文件上传" class="headerlink" title="3.2 📦 多文件上传"></a>3.2 📦 多文件上传</h3><p><strong>请求</strong>:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /api/v1/files/multi-upload</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Bearer &lt;token&gt;</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data</span><br></pre></td></tr></table></figure><p><strong>限制</strong>:</p><ul><li>最大文件数量: 10个</li><li>单文件最大大小: 100MB</li><li>总大小限制: 500MB</li></ul><p><strong>成功响应 (200)</strong>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;文件上传成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;uploaded&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uuid1&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file1.pdf&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1048576</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/uploads/uuid1-file1.pdf&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uuid2&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;file2.jpg&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">2097152</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/uploads/uuid2-file2.jpg&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;summary&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uploaded&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;failed&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;totalSize&quot;</span><span class="punctuation">:</span> <span class="number">3145728</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="3-3-📋-获取文件列表"><a href="#3-3-📋-获取文件列表" class="headerlink" title="3.3 📋 获取文件列表"></a>3.3 📋 获取文件列表</h3><p><strong>请求</strong>:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/files/list?page=1&amp;limit=20&amp;sort=name&amp;order=asc</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure><p><strong>查询参数</strong>:</p><table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>page</code></td><td>integer</td><td>1</td><td>页码</td></tr><tr><td><code>limit</code></td><td>integer</td><td>20</td><td>每页数量 (1-100)</td></tr><tr><td><code>sort</code></td><td>string</td><td>name</td><td>排序字段 (name, size, uploadTime)</td></tr><tr><td><code>order</code></td><td>string</td><td>desc</td><td>排序方向 (asc, desc)</td></tr><tr><td><code>search</code></td><td>string</td><td>-</td><td>搜索文件名</td></tr><tr><td><code>type</code></td><td>string</td><td>-</td><td>文件类型过滤</td></tr></tbody></table><p><strong>成功响应 (200)</strong>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Success&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;files&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;document.pdf&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">1048576</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;mimeType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;application/pdf&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api/v1/files/download/uuid-document.pdf&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;uploadTime&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-11-14T10:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;downloadCount&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;thumbnail&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api/v1/files/thumbnail/uuid-document.jpg&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;pagination&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;page&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;limit&quot;</span><span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;total&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;totalPages&quot;</span><span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hasNext&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;hasPrev&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;stats&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;totalFiles&quot;</span><span class="punctuation">:</span> <span class="number">100</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;totalSize&quot;</span><span class="punctuation">:</span> <span class="number">1073741824</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;totalDownloads&quot;</span><span class="punctuation">:</span> <span class="number">1250</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="3-4-⬇️-文件下载"><a href="#3-4-⬇️-文件下载" class="headerlink" title="3.4 ⬇️ 文件下载"></a>3.4 ⬇️ 文件下载</h3><p><strong>请求</strong>:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /api/v1/files/download/:filename</span><br><span class="line"><span class="attribute">Authorization</span><span class="punctuation">: </span>Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure><p><strong>URL 参数</strong>:</p><ul><li><code>filename</code>: 文件名或文件ID</li></ul><p><strong>功能特性</strong>:</p><ul><li>✅ 支持断点续传</li><li>✅ 下载统计</li><li>✅ 访问权限验证</li><li>✅ 下载日志记录</li></ul><p><strong>响应头</strong>:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/octet-stream</span><br><span class="line"><span class="attribute">Content-Disposition</span><span class="punctuation">: </span>attachment; filename=&quot;document.pdf&quot;</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1048576</span><br><span class="line"><span class="attribute">Accept-Ranges</span><span class="punctuation">: </span>bytes</span><br><span class="line"><span class="attribute">ETag</span><span class="punctuation">: </span>&quot;abc123...&quot;</span><br><span class="line"><span class="attribute">Last-Modified</span><span class="punctuation">: </span>Wed, 14 Nov 2025 10:00:00 GMT</span><br></pre></td></tr></table></figure><hr><h2 id="4-📎-文件支持"><a href="#4-📎-文件支持" class="headerlink" title="4. 📎 文件支持"></a>4. 📎 文件支持</h2><h3 id="4-1-🎨-允许的文件类型"><a href="#4-1-🎨-允许的文件类型" class="headerlink" title="4.1 🎨 允许的文件类型"></a>4.1 🎨 允许的文件类型</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[支持的文件类型] --&gt; B[图片文件]</span><br><span class="line">    A --&gt; C[文档文件]</span><br><span class="line">    A --&gt; D[压缩文件]</span><br><span class="line">    A --&gt; E[代码文件]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[image/*]</span><br><span class="line">    B --&gt; B2[jpeg, png, gif, webp]</span><br><span class="line"></span><br><span class="line">    C --&gt; C1[application/pdf]</span><br><span class="line">    C --&gt; C2[application/msword]</span><br><span class="line">    C --&gt; C3[text/plain]</span><br><span class="line"></span><br><span class="line">    D --&gt; D1[application/zip]</span><br><span class="line">    D --&gt; D2[application/x-rar-compressed]</span><br><span class="line"></span><br><span class="line">    E --&gt; E1[text/x-code]</span><br><span class="line">    E --&gt; E2[application/json]</span><br></pre></td></tr></table></figure><p><strong>详细MIME类型列表</strong>:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;images&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;image/jpeg&quot;</span><span class="punctuation">,</span> <span class="string">&quot;image/png&quot;</span><span class="punctuation">,</span> <span class="string">&quot;image/gif&quot;</span><span class="punctuation">,</span> <span class="string">&quot;image/webp&quot;</span><span class="punctuation">,</span> <span class="string">&quot;image/svg+xml&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;documents&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;application/pdf&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;application/msword&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;application/vnd.ms-excel&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;text/plain&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;text/markdown&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;archives&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;application/zip&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;application/x-rar-compressed&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;application/x-7z-compressed&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;text/x-code&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;application/json&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;text/xml&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;application/xml&quot;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="4-2-📏-文件大小限制"><a href="#4-2-📏-文件大小限制" class="headerlink" title="4.2 📏 文件大小限制"></a>4.2 📏 文件大小限制</h3><table><thead><tr><th>文件类型</th><th>最大大小</th><th>说明</th></tr></thead><tbody><tr><td><strong>图片文件</strong></td><td>50MB</td><td>JPEG, PNG, GIF等</td></tr><tr><td><strong>PDF文档</strong></td><td>100MB</td><td>PDF文档</td></tr><tr><td><strong>Office文档</strong></td><td>100MB</td><td>Word, Excel, PowerPoint</td></tr><tr><td><strong>压缩文件</strong></td><td>200MB</td><td>ZIP, RAR, 7Z</td></tr><tr><td><strong>其他文件</strong></td><td>50MB</td><td>其他允许的类型</td></tr></tbody></table><h3 id="4-3-🖼️-缩略图生成"><a href="#4-3-🖼️-缩略图生成" class="headerlink" title="4.3 🖼️ 缩略图生成"></a>4.3 🖼️ 缩略图生成</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[上传文件] --&gt; B&#123;是否为图片?&#125;</span><br><span class="line">    B --&gt;|是| C[生成缩略图]</span><br><span class="line">    B --&gt;|否| D[使用默认图标]</span><br><span class="line">    C --&gt; E[存储缩略图]</span><br><span class="line">    D --&gt; F[返回图标路径]</span><br><span class="line">    E --&gt; G[返回缩略图URL]</span><br></pre></td></tr></table></figure><p><strong>缩略图规格</strong>:</p><ul><li><strong>尺寸</strong>: 200x200 像素</li><li><strong>格式</strong>: JPEG</li><li><strong>质量</strong>: 85%</li><li><strong>存储路径</strong>: <code>/thumbnails/{file_id}.jpg</code></li></ul><hr><h2 id="5-❌-错误处理"><a href="#5-❌-错误处理" class="headerlink" title="5. ❌ 错误处理"></a>5. ❌ 错误处理</h2><h3 id="5-1-📊-标准错误响应格式"><a href="#5-1-📊-标准错误响应格式" class="headerlink" title="5.1 📊 标准错误响应格式"></a>5.1 📊 标准错误响应格式</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;success&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;error&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ERROR_CODE&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;用户友好的错误描述&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;details&quot;</span><span class="punctuation">:</span> <span class="string">&quot;详细错误信息（开发环境）&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2025-11-14T10:00:00Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;path&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/api/v1/files/upload&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;requestId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;uuid-for-tracking&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="5-2-📋-HTTP-状态码"><a href="#5-2-📋-HTTP-状态码" class="headerlink" title="5.2 📋 HTTP 状态码"></a>5.2 📋 HTTP 状态码</h3><table><thead><tr><th>状态码</th><th>说明</th><th>示例场景</th></tr></thead><tbody><tr><td><strong>200</strong></td><td>成功</td><td>文件上传成功</td></tr><tr><td><strong>201</strong></td><td>创建成功</td><td>用户注册成功</td></tr><tr><td><strong>400</strong></td><td>请求错误</td><td>参数验证失败</td></tr><tr><td><strong>401</strong></td><td>未认证</td><td>Token无效或过期</td></tr><tr><td><strong>403</strong></td><td>权限不足</td><td>访问他人文件</td></tr><tr><td><strong>404</strong></td><td>资源不存在</td><td>文件不存在</td></tr><tr><td><strong>409</strong></td><td>冲突</td><td>用户名已存在</td></tr><tr><td><strong>413</strong></td><td>文件过大</td><td>超过大小限制</td></tr><tr><td><strong>415</strong></td><td>不支持的类型</td><td>文件类型不允许</td></tr><tr><td><strong>422</strong></td><td>验证失败</td><td>业务逻辑验证失败</td></tr><tr><td><strong>429</strong></td><td>请求过多</td><td>超出速率限制</td></tr><tr><td><strong>500</strong></td><td>服务器错误</td><td>内部服务器错误</td></tr></tbody></table><h3 id="5-3-🔧-错误代码定义"><a href="#5-3-🔧-错误代码定义" class="headerlink" title="5.3 🔧 错误代码定义"></a>5.3 🔧 错误代码定义</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">ErrorCodes</span> = &#123;</span><br><span class="line">    <span class="comment">// 认证相关</span></span><br><span class="line">    <span class="attr">AUTH_TOKEN_MISSING</span>: <span class="string">&#x27;AUTH_001&#x27;</span>,</span><br><span class="line">    <span class="attr">AUTH_TOKEN_INVALID</span>: <span class="string">&#x27;AUTH_002&#x27;</span>,</span><br><span class="line">    <span class="attr">AUTH_TOKEN_EXPIRED</span>: <span class="string">&#x27;AUTH_003&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户相关</span></span><br><span class="line">    <span class="attr">USER_NOT_FOUND</span>: <span class="string">&#x27;USER_001&#x27;</span>,</span><br><span class="line">    <span class="attr">USER_ALREADY_EXISTS</span>: <span class="string">&#x27;USER_002&#x27;</span>,</span><br><span class="line">    <span class="attr">USER_CREDENTIALS_INVALID</span>: <span class="string">&#x27;USER_003&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件相关</span></span><br><span class="line">    <span class="attr">FILE_NOT_FOUND</span>: <span class="string">&#x27;FILE_001&#x27;</span>,</span><br><span class="line">    <span class="attr">FILE_TOO_LARGE</span>: <span class="string">&#x27;FILE_002&#x27;</span>,</span><br><span class="line">    <span class="attr">FILE_TYPE_NOT_ALLOWED</span>: <span class="string">&#x27;FILE_003&#x27;</span>,</span><br><span class="line">    <span class="attr">FILE_UPLOAD_FAILED</span>: <span class="string">&#x27;FILE_004&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 系统相关</span></span><br><span class="line">    <span class="attr">RATE_LIMIT_EXCEEDED</span>: <span class="string">&#x27;SYS_001&#x27;</span>,</span><br><span class="line">    <span class="attr">MAINTENANCE_MODE</span>: <span class="string">&#x27;SYS_002&#x27;</span>,</span><br><span class="line">    <span class="attr">QUOTA_EXCEEDED</span>: <span class="string">&#x27;SYS_003&#x27;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="6-🔒-安全机制"><a href="#6-🔒-安全机制" class="headerlink" title="6. 🔒 安全机制"></a>6. 🔒 安全机制</h2><h3 id="6-1-🛡️-认证与授权"><a href="#6-1-🛡️-认证与授权" class="headerlink" title="6.1 🛡️ 认证与授权"></a>6.1 🛡️ 认证与授权</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[客户端请求] --&gt; B[JWT验证]</span><br><span class="line">    B --&gt; C&#123;Token有效?&#125;</span><br><span class="line">    C --&gt;|否| D[返回401错误]</span><br><span class="line">    C --&gt;|是| E[权限检查]</span><br><span class="line">    E --&gt; F&#123;权限充足?&#125;</span><br><span class="line">    F --&gt;|否| G[返回403错误]</span><br><span class="line">    F --&gt;|是| H[处理请求]</span><br><span class="line">    H --&gt; I[返回响应]</span><br></pre></td></tr></table></figure><h4 id="JWT-Token-结构"><a href="#JWT-Token-结构" class="headerlink" title="JWT Token 结构"></a>JWT Token 结构</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;header&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JWT&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;payload&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;sub&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;email&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user@example.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;iat&quot;</span><span class="punctuation">:</span> <span class="number">1640000000</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;exp&quot;</span><span class="punctuation">:</span> <span class="number">1640086400</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="6-2-🔐-密码安全"><a href="#6-2-🔐-密码安全" class="headerlink" title="6.2 🔐 密码安全"></a>6.2 🔐 密码安全</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 密码加密示例</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">&#x27;bcrypt&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">hashPassword</span> = <span class="keyword">async</span> (<span class="params">password</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> saltRounds = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> bcrypt.<span class="title function_">hash</span>(password, saltRounds);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">verifyPassword</span> = <span class="keyword">async</span> (<span class="params">password, hash</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> bcrypt.<span class="title function_">compare</span>(password, hash);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="6-3-📝-输入验证"><a href="#6-3-📝-输入验证" class="headerlink" title="6.3 📝 输入验证"></a>6.3 📝 输入验证</h3><p><strong>文件名验证</strong>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;filename&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;pattern&quot;</span>: <span class="string">&quot;^[a-zA-Z0-9._-]+$&quot;</span>,</span><br><span class="line">        <span class="string">&quot;maxLength&quot;</span>: <span class="number">255</span>,</span><br><span class="line">        <span class="string">&quot;sanitize&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>SQL注入防护</strong>:</p><ul><li>使用参数化查询</li><li>输入转义和过滤</li><li>最小权限原则</li></ul><hr><h2 id="7-⏱️-速率限制"><a href="#7-⏱️-速率限制" class="headerlink" title="7. ⏱️ 速率限制"></a>7. ⏱️ 速率限制</h2><h3 id="7-1-🚦-限制策略"><a href="#7-1-🚦-限制策略" class="headerlink" title="7.1 🚦 限制策略"></a>7.1 🚦 限制策略</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[请求] --&gt; B[速率限制检查]</span><br><span class="line">    B --&gt; C&#123;超出限制?&#125;</span><br><span class="line">    C --&gt;|是| D[返回429错误]</span><br><span class="line">    C --&gt;|否| E[处理请求]</span><br><span class="line">    E --&gt; F[更新计数器]</span><br><span class="line"></span><br><span class="line">    style D fill:#ffcdd2</span><br><span class="line">    style F fill:#c8e6c9</span><br></pre></td></tr></table></figure><h3 id="7-2-📊-限制规则"><a href="#7-2-📊-限制规则" class="headerlink" title="7.2 📊 限制规则"></a>7.2 📊 限制规则</h3><table><thead><tr><th>端点类型</th><th>时间窗口</th><th>最大请求数</th><th>说明</th></tr></thead><tbody><tr><td><strong>认证相关</strong></td><td>15分钟</td><td>5次&#x2F;IP</td><td>登录、注册</td></tr><tr><td><strong>文件上传</strong></td><td>1小时</td><td>50次&#x2F;用户</td><td>单文件上传</td></tr><tr><td><strong>文件下载</strong></td><td>1小时</td><td>200次&#x2F;用户</td><td>文件下载</td></tr><tr><td><strong>其他API</strong></td><td>15分钟</td><td>100次&#x2F;IP</td><td>一般请求</td></tr></tbody></table><h3 id="7-3-📈-限制响应头"><a href="#7-3-📈-限制响应头" class="headerlink" title="7.3 📈 限制响应头"></a>7.3 📈 限制响应头</h3><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">429</span> Too Many Requests</span><br><span class="line"><span class="attribute">X-RateLimit-Limit</span><span class="punctuation">: </span>5</span><br><span class="line"><span class="attribute">X-RateLimit-Remaining</span><span class="punctuation">: </span>0</span><br><span class="line"><span class="attribute">X-RateLimit-Reset</span><span class="punctuation">: </span>1640090000</span><br><span class="line"><span class="attribute">Retry-After</span><span class="punctuation">: </span>900</span><br></pre></td></tr></table></figure><hr><h2 id="8-📋-OpenAPI-规范"><a href="#8-📋-OpenAPI-规范" class="headerlink" title="8. 📋 OpenAPI 规范"></a>8. 📋 OpenAPI 规范</h2><h3 id="8-1-🔍-Swagger-配置"><a href="#8-1-🔍-Swagger-配置" class="headerlink" title="8.1 🔍 Swagger 配置"></a>8.1 🔍 Swagger 配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">openapi:</span> <span class="number">3.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">info:</span></span><br><span class="line">  <span class="attr">title:</span> <span class="string">文件管理系统</span> <span class="string">API</span></span><br><span class="line">  <span class="attr">description:</span> <span class="string">基于JWT认证的文件管理系统API文档</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">  <span class="attr">contact:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">API</span> <span class="string">Support</span></span><br><span class="line">    <span class="attr">email:</span> <span class="string">support@example.com</span></span><br><span class="line">  <span class="attr">license:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">MIT</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">https://opensource.org/licenses/MIT</span></span><br><span class="line"></span><br><span class="line"><span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">https://api.example.com/api/v1</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">生产环境</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">https://dev-api.example.com/api/v1</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">开发环境</span></span><br><span class="line"></span><br><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">bearerAuth:</span> []</span><br><span class="line"></span><br><span class="line"><span class="attr">components:</span></span><br><span class="line">  <span class="attr">securitySchemes:</span></span><br><span class="line">    <span class="attr">bearerAuth:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">bearer</span></span><br><span class="line">      <span class="attr">bearerFormat:</span> <span class="string">JWT</span></span><br></pre></td></tr></table></figure><h3 id="8-2-📝-API-文档生成"><a href="#8-2-📝-API-文档生成" class="headerlink" title="8.2 📝 API 文档生成"></a>8.2 📝 API 文档生成</h3><p><strong>访问 Swagger UI</strong>:</p><ul><li>生产环境: <code>https://api.example.com/docs</code></li><li>开发环境: <code>https://dev-api.example.com/docs</code></li></ul><p><strong>下载 OpenAPI 规范</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -o api-spec.json https://api.example.com/api-spec</span><br></pre></td></tr></table></figure><hr><h2 id="📊-API-使用统计"><a href="#📊-API-使用统计" class="headerlink" title="📊 API 使用统计"></a>📊 API 使用统计</h2><h3 id="9-1-📈-使用情况监控"><a href="#9-1-📈-使用情况监控" class="headerlink" title="9.1 📈 使用情况监控"></a>9.1 📈 使用情况监控</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[API请求] --&gt; B[记录请求日志]</span><br><span class="line">    B --&gt; C[更新统计数据]</span><br><span class="line">    C --&gt; D[实时监控面板]</span><br><span class="line"></span><br><span class="line">    E[错误请求] --&gt; F[错误日志记录]</span><br><span class="line">    F --&gt; G[告警系统]</span><br><span class="line">    G --&gt; H[运维团队]</span><br></pre></td></tr></table></figure><h3 id="9-2-🔍-分析指标"><a href="#9-2-🔍-分析指标" class="headerlink" title="9.2 🔍 分析指标"></a>9.2 🔍 分析指标</h3><table><thead><tr><th>指标</th><th>说明</th><th>用途</th></tr></thead><tbody><tr><td><strong>请求量</strong></td><td>API调用次数</td><td>性能分析</td></tr><tr><td><strong>响应时间</strong></td><td>平均响应时间</td><td>性能优化</td></tr><tr><td><strong>错误率</strong></td><td>4xx&#x2F;5xx错误比例</td><td>系统稳定性</td></tr><tr><td><strong>并发用户</strong></td><td>同时在线用户数</td><td>容量规划</td></tr></tbody></table><hr><h2 id="📚-客户端集成"><a href="#📚-客户端集成" class="headerlink" title="📚 客户端集成"></a>📚 客户端集成</h2><h3 id="10-1-🖥️-JavaScript-客户端示例"><a href="#10-1-🖥️-JavaScript-客户端示例" class="headerlink" title="10.1 🖥️ JavaScript 客户端示例"></a>10.1 🖥️ JavaScript 客户端示例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileManagerAPI</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">baseURL</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">baseURL</span> = baseURL;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">token</span> = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">setToken</span>(<span class="params">token</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">token</span> = token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">request</span>(<span class="params">method, endpoint, data = <span class="literal">null</span>, options = &#123;&#125;</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> config = &#123;</span><br><span class="line">            method,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                ...options.<span class="property">headers</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">token</span>) &#123;</span><br><span class="line">            config.<span class="property">headers</span>.<span class="property">Authorization</span> = <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.token&#125;</span>`</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (data) &#123;</span><br><span class="line">            config.<span class="property">body</span> = <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.baseURL&#125;</span><span class="subst">$&#123;endpoint&#125;</span>`</span>, config);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户登录</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">login</span>(<span class="params">username, password</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;/auth/login&#x27;</span>, &#123;</span><br><span class="line">            username,</span><br><span class="line">            password</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (result.<span class="property">success</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setToken</span>(result.<span class="property">data</span>.<span class="property">token</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传文件</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">uploadFile</span>(<span class="params">file</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> formData = <span class="keyword">new</span> <span class="title class_">FormData</span>();</span><br><span class="line">        formData.<span class="title function_">append</span>(<span class="string">&#x27;file&#x27;</span>, file);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.baseURL&#125;</span>/files/upload`</span>, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Authorization&#x27;</span>: <span class="string">`Bearer <span class="subst">$&#123;<span class="variable language_">this</span>.token&#125;</span>`</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">body</span>: formData</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取文件列表</span></span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">getFiles</span>(<span class="params">page = <span class="number">1</span>, limit = <span class="number">20</span></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">request</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">`/files/list?page=<span class="subst">$&#123;page&#125;</span>&amp;limit=<span class="subst">$&#123;limit&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> api = <span class="keyword">new</span> <span class="title class_">FileManagerAPI</span>(<span class="string">&#x27;https://api.example.com/api/v1&#x27;</span>);</span><br></pre></td></tr></table></figure><hr><h2 id="📋-总结"><a href="#📋-总结" class="headerlink" title="📋 总结"></a>📋 总结</h2><h3 id="✅-API-特性总览"><a href="#✅-API-特性总览" class="headerlink" title="✅ API 特性总览"></a>✅ API 特性总览</h3><ul><li>🔐 <strong>安全认证</strong>: JWT Token 认证机制</li><li>📁 <strong>文件管理</strong>: 完整的文件上传下载功能</li><li>🎯 <strong>权限控制</strong>: 用户级别的访问控制</li><li>⚡ <strong>性能优化</strong>: 支持断点续传和缩略图</li><li>📊 <strong>监控统计</strong>: 完整的API使用统计</li><li>📝 <strong>文档完整</strong>: 详细的API文档和示例</li></ul><h3 id="🚀-集成建议"><a href="#🚀-集成建议" class="headerlink" title="🚀 集成建议"></a>🚀 集成建议</h3><ol><li><strong>前端应用</strong>: 使用 JavaScript SDK 快速集成</li><li><strong>移动应用</strong>: 使用 RESTful API 进行数据交互</li><li><strong>第三方服务</strong>: 通过 Webhook 接收文件事件通知</li><li><strong>企业集成</strong>: 支持 SSO 和企业级权限管理</li></ol><h3 id="🔧-扩展功能"><a href="#🔧-扩展功能" class="headerlink" title="🔧 扩展功能"></a>🔧 扩展功能</h3><ul><li>🔄 <strong>文件同步</strong>: 多设备文件同步</li><li>📤 <strong>分享链接</strong>: 生成文件分享链接</li><li>🔍 <strong>全文搜索</strong>: 文件内容全文检索</li><li>🗂️ <strong>版本管理</strong>: 文件版本历史记录</li><li>📱 <strong>移动端</strong>: 专用的移动端API</li></ul><hr><blockquote><p><strong>💡 使用提示</strong>:</p><ul><li>所有API调用都需要有效的JWT Token</li><li>建议使用HTTPS确保传输安全</li><li>定期轮换API密钥和密码</li><li>监控API使用情况避免超出配额限制</li></ul></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;文件管理-API-规范&quot;&gt;&lt;a href=&quot;#文件管理-API-规范&quot; class=&quot;headerlink&quot; title=&quot;文件管理 API 规范&quot;&gt;&lt;/a&gt;文件管理 API</summary>
        
      
    
    
    
    <category term="Web架构安全" scheme="https://vilaswang.github.io/categories/Web%E6%9E%B6%E6%9E%84%E5%AE%89%E5%85%A8/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>FileZilla 端口转发指南</title>
    <link href="https://vilaswang.github.io/posts/33eb4929/"/>
    <id>https://vilaswang.github.io/posts/33eb4929/</id>
    <published>2025-12-09T06:09:54.000Z</published>
    <updated>2025-12-17T15:36:29.284Z</updated>
    
    <content type="html"><![CDATA[<h1 id="FileZilla-端口转发指南"><a href="#FileZilla-端口转发指南" class="headerlink" title="FileZilla 端口转发指南"></a>FileZilla 端口转发指南</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>标签</strong>: <code>filezilla</code>, <code>ftp</code>, <code>portforwarding</code>, <code>花生壳</code>, <code>内网穿透</code>, <code>远程访问</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E6%A6%82%E8%BF%B0">1. 概述</a></li><li><a href="#2-%E9%85%8D%E7%BD%AE%E6%B5%81%E7%A8%8B%E5%9B%BE">2. 配置流程图</a></li><li><a href="#3-filezilla-server-%E9%85%8D%E7%BD%AE">3. FileZilla Server 配置</a></li><li><a href="#4-%E8%8A%B1%E7%94%9F%E5%A3%B3%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F">4. 花生壳内网穿透</a></li><li><a href="#5-ftp-%E8%A2%AB%E5%8A%A8%E6%A8%A1%E5%BC%8F%E9%85%8D%E7%BD%AE">5. FTP 被动模式配置</a></li><li><a href="#6-%E9%98%B2%E7%81%AB%E5%A2%99%E8%AE%BE%E7%BD%AE">6. 防火墙设置</a></li><li><a href="#7-%E8%BF%9E%E6%8E%A5%E6%B5%8B%E8%AF%95">7. 连接测试</a></li><li><a href="#8-%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">8. 故障排除</a></li></ul><hr><h2 id="1-📖-概述"><a href="#1-📖-概述" class="headerlink" title="1. 📖 概述"></a>1. 📖 概述</h2><p>本指南详细介绍如何使用 FileZilla Server 搭建 FTP 服务器，并通过花生壳实现外网访问内网文件的完整解决方案。</p><h3 id="🎯-配置目标"><a href="#🎯-配置目标" class="headerlink" title="🎯 配置目标"></a>🎯 配置目标</h3><ul><li>✅ 搭建内网 FTP 服务器</li><li>✅ 配置花生壳内网穿透</li><li>✅ 实现外网安全访问</li><li>✅ 支持文件上传下载</li></ul><h3 id="🏗️-系统架构图"><a href="#🏗️-系统架构图" class="headerlink" title="🏗️ 系统架构图"></a>🏗️ 系统架构图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[外网客户端] --&gt; B[花生壳外网域名]</span><br><span class="line">    B --&gt; C[花生壳服务器]</span><br><span class="line">    C --&gt; D[内网服务器]</span><br><span class="line">    D --&gt; E[FileZilla Server]</span><br><span class="line">    E --&gt; F[共享文件夹]</span><br><span class="line"></span><br><span class="line">    G[FTP控制通道&lt;br/&gt;端口21] --&gt; C</span><br><span class="line">    H[FTP数据通道&lt;br/&gt;被动端口] --&gt; C</span><br><span class="line"></span><br><span class="line">    style A fill:#e1f5fe</span><br><span class="line">    style B fill:#f3e5f5</span><br><span class="line">    style C fill:#e8f5e8</span><br><span class="line">    style D fill:#fff3e0</span><br></pre></td></tr></table></figure><hr><h2 id="2-🔄-配置流程图"><a href="#2-🔄-配置流程图" class="headerlink" title="2. 🔄 配置流程图"></a>2. 🔄 配置流程图</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">flowchart TD</span><br><span class="line">    A[开始配置] --&gt; B[安装与配置FileZilla Server]</span><br><span class="line">    B --&gt; C[配置花生壳内网穿透]</span><br><span class="line">    C --&gt; D&#123;配置FTP被动模式&lt;br&gt;与数据传输端口&#125;</span><br><span class="line">    D --&gt; E[设置Windows防火墙]</span><br><span class="line">    E --&gt; F[外网连接测试]</span><br><span class="line">    F --&gt; G&#123;测试成功?&#125;</span><br><span class="line">    G -- 是 --&gt; H[配置完成]</span><br><span class="line">    G -- 否 --&gt; I[检查端口映射与被动模式设置]</span><br><span class="line">    I --&gt; F</span><br></pre></td></tr></table></figure><hr><h2 id="3-🖥️-FileZilla-Server-配置"><a href="#3-🖥️-FileZilla-Server-配置" class="headerlink" title="3. 🖥️ FileZilla Server 配置"></a>3. 🖥️ FileZilla Server 配置</h2><h3 id="3-1-📥-下载与安装"><a href="#3-1-📥-下载与安装" class="headerlink" title="3.1 📥 下载与安装"></a>3.1 📥 下载与安装</h3><ol><li><p><strong>下载 FileZilla Server</strong></p><ul><li>访问 <a href="https://filezilla-project.org/">FileZilla 官网</a></li><li>下载 FileZilla Server 版本</li><li>以管理员身份运行安装程序</li></ul></li><li><p><strong>安装配置</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装过程中的关键设置：</span></span><br><span class="line">- 管理端口: 14147 (默认)</span><br><span class="line">- 服务端口: 21 (FTP控制端口)</span><br><span class="line">- 启动为系统服务: 推荐</span><br></pre></td></tr></table></figure></li></ol><h3 id="3-2-👤-用户与权限配置"><a href="#3-2-👤-用户与权限配置" class="headerlink" title="3.2 👤 用户与权限配置"></a>3.2 👤 用户与权限配置</h3><h4 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h4><ol><li><p><strong>打开管理界面</strong></p><ul><li>双击系统托盘的 FileZilla Server 图标</li><li>或访问 <code>http://localhost:14147</code></li></ul></li><li><p><strong>添加用户</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Edit → Users → Add</span><br><span class="line">- 用户名: user1 (自定义)</span><br><span class="line">- 密码: 设置强密码</span><br><span class="line">- 勾选 &quot;Password&quot; 并输入密码</span><br></pre></td></tr></table></figure></li></ol><h4 id="设置共享文件夹"><a href="#设置共享文件夹" class="headerlink" title="设置共享文件夹"></a>设置共享文件夹</h4><ol><li><p><strong>添加共享目录</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Shared folders → Add</span><br><span class="line">- 选择要共享的内网目录</span><br><span class="line">- 例如: D:\SharedFiles</span><br></pre></td></tr></table></figure></li><li><p><strong>配置权限</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Files权限:</span><br><span class="line">✓ Read (读取/下载)</span><br><span class="line">✓ Write (写入/上传) - 可选</span><br><span class="line">✓ Delete (删除) - 可选</span><br><span class="line">✓ Append (追加) - 可选</span><br><span class="line"></span><br><span class="line">Directories权限:</span><br><span class="line">✓ Create (创建目录)</span><br><span class="line">✓ Delete (删除目录)</span><br><span class="line">✓ List (列出目录)</span><br><span class="line">✓ Subdirs (子目录)</span><br></pre></td></tr></table></figure></li></ol><h3 id="3-3-🔧-基础配置"><a href="#3-3-🔧-基础配置" class="headerlink" title="3.3 🔧 基础配置"></a>3.3 🔧 基础配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[FileZilla设置] --&gt; B[常规设置]</span><br><span class="line">    A --&gt; C[被动模式]</span><br><span class="line">    A --&gt; D[安全设置]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[监听端口: 21]</span><br><span class="line">    B --&gt; B2[最大连接数: 10]</span><br><span class="line"></span><br><span class="line">    C --&gt; C1[启用被动模式]</span><br><span class="line">    C --&gt; C2[自定义端口范围]</span><br><span class="line"></span><br><span class="line">    D --&gt; D1[加密模式]</span><br><span class="line">    D --&gt; D2[IP过滤]</span><br></pre></td></tr></table></figure><hr><h2 id="4-🌐-花生壳内网穿透"><a href="#4-🌐-花生壳内网穿透" class="headerlink" title="4. 🌐 花生壳内网穿透"></a>4. 🌐 花生壳内网穿透</h2><h3 id="4-1-📱-花生壳客户端设置"><a href="#4-1-📱-花生壳客户端设置" class="headerlink" title="4.1 📱 花生壳客户端设置"></a>4.1 📱 花生壳客户端设置</h3><ol><li><p><strong>下载安装花生壳</strong></p><ul><li>访问 <a href="https://hsk.oray.com/">花生壳官网</a></li><li>下载并安装花生壳客户端</li><li>注册并登录花生壳账号</li></ul></li><li><p><strong>添加内网穿透映射</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">内网穿透 → + 添加映射</span><br><span class="line"></span><br><span class="line">第一个映射 (FTP控制通道):</span><br><span class="line">- 应用名称: FTP-Control</span><br><span class="line">- 应用类型: TCP</span><br><span class="line">- 内网主机IP: 192.168.x.x (服务器内网IP)</span><br><span class="line">- 内网端口: 21</span><br></pre></td></tr></table></figure></li></ol><h3 id="4-2-🔗-获取外网访问地址"><a href="#4-2-🔗-获取外网访问地址" class="headerlink" title="4.2 🔗 获取外网访问地址"></a>4.2 🔗 获取外网访问地址</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant U as 用户</span><br><span class="line">    participant P as 花生壳客户端</span><br><span class="line">    participant S as 花生壳服务器</span><br><span class="line">    participant F as FileZilla Server</span><br><span class="line"></span><br><span class="line">    U-&gt;&gt;P: 添加映射配置</span><br><span class="line">    P-&gt;&gt;S: 提交映射请求</span><br><span class="line">    S-&gt;&gt;S: 生成外网域名</span><br><span class="line">    S-&gt;&gt;P: 返回外网访问地址</span><br><span class="line">    P-&gt;&gt;U: 显示外网地址</span><br></pre></td></tr></table></figure><p><strong>获取的信息</strong>:</p><ul><li>外网域名: <code>xxxx.vicp.cc</code></li><li>外网端口: <code>12345</code> (示例)</li></ul><hr><h2 id="5-🔄-FTP-被动模式配置"><a href="#5-🔄-FTP-被动模式配置" class="headerlink" title="5. 🔄 FTP 被动模式配置"></a>5. 🔄 FTP 被动模式配置</h2><h3 id="5-1-🎯-理解被动模式"><a href="#5-1-🎯-理解被动模式" class="headerlink" title="5.1 🎯 理解被动模式"></a>5.1 🎯 理解被动模式</h3><p>FTP 协议需要两个通道：</p><ul><li><strong>控制通道</strong>: 端口 21，用于发送命令</li><li><strong>数据通道</strong>: 动态端口，用于传输数据</li></ul><h3 id="5-2-📡-添加数据端口映射"><a href="#5-2-📡-添加数据端口映射" class="headerlink" title="5.2 📡 添加数据端口映射"></a>5.2 📡 添加数据端口映射</h3><ol><li><p><strong>在花生壳中添加第二个映射</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">第二个映射 (FTP数据通道):</span><br><span class="line">- 应用名称: FTP-Data</span><br><span class="line">- 应用类型: TCP</span><br><span class="line">- 内网主机IP: 192.168.x.x (同上)</span><br><span class="line">- 内网端口: 60000 (临时设置)</span><br></pre></td></tr></table></figure></li><li><p><strong>记下外网端口</strong></p><ul><li>假设生成的外网端口为 <code>10418</code></li><li>需要修改内网端口与之匹配</li></ul></li><li><p><strong>修正端口映射</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">编辑 FTP-Data 映射:</span><br><span class="line">- 将内网端口改为: 10418</span><br><span class="line">- 确保内外端口一致</span><br></pre></td></tr></table></figure></li></ol><h3 id="5-3-⚙️-FileZilla-被动模式设置"><a href="#5-3-⚙️-FileZilla-被动模式设置" class="headerlink" title="5.3 ⚙️ FileZilla 被动模式设置"></a>5.3 ⚙️ FileZilla 被动模式设置</h3><ol><li><p><strong>进入被动模式设置</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Edit → Settings → Passive mode settings</span><br></pre></td></tr></table></figure></li><li><p><strong>配置被动模式参数</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">✓ Use custom port range</span><br><span class="line">- Custom port range: 10418-10418</span><br><span class="line"></span><br><span class="line">✓ Use the following IP</span><br><span class="line">- IP: xxxx.vicp.cc (花生壳域名)</span><br></pre></td></tr></table></figure></li></ol><h3 id="4-4-🛡️-安全配置建议"><a href="#4-4-🛡️-安全配置建议" class="headerlink" title="4.4 🛡️ 安全配置建议"></a>4.4 🛡️ 安全配置建议</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[FTP安全配置] --&gt; B[启用SSL/TLS]</span><br><span class="line">    A --&gt; C[限制IP访问]</span><br><span class="line">    A --&gt; D[强密码策略]</span><br><span class="line">    A --&gt; E[日志监控]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[生成自签名证书]</span><br><span class="line">    B --&gt; B2[强制加密连接]</span><br><span class="line"></span><br><span class="line">    C --&gt; C1[IP白名单]</span><br><span class="line">    C --&gt; C2[地理位置限制]</span><br><span class="line"></span><br><span class="line">    D --&gt; D1[密码复杂度要求]</span><br><span class="line">    D --&gt; D2[定期更换密码]</span><br><span class="line"></span><br><span class="line">    E --&gt; E1[访问日志]</span><br><span class="line">    E --&gt; E2[异常告警]</span><br></pre></td></tr></table></figure><hr><h2 id="6-🔥-Windows-防火墙设置"><a href="#6-🔥-Windows-防火墙设置" class="headerlink" title="6. 🔥 Windows 防火墙设置"></a>6. 🔥 Windows 防火墙设置</h2><h3 id="6-1-🛡️-添加防火墙规则"><a href="#6-1-🛡️-添加防火墙规则" class="headerlink" title="6.1 🛡️ 添加防火墙规则"></a>6.1 🛡️ 添加防火墙规则</h3><ol><li><p><strong>打开 Windows 防火墙</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">控制面板 → Windows Defender 防火墙 → 高级设置</span><br></pre></td></tr></table></figure></li><li><p><strong>添加入站规则</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">入站规则 → 新建规则</span><br><span class="line"></span><br><span class="line">规则1 (FTP控制):</span><br><span class="line">- 端口: TCP 21</span><br><span class="line">- 操作: 允许连接</span><br><span class="line">- 配置文件: 域、专用、公用</span><br><span class="line"></span><br><span class="line">规则2 (FTP数据):</span><br><span class="line">- 端口: TCP 10418</span><br><span class="line">- 操作: 允许连接</span><br><span class="line">- 配置文件: 域、专用、公用</span><br></pre></td></tr></table></figure></li></ol><h3 id="6-2-🔧-验证防火墙配置"><a href="#6-2-🔧-验证防火墙配置" class="headerlink" title="6.2 🔧 验证防火墙配置"></a>6.2 🔧 验证防火墙配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line">telnet localhost 21</span><br><span class="line">telnet localhost 10418</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line">netsh advfirewall show allprofiles</span><br></pre></td></tr></table></figure><hr><h2 id="7-🧪-外网连接测试"><a href="#7-🧪-外网连接测试" class="headerlink" title="7. 🧪 外网连接测试"></a>7. 🧪 外网连接测试</h2><h3 id="7-1-🔗-使用-FileZilla-Client-测试"><a href="#7-1-🔗-使用-FileZilla-Client-测试" class="headerlink" title="7.1 🔗 使用 FileZilla Client 测试"></a>7.1 🔗 使用 FileZilla Client 测试</h3><ol><li><p><strong>下载 FileZilla Client</strong></p><ul><li>访问 FileZilla 官网下载客户端</li><li>安装并启动</li></ul></li><li><p><strong>配置站点连接</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">主机: xxxx.vicp.cc:21</span><br><span class="line">用户名: user1</span><br><span class="line">密码: [设置的密码]</span><br><span class="line">端口: 21</span><br><span class="line">传输模式: 被动模式</span><br></pre></td></tr></table></figure></li><li><p><strong>连接测试</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">    participant C as FileZilla Client</span><br><span class="line">    participant H as 花生壳</span><br><span class="line">    participant S as 内网服务器</span><br><span class="line">    participant F as FileZilla Server</span><br><span class="line"></span><br><span class="line">    C-&gt;&gt;H: 连接请求 (端口21)</span><br><span class="line">    H-&gt;&gt;S: 转发连接</span><br><span class="line">    S-&gt;&gt;F: FTP控制连接</span><br><span class="line">    F-&gt;&gt;S: 响应被动端口</span><br><span class="line">    S-&gt;&gt;H: 转发被动端口信息</span><br><span class="line">    H-&gt;&gt;C: 返回数据端口</span><br><span class="line">    C-&gt;&gt;H: 数据连接 (端口10418)</span><br><span class="line">    H-&gt;&gt;S: 转发数据连接</span><br><span class="line">    S-&gt;&gt;F: FTP数据连接</span><br></pre></td></tr></table></figure></li></ol><h3 id="7-2-📊-测试结果检查"><a href="#7-2-📊-测试结果检查" class="headerlink" title="7.2 📊 测试结果检查"></a>7.2 📊 测试结果检查</h3><p><strong>成功标志</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">✅ 状态: 连接成功</span><br><span class="line">✅ 目录列表: 显示共享文件夹内容</span><br><span class="line">✅ 文件下载: 可以正常下载文件</span><br><span class="line">✅ 文件上传: 可以正常上传文件 (如果权限允许)</span><br></pre></td></tr></table></figure><h3 id="7-3-🌐-其他-FTP-客户端测试"><a href="#7-3-🌐-其他-FTP-客户端测试" class="headerlink" title="7.3 🌐 其他 FTP 客户端测试"></a>7.3 🌐 其他 FTP 客户端测试</h3><h4 id="Windows-资源管理器"><a href="#Windows-资源管理器" class="headerlink" title="Windows 资源管理器"></a>Windows 资源管理器</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">地址栏输入: ftp://user1:password@xxxx.vicp.cc:21</span><br></pre></td></tr></table></figure><h4 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">访问: ftp://xxxx.vicp.cc:21</span><br></pre></td></tr></table></figure><h4 id="命令行测试"><a href="#命令行测试" class="headerlink" title="命令行测试"></a>命令行测试</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ftp xxxx.vicp.cc:21</span><br><span class="line">user1</span><br><span class="line">password</span><br><span class="line"><span class="built_in">ls</span></span><br></pre></td></tr></table></figure><hr><h2 id="8-🔧-故障排除"><a href="#8-🔧-故障排除" class="headerlink" title="8. 🔧 故障排除"></a>8. 🔧 故障排除</h2><h3 id="8-1-❌-常见问题及解决方案"><a href="#8-1-❌-常见问题及解决方案" class="headerlink" title="8.1 ❌ 常见问题及解决方案"></a>8.1 ❌ 常见问题及解决方案</h3><h4 id="问题1-连接超时"><a href="#问题1-连接超时" class="headerlink" title="问题1: 连接超时"></a>问题1: 连接超时</h4><p><strong>症状</strong>: 连接时长时间无响应</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[连接超时] --&gt; B&#123;问题排查&#125;</span><br><span class="line">    B --&gt; C[检查花生壳映射]</span><br><span class="line">    B --&gt; D[检查防火墙设置]</span><br><span class="line">    B --&gt; E[检查FTP服务状态]</span><br><span class="line"></span><br><span class="line">    C --&gt; C1[确认映射配置正确]</span><br><span class="line">    D --&gt; D1[确认端口已开放]</span><br><span class="line">    E --&gt; E1[确认服务正在运行]</span><br></pre></td></tr></table></figure><p><strong>解决方案</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line">ftp localhost:21</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line">services.msc → 查找 FileZilla Server</span><br></pre></td></tr></table></figure><h4 id="问题2-能连接但无法列出目录"><a href="#问题2-能连接但无法列出目录" class="headerlink" title="问题2: 能连接但无法列出目录"></a>问题2: 能连接但无法列出目录</h4><p><strong>症状</strong>: 连接成功但看不到文件列表</p><p><strong>原因分析</strong>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">主要原因: 被动模式配置错误</span><br><span class="line">- 数据端口映射不正确</span><br><span class="line">- FileZilla被动模式设置问题</span><br></pre></td></tr></table></figure><p><strong>解决方案</strong>:</p><ol><li>重新配置被动模式端口</li><li>确保 FileZilla 中设置的外网IP正确</li><li>检查数据端口的防火墙规则</li></ol><h4 id="问题3-登录认证失败"><a href="#问题3-登录认证失败" class="headerlink" title="问题3: 登录认证失败"></a>问题3: 登录认证失败</h4><p><strong>症状</strong>: 用户名或密码错误</p><p><strong>解决方案</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line">FileZilla Server管理界面 → Edit → Users</span><br><span class="line">→ 选择用户 → 重新设置密码</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line">确认用户有至少一个共享文件夹</span><br><span class="line">确认用户有读取权限</span><br></pre></td></tr></table></figure><h3 id="8-2-🔍-高级故障排除"><a href="#8-2-🔍-高级故障排除" class="headerlink" title="8.2 🔍 高级故障排除"></a>8.2 🔍 高级故障排除</h3><h4 id="网络诊断工具"><a href="#网络诊断工具" class="headerlink" title="网络诊断工具"></a>网络诊断工具</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line">nmap -p 21,10418 localhost</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line">telnet localhost 21</span><br><span class="line">telnet localhost 10418</span><br><span class="line"></span><br><span class="line"><span class="comment"># FileZilla 端口转发指南</span></span><br><span class="line">tracert xxxx.vicp.cc</span><br></pre></td></tr></table></figure><h4 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h4><ol><li><p><strong>FileZilla Server 日志</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">编辑 → 设置 → 日志文件</span><br><span class="line">- 启用日志记录</span><br><span class="line">- 查看详细错误信息</span><br></pre></td></tr></table></figure></li><li><p><strong>Windows 事件日志</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">事件查看器 → Windows 日志 → 应用程序</span><br><span class="line">- 查找与 FileZilla 相关的错误</span><br></pre></td></tr></table></figure></li></ol><h3 id="8-3-📞-获取支持"><a href="#8-3-📞-获取支持" class="headerlink" title="8.3 📞 获取支持"></a>8.3 📞 获取支持</h3><p><strong>官方资源</strong>:</p><ul><li><a href="https://wiki.filezilla-project.org/">FileZilla 官方文档</a></li><li><a href="https://hsk.oray.com/support/">花生壳技术支持</a></li><li><a href="https://tools.ietf.org/html/rfc959">FTP 协议文档</a></li></ul><p><strong>社区支持</strong>:</p><ul><li>FileZilla 论坛</li><li>花生壳用户社区</li><li>Stack Overflow 技术问答</li></ul><hr><h2 id="📊-性能优化建议"><a href="#📊-性能优化建议" class="headerlink" title="📊 性能优化建议"></a>📊 性能优化建议</h2><h3 id="9-1-⚡-服务器优化"><a href="#9-1-⚡-服务器优化" class="headerlink" title="9.1 ⚡ 服务器优化"></a>9.1 ⚡ 服务器优化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[性能优化] --&gt; B[网络优化]</span><br><span class="line">    A --&gt; C[硬件优化]</span><br><span class="line">    A --&gt; D[软件配置]</span><br><span class="line"></span><br><span class="line">    B --&gt; B1[提高带宽]</span><br><span class="line">    B --&gt; B2[优化MTU]</span><br><span class="line"></span><br><span class="line">    C --&gt; C1[升级CPU]</span><br><span class="line">    C --&gt; C2[增加内存]</span><br><span class="line">    C --&gt; C3[SSD硬盘]</span><br><span class="line"></span><br><span class="line">    D --&gt; D1[调整连接数]</span><br><span class="line">    D --&gt; D2[启用缓存]</span><br><span class="line">    D --&gt; D3[优化日志]</span><br></pre></td></tr></table></figure><h3 id="9-2-🔒-安全加固"><a href="#9-2-🔒-安全加固" class="headerlink" title="9.2 🔒 安全加固"></a>9.2 🔒 安全加固</h3><ol><li><strong>定期更新</strong> - 保持 FileZilla Server 为最新版本</li><li><strong>监控访问</strong> - 设置异常访问告警</li><li><strong>备份配置</strong> - 定期备份用户和配置信息</li><li><strong>访问限制</strong> - 限制特定IP访问</li></ol><hr><h2 id="📚-总结"><a href="#📚-总结" class="headerlink" title="📚 总结"></a>📚 总结</h2><h3 id="✅-配置完成清单"><a href="#✅-配置完成清单" class="headerlink" title="✅ 配置完成清单"></a>✅ 配置完成清单</h3><ul><li><input checked="" disabled="" type="checkbox"> FileZilla Server 安装配置</li><li><input checked="" disabled="" type="checkbox"> 用户账户和权限设置</li><li><input checked="" disabled="" type="checkbox"> 花生壳内网穿透配置</li><li><input checked="" disabled="" type="checkbox"> FTP 被动模式设置</li><li><input checked="" disabled="" type="checkbox"> 防火墙规则配置</li><li><input checked="" disabled="" type="checkbox"> 外网连接测试通过</li></ul><h3 id="🎯-使用场景"><a href="#🎯-使用场景" class="headerlink" title="🎯 使用场景"></a>🎯 使用场景</h3><ul><li><strong>个人文件分享</strong> - 在外网访问家中文件</li><li><strong>团队协作</strong> - 共享项目文件</li><li><strong>远程备份</strong> - 外网备份重要数据</li><li><strong>网站维护</strong> - 上传下载网站文件</li></ul><h3 id="💡-维护建议"><a href="#💡-维护建议" class="headerlink" title="💡 维护建议"></a>💡 维护建议</h3><ul><li>定期检查花生壳映射状态</li><li>监控服务器性能和连接数</li><li>定期更新密码和安全配置</li><li>备份重要文件和配置</li></ul><hr><blockquote><p><strong>💡 提示</strong>:</p><ul><li>花生壳免费版本通常限制映射数量和带宽</li><li>生产环境建议使用付费版本获得更好性能</li><li>定期检查 FTP 服务状态确保可用性</li><li>重要数据建议使用更安全的传输方式如 SFTP</li></ul></blockquote>]]></content>
    
    
      
      
        
        
    <summary type="html">&lt;h1 id=&quot;FileZilla-端口转发指南&quot;&gt;&lt;a href=&quot;#FileZilla-端口转发指南&quot; class=&quot;headerlink&quot; title=&quot;FileZilla 端口转发指南&quot;&gt;&lt;/a&gt;FileZilla</summary>
        
      
    
    
    
    <category term="云原生运维" scheme="https://vilaswang.github.io/categories/%E4%BA%91%E5%8E%9F%E7%94%9F%E8%BF%90%E7%BB%B4/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>Qt 下载器需求规范</title>
    <link href="https://vilaswang.github.io/posts/6ee89f12/"/>
    <id>https://vilaswang.github.io/posts/6ee89f12/</id>
    <published>2025-12-09T06:09:54.000Z</published>
    <updated>2025-12-18T15:50:00.259Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Qt-下载器需求规范"><a href="#Qt-下载器需求规范" class="headerlink" title="Qt 下载器需求规范"></a>Qt 下载器需求规范</h1><blockquote><p><strong>文档创建时间</strong>: 2025-11-14<br><strong>最后更新</strong>: 2025-11-14<br><strong>版本</strong>: v1.0<br><strong>标签</strong>: <code>qt</code>, <code>downloader</code>, <code>product-requirements</code>, <code>desktop-app</code>, <code>c++</code></p></blockquote><h2 id="📑-目录"><a href="#📑-目录" class="headerlink" title="📑 目录"></a>📑 目录</h2><ul><li><a href="#1-%E4%BA%A7%E5%93%81%E6%A6%82%E8%BF%B0">1. 产品概述</a></li><li><a href="#2-%E7%94%A8%E6%88%B7%E8%A7%92%E8%89%B2">2. 用户角色</a></li><li><a href="#3-%E5%8A%9F%E8%83%BD%E9%9C%80%E6%B1%82">3. 功能需求</a></li><li><a href="#4-%E9%9D%9E%E5%8A%9F%E8%83%BD%E9%9C%80%E6%B1%82">4. 非功能需求</a></li><li><a href="#5-%E7%95%8C%E9%9D%A2%E8%AE%BE%E8%AE%A1">5. 界面设计</a></li><li><a href="#6-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B">6. 数据模型</a></li><li><a href="#7-%E6%8A%80%E6%9C%AF%E8%A7%84%E8%8C%83">7. 技术规范</a></li><li><a href="#8-%E4%BA%A4%E4%BB%98%E8%A6%81%E6%B1%82">8. 交付要求</a></li></ul><hr><h2 id="1-🎯-产品概述"><a href="#1-🎯-产品概述" class="headerlink" title="1. 🎯 产品概述"></a>1. 🎯 产品概述</h2><h3 id="1-1-产品定位"><a href="#1-1-产品定位" class="headerlink" title="1.1 产品定位"></a>1.1 产品定位</h3><p>基于 Qt 框架开发的桌面下载管理器，支持多线程并发下载，提供直观的任务管理界面和实时进度监控。</p><h3 id="1-2-核心价值"><a href="#1-2-核心价值" class="headerlink" title="1.2 核心价值"></a>1.2 核心价值</h3><ul><li>✅ <strong>批量下载</strong> - 支持多任务并发下载</li><li>✅ <strong>进度监控</strong> - 实时显示下载状态和进度</li><li>✅ <strong>断点续传</strong> - 支持下载中断后继续</li><li>✅ <strong>跨平台</strong> - 支持 Windows、macOS、Linux</li></ul><h3 id="1-3-产品架构图"><a href="#1-3-产品架构图" class="headerlink" title="1.3 产品架构图"></a>1.3 产品架构图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">graph TD</span><br><span class="line">    A[用户界面] --&gt; B[任务管理器]</span><br><span class="line">    B --&gt; C[下载引擎]</span><br><span class="line">    C --&gt; D[网络请求层]</span><br><span class="line"></span><br><span class="line">    B --&gt; E[数据持久化]</span><br><span class="line">    B --&gt; F[配置管理]</span><br><span class="line"></span><br><span class="line">    C --&gt; G[线程池]</span><br><span class="line">    G --&gt; H[任务队列]</span><br><span class="line"></span><br><span class="line">    D --&gt; I[HTTP/HTTPS]</span><br><span class="line">    D --&gt; J[重定向处理]</span><br><span class="line">    D --&gt; K[认证处理]</span><br><span class="line"></span><br><span class="line">    style A fill:#e1f5fe</span><br><span class="line">    style B fill:#f3e5f5</span><br><span class="line">    style C fill:#e8f5e8</span><br><span class="line">    style D fill:#fff3e0</span><br></pre></td></tr></table></figure><hr><h2 id="2-👥-用户角色"><a href="#2-👥-用户角色" class="headerlink" title="2. 👥 用户角色"></a>2. 👥 用户角色</h2><h3 id="2-1-目标用户"><a href="#2-1-目标用户" class="headerlink" title="2.1 目标用户"></a>2.1 目标用户</h3><p><strong>终端用户</strong> - 需要批量下载文件的个人用户</p><ul><li>技术背景：普通计算机用户</li><li>使用场景：下载软件、文档、媒体文件</li><li>操作习惯：图形界面操作</li></ul><h3 id="2-2-用户场景"><a href="#2-2-用户场景" class="headerlink" title="2.2 用户场景"></a>2.2 用户场景</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">    A[用户输入URL] --&gt; B[添加下载任务]</span><br><span class="line">    B --&gt; C[开始下载]</span><br><span class="line">    C --&gt; D[监控进度]</span><br><span class="line">    D --&gt; E&#123;完成下载?&#125;</span><br><span class="line">    E --&gt;|是| F[通知用户]</span><br><span class="line">    E --&gt;|否| D</span><br><span class="line">    F --&gt; G[任务完成]</span><br></pre></td></tr></table></figure><hr><h2 id="3-📋-功能需求"><a href="#3-📋-功能需求" class="headerlink" title="3. 📋 功能需求"></a>3. 📋 功能需求</h2><h3 id="3-1-🎛️-任务管理"><a href="#3-1-🎛️-任务管理" class="headerlink" title="3.1 🎛️ 任务管理"></a>3.1 🎛️ 任务管理</h3><h4 id="3-1-1-添加任务"><a href="#3-1-1-添加任务" class="headerlink" title="3.1.1 添加任务"></a>3.1.1 添加任务</h4><ul><li><strong>URL 输入</strong>: 支持单个或多个 URL（每行一个）</li><li><strong>URL 格式</strong>: 支持 HTTP&#x2F;HTTPS 协议</li><li><strong>认证支持</strong>: URL 中可包含用户名密码 (<code>user:pass@host</code>)</li><li><strong>批量导入</strong>: 支持从剪贴板粘贴多个 URL</li></ul><h4 id="3-1-2-任务列表显示"><a href="#3-1-2-任务列表显示" class="headerlink" title="3.1.2 任务列表显示"></a>3.1.2 任务列表显示</h4><p><strong>表格列必须包含</strong>:</p><ul><li><strong>文件名</strong>: 从 URL 提取或 Content-Disposition 解析</li><li><strong>文件大小</strong>: 字节数，获取后显示 (-1 表示未知)</li><li><strong>已下载大小</strong>: 字节数，实时刷新</li><li><strong>进度百分比</strong>: 0-100%，实时计算</li><li><strong>下载速度</strong>: B&#x2F;s，实时刷新</li><li><strong>状态</strong>: 等待 &#x2F; 下载中 &#x2F; 已完成 &#x2F; 错误</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gantt</span><br><span class="line">    title 下载任务状态流转</span><br><span class="line">    dateFormat X</span><br><span class="line">    axisFormat %s</span><br><span class="line"></span><br><span class="line">    section 下载流程</span><br><span class="line">    等待中     :0, 10</span><br><span class="line">    下载中     :10, 100</span><br><span class="line">    已完成     :100, 110</span><br><span class="line">    错误处理   :a1, after a2, 20</span><br></pre></td></tr></table></figure><h4 id="3-1-3-任务操作"><a href="#3-1-3-任务操作" class="headerlink" title="3.1.3 任务操作"></a>3.1.3 任务操作</h4><ul><li><strong>开始</strong>: 启动选中的下载任务</li><li><strong>暂停</strong>: 暂停正在下载的任务</li><li><strong>取消</strong>: 取消下载并删除未完成的文件</li><li><strong>删除</strong>: 从列表中删除已完成或失败的记录</li></ul><h3 id="3-2-⚙️-下载引擎"><a href="#3-2-⚙️-下载引擎" class="headerlink" title="3.2 ⚙️ 下载引擎"></a>3.2 ⚙️ 下载引擎</h3><h4 id="3-2-1-多线程下载"><a href="#3-2-1-多线程下载" class="headerlink" title="3.2.1 多线程下载"></a>3.2.1 多线程下载</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单任务多线程配置</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> DEFAULT_THREAD_COUNT = <span class="number">4</span>;  <span class="comment">// 默认4线程</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> MAX_THREAD_COUNT = <span class="number">16</span>;     <span class="comment">// 最大16线程</span></span><br></pre></td></tr></table></figure><ul><li><strong>分段下载</strong>: 将文件分为多个片段并发下载</li><li><strong>线程管理</strong>: 每个任务可配置独立线程数</li><li><strong>负载均衡</strong>: 动态调整各线程下载速度</li></ul><h4 id="3-2-2-网络支持"><a href="#3-2-2-网络支持" class="headerlink" title="3.2.2 网络支持"></a>3.2.2 网络支持</h4><ul><li><strong>协议支持</strong>: HTTP&#x2F;HTTPS</li><li><strong>重定向</strong>: 自动处理 3xx 重定向</li><li><strong>认证</strong>: 支持 Basic Authentication</li><li><strong>代理支持</strong>: 系统代理设置</li></ul><h4 id="3-2-3-完整性校验"><a href="#3-2-3-完整性校验" class="headerlink" title="3.2.3 完整性校验"></a>3.2.3 完整性校验</h4><ul><li><strong>大小校验</strong>: 下载完成后校验 Content-Length</li><li><strong>MD5校验</strong>: 服务器返回 MD5 头时进行校验</li><li><strong>断点续传</strong>: 支持从中断位置继续下载</li></ul><h3 id="3-3-💾-设置与持久化"><a href="#3-3-💾-设置与持久化" class="headerlink" title="3.3 💾 设置与持久化"></a>3.3 💾 设置与持久化</h3><h4 id="3-3-1-配置管理"><a href="#3-3-1-配置管理" class="headerlink" title="3.3.1 配置管理"></a>3.3.1 配置管理</h4><ul><li><strong>下载目录</strong>: 默认系统”下载”文件夹，可自定义</li><li><strong>并发限制</strong>: 全局最大同时下载数</li><li><strong>线程数</strong>: 每任务默认线程数</li><li><strong>重试次数</strong>: 失败重试次数</li></ul><h4 id="3-3-2-任务持久化"><a href="#3-3-2-任务持久化" class="headerlink" title="3.3.2 任务持久化"></a>3.3.2 任务持久化</h4><ul><li><strong>自动保存</strong>: 任务状态自动保存</li><li><strong>启动恢复</strong>: 程序启动时恢复未完成任务</li><li><strong>设置保存</strong>: 用户配置持久化存储</li></ul><h3 id="3-4-🚨-异常处理与反馈"><a href="#3-4-🚨-异常处理与反馈" class="headerlink" title="3.4 🚨 异常处理与反馈"></a>3.4 🚨 异常处理与反馈</h3><h4 id="3-4-1-网络异常"><a href="#3-4-1-网络异常" class="headerlink" title="3.4.1 网络异常"></a>3.4.1 网络异常</h4><ul><li><strong>自动重试</strong>: 网络中断时自动重试3次</li><li><strong>指数退避</strong>: 重试间隔逐渐增加</li><li><strong>错误分类</strong>: 区分临时错误和永久错误</li></ul><h4 id="3-4-2-用户反馈"><a href="#3-4-2-用户反馈" class="headerlink" title="3.4.2 用户反馈"></a>3.4.2 用户反馈</h4><ul><li><strong>状态更新</strong>: 实时更新任务状态</li><li><strong>错误提示</strong>: 显示详细错误信息</li><li><strong>完成通知</strong>: 下载完成时系统托盘通知</li><li><strong>进度提示</strong>: 进度条和百分比显示</li></ul><hr><h2 id="4-🚀-非功能需求"><a href="#4-🚀-非功能需求" class="headerlink" title="4. 🚀 非功能需求"></a>4. 🚀 非功能需求</h2><h3 id="4-1-🖥️-平台兼容性"><a href="#4-1-🖥️-平台兼容性" class="headerlink" title="4.1 🖥️ 平台兼容性"></a>4.1 🖥️ 平台兼容性</h3><table><thead><tr><th>平台</th><th>最低版本</th><th>架构</th><th>Qt 版本</th></tr></thead><tbody><tr><td><strong>Windows</strong></td><td>Windows 10+</td><td>x64</td><td>Qt 5.3-5.12</td></tr><tr><td><strong>macOS</strong></td><td>10.15+</td><td>x64</td><td>Qt 5.3-5.12</td></tr><tr><td><strong>Linux</strong></td><td>Ubuntu 22.04+</td><td>x64</td><td>Qt 5.3-5.12</td></tr></tbody></table><h3 id="4-2-⚡-性能要求"><a href="#4-2-⚡-性能要求" class="headerlink" title="4.2 ⚡ 性能要求"></a>4.2 ⚡ 性能要求</h3><ul><li><strong>内存使用</strong>: 同时10个任务并发时，峰值内存 ≤ 200MB</li><li><strong>UI响应</strong>: 任何操作在 200ms 内给出视觉反馈</li><li><strong>下载速度</strong>: 充分利用可用带宽</li><li><strong>启动时间</strong>: 冷启动 &lt; 3秒</li></ul><h3 id="4-3-🔒-安全性要求"><a href="#4-3-🔒-安全性要求" class="headerlink" title="4.3 🔒 安全性要求"></a>4.3 🔒 安全性要求</h3><ul><li><strong>URL验证</strong>: 验证输入URL格式</li><li><strong>文件路径</strong>: 防止路径遍历攻击</li><li><strong>下载限制</strong>: 支持文件大小和类型限制</li><li><strong>用户数据</strong>: 本地数据加密存储</li></ul><hr><h2 id="5-🎨-界面设计"><a href="#5-🎨-界面设计" class="headerlink" title="5. 🎨 界面设计"></a>5. 🎨 界面设计</h2><h3 id="5-1-主界面布局"><a href="#5-1-主界面布局" class="headerlink" title="5.1 主界面布局"></a>5.1 主界面布局</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌─────────────────────────────────────────────────────────┐</span><br><span class="line">│ URL 输入框                                              │</span><br><span class="line">│ ┌─────────────────────────────────────────────────────┐ │</span><br><span class="line">│ │ https://example.com/file1.zip                       │ │</span><br><span class="line">│ │ https://example.com/file2.pdf                       │ │</span><br><span class="line">│ └─────────────────────────────────────────────────────┘ │</span><br><span class="line">│ [添加] [开始全部] [暂停全部] [删除选中]                 │</span><br><span class="line">├─────────────────────────────────────────────────────────┤</span><br><span class="line">│ 任务列表 (QTableView)                                  │</span><br><span class="line">│ 文件名      │ 大小     │ 已下载  │ 进度  │ 速度  │ 状态 │</span><br><span class="line">│ file1.zip   │ 100MB    │ 50MB    │ 50%   │ 1MB/s │下载中│</span><br><span class="line">│ file2.pdf   │ 20MB     │ 20MB    │ 100%  │ 0     │完成 │</span><br><span class="line">├─────────────────────────────────────────────────────────┤</span><br><span class="line">│ 全局速度: 1.5MB/s  剩余时间: 2分钟  任务数: 2/10       │</span><br><span class="line">│ [设置] [关于] [退出]                                    │</span><br><span class="line">└─────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><h3 id="5-2-界面状态图"><a href="#5-2-界面状态图" class="headerlink" title="5.2 界面状态图"></a>5.2 界面状态图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stateDiagram-v2</span><br><span class="line">    [*] --&gt; 初始化界面</span><br><span class="line">    初始化界面 --&gt; 空闲状态</span><br><span class="line">    空闲状态 --&gt; 下载中: 添加任务并开始</span><br><span class="line">    下载中 --&gt; 暂停中: 用户暂停</span><br><span class="line">    暂停中 --&gt; 下载中: 用户继续</span><br><span class="line">    下载中 --&gt; 完成: 下载完成</span><br><span class="line">    下载中 --&gt; 错误: 下载失败</span><br><span class="line">    错误 --&gt; 下载中: 重试下载</span><br><span class="line">    完成 --&gt; 空闲状态: 清除任务</span><br></pre></td></tr></table></figure><hr><h2 id="6-📊-数据模型"><a href="#6-📊-数据模型" class="headerlink" title="6. 📊 数据模型"></a>6. 📊 数据模型</h2><h3 id="6-1-核心数据结构"><a href="#6-1-核心数据结构" class="headerlink" title="6.1 核心数据结构"></a>6.1 核心数据结构</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 下载任务数据模型</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">DownloadTask</span> &#123;</span><br><span class="line">    QString id;                    <span class="comment">// 唯一标识</span></span><br><span class="line">    QUrl url;                     <span class="comment">// 下载URL</span></span><br><span class="line">    QString fileName;             <span class="comment">// 本地文件名</span></span><br><span class="line">    QString savePath;             <span class="comment">// 保存路径</span></span><br><span class="line">    qint64 totalBytes;           <span class="comment">// 总大小 (-1=未知)</span></span><br><span class="line">    qint64 downloadedBytes;      <span class="comment">// 已下载大小</span></span><br><span class="line">    <span class="type">int</span> progress;                 <span class="comment">// 进度百分比 (0-100)</span></span><br><span class="line">    qint64 speed;                <span class="comment">// 当前速度 (B/s)</span></span><br><span class="line">    qint64 averageSpeed;         <span class="comment">// 平均速度 (B/s)</span></span><br><span class="line">    QDateTime startTime;         <span class="comment">// 开始时间</span></span><br><span class="line">    QDateTime finishTime;        <span class="comment">// 完成时间</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">State</span> &#123;</span><br><span class="line">        Waiting,     <span class="comment">// 等待开始</span></span><br><span class="line">        Running,     <span class="comment">// 下载中</span></span><br><span class="line">        Paused,      <span class="comment">// 已暂停</span></span><br><span class="line">        Completed,   <span class="comment">// 已完成</span></span><br><span class="line">        Error,       <span class="comment">// 错误</span></span><br><span class="line">        Cancelled    <span class="comment">// 已取消</span></span><br><span class="line">    &#125; state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">Priority</span> &#123;</span><br><span class="line">        Low = <span class="number">1</span>,</span><br><span class="line">        Normal = <span class="number">2</span>,</span><br><span class="line">        High = <span class="number">3</span></span><br><span class="line">    &#125; priority;</span><br><span class="line"></span><br><span class="line">    QString errorMessage;        <span class="comment">// 错误信息</span></span><br><span class="line">    <span class="type">int</span> retryCount;             <span class="comment">// 重试次数</span></span><br><span class="line">    <span class="type">int</span> maxRetries;             <span class="comment">// 最大重试次数</span></span><br><span class="line">    QStringList downloadThreads;  <span class="comment">// 下载线程列表</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="6-2-配置数据结构"><a href="#6-2-配置数据结构" class="headerlink" title="6.2 配置数据结构"></a>6.2 配置数据结构</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">DownloadSettings</span> &#123;</span><br><span class="line">    QString defaultDownloadPath;    <span class="comment">// 默认下载路径</span></span><br><span class="line">    <span class="type">int</span> maxConcurrentTasks;         <span class="comment">// 最大并发任务数</span></span><br><span class="line">    <span class="type">int</span> defaultThreadCount;         <span class="comment">// 默认线程数</span></span><br><span class="line">    <span class="type">int</span> maxRetryCount;             <span class="comment">// 最大重试次数</span></span><br><span class="line">    <span class="type">bool</span> autoRetry;                <span class="comment">// 自动重试</span></span><br><span class="line">    <span class="type">bool</span> startOnStartup;           <span class="comment">// 开机启动</span></span><br><span class="line">    <span class="type">bool</span> showNotifications;        <span class="comment">// 显示通知</span></span><br><span class="line">    <span class="type">bool</span> verifyIntegrity;          <span class="comment">// 验证文件完整性</span></span><br><span class="line">    qint64 maxFileSize;            <span class="comment">// 最大文件大小限制</span></span><br><span class="line">    QStringList blockedExtensions;  <span class="comment">// 禁止的文件扩展名</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="7-🔧-技术规范"><a href="#7-🔧-技术规范" class="headerlink" title="7. 🔧 技术规范"></a>7. 🔧 技术规范</h2><h3 id="7-1-技术栈"><a href="#7-1-技术栈" class="headerlink" title="7.1 技术栈"></a>7.1 技术栈</h3><ul><li><strong>UI框架</strong>: Qt Widgets (非QML)</li><li><strong>网络库</strong>: QNetworkRequest</li><li><strong>并发</strong>: QThread + QThreadPool</li><li><strong>持久化</strong>: QSettings + SQLite</li><li><strong>日志</strong>: QtMessageHandler</li></ul><h3 id="7-2-代码结构"><a href="#7-2-代码结构" class="headerlink" title="7.2 代码结构"></a>7.2 代码结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FastDownloader/</span><br><span class="line">├── main.cpp                 # 程序入口</span><br><span class="line">├── MainWindow.h/.cpp         # 主窗口</span><br><span class="line">├── MainWindow.ui             # UI文件</span><br><span class="line">├── DownloadTask.h/.cpp       # 下载任务数据模型</span><br><span class="line">├── DownloadManager.h/.cpp    # 下载管理器</span><br><span class="line">├── Downloader.h/.cpp         # 下载引擎</span><br><span class="line">├── SettingsDialog.h/.cpp     # 设置对话框</span><br><span class="line">├── SettingsDialog.ui         # 设置UI</span><br><span class="line">└── resources/                # 资源文件</span><br><span class="line">    ├── icons/</span><br><span class="line">    └── translations/</span><br></pre></td></tr></table></figure><h3 id="7-3-关键技术点"><a href="#7-3-关键技术点" class="headerlink" title="7.3 关键技术点"></a>7.3 关键技术点</h3><h4 id="7-3-1-多线程下载"><a href="#7-3-1-多线程下载" class="headerlink" title="7.3.1 多线程下载"></a>7.3.1 多线程下载</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DownloadThread</span> : <span class="keyword">public</span> QThread &#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">pause</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">stop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">progressChanged</span><span class="params">(qint64 bytesReceived, qint64 bytesTotal)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">speedChanged</span><span class="params">(qint64 speed)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">finished</span><span class="params">(<span class="type">bool</span> success, <span class="type">const</span> QString&amp; error)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QNetworkReply* m_reply;</span><br><span class="line">    QUrl m_url;</span><br><span class="line">    QString m_filePath;</span><br><span class="line">    qint64 m_startPos;</span><br><span class="line">    qint64 m_endPos;</span><br><span class="line">    <span class="type">bool</span> m_paused;</span><br><span class="line">    <span class="type">bool</span> m_stopped;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="7-3-2-断点续传"><a href="#7-3-2-断点续传" class="headerlink" title="7.3.2 断点续传"></a>7.3.2 断点续传</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取文件已下载大小</span></span><br><span class="line"><span class="function">qint64 <span class="title">getDownloadedFileSize</span><span class="params">(<span class="type">const</span> QString&amp; filePath)</span> </span>&#123;</span><br><span class="line">    <span class="function">QFile <span class="title">file</span><span class="params">(filePath)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (file.<span class="built_in">exists</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> file.<span class="built_in">size</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置Range请求头</span></span><br><span class="line"><span class="function">QNetworkRequest <span class="title">createRangeRequest</span><span class="params">(<span class="type">const</span> QUrl&amp; url, qint64 startPos)</span> </span>&#123;</span><br><span class="line">    <span class="function">QNetworkRequest <span class="title">request</span><span class="params">(url)</span></span>;</span><br><span class="line">    QString range = <span class="built_in">QString</span>(<span class="string">&quot;bytes=%1-&quot;</span>).<span class="built_in">arg</span>(startPos);</span><br><span class="line">    request.<span class="built_in">setRawHeader</span>(<span class="string">&quot;Range&quot;</span>, range.<span class="built_in">toLatin1</span>());</span><br><span class="line">    <span class="keyword">return</span> request;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-4-性能优化"><a href="#7-4-性能优化" class="headerlink" title="7.4 性能优化"></a>7.4 性能优化</h3><ul><li><strong>内存管理</strong>: 及时释放下载完成的数据</li><li><strong>网络优化</strong>: 连接池和Keep-Alive</li><li><strong>UI更新</strong>: 使用定时器减少UI刷新频率</li><li><strong>磁盘IO</strong>: 缓冲写入，减少磁盘IO次数</li></ul><hr><h2 id="8-📦-交付要求"><a href="#8-📦-交付要求" class="headerlink" title="8. 📦 交付要求"></a>8. 📦 交付要求</h2><h3 id="8-1-交付物清单"><a href="#8-1-交付物清单" class="headerlink" title="8.1 交付物清单"></a>8.1 交付物清单</h3><ul><li><input checked="" disabled="" type="checkbox"> <strong>源代码</strong>: 完整的C++源码实现</li><li><input checked="" disabled="" type="checkbox"> <strong>资源文件</strong>: 图标、UI文件等</li><li><input checked="" disabled="" type="checkbox"> <strong>构建脚本</strong>: CMakeLists.txt或.pro文件</li><li><input disabled="" type="checkbox"> <strong>测试用例</strong>: 单元测试和集成测试</li><li><input disabled="" type="checkbox"> <strong>部署文档</strong>: 编译和部署说明</li></ul><h3 id="8-2-代码规范"><a href="#8-2-代码规范" class="headerlink" title="8.2 代码规范"></a>8.2 代码规范</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 命名规范</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DownloadManager</span> : <span class="keyword">public</span> QObject &#123;  <span class="comment">// 类名：PascalCase</span></span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">DownloadManager</span><span class="params">(QObject *parent = <span class="literal">nullptr</span>)</span></span>;  <span class="comment">// 函数名：camelCase</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onDownloadProgress</span><span class="params">(qint64 bytesReceived, qint64 bytesTotal)</span></span>;  <span class="comment">// 槽函数命名</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_maxConcurrentTasks;  <span class="comment">// 成员变量：m_前缀，camelCase</span></span><br><span class="line">    QString m_defaultPath;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="8-3-质量要求"><a href="#8-3-质量要求" class="headerlink" title="8.3 质量要求"></a>8.3 质量要求</h3><ul><li><strong>代码覆盖率</strong>: ≥80%</li><li><strong>内存泄漏</strong>: 无内存泄漏</li><li><strong>文档完整</strong>: 关键函数有注释</li><li><strong>异常处理</strong>: 完善的错误处理机制</li></ul><hr><h2 id="📊-项目里程碑"><a href="#📊-项目里程碑" class="headerlink" title="📊 项目里程碑"></a>📊 项目里程碑</h2><h3 id="Phase-1-基础框架-2周"><a href="#Phase-1-基础框架-2周" class="headerlink" title="Phase 1: 基础框架 (2周)"></a>Phase 1: 基础框架 (2周)</h3><ul><li><input checked="" disabled="" type="checkbox"> 主界面设计</li><li><input checked="" disabled="" type="checkbox"> 数据模型定义</li><li><input checked="" disabled="" type="checkbox"> 基础下载功能</li></ul><h3 id="Phase-2-核心功能-3周"><a href="#Phase-2-核心功能-3周" class="headerlink" title="Phase 2: 核心功能 (3周)"></a>Phase 2: 核心功能 (3周)</h3><ul><li><input disabled="" type="checkbox"> 多线程下载实现</li><li><input disabled="" type="checkbox"> 断点续传功能</li><li><input disabled="" type="checkbox"> 任务管理界面</li></ul><h3 id="Phase-3-高级功能-2周"><a href="#Phase-3-高级功能-2周" class="headerlink" title="Phase 3: 高级功能 (2周)"></a>Phase 3: 高级功能 (2周)</h3><ul><li><input disabled="" type="checkbox"> 配置管理</li><li><input disabled="" type="checkbox"> 异常处理</li><li><input disabled="" type="checkbox"> 性能优化</li></ul><h3 id="Phase-4-测试发布-1周"><a href="#Phase-4-测试发布-1周" class="headerlink" title="Phase 4: 测试发布 (1周)"></a>Phase 4: 测试发布 (1周)</h3><ul><li><input disabled="" type="checkbox"> 功能测试</li><li><input disabled="" type="checkbox"> 性能测试</li><li><input disabled="" type="checkbox"> 代码审查</li></ul><hr><h2 id="📈-成功指标"><a href="#📈-成功指标" class="headerlink" title="📈 成功指标"></a>📈 成功指标</h2><h3 id="8-1-功能指标"><a href="#8-1-功能指标" class="headerlink" title="8.1 功能指标"></a>8.1 功能指标</h3><ul><li>✅ 支持同时下载10个文件</li><li>✅ 下载速度达到带宽的90%以上</li><li>✅ 程序启动时间&lt;3秒</li><li>✅ 内存使用&lt;200MB（10个并发任务）</li></ul><h3 id="8-2-用户体验指标"><a href="#8-2-用户体验指标" class="headerlink" title="8.2 用户体验指标"></a>8.2 用户体验指标</h3><ul><li>✅ 界面响应时间&lt;200ms</li><li>✅ 支持断点续传</li><li>✅ 错误恢复成功率&gt;95%</li><li>✅ 用户操作流程简化</li></ul><hr><h2 id="📚-参考资料"><a href="#📚-参考资料" class="headerlink" title="📚 参考资料"></a>📚 参考资料</h2><ul><li><a href="https://doc.qt.io/">Qt 官方文档</a></li><li><a href="https://doc.qt.io/qt-5/qnetworkrequest.html">QNetworkRequest 类文档</a></li><li><a href="https://doc.qt.io/qt-5/thread-support.html">Qt 多线程编程指南</a></li><li><a href="https://tools.ietf.org/html/rfc7231">HTTP 协议规范</a></li></ul><hr><blockquote><p><strong>💡 开发建议</strong>:</p><ul><li>采用模块化设计，便于功能扩展</li><li>重视用户体验，界面简洁直观</li><li>完善错误处理，提高程序稳定性</li><li>充分测试各种网络环境和异常情况</li></ul></blockquote>]]></content>
    
    
    <summary type="html">详细说明基于 Qt 框架开发的桌面下载管理器的核心功能、用户场景、非功能性需求及数据模型。</summary>
    
    
    
    <category term="软件架构" scheme="https://vilaswang.github.io/categories/%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/"/>
    
    
    <category term="技术文档" scheme="https://vilaswang.github.io/tags/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/"/>
    
    <category term="指南" scheme="https://vilaswang.github.io/tags/%E6%8C%87%E5%8D%97/"/>
    
  </entry>
  
  <entry>
    <title>FileZilla 内网穿透配置指南</title>
    <link href="https://vilaswang.github.io/posts/2acf74bd/"/>
    <id>https://vilaswang.github.io/posts/2acf74bd/</id>
    <published>2025-12-09T04:59:14.000Z</published>
    <updated>2025-12-17T15:36:29.265Z</updated>
    
    <content type="html"><![CDATA[<h3 id="🛠️-详细配置步骤"><a href="#🛠️-详细配置步骤" class="headerlink" title="🛠️ 详细配置步骤"></a>🛠️ 详细配置步骤</h3><h4 id="1-安装与配置FileZilla-Server"><a href="#1-安装与配置FileZilla-Server" class="headerlink" title="1. 安装与配置FileZilla Server"></a>1. 安装与配置FileZilla Server</h4><ul><li><p><strong>下载与安装</strong><br>在您的内网服务器上，从FileZilla官网下载FileZilla Server并安装。</p><blockquote><p><strong>注意</strong>: 本指南基于 FileZilla Server 经典版本 (0.9.x) 的界面描述。如果您使用的是 1.x 或更高版本，管理界面可能有所不同（通常为基于Web的仪表板），但核心配置概念（用户、被动模式端口）是通用的。</p></blockquote><p>安装过程中，如果弹出“连接到服务器”配置界面，通常使用默认设置（如主机名<code>127.0.0.1</code>，管理端口）即可，点击“连接”或“确定”。</p></li><li><p><strong>创建用户与设置密码</strong><br>安装完成后，在FileZilla Server管理界面中：</p><ul><li>点击 <strong>Edit</strong> -&gt; <strong>Users</strong> 进入用户设置。</li><li>在 <strong>General</strong>（通用）页面，点击 <strong>Add</strong> 按钮创建新用户（例如 <code>user1</code>）。</li><li>为该用户设置密码。</li></ul></li><li><p><strong>设置共享文件夹</strong><br>创建用户后，系统通常会提示需设置至少一个共享文件夹。</p><ul><li>在 <strong>Shared folders</strong> 页面，点击 <strong>Add</strong> 按钮，选择您希望外网能访问下载文件的内网目录。</li><li>根据需要，在 <strong>Files</strong> 和 <strong>Directories</strong> 下为用户设置目录的读取（可下载）、写入、删除等权限。至少需要开启<strong>读取</strong>权限，才能允许文件下载。</li></ul></li></ul><h4 id="2-配置花生壳内网穿透"><a href="#2-配置花生壳内网穿透" class="headerlink" title="2. 配置花生壳内网穿透"></a>2. 配置花生壳内网穿透</h4><ul><li><strong>安装花生壳并添加映射</strong><br>在内网服务器下载、安装并登录花生壳客户端。<ul><li>在花生壳客户端的 <strong>内网穿透</strong> 页面，点击 <strong>+</strong> 按钮添加映射。</li><li><strong>应用名称</strong>：可自定义，如”FTP-Control”。</li><li><strong>应用类型</strong>：选择 <strong>TCP</strong>。</li><li><strong>内网主机IP</strong>：填写运行FileZilla Server的内网服务器IP地址（通常是<code>192.168.x.x</code>形式的地址）。<strong>注意</strong>：不要使用<code>localhost</code>或<code>127.0.0.1</code>。</li><li><strong>内网端口</strong>：填写FTP服务的控制端口，默认为 <strong>21</strong>。</li><li>点击保存，花生壳会生成一个FTP控制通道的外网访问地址（包含域名和端口）。</li></ul></li></ul><h4 id="3-配置FTP被动模式与数据传输端口"><a href="#3-配置FTP被动模式与数据传输端口" class="headerlink" title="3. 配置FTP被动模式与数据传输端口"></a>3. 配置FTP被动模式与数据传输端口</h4><p>FTP协议使用<strong>21端口</strong>建立控制连接，使用<strong>被动模式下的其他端口</strong>进行数据传输。因此，必须单独映射数据传输端口。</p><ul><li><p><strong>在花生壳中映射数据端口</strong><br>按照上述同样方法，在花生壳中为FTP被动模式端口再添加一条映射：</p><ul><li><strong>应用名称</strong>：可自定义，如”FTP-Data”。</li><li><strong>应用类型</strong>：<strong>TCP</strong>。</li><li><strong>内网主机IP</strong>：与上一步相同。</li><li><strong>内网端口</strong>：可<strong>任意填写一个未占用的端口号</strong>，例如 <code>12345</code>。</li><li>保存后，花生壳会生成第二个外网访问地址，<strong>请记下这个新地址的外网端口号</strong>（例如 <code>10418</code>），下一步需要用到。</li></ul><p>添加映射后，可能需要<strong>编辑这条映射</strong>，将 <strong>内网端口</strong> 修改为与花生壳生成的 <strong>外网端口一致</strong>（例如将内网端口从<code>12345</code>改为<code>10418</code>），以确保数据通道正常传输。</p></li><li><p><strong>在FileZilla Server中设置被动模式</strong><br>现在需要在FileZilla Server中告知它使用这个映射好的端口。</p><ul><li>打开FileZilla Server，点击 <strong>Edit</strong> -&gt; <strong>Settings</strong>，进入 <strong>Passive mode settings</strong> (被动模式设置)。</li><li>勾选 <strong>Use custom port range</strong> (使用自定义端口范围)。</li><li>在输入框中，<strong>填写花生壳为数据通道生成的外网端口号</strong>（例如上一步的 <code>10418</code>）。如果只使用单个端口，起始和结束端口填相同的即可。</li><li><strong>关键步骤</strong>：在 <strong>Use the following IP</strong> 下方，可能需要填写花生壳生成的外网访问<strong>域名</strong>（即FTP控制通道的域名）。这能确保FTP服务器将正确的地址告知外网客户端。</li></ul></li></ul><h4 id="4-设置Windows防火墙"><a href="#4-设置Windows防火墙" class="headerlink" title="4. 设置Windows防火墙"></a>4. 设置Windows防火墙</h4><p>如果内网服务器的Windows防火墙已开启，需要放行FileZilla Server相关端口。</p><ul><li>在 <strong>Windows Defender 防火墙</strong> 中，添加入站规则。</li><li>允许之前用到的端口（如控制端口<code>21</code>和您在花生壳设置的数据端口<code>10418</code>）的TCP连接。</li></ul><h4 id="5-外网连接测试"><a href="#5-外网连接测试" class="headerlink" title="5. 外网连接测试"></a>5. 外网连接测试</h4><p>在另一台外网电脑上，使用任何FTP客户端（如FileZilla Client）进行测试。</p><ul><li><strong>主机&#x2F;地址</strong>：填写花生壳为<strong>控制通道</strong>生成的外网访问地址（域名和端口，例如 <code>xxxx.vicp.cc:21</code> 处的端口）。</li><li><strong>用户名与密码</strong>：填写您在FileZilla Server中设置的账号（如 <code>user1</code>）和密码。</li><li><strong>传输模式</strong>：在FTP客户端的站点设置中，<strong>传输模式请选择“被动模式”</strong>。</li><li>连接成功后，您应该能看到内网共享的文件并可进行下载。</li></ul><h3 id="💡-关键配置提醒与排查"><a href="#💡-关键配置提醒与排查" class="headerlink" title="💡 关键配置提醒与排查"></a>💡 关键配置提醒与排查</h3><ul><li><strong>核心原理</strong>：成功的关键在于理解FTP需要<strong>两个通道</strong>（控制+数据），并正确配置<strong>被动模式</strong>及对应的<strong>端口映射</strong>。</li><li><strong>域名与IP</strong>：在FileZilla Server的被动模式设置中，”Use the following IP”处建议填写花生壳生成的<strong>域名</strong>，而非IP地址。</li><li><strong>防火墙</strong>：确保内网服务器的防火墙不会阻挡连接。</li><li><strong>花生壳版本</strong>：免费版花生壳通常支持添加2条映射，刚好满足FTP控制与数据通道的需求。如果数据端口不理想，可以删除映射后重新添加。</li></ul>]]></content>
    
    
    <summary type="html">详细介绍使用Filezilla Server和花生壳实现内网穿透的技术实现、配置方法、最佳实践等内容。</summary>
    
    
    
    <category term="系统运维管理" scheme="https://vilaswang.github.io/categories/%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4%E7%AE%A1%E7%90%86/"/>
    
    <category term="Windows服务管理" scheme="https://vilaswang.github.io/categories/%E7%B3%BB%E7%BB%9F%E8%BF%90%E7%BB%B4%E7%AE%A1%E7%90%86/Windows%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/"/>
    
    
    <category term="Windows" scheme="https://vilaswang.github.io/tags/Windows/"/>
    
  </entry>
  
</feed>
